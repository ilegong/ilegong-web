angular.module("me-lazyload",[]).directive("lazySrc",["$window","$document",function($window,$document){function getUid(el){return el.__uid||(el.__uid=""+ ++uid)}function getWindowOffset(){var t,pageXOffset="number"==typeof win.pageXOffset?win.pageXOffset:(((t=doc.documentElement)||(t=body.parentNode))&&"number"==typeof t.ScrollLeft?t:body).ScrollLeft,pageYOffset="number"==typeof win.pageYOffset?win.pageYOffset:(((t=doc.documentElement)||(t=body.parentNode))&&"number"==typeof t.ScrollTop?t:body).ScrollTop;return{offsetX:pageXOffset,offsetY:pageYOffset}}function isVisible(iElement){var xVisible,yVisible,elem=iElement[0],elemRect=elem.getBoundingClientRect(),windowOffset=getWindowOffset(),winOffsetX=windowOffset.offsetX,winOffsetY=windowOffset.offsetY,elemWidth=elemRect.width,elemHeight=elemRect.height,elemOffsetX=elemRect.left+winOffsetX,elemOffsetY=elemRect.top+winOffsetY,viewWidth=Math.max(doc.documentElement.clientWidth,win.innerWidth||0),viewHeight=Math.max(doc.documentElement.clientHeight,win.innerHeight||0);return winOffsetY>=elemOffsetY?elemOffsetY+elemHeight>=winOffsetY&&(yVisible=!0):elemOffsetY>=winOffsetY&&winOffsetY+viewHeight>=elemOffsetY&&(yVisible=!0),winOffsetX>=elemOffsetX?elemOffsetX+elemWidth>=winOffsetX&&(xVisible=!0):elemOffsetX>=winOffsetX&&winOffsetX+viewWidth>=elemOffsetX&&(xVisible=!0),xVisible&&yVisible}function checkImage(){Object.keys(elements).forEach(function(key){var obj=elements[key],iElement=obj.iElement,$scope=obj.$scope;isVisible(iElement)&&iElement.attr("src",$scope.lazySrc)})}function onLoad(){var $el=angular.element(this),uid=getUid($el);$el.css("opacity",1),elements.hasOwnProperty(uid)&&delete elements[uid]}var doc=$document[0],body=doc.body,win=$window,$win=angular.element(win),uid=0,elements={};return $win.bind("scroll",checkImage),$win.bind("resize",checkImage),{restrict:"A",scope:{lazySrc:"@"},link:function($scope,iElement){iElement.bind("load",onLoad),$scope.$watch("lazySrc",function(){if(isVisible(iElement))iElement.attr("src")||iElement.attr("src",$scope.lazySrc);else{var uid=getUid(iElement);iElement.css({"background-color":"#fff",opacity:0,"-webkit-transition":"opacity 1s",transition:"opacity 1s"}),elements[uid]={iElement:iElement,$scope:$scope}}}),$scope.$on("$destroy",function(){iElement.unbind("load")})}}}]),function(window,angular){angular.module("module.filters",[]).filter("thumb",function(){return function(input,type){if(input=input||"",input.indexOf("/s/")>=0||input.indexOf("/m/")>=0)return input;var thumb_type="s";return"m"==type&&(thumb_type="m"),input.indexOf("avatar/")>=0?input.replace("/avatar/","/avatar/"+thumb_type+"/"):input.indexOf("/images/")>=0?input.replace("/images/","/images/"+thumb_type+"/"):input}})}(window,window.angular),function(window,angular){angular.module("module.directives",[]).directive("fallbackSrc",function(){var fallbackSrc={link:function(scope,iElement,iAttrs){iElement.bind("error",function(){var oldSrc=angular.element(this).attr("src");oldSrc!=iAttrs.fallbackSrc&&angular.element(this).attr("src",iAttrs.fallbackSrc)})}};return fallbackSrc}).directive("stringToNumber",function(){return{require:"ngModel",link:function(scope,element,attrs,ngModel){ngModel.$parsers.push(function(value){return""+value}),ngModel.$formatters.push(function(value){return parseFloat(value)})}}})}(window,window.angular),function(window,angular){function Utils(){function isMobileValid(mobile){return/^1\d{10}$/.test(mobile)}function isBlank(str){return!str||/^\s*$/.test(str)}function isNumber(n){return!isNaN(n)}function toPercent(value){return Math.min(Math.round(1e4*value)/100,100)}return{isBlank:isBlank,isMobileValid:isMobileValid,isNumber:isNumber,toPercent:toPercent}}angular.module("module.services",[]).service("Utils",Utils)}(window,window.angular),function(window,angular){function configCompileProvider($compileProvider){$compileProvider.imgSrcSanitizationWhitelist(/^\s*(https|file|blob|cdvfile|http|chrome-extension|blob:chrome-extension):|data:image\//)}function configHttpProvider($httpProvider){$httpProvider.defaults.headers.common["Content-Type"]="application/json",$httpProvider.defaults.headers.post["Content-Type"]="application/json"}function extendLog($provide){$provide.decorator("$log",function($delegate,$injector){var _log=$delegate.log,_warn=$delegate.warn,_info=$delegate.info,_debug=$delegate.debug,_error=$delegate.error,addMessage=function(message,forceLog){var $rootScope=$injector.get("$rootScope");return $rootScope.config=$rootScope.config||{logMode:!1},($rootScope.config.logMode||forceLog)&&($rootScope.messages=$rootScope.messages||[],$rootScope.messages.push(message)),message};return $delegate.log=function(msg,forceLog){return _log(addMessage(msg,forceLog||!1)),this},$delegate.warn=function(msg,forceLog){return _warn(addMessage(msg,forceLog||!1)),this},$delegate.info=function(msg,forceLog){return _info(addMessage(msg,forceLog||!1)),this},$delegate.debug=function(msg,forceLog){return _debug(addMessage(msg,forceLog||!1)),this},$delegate.error=function(msg,forceLog){return _error(addMessage(msg,forceLog||!1)),this},$delegate})}function initApp($rootScope){$rootScope._=_,$rootScope.loadingPage=!0}var app=angular.module("weshares",["infinite-scroll","module.services","module.filters","module.directives","me-lazyload"]).constant("_",window._).config(configCompileProvider).config(configHttpProvider).config(extendLog).config(["$sceDelegateProvider",function($sceDelegateProvider){$sceDelegateProvider.resourceUrlWhitelist(["self",PYS.staticFilePath+"/**"])}]).run(initApp);app.factory("CoreReactorChannel",function($rootScope){var elevatedEvent=function(event,data){$rootScope.$broadcast(event,data)},onElevatedEvent=function($scope,event,handler){$scope.$on(event,function(e,data){handler(data)})};return{elevatedEvent:elevatedEvent,onElevatedEvent:onElevatedEvent}}),app.factory("ShareOrder",function($http,$templateCache){function merge_options(obj1,obj2){var obj3={};for(var attrname in obj1)obj3[attrname]=obj1[attrname];for(var attrname in obj2)obj3[attrname]=obj2[attrname];return obj3}var ShareOrder=function(){this.orders=[],this.order_cart_map={},this.rebate_logs={},this.users={},this.levelData={},this.shareId=0,this.busy=!1,this.noMore=!1,this.page=1,this.pageInfo={},this.orderComments={},this.orderCommentReplies={},this.combineComment=1};return ShareOrder.prototype.nextPage=function(){if(!this.busy&&!this.noMore){this.page>this.pageInfo.page_count&&(this.noMore=!0),this.busy=!0;var url="/weshares/get_share_order_by_page/"+this.shareId+"/"+this.page+".json?combineComment="+this.combineComment;$http({method:"GET",url:url,cache:$templateCache}).success(function(data,status){this.busy=!1,this.orders=this.orders.concat(data.orders),this.order_cart_map=merge_options(this.order_cart_map,data.order_cart_map),this.rebate_logs=merge_options(this.rebate_logs,data.rebate_logs),this.users=merge_options(this.users,data.users),this.levelData=merge_options(this.levelData,data.level_data),data.page_info&&(this.pageInfo=data.page_info),data.comment_data&&(this.orderComments=merge_options(this.orderComments,data.comment_data.order_comments),this.orderCommentReplies=merge_options(this.orderCommentReplies,data.comment_data.comment_replies)),this.page=this.page+1}.bind(this)).error(function(data,status){})}},ShareOrder}),app.constant("staticFilePath",PYS.staticFilePath),app.constant("shipTypes",{101:"申通",102:"圆通",103:"韵达",104:"顺丰",105:"EMS",106:"邮政包裹",107:"天天",108:"汇通",109:"中通",110:"全一",111:"宅急送",112:"全峰",113:"快捷",115:"城际快递",132:"优速",133:"增益快递",134:"万家康",135:"京东快递",136:"德邦快递",137:"自提",138:"百富达",139:"黑狗",140:"E快送",141:"国通快递",142:"人人快递",143:"百世汇通"}),app.filter("unsafe",function($sce){return function(val){return $sce.trustAsHtml(val)}}),app.directive("readMore",function(){return{restrict:"A",transclude:!0,replace:!0,scope:{moreText:"@",lessText:"@",words:"@",ellipsis:"@","char":"@",limit:"@",content:"@"},link:function(scope,elem,attr,ctrl,transclude){function readmore(text){var text=text,orig=text,regex=/\s+/gi,charCount=text.length,wordCount=text.trim().replace(regex," ").split(" ").length,countBy="char",count=charCount,foundWords=[],markup=text,more="";angular.isUndefined(attr.words)||(countBy="words",count=wordCount),"words"===countBy?(foundWords=text.split(/\s+/),foundWords.length>limit&&(text=foundWords.slice(0,limit).join(" ")+ellipsis,more=foundWords.slice(limit,count).join(" "),markup='<div class="less-text">'+text+moreText+'</div><div class="more-text">'+orig+lessText+"</div>")):count>limit&&(text=orig.slice(0,limit)+ellipsis,text=text.replace(/<\/?[^>]+(>|$)/g,""),more=orig.slice(limit,count),markup='<div class="less-text">'+text+moreText+'</div><div class="more-text">'+orig+lessText+"</div>"),elem.append(markup),angular.element(document.getElementsByClassName("read-more")[0]).bind("click",function(){document.getElementsByClassName("less-text")[0].style.display="none",document.getElementsByClassName("read-more")[0].style.display="none",document.getElementsByClassName("more-text")[0].style.display="block",document.getElementsByClassName("read-less")[0].style.display="block",videoIFrame=document.getElementById("video"),videoIFrame&&(video.style.dislay="block")}),angular.element(document.getElementsByClassName("read-less")[0]).bind("click",function(){document.getElementsByClassName("less-text")[0].style.display="block",document.getElementsByClassName("read-more")[0].style.display="block",document.getElementsByClassName("more-text")[0].style.display="none",document.getElementsByClassName("read-less")[0].style.display="none",videoIFrame=document.getElementById("video"),videoIFrame&&(video.style.dislay="none")})}var moreText=angular.isUndefined(scope.moreText)?' <a class="read-more">Read More...</a>':' <a class="read-more">'+scope.moreText+"</a>",lessText=angular.isUndefined(scope.lessText)?' <a class="read-less">Less ^</a>':' <a class="read-less">'+scope.lessText+"</a>",ellipsis=angular.isUndefined(scope.ellipsis)?"":scope.ellipsis,limit=angular.isUndefined(scope.limit)?150:scope.limit;attr.$observe("content",function(str){readmore(str)}),transclude(scope.$parent,function(clone,scope){readmore(clone.text().trim())})}}})}(window,window.angular),function(window,angular,wx){function TutorialBindingCardCtrl($scope,$rootScope,$log,$http,$interval,Utils,staticFilePath){function activate(){vm.payment={type:0,account:"",full_name:"",card_name:""},vm.zhifubao={account:"",full_name:""},vm.bank={account:"",full_name:"",card_name:""}}function bindCard(){vm.binding||(vm.binding=!0,0==vm.payment.type?(vm.payment.account=vm.zhifubao.account,vm.payment.full_name=vm.zhifubao.full_name):(vm.payment.account=vm.bank.account,vm.payment.full_name=vm.bank.full_name,vm.payment.card_name=vm.bank.card_name),$log.log("Bind payment: ").log(vm.payment),$http.post().success(function(){vm.binding=!1}).error(function(data){vm.binding=!1}))}function canBindCard(){return 0==vm.payment.type?!_.isEmpty(vm.zhifubao.account)&&!_.isEmpty(vm.zhifubao.full_name):!_.isEmpty(vm.bank.account)&&!_.isEmpty(vm.bank.full_name)&&!_.isEmpty(vm.bank.card_name)}function onAccountChanged(){$http.get("/get_bank_info/"+vm.bank.account).success(function(data){data.validated&&(vm.bank.card_name=data.card_name)}).error(function(){})}var vm=this;vm.staticFilePath=staticFilePath,vm.canBindCard=canBindCard,vm.bindCard=bindCard,vm.onAccountChanged=onAccountChanged,activate()}angular.module("weshares").constant("wx",wx).controller("TutorialBindingCardCtrl",TutorialBindingCardCtrl)}(window,window.angular,window.wx),function(window,angular,wx){function TutorialBindingMobileCtrl($scope,$rootScope,$log,$http,$interval,Utils,staticFilePath){function activate(){vm.mobilePhone={value:"",valid:!0},vm.code={value:"",sent:!1,timer:null,timeSpent:60}}function validateMobilePhone(){var valid=Utils.isMobileValid(vm.mobilePhone.value);return valid&&!vm.mobilePhone.valid&&(vm.mobilePhone.valid=!0),valid}function validateMobilePhoneAndAlert(){vm.mobilePhone.valid=vm.validateMobilePhone()}function getSendCodeText(){return vm.code.sent?"已发送("+vm.code.timeSpent+"s)":"获取验证码"}function canSendCode(){return Utils.isMobileValid(vm.mobilePhone.value)&&!_.isEmpty(vm.mobilePhone.value)&&!vm.code.sent}function sendCode(){vm.canSendCode()&&(vm.code.sending=!0,$http.post("/check/get_message_code",{mobile:mobile}).success(function(data){vm.code.timer=$interval(function(){vm.code.timeSpent=Math.max(0,vm.code.timeSpent-1),vm.code.timeSpent<=0&&(vm.code.sent=!1,vm.code.timeSpent=60,_.isEmpty(vm.code.timer)||($interval.cancel(vm.code.timer),vm.code.timer=null))},1e3)}).error(function(){vm.code.sending=!1}))}function canBindMobile(){return Utils.isMobileValid(vm.mobilePhone.value)&&!_.isEmpty(vm.mobilePhone.value)&&!_.isEmpty(vm.code.value)}function bindMobile(){vm.canBindMobile()&&(vm.binding=!0,$http.post("/users/mobile_bind",{mobile:vm.mobilePhone.value,code:vm.code.value,from:""}).success(function(data){vm.binding=!1,window.location.href="/users/complete_user_info"}).error(function(data){vm.binding=!1}))}function bindCard(){}function canBindCard(){}var vm=this;vm.staticFilePath=staticFilePath,vm.canSendCode=canSendCode,vm.sendCode=sendCode,vm.getSendCodeText=getSendCodeText,vm.validateMobilePhone=validateMobilePhone,vm.validateMobilePhoneAndAlert=validateMobilePhoneAndAlert,vm.canBindMobile=canBindMobile,vm.bindMobile=bindMobile,vm.canBindCard=canBindCard,vm.bindCard=bindCard,activate()}angular.module("weshares").constant("wx",wx).controller("TutorialBindingMobileCtrl",TutorialBindingMobileCtrl)}(window,window.angular,window.wx);