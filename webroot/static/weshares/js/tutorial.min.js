!function(window,angular,wx){function TutorialBindingCardCtrl($scope,$rootScope,$log,$http,$interval,Utils){function activate(){$rootScope.loadingPage=!1,vm.payment={type:0,account:"",full_name:"",card_name:""},vm.zhifubao={account:"",full_name:""},vm.bank={account:"",full_name:"",card_name:"",account_valid:!0}}function validateBankAccount(){var valid=/^\d{16,20}$/.test(vm.bank.account);return valid&&!vm.bank.account_valid&&(vm.bank.account_valid=!0),valid}function onAccountChanged(){vm.bank.account_valid=vm.validateBankAccount(),!vm.bank.account_valid,$http.get("/payapi/get_bank_info/"+vm.bank.account).success(function(data){data.validated&&(vm.bank.card_name=data.card_name)}).error(function(){})}function bindCard(){vm.binding||(vm.binding=!0,0==vm.payment.type?(vm.payment.account=vm.zhifubao.account,vm.payment.full_name=vm.zhifubao.full_name):(vm.payment.account=vm.bank.account,vm.payment.full_name=vm.bank.full_name,vm.payment.card_name=vm.bank.card_name),$log.log("Bind payment: ").log(vm.payment),$http.post("/users/complete",vm.payment).success(function(){vm.binding=!1,window.location.href="/weshares/add"}).error(function(data){vm.binding=!1}))}function canBindCard(){return 0==vm.payment.type?!_.isEmpty(vm.zhifubao.account)&&!_.isEmpty(vm.zhifubao.full_name):!_.isEmpty(vm.bank.account)&&!_.isEmpty(vm.bank.full_name)&&!_.isEmpty(vm.bank.card_name)&&vm.bank.account_valid}function onError(message){$rootScope.showErrorMessageLayer=!0,$rootScope.errorMessage=message,$timeout(function(){$rootScope.showErrorMessageLayer=!1},2e3)}var vm=this;vm.staticFilePath=Utils.staticFilePath(),vm.canBindCard=canBindCard,vm.bindCard=bindCard,vm.onAccountChanged=onAccountChanged,vm.validateBankAccount=validateBankAccount,vm.onError=onError,vm.goBack=function(){window.history.back()},activate()}angular.module("weshares").constant("wx",wx).controller("TutorialBindingCardCtrl",TutorialBindingCardCtrl)}(window,window.angular,window.wx),function(window,angular,wx){function TutorialBindingMobileCtrl($scope,$rootScope,$log,$http,$interval,$timeout,Utils,CoreReactorChannel){function activate(){$rootScope.loadingPage=!1,vm.mobilePhone={value:"",valid:!0},vm.code={value:"",sent:!1,timer:null,timeSpent:60,valid:!0,sending:!1},CoreReactorChannel.onElevatedEvent($scope,"BindMobile",function(){return vm.userBindMobileSuccess?void(window.location.href="/scores/detail.html"):(vm.showBindMobileDialog=!0,void(vm.showMaskLayer=!0))})}function hideAllLayer(){vm.showBindMobileDialog=!1,vm.showMaskLayer=!1,vm.showBindSuccess=!1}function validateMobilePhone(){return vm.mobilePhone.valid=Utils.isMobileValid(vm.mobilePhone.value),vm.mobilePhone.valid}function validateMobilePhoneAndAlert(){vm.mobilePhone.valid=vm.validateMobilePhone()}function getSendCodeText(){return vm.code.sent?"已发送("+vm.code.timeSpent+"s)":"获取验证码"}function canSendCode(){return Utils.isMobileValid(vm.mobilePhone.value)&&!_.isEmpty(vm.mobilePhone.value)&&!vm.code.sent}function sendCode(){vm.canSendCode()&&(vm.code.sending||(vm.code.sending=!0,$http.post("/check/get_mobile_code?mobile="+vm.mobilePhone.value).success(function(data){return data.error&&"not login"==data.msg?void(window.location.href="/users/login"):(vm.code.sent=!0,vm.code.timer=$interval(function(){vm.code.timeSpent=Math.max(0,vm.code.timeSpent-1),vm.code.timeSpent<=0&&(vm.code.sent=!1,vm.code.timeSpent=60,_.isEmpty(vm.code.timer)||($interval.cancel(vm.code.timer),vm.code.timer=null))},1e3),void(vm.code.sending=!1))}).error(function(data){vm.code.sending=!1,$log.log("Failed to get mobile code: ").log(data)})))}function canBindMobile(){return Utils.isMobileValid(vm.mobilePhone.value)&&!_.isEmpty(vm.mobilePhone.value)&&!_.isEmpty(vm.code.value)}function bindAndMerge(){vm.validateMobilePhone()&&vm.onCodeChanged()&&vm.canBindMobile()&&(vm.binding=!0,$http.post("/users/wx_user_bind_mobile",{code:vm.code.value,mobile:vm.mobilePhone.value}).success(function(data){$log.log(data),vm.binding=!1,data.success?(vm.userBindMobileSuccess=!0,vm.showBindSuccess=!0,vm.showBindMobileDialog=!1):("code_error"==data.reason&&alert("验证码有误"),"mobile_error"==data.reason&&alert("手机号码有误"),"system_error"==data.reason&&(alert("绑定失败，请联系客服！"),vm.hideAllLayer()))}).error(function(data){vm.binding=!1}))}function bindMobile(){vm.canBindMobile()&&(vm.binding=!0,$http.post("/users/mobile_bind",{mobile:vm.mobilePhone.value,code:vm.code.value}).success(function(data){return vm.binding=!1,data.success?void(window.location.href="/users/complete_user_info"):"user_not_login"==data.msg?(vm.onError("未登录，请登陆后再操作"),void(window.location.href="/users/login")):"mobile_phone_duplicate"==data.msg?(vm.onError("该手机号已经被注册,请联系管理员"),void(vm.mobilePhone.valid=!1)):"code_invalid"==data.msg?(vm.onError("验证码错误，请重新输入"),void(vm.code.valid=!1)):"mobile_phone_invalid"==data.msg?(vm.onError("手机号错误，请联系管理员"),void(vm.mobilePhone.valid=!1)):(vm.onError("系统错误，请联系管理员"),void(vm.code.valid=!1))}).error(function(data){vm.onError("系统错误，请联系管理员"),vm.code.valid=!1,vm.binding=!1}))}function onCodeChanged(){return vm.code.valid=!_.isEmpty(vm.code.value),vm.code.valid}function onError(message){$rootScope.showErrorMessageLayer=!0,$rootScope.errorMessage=message,$timeout(function(){$rootScope.showErrorMessageLayer=!1},2e3)}var vm=this;vm.staticFilePath=Utils.staticFilePath(),vm.canSendCode=canSendCode,vm.sendCode=sendCode,vm.getSendCodeText=getSendCodeText,vm.validateMobilePhone=validateMobilePhone,vm.validateMobilePhoneAndAlert=validateMobilePhoneAndAlert,vm.canBindMobile=canBindMobile,vm.bindMobile=bindMobile,vm.onCodeChanged=onCodeChanged,vm.onError=onError,vm.bindAndMerge=bindAndMerge,vm.hideAllLayer=hideAllLayer,vm.showBindMobileDialog=!1,vm.showBindSuccess=!1,vm.showMaskLayer=!1,vm.userBindMobileSuccess=!1,vm.goBack=function(){window.history.back()},activate()}angular.module("weshares").constant("wx",wx).controller("TutorialBindingMobileCtrl",TutorialBindingMobileCtrl)}(window,window.angular,window.wx);