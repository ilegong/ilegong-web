!function(window,angular){function unsafe($sce){return function(val){return $sce.trustAsHtml(val)}}function thumb(){return function(input,type){if(input=input||"",input.indexOf("/s/")>=0||input.indexOf("/m/")>=0)return input;var thumb_type="s";return"m"==type&&(thumb_type="m"),input.indexOf("avatar/")>=0?input.replace("/avatar/","/avatar/"+thumb_type+"/"):input.indexOf("/images/")>=0?input.replace("/images/","/images/"+thumb_type+"/"):input}}angular.module("module.filters",[]).filter("unsafe",unsafe).filter("thumb",thumb)}(window,window.angular),function(window,angular){function fallbackSrc(){return{link:function(scope,iElement,iAttrs){iElement.bind("error",function(){var oldSrc=angular.element(this).attr("src");oldSrc!=iAttrs.fallbackSrc&&angular.element(this).attr("src",iAttrs.fallbackSrc)})}}}function stringToNumber(){return{require:"ngModel",link:function(scope,element,attrs,ngModel){ngModel.$parsers.push(function(value){return value?""+value:""}),ngModel.$formatters.push(function(value){return value?parseFloat(value):null})}}}function lazySrc($window,$document){function getUid(el){return el.__uid||(el.__uid=""+ ++uid)}function getWindowOffset(){var t,pageXOffset="number"==typeof win.pageXOffset?win.pageXOffset:(((t=doc.documentElement)||(t=body.parentNode))&&"number"==typeof t.ScrollLeft?t:body).ScrollLeft,pageYOffset="number"==typeof win.pageYOffset?win.pageYOffset:(((t=doc.documentElement)||(t=body.parentNode))&&"number"==typeof t.ScrollTop?t:body).ScrollTop;return{offsetX:pageXOffset,offsetY:pageYOffset}}function isVisible(iElement){var xVisible,yVisible,elem=iElement[0],elemRect=elem.getBoundingClientRect(),windowOffset=getWindowOffset(),winOffsetX=windowOffset.offsetX,winOffsetY=windowOffset.offsetY,elemWidth=elemRect.width,elemHeight=elemRect.height,elemOffsetX=elemRect.left+winOffsetX,elemOffsetY=elemRect.top+winOffsetY,viewWidth=Math.max(doc.documentElement.clientWidth,win.innerWidth||0),viewHeight=Math.max(doc.documentElement.clientHeight,win.innerHeight||0);return"none"==elem.style.display?!1:(winOffsetY>=elemOffsetY?elemOffsetY+elemHeight>=winOffsetY&&(yVisible=!0):elemOffsetY>=winOffsetY&&winOffsetY+viewHeight>=elemOffsetY&&(yVisible=!0),winOffsetX>=elemOffsetX?elemOffsetX+elemWidth>=winOffsetX&&(xVisible=!0):elemOffsetX>=winOffsetX&&winOffsetX+viewWidth>=elemOffsetX&&(xVisible=!0),xVisible&&yVisible)}function checkImage(){Object.keys(elements).forEach(function(key){var obj=elements[key],iElement=obj.iElement,$scope=obj.$scope;isVisible(iElement)&&iElement.attr("src",$scope.lazySrc)})}function onLoad(){var $el=angular.element(this),uid=getUid($el);$el.css("opacity",1),elements.hasOwnProperty(uid)&&delete elements[uid]}var doc=$document[0],body=doc.body,win=$window,$win=angular.element(win),uid=0,elements={};return $win.bind("scroll",checkImage),$win.bind("resize",checkImage),{restrict:"A",scope:{lazySrc:"@"},link:function($scope,iElement){iElement.bind("load",onLoad),$scope.$watch("lazySrc",function(){if(isVisible(iElement))iElement.attr("src")||iElement.attr("src",$scope.lazySrc);else{var uid=getUid(iElement);iElement.css({"background-color":"#fff",opacity:0,"-webkit-transition":"opacity 1s",transition:"opacity 1s"}),elements[uid]={iElement:iElement,$scope:$scope}}}),$scope.$on("$destroy",function(){iElement.unbind("load")})}}}function readMore(){return{restrict:"A",transclude:!0,replace:!0,scope:{moreText:"@",lessText:"@",words:"@",ellipsis:"@","char":"@",limit:"@",content:"@"},link:function(scope,elem,attr,ctrl,transclude){function readmore(text){var text=text,orig=text,regex=/\s+/gi,charCount=text.length,wordCount=text.trim().replace(regex," ").split(" ").length,countBy="char",count=charCount,foundWords=[],markup=text,more="";angular.isUndefined(attr.words)||(countBy="words",count=wordCount),"words"===countBy?(foundWords=text.split(/\s+/),foundWords.length>limit&&(text=foundWords.slice(0,limit).join(" ")+ellipsis,more=foundWords.slice(limit,count).join(" "),markup='<div class="less-text">'+text+moreText+'</div><div class="more-text">'+orig+lessText+"</div>")):count>limit&&(text=orig.slice(0,limit)+ellipsis,text=text.replace(/<\/?[^>]+(>|$)/g,""),more=orig.slice(limit,count),markup='<div class="less-text">'+text+moreText+'</div><div class="more-text">'+orig+lessText+"</div>"),elem.append(markup),angular.element(document.getElementsByClassName("read-more")[0]).bind("click",function(){document.getElementsByClassName("less-text")[0].style.display="none",document.getElementsByClassName("read-more")[0].style.display="none",document.getElementsByClassName("more-text")[0].style.display="block",document.getElementsByClassName("read-less")[0].style.display="block",videoIFrame=document.getElementById("video"),videoIFrame&&(video.style.dislay="block")}),angular.element(document.getElementsByClassName("read-less")[0]).bind("click",function(){document.getElementsByClassName("less-text")[0].style.display="block",document.getElementsByClassName("read-more")[0].style.display="block",document.getElementsByClassName("more-text")[0].style.display="none",document.getElementsByClassName("read-less")[0].style.display="none",videoIFrame=document.getElementById("video"),videoIFrame&&(video.style.dislay="none")})}var moreText=angular.isUndefined(scope.moreText)?' <a class="read-more">Read More...</a>':' <a class="read-more">'+scope.moreText+"</a>",lessText=angular.isUndefined(scope.lessText)?' <a class="read-less">Less ^</a>':' <a class="read-less">'+scope.lessText+"</a>",ellipsis=angular.isUndefined(scope.ellipsis)?"":scope.ellipsis,limit=angular.isUndefined(scope.limit)?150:scope.limit;attr.$observe("content",function(str){readmore(str)}),transclude(scope.$parent,function(clone,scope){readmore(clone.text().trim())})}}}angular.module("module.directives",[]).directive("fallbackSrc",fallbackSrc).directive("stringToNumber",stringToNumber).directive("readMore",readMore).directive("lazySrc",["$window","$document",lazySrc])}(window,window.angular),function(window,angular){function Utils($location,$log){function isMobileValid(mobile){return/^1\d{10}$/.test(mobile)}function isBlank(str){return!str||/^\s*$/.test(str)}function isNumber(n){return!isNaN(n)}function toPercent(value){return Math.min(Math.round(1e4*value)/100,100)}function removeEmoji(str){return str.replace(/([\uE000-\uF8FF]|\uD83C[\uDF00-\uDFFF]|\uD83D[\uDC00-\uDDFF])/g,"")}function shipTypes(){return{101:"申通",102:"圆通",103:"韵达",104:"顺丰",105:"EMS",106:"邮政包裹",107:"天天",108:"汇通",109:"中通",110:"全一",111:"宅急送",112:"全峰",113:"快捷",115:"城际快递",132:"优速",133:"增益快递",134:"万家康",135:"京东快递",136:"德邦快递",137:"自提",138:"百富达",139:"黑狗",140:"E快送",141:"国通快递",142:"人人快递",143:"百世汇通"}}function staticFilePath(){if(""!=staticHost)return staticHost;var host=$location.host();return staticHost="www.tongshijia.com"==host?"http://static.tongshijia.com":"preprod.tongshijia.com"==host?"http://static-preprod.tongshijia.com":"sh.tongshijia.com"==host?"http://static-sh.tongshijia.com":"test.tongshijia.com"==host?"http://static-test.tongshijia.com":"http://dev.tongshijia.com"}function isWeixin(){var ua=navigator.userAgent.toLowerCase();return"micromessenger"==ua.match(/MicroMessenger/i)}var staticHost="",Storage={save:function(key,jsonData,expirationHour){var expirationMS=60*expirationHour*60*1e3,record={value:JSON.stringify(jsonData),timestamp:(new Date).getTime()+expirationMS};return localStorage.setItem(key,JSON.stringify(record)),jsonData},load:function(key){var record=JSON.parse(localStorage.getItem(key));return record?(new Date).getTime()<record.timestamp&&JSON.parse(record.value):!1},clear:function(){localStorage.clear()}};return{isBlank:isBlank,isMobileValid:isMobileValid,isNumber:isNumber,toPercent:toPercent,removeEmoji:removeEmoji,staticFilePath:staticFilePath,shipTypes:shipTypes,isWeixin:isWeixin,Storage:Storage}}function CoreReactorChannel($rootScope){var elevatedEvent=function(event,data){$rootScope.$broadcast(event,data)},onElevatedEvent=function($scope,event,handler){$scope.$on(event,function(e,data){handler(data)})};return{elevatedEvent:elevatedEvent,onElevatedEvent:onElevatedEvent}}function ShareOrder($http,$templateCache){function merge_options(obj1,obj2){var obj3={};for(var attrname in obj1)obj3[attrname]=obj1[attrname];for(var attrname in obj2)obj3[attrname]=obj2[attrname];return obj3}var ShareOrder=function(){this.orders=[],this.order_cart_map={},this.rebate_logs={},this.users={},this.levelData={},this.shareId=0,this.busy=!1,this.noMore=!1,this.page=1,this.pageInfo={},this.orderComments={},this.orderCommentReplies={},this.combineComment=1};return ShareOrder.prototype.nextPage=function(){if(!this.busy&&!this.noMore){this.page>this.pageInfo.page_count&&(this.noMore=!0),this.busy=!0;var url="/weshares/get_share_order_by_page/"+this.shareId+"/"+this.page+".json?combineComment="+this.combineComment;$http({method:"GET",url:url,cache:$templateCache}).success(function(data,status){this.busy=!1,this.orders=this.orders.concat(data.orders),this.order_cart_map=merge_options(this.order_cart_map,data.order_cart_map),this.rebate_logs=merge_options(this.rebate_logs,data.rebate_logs),this.users=merge_options(this.users,data.users),this.levelData=merge_options(this.levelData,data.level_data),data.page_info&&(this.pageInfo=data.page_info),data.comment_data&&(this.orderComments=merge_options(this.orderComments,data.comment_data.order_comments),this.orderCommentReplies=merge_options(this.orderCommentReplies,data.comment_data.comment_replies)),this.page=this.page+1}.bind(this)).error(function(data,status){})}},ShareOrder}function Locations($http,$templateCache){function loadCityData(provinceId){$http({method:"GET",url:"/locations/get_city.json?provinceId="+provinceId,cache:$templateCache}).success(function(data){me.cityData=data}).error(function(data,status){})}function loadCountyData(cityId){$http({method:"GET",url:"/locations/get_county.json?cityId="+cityId,cache:$templateCache}).success(function(data){me.countyData=data}).error(function(data,status){})}var me=this;return me.provinceData=[{id:"110100",name:"北京",parent_id:"2"},{id:"120100",name:"天津",parent_id:"2"},{id:"130000",name:"河北",parent_id:"2"},{id:"140000",name:"山西",parent_id:"2"},{id:"150000",name:"内蒙古",parent_id:"2"},{id:"210000",name:"辽宁",parent_id:"5"},{id:"220000",name:"吉林",parent_id:"5"},{id:"230000",name:"黑龙江",parent_id:"5"},{id:"310100",name:"上海",parent_id:"1"},{id:"320000",name:"江苏",parent_id:"1"},{id:"330000",name:"浙江",parent_id:"1"},{id:"340000",name:"安徽",parent_id:"1"},{id:"350000",name:"福建",parent_id:"4"},{id:"360000",name:"江西",parent_id:"1"},{id:"370000",name:"山东",parent_id:"2"},{id:"410000",name:"河南",parent_id:"3"},{id:"420000",name:"湖北",parent_id:"3"},{id:"430000",name:"湖南",parent_id:"3"},{id:"440000",name:"广东",parent_id:"4"},{id:"450000",name:"广西",parent_id:"4"},{id:"460000",name:"海南",parent_id:"4"},{id:"500100",name:"重庆",parent_id:"7"},{id:"510000",name:"四川",parent_id:"7"},{id:"520000",name:"贵州",parent_id:"7"},{id:"530000",name:"云南",parent_id:"7"},{id:"540000",name:"西藏",parent_id:"7"},{id:"610000",name:"陕西",parent_id:"6"},{id:"620000",name:"甘肃",parent_id:"6"},{id:"630000",name:"青海",parent_id:"6"},{id:"640000",name:"宁夏",parent_id:"6"},{id:"650000",name:"新疆",parent_id:"6"},{id:"710000",name:"台湾",parent_id:"8"},{id:"810000",name:"香港",parent_id:"8"},{id:"820000",name:"澳门",parent_id:"8"}],{provinceData:this.provinceData,cityData:this.cityData,countyData:this.countyData,loadCityData:loadCityData,loadCountyData:loadCountyData}}function PoolProductInfo($http,$log,$templateCache){return{prepareProductInfo:function(weshareId,callBackFunc){$http({method:"GET",url:"/share_product_pool/get_share_product_detail/"+weshareId+".json",cache:$templateCache}).success(function(data){callBackFunc(data)}).error(function(){$log.log("get share product info error"),$rootScope.loadingPage=!1})}}}function OfflineStore(){function ChooseOfflineStore($vm,$http,$templateCache){function showChooseOfflineStore(){changeOfflineStoreArea($vm.currentAreaCode),$vm.showOfflineStoreDetailView=!1,$vm.chooseOfflineStoreView=!0,$vm.showShareDetailView=!1,$vm.showBalanceView=!1}function chooseOfflineStore(offlineStore){$vm.showOfflineStoreDetailView=!1,$vm.chooseOfflineStoreView=!1,$vm.showShareDetailView=!1,$vm.showBalanceView=!0,$vm.checkedOfflineStore=offlineStore}function showOfflineStoreDetail(offlineStore){if(!offlineStore.mapImg){var pointStr=offlineStore.location_long+","+offlineStore.location_lat,reversePointStr=offlineStore.location_lat+","+offlineStore.location_long,pointName=offlineStore.alias;offlineStore.mapImg="http://api.map.baidu.com/staticimage?width=400&height=200&center="+pointStr+"&markers="+pointName+"|"+pointStr+"&zoom=18&markerStyles=l,A,0xff0000",offlineStore.mapDetailUrl="http://api.map.baidu.com/marker?location="+reversePointStr+"&title="+pointName+"&content="+pointName+"&output=html"}$vm.currentOfflineStore=offlineStore,$vm.showOfflineStoreDetailView=!0,$vm.chooseOfflineStoreView=!1,$vm.showShareDetailView=!1,$vm.showBalanceView=!1}function changeOfflineStoreArea(code){$vm.currentAreaCode=code,$http({method:"GET",url:"/commonApi/get_offline_store/"+code+".json",cache:$templateCache}).success(function(data){$vm.offlineStores[code]=data}).error(function(){})}$vm.areas={110101:{name:"东城区"},110108:{name:"海淀区"},110102:{name:"西城区"},110105:{name:"朝阳区"},110106:{name:"丰台区"},110114:{name:"昌平区"},110113:{name:"顺义区"},110115:{name:"大兴区"},110112:{name:"通州区"}},$vm.currentAreaCode="110101",$vm.offlineStores={},$vm.changeOfflineStoreArea=changeOfflineStoreArea,$vm.showOfflineStoreDetail=showOfflineStoreDetail,$vm.chooseOfflineStore=chooseOfflineStore,$vm.showChooseOfflineStore=showChooseOfflineStore}return{ChooseOfflineStore:ChooseOfflineStore}}angular.module("module.services",[]).service("Utils",Utils).service("CoreReactorChannel",CoreReactorChannel).service("Locations",Locations).service("PoolProductInfo",PoolProductInfo).service("OfflineStore",OfflineStore).service("ShareOrder",ShareOrder)}(window,window.angular),function(window,angular){function configCompileProvider($compileProvider){$compileProvider.imgSrcSanitizationWhitelist(/^\s*(https|file|blob|cdvfile|http|chrome-extension|blob:chrome-extension):|data:image\//)}function configHttpProvider($httpProvider){$httpProvider.defaults.headers.common["Content-Type"]="application/json",$httpProvider.defaults.headers.post["Content-Type"]="application/json"}function extendLog($provide){$provide.decorator("$log",function($delegate,$injector){var _log=$delegate.log;return $delegate.log=function(msg,forceLog){return _log(msg),this},$delegate})}function initApp($rootScope,$http){$rootScope._=_,$rootScope.loadingPage=!0,$rootScope.clickPage=function(){$rootScope.$broadcast("page_clicked",{})},$rootScope.checkHasUnRead=function(){},$rootScope.addPageClickLog=function(data){$http.post("/util/log_view_position_click.json",data).success(function(data){}).error(function(){})}}function DefaultCtrl($rootScope){$rootScope.loadingPage=!1,$rootScope.checkHasUnRead()}angular.module("weshares",["infinite-scroll","angular-carousel","module.services","module.filters","module.directives"]).constant("_",window._).config(configCompileProvider).config(configHttpProvider).config(extendLog).config(["$sceDelegateProvider",function($sceDelegateProvider){$sceDelegateProvider.resourceUrlWhitelist(["self","http://*.tongshijia.com/**"])}]).run(initApp).controller("DefaultCtrl",DefaultCtrl)}(window,window.angular),function(window,angular){function SubscriptionController($rootScope,$scope,$http,$window,$log){function activate(){sub.showUnSubscribeBtn=!1,$scope.$on("page_clicked",function(){sub.showUnSubscribeBtn=!1})}function isSubscribed(proxyId){return _.contains($rootScope.proxies,parseInt(proxyId))}function subscribe(proxyId){return $rootScope.uid<0?void($window.location.href="/users/login"):void(sub.subscribeInProcess||(sub.subscribeInProcess=!0,$http.get("/weshares/subscribe_sharer/"+proxyId+"/"+$rootScope.uid).success(function(data){data.success?$rootScope.proxies.push(parseInt(proxyId)):"not_sub"==data.reason&&(window.location.href=data.url),sub.subscribeInProcess=!1}).error(function(data,e){sub.subscribeInProcess=!1,$log.log("Failed to subscribe: "+e)})))}function unSubscribe(proxyId){return $rootScope.uid<0?void($window.location.href="/users/login"):void(sub.unSubscribeInProcess||(sub.unSubscribeInProcess=!0,$http.get("/weshares/unsubscribe_sharer/"+proxyId+"/"+$rootScope.uid).success(function(data){data.success&&($rootScope.proxies=_.reject($rootScope.proxies,function(proxy){return proxy==proxyId})),sub.unSubscribeInProcess=!1}).error(function(data,e){$log.log("Failed to get proxies: "+e),sub.unSubscribeInProcess=!1})))}function clickSubscribedBtn(proxyId,$event){sub.showUnSubscribeBtn=!0,$event.stopPropagation()}var sub=this;sub.isSubscribed=isSubscribed,sub.unSubscribe=unSubscribe,sub.subscribe=subscribe,sub.clickSubscribedBtn=clickSubscribedBtn,activate()}angular.module("weshares").controller("SubscriptionController",SubscriptionController)}(window,window.angular);