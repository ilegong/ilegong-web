!function(window,angular){function WesharesConsigneeCtrl($scope,CoreReactorChannel){function active(){vm.selectShipType=getSelectTypeDefaultVal(),wcc.availableShipTypes=Math.max(_.filter(["kuai_di","self_ziti","pys_ziti"],function(item){return vm.weshareSettings[item]&&1==vm.weshareSettings[item].status}).length,1),vm.shouldInitUserConsigneeData&&(initUserConsigneeData(),vm.calOrderTotalPrice(),vm.shouldInitUserConsigneeData=!1)}function changeShipTab(type){vm.selectShipType=type,vm.updateBuyerData(type)}function toEditConsigneeView(){vm.showBalanceView=!1,vm.showEditConsigneeView=!0,CoreReactorChannel.elevatedEvent("EditConsignee",{})}function initUserConsigneeData(){_.each(vm.consignee,function(item){0==item.type&&(vm.expressShipInfo=item),1==item.type&&(vm.pickUpShipInfo=item),2==item.type&&(vm.checkedOfflineStore=item.offlineStore,vm.offlineStoreShipInfo=item)}),vm.updateBuyerData(vm.selectShipType)}function getSelectTypeDefaultVal(){return vm.selectShipType?vm.selectShipType:vm.weshareSettings.kuai_di&&1==vm.weshareSettings.kuai_di.status?0:vm.weshareSettings.self_ziti&&1==vm.weshareSettings.self_ziti.status?(vm.shipFee=vm.weshareSettings.self_ziti.ship_fee,1):vm.weshareSettings.pys_ziti&&1==vm.weshareSettings.pys_ziti.status?(vm.shipFee=vm.weshareSettings.pys_ziti.ship_fee,2):-1}var wcc=this;wcc.changeShipTab=changeShipTab,wcc.toEditConsigneeView=toEditConsigneeView;var vm=$scope.$parent.vm;active()}angular.module("weshares").controller("WesharesConsigneeCtrl",WesharesConsigneeCtrl)}(window,window.angular),function(window,angular){function WesharesEditConsigneeCtrl($scope,$http,CoreReactorChannel,$templateCache,Utils){function active(){CoreReactorChannel.onElevatedEvent($scope,"EditConsignee",function(){vmc.showConsigneeListView()})}function showLoading(){vmc.loadingConsignee=!0,vmc.showLayerBg=!0}function closeLoading(){vmc.loadingConsignee=!1,vmc.showLayerBg=!1}function validConsignee(){return Utils.isMobileValid(vmc.editConsigneeData.mobilephone)?_.isEmpty(vmc.editConsigneeData.name)?(alert("请输入收货人"),!1):_.isEmpty(vmc.editConsigneeData.address)?(alert("请输入收货地址"),!1):_.isEmpty(vmc.editConsigneeData.province_id)||_.isEmpty(vmc.editConsigneeData.city_id)?(alert("请选择省市区"),!1):!0:(alert("请输入手机号码"),!1)}function saveConsignee(){return validConsignee()?(vmc.submiting=!0,showLoading(),void $http.post("/users/save_consignee.json",vmc.editConsigneeData).success(function(data){data.success&&(vm.reloadConsigneeData=!0,vm.expressShipInfo=data.consignee,vmc.toBalanceView(),vmc.submiting=!1,closeLoading())}).error(function(){vmc.submiting=!1,closeLoading(),alert("保存失败，请联系客服！")})):!1}function chooseConsignee(consignee){if(1==consignee.status)return void vmc.toBalanceView();var consigneeId=consignee.id;vmc.submiting=!0,showLoading(),$http({method:"GET",url:"/users/select_consignee/"+consigneeId+".json"}).success(function(data){if(vmc.submiting=!1,data.success){var consignees=_.map(vmc.consignees,function(item){return item.id==consigneeId?item.status=1:item.status=0,item});vmc.consignees=_.sortBy(consignees,function(item){return 1==item.status?0:1}),closeLoading(),vm.expressShipInfo=consignee,vmc.toBalanceView()}}).error(function(){vmc.submiting=!1,closeLoading(),alert("请重试！")})}function loadConsignees(){!vm.reloadConsigneeData&&vmc.consignees||(vm.reloadConsigneeData=!0,vmc.consignees=null,showLoading(),$http({method:"GET",url:"/users/get_consignee_list.json"}).success(function(data){var consignees=data.consignees;if(_.isEmpty(consignees))vmc.noConsignee=!0;else{var default_item=0;consignees.map(function(item){1==item.status&&default_item++}),default_item>1&&(consignees.map(function(item){item.status=0}),consignees[0].status=1),consignees=_.sortBy(consignees,function(item){return 1==item.status?0:1})}vmc.consignees=consignees,vm.reloadConsigneeData=!1,closeLoading()}).error(function(){closeLoading(),vm.reloadConsigneeData=!0}))}function toBalanceView(){vm.updateBuyerData(vm.selectShipType),vm.showBalanceView=!0,vmc.selectConsignees=!1,vmc.editConsignee=!1}function showConsigneeFormView(data){vmc.selectConsignees=!1,vmc.editConsignee=!0,vmc.editConsigneeData=null,data&&(vmc.editConsigneeData=data),initAreaData()}function initAreaData(){vmc.editConsigneeData&&(vmc.editConsigneeData.city_id&&vmc.loadCityData(vmc.editConsigneeData.province_id),vmc.editConsigneeData.county_id&&vmc.loadCountyData(vmc.editConsigneeData.city_id))}function showConsigneeListView(){loadConsignees(),vmc.selectConsignees=!0,vmc.editConsignee=!1}function initProvince(){vmc.provinceData=[{id:"110100",name:"北京",parent_id:"2"},{id:"120100",name:"天津",parent_id:"2"},{id:"130000",name:"河北",parent_id:"2"},{id:"140000",name:"山西",parent_id:"2"},{id:"150000",name:"内蒙古",parent_id:"2"},{id:"210000",name:"辽宁",parent_id:"5"},{id:"220000",name:"吉林",parent_id:"5"},{id:"230000",name:"黑龙江",parent_id:"5"},{id:"310100",name:"上海",parent_id:"1"},{id:"320000",name:"江苏",parent_id:"1"},{id:"330000",name:"浙江",parent_id:"1"},{id:"340000",name:"安徽",parent_id:"1"},{id:"350000",name:"福建",parent_id:"4"},{id:"360000",name:"江西",parent_id:"1"},{id:"370000",name:"山东",parent_id:"2"},{id:"410000",name:"河南",parent_id:"3"},{id:"420000",name:"湖北",parent_id:"3"},{id:"430000",name:"湖南",parent_id:"3"},{id:"440000",name:"广东",parent_id:"4"},{id:"450000",name:"广西",parent_id:"4"},{id:"460000",name:"海南",parent_id:"4"},{id:"500100",name:"重庆",parent_id:"7"},{id:"510000",name:"四川",parent_id:"7"},{id:"520000",name:"贵州",parent_id:"7"},{id:"530000",name:"云南",parent_id:"7"},{id:"540000",name:"西藏",parent_id:"7"},{id:"610000",name:"陕西",parent_id:"6"},{id:"620000",name:"甘肃",parent_id:"6"},{id:"630000",name:"青海",parent_id:"6"},{id:"640000",name:"宁夏",parent_id:"6"},{id:"650000",name:"新疆",parent_id:"6"},{id:"710000",name:"台湾",parent_id:"8"},{id:"810000",name:"香港",parent_id:"8"},{id:"820000",name:"澳门",parent_id:"8"}]}function loadCityData(provinceId){$http({method:"GET",url:"/locations/get_city.json?provinceId="+provinceId,cache:$templateCache}).success(function(data){vmc.cityData=data}).error(function(data,status){})}function loadCounty(cityId){$http({method:"GET",url:"/locations/get_county.json?cityId="+cityId,cache:$templateCache}).success(function(data){vmc.countyData=data}).error(function(data,status){})}var vmc=this;vmc.selectConsignees=!1,vmc.editConsignee=!1,vmc.showConsigneeFormView=showConsigneeFormView,vmc.showConsigneeListView=showConsigneeListView,vmc.toBalanceView=toBalanceView,vmc.initProvince=initProvince,vmc.loadCityData=loadCityData,vmc.loadCountyData=loadCounty,vmc.saveConsignee=saveConsignee,vmc.chooseConsignee=chooseConsignee,vmc.validConsignee=validConsignee,vmc.noConsignee=!1,vmc.initProvince(),vmc.loadingConsignee=!1,vmc.submiting=!1,vmc.showLayerBg=!1;var vm=$scope.$parent.vm;active()}angular.module("weshares").controller("WesharesEditConsigneeCtrl",WesharesEditConsigneeCtrl)}(window,window.angular),function(window,angular){function WesharesViewCtrl($scope,$rootScope,$log,$http,$templateCache,$timeout,$filter,Utils,ShareOrder,OfflineStore){function activate(){vm.currentUserOrderCount=0,vm.orderPayTotalPrice=0,vm.productTotalPrice=0,vm.commentData={},vm.orderComments=[],vm.inWeixin=Utils.isWeixin(),vm.recommendWeshares=[],$rootScope.uid=-1,$rootScope.proxies=[],vm.initWeshareData()}function filterProductByNum(product){return product.num>0}function getDate(strDate){var date=eval("new Date("+strDate.replace(/\d+(?=-[^-]+$)/,function(a){return parseInt(a,10)-1}).match(/\d+/g)+")");return date}function getFormatDate(dateStr){var date=getDate(dateStr),formatedDate=$filter("date")(date,"MM-dd HH:mm");return formatedDate}function chatToUser(userId){return userId==vm.currentUser.id?void(window.location.href="/share_faq/faq_list/"+vm.weshare.id+"/"+userId):void(window.location.href="/share_faq/faq/"+vm.weshare.id+"/"+userId)}function loadOrderDetail(share_id){var viewFrom=angular.element(document.getElementById("weshareView")).attr("data-from");vm.viewFrom=viewFrom;var initSharedOfferId=angular.element(document.getElementById("weshareView")).attr("data-shared-offer"),followSharedType=angular.element(document.getElementById("sharedOfferResult")).attr("data-shared-type"),followSharedNum=parseFloat(angular.element(document.getElementById("sharedOfferResult")).attr("data-shared-coupon-num"));vm.sharedOfferId=initSharedOfferId,followSharedType&&"got"==followSharedType&&followSharedNum>0&&(vm.showNotifyGetPacketDialog=!0,vm.getPacketNum=followSharedNum+"元",vm.showLayer=!0),$http({method:"GET",url:"/weshares/get_share_user_order/"+share_id+".json",cache:$templateCache}).success(function(data,status){vm.ordersDetail=data.ordersDetail,_.isEmpty(data.ordersDetail.order_ids)||loadOrderCommentData(share_id),vm.autoPopCommentData.comment_order_info&&vm.showAutoCommentDialog(),vm.shareOrder=new ShareOrder,vm.shareOrder.shareId=share_id}).error(function(data,status){$log.log(data)})}function getShareSummeryData(shareId,userId){$http.get("/weshares/summaries",{params:{shareIds:JSON.stringify([shareId])}}).success(function(summaries){vm.weshare.summary=summaries[0]}).error(function(data,e){$log.log("Failed to get summaries: "+e)})}function initWeshareData(){var element=angular.element(document.getElementById("weshareView")),rebateLogId=element.attr("data-rebate-log-id"),recommendUserId=element.attr("data-recommend-id"),commentOrderId=element.attr("data-comment-order-id"),replayCommentId=element.attr("data-replay-comment-id");vm.rebateLogId=rebateLogId||0,vm.recommendUserId=recommendUserId||0;var weshareId=element.attr("data-weshare-id");$rootScope.uid=element.attr("data-uid"),vm.weshare={},$scope.$watch("vm.selectShipType",function(val){-1!=val&&(vm.chooseShipType=!1)}),$scope.$watchCollection("vm.checkedOfflineStore",function(val){val&&(vm.chooseOfflineStoreError=!1)});var shareDetailUrl="/weshares/detail/"+weshareId+".json?comment_order_id="+commentOrderId+"&reply_comment_id="+replayCommentId;$http({method:"GET",url:shareDetailUrl,params:{comment_order_id:commentOrderId,reply_comment_id:replayCommentId},cache:$templateCache}).success(function(data,status){handleShareData(data)}).error(function(data,status){$log.log(data),$rootScope.loadingPage=!1}),vm.checkHasUnRead()}function sortOrders(){vm.isCreator()||(vm.ordersDetail.orders=_.sortBy(vm.ordersDetail.orders,function(order){return 9==order.status&&order.creator==vm.currentUser.id?(vm.currentUserOrderCount=vm.currentUserOrderCount+1,-2147483646):order.creator==vm.currentUser.id?(vm.currentUserOrderCount=vm.currentUserOrderCount+1,-2147483647):order.id}))}function isProxy(){return!_.isEmpty(vm.currentUser)&&1==vm.currentUser.is_proxy}function isCreator(){return!_.isEmpty(vm.currentUser)&&vm.currentUser.id==vm.weshare.creator.id}function isShareManager(){return vm.isCreator()||vm.canManageShare}function isOwner(order){return!_.isEmpty(vm.currentUser)&&!_.isEmpty(order)&&vm.currentUser.id==order.creator}function isOrderReceived(order){return!_.isEmpty(order)&&3==order.status}function getOrderDisplayName(orderId){var carts=[];return carts=vm.ordersDetail&&vm.ordersDetail.order_cart_map&&vm.ordersDetail.order_cart_map[orderId]?vm.ordersDetail.order_cart_map[orderId]:vm.shareOrder.order_cart_map[orderId],_.map(carts,function(cart){return cart.name+"X"+cart.num}).join(", ")}function redirectFaq(){vm.isCreator()||vm.canManageShare?window.location.href="/share_faq/faq_list/"+vm.weshare.id+"/"+vm.weshare.creator.id:window.location.href="/share_faq/faq/"+vm.weshare.id+"/"+vm.weshare.creator.id}function showShareDetail(){vm.showOfflineStoreDetailView=!1,vm.chooseOfflineStoreView=!1,vm.showBalanceView=!1,vm.showEditConsigneeView=!1,vm.showShareDetailView=!0}function toShareDetailView($share_id){window.location.href="/weshares/view/"+$share_id}function toUserShareInfo($uid){window.location.href="/weshares/user_share_info/"+$uid}function viewImage(url){wx&&wx.previewImage({current:url,urls:vm.weshare.images})}function getConsigneeInfo(order){return _.isEmpty(order)?"":_.reject([order.consignee_name,order.consignee_mobilephone],function(e){return _.isEmpty(e)}).join(",")}function calCanUserRebate(totalPrice){if(0==vm.rebateTotal)vm.canUseRebateTotal=0;else{totalPrice/=100;var rebateMoney=vm.rebateTotal/100;rebateMoney>totalPrice/2&&(rebateMoney=totalPrice/2),vm.canUseRebateTotal=parseInt(100*rebateMoney+"")}}function calOrderTotalPrice(){var submit_products=[];_.each(vm.weshare.products,function(product){product.num&&product.num>0&&submit_products.push(product)});var totalPrice=0;_.each(submit_products,function(product){totalPrice+=product.price*product.num}),0!=totalPrice?(vm.productTotalPrice=totalPrice/100,vm.userCouponReduce&&(totalPrice-=vm.userCouponReduce),vm.shipFee=parseInt(getShipFee()),vm.shipSetId=getShipSetId(),calCanUserRebate(totalPrice),"1"==vm.useRebate&&(totalPrice-=vm.canUseRebateTotal),totalPrice+=vm.shipFee,vm.orderPayTotalPrice=totalPrice/100):(vm.productTotalPrice=0,vm.orderPayTotalPrice=0,vm.shipFee=0)}function getOrderComment(order_id){return vm.commentData.order_comments&&vm.commentData.order_comments[order_id]?vm.commentData.order_comments[order_id]:vm.shareOrder.orderComments?vm.shareOrder.orderComments[order_id]:null}function getOrderCommentLength(){var orderCommentCount=0;return vm.shareOrder&&vm.shareOrder.orderComments&&(orderCommentCount+=Object.keys(vm.shareOrder.orderComments).length),orderCommentCount}function getReplyComments(comment_id){return vm.commentData.comment_replies&&vm.commentData.comment_replies[comment_id]?vm.commentData.comment_replies[comment_id]:vm.shareOrder&&vm.shareOrder.orderCommentReplies?vm.shareOrder.orderCommentReplies[comment_id]:void 0}function showReplies(comment_id){if(!vm.commentData&&!vm.shareOrder.orderCommentReplies)return!1;var selfAllReplies=vm.commentData.comment_replies;if(selfAllReplies&&selfAllReplies[comment_id])return!0;var referAllReplies=vm.shareOrder.orderCommentReplies;return!(!referAllReplies||!referAllReplies[comment_id])}function getShipSetId(){return 0==vm.selectShipType?vm.weshareSettings.kuai_di.id:1==vm.selectShipType?vm.weshareSettings.self_ziti.id:2==vm.selectShipType?vm.weshareSettings.pys_ziti.id:void 0}function setShipFee(){vm.shipFee=getShipFee()}function getShipFee(){if(0==vm.selectShipType){var goodNum=0,goodWeight=0;return _.each(vm.weshare.products,function(product){product.num&&product.num>0&&(goodNum+=parseInt(product.num),product.weight&&product.weight>0&&(goodWeight+=parseInt(product.weight)*parseInt(product.num)))}),vm.expressShipInfo?vm.calculateShipFee(vm.dliveryTemplate,vm.expressShipInfo.province_id,goodNum,goodWeight):0}return 1==vm.selectShipType?vm.weshareSettings.self_ziti.ship_fee:2==vm.selectShipType?vm.weshareSettings.pys_ziti.ship_fee:void 0}function increaseProductNum(product){Utils.isNumber(product.num)||(product.num=0),product.limit>0&&product.num==product.limit?alert("亲，最多可购"+product.limit+"份."):product.store>0?product.num=Math.min(product.num+1,vm.getProductLeftNum(product)):product.num=product.num+1,vm.showBalanceView&&calOrderTotalPrice()}function decreaseProductNum(product){Utils.isNumber(product.num)||(product.num=0);var minNum=0;if(vm.showBalanceView){var totalNum=_.reduce(_.filter(vm.weshare.products,function(p){return vm.filterProductByNum(p)}),function(memo,p){return memo+p.num},0);1>=totalNum&&(minNum=1)}product.num=Math.max(minNum,product.num-1),vm.showBalanceView&&calOrderTotalPrice()}function validateMobile(){return vm.buyerMobilePhoneHasError=!Utils.isMobileValid(vm.buyerMobilePhone),vm.buyerMobilePhoneHasError}function validateUserName(){return vm.usernameHasError=_.isEmpty(vm.buyerName),vm.usernameHasError}function validateShipInfo(){return 0!=vm.selectShipType||vm.expressShipInfo?1==vm.selectShipType&&-1==vm.selectedPickUpAddressId?(alert("请选择自提地址"),!1):2!=vm.selectShipType||vm.checkedOfflineStore?_.isEmpty(vm.buyerAddress)?(alert("请填写地址信息"),!1):1!=vm.selectShipType&&2!=vm.selectShipType||!_.isEmpty(vm.buyerPatchAddress)?!0:(alert("请填写详细地址信息"),!1):(alert("请选择好邻居线下店"),!1):(alert("快递地址选择有误"),!1)}function validateProducts(){return _.all(vm.weshare.products,function(product){return!product.num||product.num<=0})}function getProductLeftNum(product){if(vm.productSummery&&vm.productSummery.details[product.id]){var product_buy_num=parseInt(vm.productSummery.details[product.id].num),store_num=product.store;return store_num-product_buy_num}return product.store}function checkProductNum(product){var store_num=product.store;if(-1==store_num)return!1;if(0==store_num)return!0;if(vm.productSummery&&vm.productSummery.details[product.id]&&store_num>0){var product_buy_num=parseInt(vm.productSummery.details[product.id].num);return store_num>product_buy_num}return!0}function buyProducts(){if(vm.validateProducts()){alert("请选择报名商品！");var element=angular.element(document.getElementById("share-product-list"));return window.scrollTo(0,element[0].offsetTop-100),!1}vm.showShareDetailView=!1,vm.chooseShipType=!1,vm.showBalanceView=!0,vm.shouldInitUserConsigneeData=!0,vm.showEditConsigneeView=!0,vm.reloadConsigneeData=!0}function getBuyShipInfo(){vm.shipFee=vm.shipFee||0;var ship_info={ship_type:vm.selectShipType,ship_fee:vm.shipFee,ship_set_id:vm.shipSetId,name:vm.buyerName,mobilephone:vm.buyerMobilePhone,address:vm.buyerAddress,patchAddress:vm.buyerPatchAddress};return 0==vm.selectShipType&&(ship_info.consignee_id=vm.expressShipInfo.id,ship_info.provinceId=vm.expressShipInfo.province_id),1!=vm.selectShipType&&2!=vm.selectShipType||(1==vm.selectShipType&&(ship_info.consignee_id=vm.selectedPickUpAddressId),2==vm.selectShipType&&(ship_info.consignee_id=vm.checkedOfflineStore.id)),ship_info}function submitOrder(paymentType){if(!vm.validateOrderData())return!1;var submit_products=[];_.each(vm.weshare.products,function(product){product.num&&product.num>0&&submit_products.push(product)}),submit_products=_.map(submit_products,function(product){return{id:product.id,num:product.num}});var ship_info=getBuyShipInfo(),orderData={weshare_id:vm.weshare.id,from:vm.viewFrom,weshare_creator:vm.weshare.creator.id,rebate_log_id:vm.rebateLogId,products:submit_products,ship_info:ship_info,remark:vm.buyerRemark,useRebate:vm.useRebate};vm.useCouponId&&(orderData.coupon_id=vm.useCouponId),vm.submitProcessing||(vm.submitProcessing=!0,$http.post("/weshares/makeOrder",orderData).success(function(data){data.success?window.location.href="/weshares/pay/"+data.orderId+"/"+paymentType:(vm.submitProcessing=!1,vm.showBuyingDialog=!1,vm.showLayer=!1,data.reason?alert(data.reason):alert("提交失败.请联系客服.."))}).error(function(){vm.submitProcessing=!1}))}function cloneShare(){vm.cloneShareProcessing||(vm.cloneShareProcessing=!0,$http.post("/weshares/cloneShare/"+vm.weshare.id).success(function(data){data.success?window.location.href="/weshares/view/"+data.shareId:(vm.cloneShareProcessing=!1,data.reason?alert(data.reason):alert("提交失败"))}).error(function(){vm.cloneShareProcessing=!1}))}function notifyUserToComment(order){vm.submitTempCommentData.order_id=order.id,vm.submitTempCommentData.reply_comment_id=0,vm.submitTempCommentData.share_id=order.member_id,vm.submitComment(),order.notify=!0}function submitComment(){$http.post("/weshares/comment",vm.submitTempCommentData).success(function(data){if(data.success){if("notify"==data.type)return window.alert("已经通知TA"),!0;var order_id=data.order_id;vm.commentOrder.id==order_id&&3==vm.commentOrder.status&&(vm.commentOrder.status=9),loadOrderCommentData(vm.weshare.id)}else alert("提交失败")}).error(function(){alert("提交失败")}),vm.closeCommentDialog()}function loadOrderCommentData(share_id){$http({method:"GET",url:"/weshares/get_share_comment_data/"+share_id+"/"+vm.weshare.creator.id+".json"}).success(function(data,status){vm.commentData=data.comment_data,vm.orderComments=vm.commentData.order_comments}).error(function(data,status){$log.log(data)})}function resetNotifyContent(){0==vm.sendNotifyType?vm.notify.content=vm.defaultNotifyHasBuyMsgContent():vm.notify.content=""}function defaultNotifyHasBuyMsgContent(){var msgContent="";if(0==vm.notifyType())return msgContent="我发起了一个分享，时间有限，抓紧报名啦！";if(vm.weshare.summary.order_count>10){var index=0;for(var userId in vm.shareOrder.users){var user=vm.shareOrder.users[userId];if(index++,index>10)break;10==index?msgContent+=user.nickname:msgContent=msgContent+user.nickname+"，"}msgContent=msgContent+"...等"+vm.weshare.summary.order_count+"人都已经报名"+vm.weshare.creator.nickname+"分享的"+vm.weshare.title+"啦，就差你啦。"}else msgContent=_.reduce(vm.shareOrder.users,function(memo,user){return memo+user.nickname+"，"},""),msgContent=msgContent+"都已经报名"+vm.weshare.creator.nickname+"分享的"+vm.weshare.title+"啦，就差你啦。";return msgContent}function notifyFans(){vm.showNotifyView=!0,vm.showLayer=!0,vm.sendNotifyType=0,vm.notify={},vm.notify.type=vm.sendNotifyType,vm.notify.content=vm.defaultNotifyHasBuyMsgContent()}function notifyType(){return vm.shareOrder&&vm.shareOrder.orders&&vm.shareOrder.orders.length>0?1:0}function validNotifyMsgContent(){return _.isEmpty(vm.notify.content)?void(vm.notifyMsgHasError=!0):void(vm.notifyMsgHasError=!1)}function sendNotifyShareMsg(){return _.isEmpty(vm.notify.content)?void(vm.notifyMsgHasError=!0):(vm.notifyMsgHasError=!1,void(confirm("是否要发送消息，发送次数过多会对用户形成骚扰?")&&$http({method:"POST",url:"/weshares/send_buy_percent_msg/"+vm.weshare.id,data:{content:vm.notify.content,type:vm.sendNotifyType}}).success(function(data){data.success&&(vm.showNotifyView=!1,vm.showLayer=!1),data.msg&&alert(data.msg)}).error(function(){alert("发送失败,请联系朋友说客服。。")})))}function showCommentListDialog(){vm.showCommentListDialogView=!0,vm.showLayer=!0}function closeCommentDialog(){vm.showCommentingDialog=!1,vm.showLayer=!1,vm.submitTempCommentData={}}function showAutoCommentDialog(){var order=vm.autoPopCommentData.comment_order_info;if(order){vm.showCommentingDialog=!0,vm.showLayer=!0;var reply_comment_id=0,comment_tip_info="",comment=vm.autoPopCommentData.comment_info;if(comment){reply_comment_id=comment.id||0;var reply_username=comment.username;comment_tip_info=reply_username==vm.currentUser.nickname?"爱心评价":"回复"+reply_username+"："}else if(vm.currentUser.id==vm.weshare.creator.id){var order_username=order.creator_nickname;comment_tip_info="回复"+order_username+"说："}else comment_tip_info="回复"+vm.weshare.creator.nickname+"说：";vm.submitTempCommentData={},vm.commentTipInfo=comment_tip_info,vm.commentOrder=order,vm.submitTempCommentData.order_id=order.id,vm.submitTempCommentData.reply_comment_id=reply_comment_id,vm.submitTempCommentData.share_id=vm.weshare.id}}function showCommentDialog(order,comment){if(vm.currentUser.id!=order.creator&&!vm.isCreator())return!1;vm.showCommentingDialog=!0,vm.showLayer=!0;var reply_comment_id=0,comment_tip_info="";if(comment){reply_comment_id=comment.id||0;var reply_username=comment.username;comment.plain_username&&(reply_username=comment.plain_username),comment_tip_info=reply_username==vm.currentUser.nickname?"爱心评价":"回复"+reply_username+"："}else if(vm.currentUser.id==vm.weshare.creator.id){var order_username;order_username=vm.ordersDetail.users[order.creator]?vm.ordersDetail.users[order.creator].nickname:vm.shareOrder.users[order.creator].nickname,comment_tip_info="回复"+order_username+"说："}else comment_tip_info="回复"+vm.weshare.creator.nickname+"说：";vm.submitTempCommentData={},vm.commentTipInfo=comment_tip_info,vm.commentOrder=order,vm.submitTempCommentData.order_id=order.id,vm.submitTempCommentData.reply_comment_id=reply_comment_id,vm.submitTempCommentData.share_id=order.member_id}function getStatusName(status,orderType){return 1==status?"待发货":2==status?"kuai_di"==orderType?"待签收":"待取货":3==status?"待评价":"已完成"}function updateBuyerData(type){function setBuyerData(data){vm.buyerName=data.name,vm.buyerMobilePhone=data.mobilephone,vm.buyerPatchAddress=data.remark_address,vm.buyerAddress=data.address}function cleanBuyerData(){vm.buyerName="",vm.buyerMobilePhone="",vm.buyerPatchAddress="",vm.buyerAddress=""}cleanBuyerData(),0==type&&vm.expressShipInfo&&setBuyerData(vm.expressShipInfo),1==type&&vm.pickUpShipInfo&&setBuyerData(vm.pickUpShipInfo),2==type&&vm.offlineStoreShipInfo&&setBuyerData(vm.offlineStoreShipInfo),calOrderTotalPrice()}function validateOrderData(){function setUserAddress(){if(0==vm.selectShipType&&vm.expressShipInfo&&(vm.buyerAddress=vm.expressShipInfo.address),1==vm.selectShipType&&-1!=vm.selectedPickUpAddressId){var selectAddress=_.filter(vm.weshare.addresses,function(item){return item.id=vm.selectedPickUpAddressId});vm.buyerAddress=selectAddress[0].address}2==vm.selectShipType&&vm.checkedOfflineStore&&(vm.buyerAddress=vm.checkedOfflineStore.name)}setUserAddress();var productsHasError=vm.validateProducts();return productsHasError?void alert("请输入商品数量"):-1==vm.selectShipType?(alert("请选择快递方式"),vm.chooseShipType=!0,!1):2!=vm.selectShipType||vm.checkedOfflineStore?(vm.validateUserName(),vm.validateMobile(),vm.buyerMobilePhoneHasError||vm.usernameHasError?(alert("报名用户信息有误"),!1):!!vm.validateShipInfo()):(alert("请选择自提点"),vm.chooseOfflineStoreError=!0,!1)}function confirmReceived(order){_.isEmpty(order)||vm.isOrderReceived(order)||$http.post("/weshares/confirmReceived/"+order.id).success(function(data){data.success&&(order.status=3)}).error(function(e){$log.log(e)})}function stopShare(){var confirmResult=window.confirm("是否截止分享?");return confirmResult?void $http.post("/weshares/stopShare/"+vm.weshare.id).success(function(data){data.success&&(vm.weshare.status=1)}).error(function(e){$log.log(e)}):!1}function createMyShare(){var wx_article="http://mp.weixin.qq.com/s?__biz=MjM5MjY5ODAyOA==&mid=209712305&idx=1&sn=ddb8431d97100d7e6305c2bc46d9ae75#rd";vm.currentUser.mobilephone&&vm.currentUser.payment?window.location.href="/weshares/add?from=share_view":window.location.href=wx_article}function toShareOrderList(){window.location.href="/weshares/share_order_list/"+vm.weshare.id}function toUpdate(){window.location.href="/weshares/update/"+vm.weshare.id}function getShipCode(order){var shipMark=order.ship_mark,code=order.ship_code;if("kuai_di"==shipMark){var ship_type_name=order.ship_type_name;if(!ship_type_name){var ship_company=order.ship_type;ship_type_name=vm.shipTypes[ship_company]}return ship_type_name+": "+code}return"pys_ziti"==shipMark?"提货码: "+code:""}function closeRecommendDialog(){vm.showShareDialog=!0,vm.showRecommendDialog=!1}function submitRecommend(){return vm.validRecommendContent()?!1:($http.post("/weshares/recommend",vm.submitRecommendData).success(function(data){data.msg&&alert(data.msg)}).error(function(e){$log.log(e)}),void vm.closeRecommendDialog())}function validRecommendContent(){return vm.recommendContentHasError=!1,_.isEmpty(vm.submitRecommendData.recommend_content)&&(vm.recommendContentHasError=!0),vm.recommendContentHasError}function checkHasUnRead(){$http.get("/share_opt/check_opt_has_new.json").success(function(data){data.has_new&&(vm.showUnReadMark=!0)})}function isShowShipCode(order){if(("kuai_di"==order.ship_mark||"pys_ziti"==order.ship_mark)&&1!=order.status&&vm.isOwner(order)){var code=order.ship_code;if(code)return!0}return!1}function isShowExpressInfoBtn(order){return!!("kuai_di"==order.ship_mark&&order.status>1&&vm.isOwner(order))}function showOrderExpressInfo(order){window.location.href="/weshares/express_info/"+order.id}function calculateShipFee(deliveryTemplate,provinceId,goodNum,goodWeight){var shipFee=0;if(provinceId&&goodNum>0){var template=null;if(deliveryTemplate.delivery_templates&&deliveryTemplate.delivery_templates.length>0)for(var i=0;i<deliveryTemplate.delivery_templates.length;i++){var deliveryTemplateItem=deliveryTemplate.delivery_templates[i],regions=deliveryTemplateItem.regions;if(regions&&regions.length>0){for(var j=0;j<regions.length;j++){var region=regions[j];if(region.province_id==provinceId){template=deliveryTemplateItem;break}}if(template)break}}template||(template=deliveryTemplate.default_delivery_template);var startUnits=parseInt(template.start_units),startFee=parseInt(template.start_fee),addUnits=parseInt(template.add_units),addFee=parseInt(template.add_fee),unitType=parseInt(template.unit_type),cal_val=goodNum;1==unitType&&(cal_val=goodWeight);var gapVal=cal_val-startUnits;shipFee=0>=gapVal?startFee:startFee+Math.ceil(gapVal/addUnits)*addFee}return shipFee}function handleShareData(data){$rootScope.loadingPage=!1,vm.weshare=data.weshare,vm.weshare.addresses&&1==vm.weshare.addresses.length?vm.selectedPickUpAddressId=vm.weshare.addresses[0].id:vm.weshare.addresses&&vm.weshare.addresses.length>1&&(vm.weshare.addresses.unshift({id:-1,address:"请选择收货地址"}),vm.selectedPickUpAddressId=-1),vm.isManage=data.is_manage,vm.canManageShare=data.can_manage_share,vm.canEditShare=data.can_edit_share,vm.recommendData=data.recommendData,vm.currentUser=data.current_user||{},vm.consignee=data.consignee,vm.myCoupons=data.my_coupons,vm.rebateTotal=parseInt(data.user_rebate_total),vm.weshareSettings=data.weshare_ship_settings,data.sub_status&&$rootScope.proxies.push(parseInt(vm.weshare.creator.id)),vm.autoPopCommentData=data.prepare_comment_data,vm.dliveryTemplate=data.weshare.deliveryTemplate,vm.productSummery=data.share_summery,vm.submitRecommendData={},vm.submitRecommendData.recommend_content=vm.weshare.creator.nickname+"我认识，很靠谱！",vm.submitRecommendData.recommend_user=vm.currentUser.id,vm.submitRecommendData.recommend_share=vm.weshare.id,vm.myCoupons&&(vm.useCouponId=vm.myCoupons.CouponItem.id,vm.userCouponReduce=vm.myCoupons.Coupon.reduced_price),vm.userShareSummery=data.user_share_summery,(vm.isCreator()||vm.canManageShare)&&(vm.faqTipText="反馈消息"),vm.getShareSummeryData(vm.weshare.id,vm.weshare.creator.id),vm.loadOrderDetail(vm.weshare.id),vm.getRecommendWeshares(vm.weshare.id,vm.weshare.creator.id)}function getBannerImage(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream?vm.staticFilePath+"/static/weshares/images/share-banner-ios-app.gif":vm.staticFilePath+"/static/weshares/images/share-banner-new.gif"}function getBannerLink(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream?"/pys/download_app?from=share_view":"/weshares/add?from=share_view"}function getRecommendWeshares(weshareId,proxyId){$http.get("/weshares/get_recommend_weshares/"+proxyId).success(function(data){vm.recommendWeshares=_.filter(data,function(share){return share.id!=weshareId}),vm.recommendWeshares=vm.recommendWeshares.slice(0,4)})}var vm=this;vm.staticFilePath=Utils.staticFilePath(),vm.showShareDetailView=!0,vm.faqTipText="私信",vm.showUnReadMark=!1,vm.readMoreBtnText="全文",vm.hideMoreShareInfo=!1,vm.shouldShowReadMoreBtn=!1,vm.shipTypes=Utils.shipTypes(),vm.submitTempCommentData={},vm.viewImage=viewImage,vm.increaseProductNum=increaseProductNum,vm.decreaseProductNum=decreaseProductNum,vm.getOrderDisplayName=getOrderDisplayName,vm.isCreator=isCreator,vm.isProxy=isProxy,vm.isOwner=isOwner,vm.isOrderReceived=isOrderReceived,vm.getConsigneeInfo=getConsigneeInfo,vm.validateProducts=validateProducts,vm.buyProducts=buyProducts,vm.validateMobile=validateMobile,vm.validateUserName=validateUserName,vm.validateShipInfo=validateShipInfo,vm.validateOrderData=validateOrderData,vm.submitOrder=submitOrder,vm.confirmReceived=confirmReceived,vm.toUserShareInfo=toUserShareInfo,vm.toShareDetailView=toShareDetailView,vm.checkProductNum=checkProductNum,vm.getProductLeftNum=getProductLeftNum,vm.toShareOrderList=toShareOrderList,vm.createMyShare=createMyShare,vm.toUpdate=toUpdate,vm.stopShare=stopShare,vm.showShareDetail=showShareDetail,vm.calOrderTotalPrice=calOrderTotalPrice,vm.getStatusName=getStatusName,vm.getShipCode=getShipCode,vm.isShowShipCode=isShowShipCode,vm.showCommentDialog=showCommentDialog,vm.showAutoCommentDialog=showAutoCommentDialog,vm.submitComment=submitComment,vm.getOrderComment=getOrderComment,vm.getReplyComments=getReplyComments,vm.showReplies=showReplies,vm.showCommentListDialog=showCommentListDialog,vm.getOrderCommentLength=getOrderCommentLength,vm.initWeshareData=initWeshareData,vm.sortOrders=sortOrders,vm.closeCommentDialog=closeCommentDialog,vm.notifyUserToComment=notifyUserToComment,vm.loadOrderDetail=loadOrderDetail,vm.getFormatDate=getFormatDate,vm.notifyFans=notifyFans,vm.notifyType=notifyType,
vm.sendNotifyShareMsg=sendNotifyShareMsg,vm.validNotifyMsgContent=validNotifyMsgContent,vm.cloneShare=cloneShare,vm.resetNotifyContent=resetNotifyContent,vm.defaultNotifyHasBuyMsgContent=defaultNotifyHasBuyMsgContent,vm.closeRecommendDialog=closeRecommendDialog,vm.submitRecommend=submitRecommend,vm.validRecommendContent=validRecommendContent,vm.checkHasUnRead=checkHasUnRead,vm.setShipFee=setShipFee,vm.redirectFaq=redirectFaq,vm.chatToUser=chatToUser,vm.isShareManager=isShareManager,vm.calculateShipFee=calculateShipFee,vm.updateBuyerData=updateBuyerData,vm.getShareSummeryData=getShareSummeryData,vm.filterProductByNum=filterProductByNum,vm.isShowExpressInfoBtn=isShowExpressInfoBtn,vm.showOrderExpressInfo=showOrderExpressInfo,vm.getBannerImage=getBannerImage,vm.getBannerLink=getBannerLink,vm.getRecommendWeshares=getRecommendWeshares,activate(),OfflineStore.ChooseOfflineStore(vm,$http,$templateCache)}angular.module("weshares").controller("WesharesViewCtrl",WesharesViewCtrl)}(window,window.angular),function(window,angular){function ShareProductViewCtrl($scope,$rootScope,$log,$http,$templateCache,$timeout,$filter,$window,Utils,PoolProductInfo){function activate(){vm.initProductInfo()}function initProductInfo(){var weshareId=angular.element(document.getElementById("shareProductView")).attr("data-weshare-id");vm.shareId=weshareId,vm.weshare={},PoolProductInfo.prepareProductInfo(weshareId,function(data){vm.weshare=data,vm.initViewFieldName(),vm.initProductBuyBtn(),$rootScope.loadingPage=!1})}function initProductBuyBtn(){if(vm.weshare.buy_config){var buyConfig=vm.weshare.buy_config;buyConfig["try"]&&(vm.buyShareId=buyConfig["try"],vm.buyButtonText="试吃申请"),buyConfig.buy&&(vm.buyShareId=buyConfig.buy,vm.buyButtonText="渠道价购买")}}function toBuyShare(){vm.buyShareId?window.location.href="/weshares/view/"+vm.buyShareId:alert("该商品没有试吃！请联系客服。")}function toggleTag(tag){var currentToggleState=vm.toggleState[tag];currentToggleState.open=!currentToggleState.open,currentToggleState.statusText=currentToggleState.open?"收起":"展开"}function cloneShare(){vm.cloneShareProcessing||(vm.cloneShareProcessing=!0,$http({method:"GET",url:"/share_product_pool/clone_share/"+vm.shareId}).success(function(data){if(data.success){var newShareId=data.shareId;window.location.href="/weshares/view/"+newShareId}else data.reason?data[!1]?(alert("您还没有登录，请登录后进行操作。"),window.location.href="/users/login"):alert(data.reason):alert("开团失败，请联系管理员");vm.cloneShareProcessing=!1}).error(function(){$log.log("clone share from product pool error"),alert("系统错误，请联系管理员"),vm.cloneShareProcessing=!1}))}function viewImage(url){wx.previewImage({current:url,urls:vm.weshare.images})}function initViewFieldName(){vm.shareStatusText=2==vm.weshare.status?"无效":"可用",vm.toggleState={0:{open:!0,statusText:"收起"}},_.each(vm.weshare.tags,function(value,key){vm.toggleState[key]={open:!0,statusText:"收起"}})}var vm=this;vm.showDetailView=!0,vm.initProductInfo=initProductInfo,vm.initViewFieldName=initViewFieldName,vm.toggleTag=toggleTag,vm.cloneShare=cloneShare,vm.viewImage=viewImage,vm.toBuyShare=toBuyShare,vm.initProductBuyBtn=initProductBuyBtn,vm.staticFilePath=Utils.staticFilePath(),activate()}angular.module("weshares").controller("ShareProductViewCtrl",ShareProductViewCtrl)}(window,window.angular);