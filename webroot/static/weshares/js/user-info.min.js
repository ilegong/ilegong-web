angular.module("me-lazyload",[]).directive("lazySrc",["$window","$document",function($window,$document){var doc=$document[0],body=doc.body,win=$window,$win=angular.element(win),uid=0,elements={};function getUid(el){return el.__uid||(el.__uid=""+ ++uid)}function getWindowOffset(){var t,pageXOffset=typeof win.pageXOffset=="number"?win.pageXOffset:(((t=doc.documentElement)||(t=body.parentNode))&&typeof t.ScrollLeft=="number"?t:body).ScrollLeft,pageYOffset=typeof win.pageYOffset=="number"?win.pageYOffset:(((t=doc.documentElement)||(t=body.parentNode))&&typeof t.ScrollTop=="number"?t:body).ScrollTop;return{offsetX:pageXOffset,offsetY:pageYOffset}}function isVisible(iElement){var elem=iElement[0],elemRect=elem.getBoundingClientRect(),windowOffset=getWindowOffset(),winOffsetX=windowOffset.offsetX,winOffsetY=windowOffset.offsetY,elemWidth=elemRect.width,elemHeight=elemRect.height,elemOffsetX=elemRect.left+winOffsetX,elemOffsetY=elemRect.top+winOffsetY,viewWidth=Math.max(doc.documentElement.clientWidth,win.innerWidth||0),viewHeight=Math.max(doc.documentElement.clientHeight,win.innerHeight||0),xVisible,yVisible;if(elemOffsetY<=winOffsetY){if(elemOffsetY+elemHeight>=winOffsetY){yVisible=true}}else if(elemOffsetY>=winOffsetY){if(elemOffsetY<=winOffsetY+viewHeight){yVisible=true}}if(elemOffsetX<=winOffsetX){if(elemOffsetX+elemWidth>=winOffsetX){xVisible=true}}else if(elemOffsetX>=winOffsetX){if(elemOffsetX<=winOffsetX+viewWidth){xVisible=true}}return xVisible&&yVisible}function checkImage(){Object.keys(elements).forEach(function(key){var obj=elements[key],iElement=obj.iElement,$scope=obj.$scope;if(isVisible(iElement)){iElement.attr("src",$scope.lazySrc)}})}$win.bind("scroll",checkImage);$win.bind("resize",checkImage);function onLoad(){var $el=angular.element(this),uid=getUid($el);$el.css("opacity",1);if(elements.hasOwnProperty(uid)){delete elements[uid]}}return{restrict:"A",scope:{lazySrc:"@"},link:function($scope,iElement){iElement.bind("load",onLoad);$scope.$watch("lazySrc",function(){if(isVisible(iElement)){if(!iElement.attr("src")){iElement.attr("src",$scope.lazySrc)}}else{var uid=getUid(iElement);iElement.css({"background-color":"#fff",opacity:0,"-webkit-transition":"opacity 1s",transition:"opacity 1s"});elements[uid]={iElement:iElement,$scope:$scope}}});$scope.$on("$destroy",function(){iElement.unbind("load")})}}}]);(function(window,angular){angular.module("module.filters",[])})(window,window.angular);(function(window,angular){angular.module("module.services",[])})(window,window.angular);(function(window,angular){angular.module("module.directives",[])})(window,window.angular);(function(window,angular){var app=angular.module("UserInfo",["infinite-scroll","module.services","module.filters","module.directives","me-lazyload"]).constant("_",window._).config(configCompileProvider).config(configHttpProvider).config(extendLog).run(initApp);function configCompileProvider($compileProvider){$compileProvider.imgSrcSanitizationWhitelist(/^\s*(https|file|blob|cdvfile|http|chrome-extension|blob:chrome-extension):|data:image\//)}function configHttpProvider($httpProvider){$httpProvider.defaults.headers.common["Content-Type"]="application/json";$httpProvider.defaults.headers.post["Content-Type"]="application/json"}function extendLog($provide){$provide.decorator("$log",function($delegate,$injector){var _log=$delegate.log;var _warn=$delegate.warn;var _info=$delegate.info;var _debug=$delegate.debug;var _error=$delegate.error;var addMessage=function(message,forceLog){var $rootScope=$injector.get("$rootScope");$rootScope.config=$rootScope.config||{logMode:false};if($rootScope.config.logMode||forceLog){$rootScope.messages=$rootScope.messages||[];$rootScope.messages.push(message)}return message};$delegate.log=function(msg,forceLog){_log(addMessage(msg,forceLog||false));return this};$delegate.warn=function(msg,forceLog){_warn(addMessage(msg,forceLog||false));return this};$delegate.info=function(msg,forceLog){_info(addMessage(msg,forceLog||false));return this};$delegate.debug=function(msg,forceLog){_debug(addMessage(msg,forceLog||false));return this};$delegate.error=function(msg,forceLog){_error(addMessage(msg,forceLog||false));return this};return $delegate})}function initApp($rootScope){$rootScope._=_;$rootScope.loadingPage=true}})(window,window.angular);(function(window,angular){angular.module("UserInfo").controller("UserListCtrl",UserListCtrl);function UserListCtrl($http,$templateCache){var vm=this;vm.loadData=loadData;vm.getUserLevelText=getUserLevelText;vm.hasSub=hasSub;vm.toggleHideShowUnSubBtn=toggleHideShowUnSubBtn;vm.unSub=unSub;vm.subUser=subUser;vm.viewUser=viewUser;vm.search=search;vm.noMoreData=false;vm.loadingData=false;vm.page=1;vm.users=[];vm.level_map={};vm.sub_user_ids=[];vm.flag_show_un_sub={};vm.processSubmit=false;vm.queryWord="";vm.searchWord="";vm.levelTextMap=["分享达人","实习团长","正式团长","优秀团长","高级团长","资深团长","首席团长"];active();function active(){vm.userId=angular.element(document.getElementById("userListView")).attr("data-uid");vm.me=angular.element(document.getElementById("userListView")).attr("data-me");vm.dataType=angular.element(document.getElementById("userListView")).attr("data-type")}function toggleHideShowUnSubBtn(uid){if(!vm.flag_show_un_sub[uid]){vm.flag_show_un_sub[uid]=true;return}vm.flag_show_un_sub[uid]=!vm.flag_show_un_sub[uid]}function viewUser(uid){window.location.href="/weshares/user_share_info/"+uid}function unSub(uid){vm.processSubmit=true;$http({method:"GET",url:"/weshares/unsubscribe_sharer/"+uid+"/"+vm.userId}).success(function(data){if(data["success"]){afterUnSub(uid)}vm.processSubmit=false}).error(function(){vm.processSubmit=false})}function subUser(uid){vm.processSubmit=true;$http({method:"GET",url:"/weshares/subscribe_sharer/"+uid+"/"+vm.userId}).success(function(data){if(data["success"]){vm.sub_user_ids.push(uid)}else{if(data["reason"]=="not_sub"){alert("请先关注我们的服务号");window.location.href="https://mp.weixin.qq.com/s?__biz=MjM5MjY5ODAyOA==&mid=403992659&idx=1&sn=714a1a5f0bb4940f895e60f2f3995544"}}vm.processSubmit=false}).error(function(){vm.processSubmit=false})}function afterUnSub(uid){vm.sub_user_ids=_.without(vm.sub_user_ids,uid);delete vm.flag_show_un_sub[uid];if(vm.dataType==1){vm.users=_.filter(vm.users,function(item){return item["User"]["id"]!=uid})}}function getUserLevelText(uid){var level=vm.level_map[uid];return"V"+level+vm.levelTextMap[level]}function hasSub(uid){return _.indexOf(vm.sub_user_ids,uid)>=0}function search(){vm.queryWord=vm.searchWord;vm.users=[];vm.sub_user_ids=[];vm.level_map={};vm.page=1;vm.pageInfo={};vm.noMoreData=false;vm.loadingData=false;loadData()}function loadData(){vm.loadingData=true;var url="/weshares/get_u_list_data/"+vm.dataType+"/"+vm.userId+"/"+vm.page+".json?query="+vm.queryWord;$http({method:"GET",url:url,cache:$templateCache}).success(function(data){vm.loadingData=false;if(data["page_info"]){vm.pageInfo=data["page_info"]}vm.users=vm.users.concat(data["users"]);vm.sub_user_ids=vm.sub_user_ids.concat(data["sub_user_ids"]);vm.level_map=merge_options(vm.level_map,data["level_map"]);vm.page=vm.page+1;if(vm.pageInfo["page_count"]<vm.page){vm.noMoreData=true}}).error(function(data,status){})}function merge_options(obj1,obj2){var obj3={};for(var attrname in obj1){obj3[attrname]=obj1[attrname]}for(var attrname in obj2){obj3[attrname]=obj2[attrname]}return obj3}}})(window,window.angular);