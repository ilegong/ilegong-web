$(document).ready(function(){var e=$("#order-tag-toggle");var a=$("li",e);var r=$("div.div-order-item");var s=$("tr.summery-product-item");var t=$("tr.order-data-summery");var n=$("#self-ziti-orders");$("div.offer .div-share-item").on("click",function(e){e.preventDefault();var a=$(this);var r=a.parentsUntil("div.col-xs-12").parent("div.col-xs-12");var s=r.data("id");window.location.href="/weshares/view/"+s});function i(){if(a.length>0){$("li:first",e).trigger("click")}}a.on("click",function(e){e.preventDefault();var r=$(this);var s=r.data("id");d(s);a.removeClass("active");r.addClass("active")});i();function d(e){if(e=="all"){r.show();s.show();t.hide();$('tr[name="order-data-summery-all"]').show()}else{r.hide();s.hide();$('div[name="order-item-tag-'+e+'"]').show();$('tr[name="summery-product-'+e+'"]').show();t.hide();$('tr[name="order-data-summery-'+e+'"]').show()}}var o="";var v=$("#self-ziti-orders");$('select[name="ship_company_code"]').on("change",function(){var e=this.value;$("option[value='"+e+"']").prop("selected",true)});$("ul.nav li a").on("click",function(){var e=$(this);o=e.data("order-type");if(o=="self_ziti"){$("#send_product_arrive_msg").show()}else{$("#send_product_arrive_msg").hide()}});$("ul.nav li:first a").trigger("click");$("button.set-order-ship-code").on("click",function(){var e=$(this);var a=e.parentsUntil("div.col-xs-12");var r=e.parent("div");var s=$("select[name=ship_company_code]",r);var t=$("input[name=ship_code]",r);var n=e.data("order-id");var i=s.val();var d=t.val();var o=e.data("weshare-id");var v=$("option:selected",s).text();$.post("/weshares/set_order_ship_code",{order_id:n,company_id:i,ship_code:d,weshare_id:o},function(e){if(e["success"]){a.removeClass("offer-success").addClass("offer-warning");$("div.shape-text",a).text("已发货");r.parent("div.offer-content").append("<p><strong>"+v+":</strong><strong>"+d+"</strong> </p>");r.remove()}},"json")});$('button[name="set_order_shipped"]').on("click",function(e){e.preventDefault();var a=$(this);bootbox.confirm("确定已发货?",function(e){if(!e){return}var r=a.data("id");var s=a.parentsUntil("div.col-xs-12");$.getJSON("/weshares/confirmReceived/"+r,function(e){if(e["success"]){s.removeClass("offer-success").addClass("offer-warning");$("div.shape-text",s).text("已发货");a.next().remove();a.remove()}else{alert("修改失败")}})})});$('button[name="send_product_arrival_msg"]').on("click",function(e){e.preventDefault();var a=$("#arrival_msg");var r=a.val();if(!r||!r.trim()){return}var s=$(this).data("id");var t=$("div.div-order-item:visible",n);var i=[];t.each(function(e,a){var r=$(a);i.push(r.data("id"))});var d=i.join(",");var o={msg:r,share_id:s,ids:d};$.ajax({type:"POST",url:"/weshares/send_arrival_msg",data:JSON.stringify(o),success:function(e){$("div.send-msg-dialog").modal("hide");var a=$('div[data-order-status="1"]',v);a.each(function(e,a){var r=$(a);r.removeClass("offer-success").addClass("offer-warning");$("div.shape-text",r).text("已发货");r.data("order-status","2")})},contentType:"application/json",dataType:"json"})});var l=$("#set_share_shipped_dialog");var c=$("#set_shipped_share_id",l);var f=$("#share_arrival_msg",l);var u=$("#set_shipped_refer_share_id",l);var p=$("#set_shipped_address",l);$("button.set-shipped-share").on("click",function(e){e.preventDefault();var a=$(this);var r=a.data("id");var s=a.data("refer-share-id");var t=a.data("address");u.val(s);p.val(p);c.val(r);l.modal("show")});$('button[name="set-share-shipped"]').on("click",function(e){e.preventDefault();var a=f.val();if(!a||!a.trim()){return}var r=c.val();var s=u.val();var t=p.val();var n={share_id:r,refer_share_id:s,address:t,msg:a};$.post("/weshares/set_share_shipped",n,function(){var e=$("#set-share-shipped-btn-"+r);e.unbind();var a=e.parent("div.offer-content");a=a.parent();a.removeClass().addClass("offer").addClass("offer-success");$("div.shape-text",a).text("已发货");e.remove();l.modal("hide")},"json")});var m=$("#refund-money-dialog");var h=$("#refund-order-user",m);var _=$("#refund-order-id",m);var g=$("#refund-money",m);var b=$("#refund-msg",m);$('button[name="handle-refund-money"]').on("click",function(e){e.preventDefault();var a=$(this);var r=g.val();if(isNaN(r)){alert("请输入退款金额");return false}var s=b.val();if(!s){alert("请输入退款原因");return false}var t={orderId:_.val(),shareId:a.data("id"),refundMoney:g.val(),refundMark:b.val()};$.post("/weshares/refund_money.json",t,function(e){if(e["success"]){var a=e["order_id"];var r=$("#refund-btn-"+a);r.unbind();var s=r.parent("div.offer-content");s=s.parent();s.removeClass().addClass("offer").addClass("offer-danger");$("div.shape-text",s).text("退款中");r.remove();m.modal("hide")}},"json")});$("button.refund-money").on("click",function(e){e.preventDefault();var a=$(this);var r=a.data("order-id");var s=a.data("order-name");h.val(s);_.val(r);g.val(0);b.val("");m.modal("show")});var w=$("#confirm-money-dialog");var y=$("#confirm-order-id",w);var C=$("#confirm-order-user",w);var x="";var k={};$("button.price-confirm").on("click",function(e){e.preventDefault();var a=$(this);var r=a.data("order-id");var s=a.data("order-name");y.val(r);C.val(s);x=$("#order-cart-info-"+r).val();k=JSON.parse(x);var t="";$.each(k,function(e,a){if(a["confirm_price"]==0){t=t+'<div class="form-group cart-item">'+'<label for="refund-money" class="col-sm-2 control-label">'+a["name"]+"X"+a["num"]+"&nbsp;&nbsp;已经预付"+a["price"]*a["num"]/100+"</label>"+'<div class="col-sm-10">'+'<input type="number" placeholder="实际价格" class="form-control" id="cart_'+a["id"]+'" data-origin-price="'+a["price"]*a["num"]+'">'+"</div>"+"</div>"}});$("form",w).append(t);w.modal("show");w.on("hide.bs.modal",function(){$("form div.cart-item",w).remove()})});$('button[name="handle-confirm-money"]').on("click",function(e){e.preventDefault();var a={};a["order_id"]=y.val();a["cart_map"]=[];$.each(k,function(e,r){if(r["confirm_price"]==0){var s=r["id"];var t=$("#cart_"+s,w);var n=t.data("origin-price");var i=t.val()||n;var d=r["product_id"];var o={};o["product_id"]=d;o["price"]=i;a["cart_map"].push(o)}});var r=JSON.stringify(a);$.post("/weshares/confirm_price.json",{data:r},function(e){if(e["success"]){var a=e["order_id"];var r=parseFloat(e["difference_price"]);var s=$("#price-confirm-btn-"+a);s.unbind();var t=s.parent("div.offer-content");t=t.parent();var n=$("#process-prepaid-status span",t);if(r>0){n.removeClass().addClass("label").addClass("label-info").text("待补款")}else if(r<0){n.removeClass().addClass("label").addClass("label-info").text("待退差价")}else{n.removeClass().addClass("label").addClass("label-info").text("无差价")}s.remove();w.modal("hide")}else{alert("保存失败,请联系客服")}},"json")});var j=$("#refund-share-dialog");var D=$("#refund-share-address",j);var N=$("#refund-share-id",j);var O=$("#refund-share-msg",j);$("button.refund-share-money").on("click",function(e){e.preventDefault();var a=$(this);var r=a.data("address");var s=a.data("id");D.val(r);N.val(s);O.val("");j.modal("show")});$('button[name="handle-refund-share-money"]').on("click",function(e){e.preventDefault();var a=O.val();var r=N.val();if(!a){alert("请输入退款原因");return false}var s={refundMark:a};$.post("/weshares/refund_share/"+r+".json",s,function(e){if(e["success"]){$("#refund-share-btn-"+r).remove();j.modal("hide")}},"json")})});