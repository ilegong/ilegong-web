$(document).ready(function(){function init(){$tagLi.length>0&&$("li:first",$shareOrderListTagToggle).trigger("click")}function handleTagChange(tag){filterOrderTag=tag,"all"==tag?($divOrderItems.show(),$summeryProductItems.show(),$orderDataSummeryItems.hide(),$('tr[name="order-data-summery-all"]').show()):($divOrderItems.hide(),$summeryProductItems.hide(),showFilterOrderItems(filterOrderTag,filterOrderStatus,filterOrderKeyword),$('tr[name="summery-product-'+tag+'"]').show(),$orderDataSummeryItems.hide(),$('tr[name="order-data-summery-'+tag+'"]').show())}function showFilterOrderItems(tag,status,keyword){$divOrderItems.hide();var $showOrderItems=$divOrderItems;"all"==tag?"all"!=status&&($showOrderItems=$divOrderItems.filter('div[data-order-status="'+status+'"]')):$showOrderItems="all"==status?$('div[name="order-item-tag-'+tag+'"]'):$('div[name="order-item-tag-'+tag+'"]').filter('div[data-order-status="'+status+'"]'),keyword&&($showOrderItems=$showOrderItems.filter(function(){return-1!=$('p[id^="order-info-panel"]',$(this)).text().indexOf(keyword)})),$showOrderItems.show(),$zitiOrderCountDom.length&&$zitiOrderCountDom.text($showOrderItems.filter('div[data-order-ship-type="self_ziti"]').length),$kuaidiOrderCountDom.length&&$kuaidiOrderCountDom.text($showOrderItems.filter('div[data-order-ship-type="kuai_di"]').length),$pysZitiOrderCount.length&&$pysZitiOrderCount.text($showOrderItems.filter('div[data-order-ship-type="pys_ziti"]').length)}var $shareOrderListTagToggle=$("#order-tag-toggle"),$tagLi=$("li",$shareOrderListTagToggle),$divOrderItems=$("div.div-order-item"),$summeryProductItems=$("tr.summery-product-item"),$orderDataSummeryItems=$("tr.order-data-summery"),$zitiPanel=$("#self-ziti-orders"),filterOrderTag="all",filterOrderStatus="all",filterOrderKeyword="",$filterOrderBtn=$("#filter-order"),$filterOrderText=$("#filterOrderText");$("div.offer .div-share-item").on("click",function(e){e.preventDefault();var $me=$(this),$parent=$me.parentsUntil("div.col-xs-12").parent("div.col-xs-12"),child_share_id=$parent.data("id");window.location.href="/weshares/view/"+child_share_id}),$tagLi.on("click",function(e){e.preventDefault();var $me=$(this),tagId=$me.data("id");handleTagChange(tagId),$tagLi.removeClass("active"),$me.addClass("active")}),init();var orderType="",$selfZitiOrder=$("#self-ziti-orders");$('select[name="ship_company_code"]').on("change",function(){var valueSelected=this.value;$("option[value='"+valueSelected+"']").prop("selected",!0)}),$("ul.nav-tabs li a").on("click",function(){var $me=$(this);orderType=$me.data("order-type"),"self_ziti"==orderType?$("#send_product_arrive_msg").show():$("#send_product_arrive_msg").hide()}),$("ul.nav-tabs li:first a").trigger("click"),$("button.set-order-shipped").on("click",function(){var $me=$(this),$parent=$me.parentsUntil("div.col-xs-12"),$form=$me.parent("div"),orderId=$me.data("order-id"),weshareId=$me.data("weshare-id");$.post("/weshares/set_order_shipped",{order_id:orderId,weshare_id:weshareId},function(data){data.success&&($parent.removeClass("offer-success").addClass("offer-warning"),$("div.shape-text",$parent).text("已发货"),$form.remove())},"json")}),$("button.set-order-ship-code").on("click",function(){var $me=$(this),$parent=$me.parentsUntil("div.col-xs-12"),$form=$me.parent("div"),$shipCompany=$("select[name=ship_company_code]",$form),$shipCode=$("input[name=ship_code]",$form),orderId=$me.data("order-id"),shipCompayId=$shipCompany.val(),shipCode=$shipCode.val(),weshareId=$me.data("weshare-id"),companyName=$("option:selected",$shipCompany).text();$.post("/weshares/set_order_ship_code",{order_id:orderId,company_id:shipCompayId,ship_code:shipCode,weshare_id:weshareId},function(data){data.success&&($parent.removeClass("offer-success").addClass("offer-warning"),$("div.shape-text",$parent).text("已发货"),$form.parent("div.offer-content").append("<p><strong>"+companyName+":</strong><strong>"+shipCode+"</strong> </p>"),$form.remove())},"json")});var $orderStatusLi=$("ul.nav-pills li"),$zitiOrderCountDom=$('font[name="self-ziti-orders-count"]'),$kuaidiOrderCountDom=$('font[name="kuaidi-orders-count"]'),$pysZitiOrderCount=$('font[name="pys-ziti-orders-count"]');$filterOrderBtn.on("click",function(e){e.preventDefault();var filterText=$filterOrderText.val();filterOrderKeyword=filterText.trim(),showFilterOrderItems(filterOrderTag,filterOrderStatus,filterOrderKeyword)}),$orderStatusLi.on("click",function(e){e.preventDefault(),$orderStatusLi.removeClass("disabled");var $me=$(this);$me.addClass("disabled");var toggleOrderStatus=$me.data("toggle-val");filterOrderStatus=toggleOrderStatus,showFilterOrderItems(filterOrderTag,filterOrderStatus,filterOrderKeyword)}),$('button[name="set_order_received"]').on("click",function(e){e.preventDefault();var $me=$(this);bootbox.confirm("确定已签收?",function(result){if(result){var order_id=$me.data("order-id"),$parent=$me.parentsUntil("div.col-xs-12");$.getJSON("/weshares/confirmReceived/"+order_id,function(data){data.success?($parent.removeClass("offer-success").addClass("offer-warning"),$("div.shape-text",$parent).text("已取货"),$me.remove()):alert("更新失败")})}})}),$('button[name="send_product_arrival_msg"]').on("click",function(e){e.preventDefault();var $msgInput=$("#arrival_msg"),msg=$msgInput.val();if(msg&&msg.trim()){var id=$(this).data("id"),$processOrders=$("div.div-order-item:visible",$zitiPanel),processOrderIds=[];$processOrders.each(function(index,item){var $item=$(item);processOrderIds.push($item.data("id"))});var processOrderIdStrs=processOrderIds.join(","),postData={msg:msg,share_id:id,ids:processOrderIdStrs};$.ajax({type:"POST",url:"/weshares/send_arrival_msg",data:JSON.stringify(postData),success:function(data){$("div.send-msg-dialog").modal("hide");var $paidOrders=$('div[data-order-status="1"]',$selfZitiOrder);$paidOrders.each(function(index,item){var $dom=$(item);$dom.removeClass("offer-success").addClass("offer-warning"),$("div.shape-text",$dom).text("已发货"),$dom.data("order-status","2")})},contentType:"application/json",dataType:"json"})}});var $setShareShippedDialog=$("#set_share_shipped_dialog"),$setShipShareId=$("#set_shipped_share_id",$setShareShippedDialog),$setShipShareMsg=$("#share_arrival_msg",$setShareShippedDialog),$setShipReferShareId=$("#set_shipped_refer_share_id",$setShareShippedDialog),$setShipAddress=$("#set_shipped_address",$setShareShippedDialog);$("button.set-shipped-share").on("click",function(e){e.preventDefault();var $me=$(this),shareId=$me.data("id"),referShareId=$me.data("refer-share-id");$me.data("address");$setShipReferShareId.val(referShareId),$setShipAddress.val($setShipAddress),$setShipShareId.val(shareId),$setShareShippedDialog.modal("show")}),$('button[name="set-share-shipped"]').on("click",function(e){e.preventDefault();var msg=$setShipShareMsg.val();if(msg&&msg.trim()){var shareId=$setShipShareId.val(),referShareId=$setShipReferShareId.val(),shipAddress=$setShipAddress.val(),postData={share_id:shareId,refer_share_id:referShareId,address:shipAddress,msg:msg};$.post("/weshares/set_share_shipped",postData,function(){var $setShippedBtn=$("#set-share-shipped-btn-"+shareId);$setShippedBtn.unbind();var $parent=$setShippedBtn.parent("div.offer-content");$parent=$parent.parent(),$parent.removeClass().addClass("offer").addClass("offer-success"),$("div.shape-text",$parent).text("已发货"),$setShippedBtn.remove(),$setShareShippedDialog.modal("hide")},"json")}});var $refundMoneyDialog=$("#refund-money-dialog"),$refundOrderName=$("#refund-order-user",$refundMoneyDialog),$refundOrderId=$("#refund-order-id",$refundMoneyDialog),$refundMoney=$("#refund-money",$refundMoneyDialog),$refundMsg=$("#refund-msg",$refundMoneyDialog);$('button[name="handle-refund-money"]').on("click",function(e){e.preventDefault();var $me=$(this),refundMoney=$refundMoney.val();if(isNaN(refundMoney))return alert("请输入退款金额"),!1;var refundMark=$refundMsg.val();if(!refundMark)return alert("请输入退款原因"),!1;var postData={orderId:$refundOrderId.val(),shareId:$me.data("id"),refundMoney:$refundMoney.val(),refundMark:$refundMsg.val()};$.post("/weshares/refund_money.json",postData,function(data){if(data.success){var orderId=data.order_id,$refundBtn=$("#refund-btn-"+orderId);$refundBtn.unbind();var $parent=$refundBtn.parent("div.offer-content");$parent=$parent.parent(),$parent.removeClass().addClass("offer").addClass("offer-danger"),$("div.shape-text",$parent).text("退款中"),$refundBtn.remove(),$refundMoneyDialog.modal("hide")}},"json")}),$("button.refund-money").on("click",function(e){e.preventDefault();var $me=$(this),orderId=$me.data("order-id"),orderUserName=$me.data("order-name");$refundOrderName.val(orderUserName),$refundOrderId.val(orderId),$refundMoney.val(0),$refundMsg.val(""),$refundMoneyDialog.modal("show")});var $confirmMoneyDialog=$("#confirm-money-dialog"),$confirmOrderId=$("#confirm-order-id",$confirmMoneyDialog),$confirmUsername=$("#confirm-order-user",$confirmMoneyDialog),cartJsonStr="",cartJsonData={};$("button.price-confirm").on("click",function(e){e.preventDefault();var $me=$(this),orderId=$me.data("order-id"),orderName=$me.data("order-name");$confirmOrderId.val(orderId),$confirmUsername.val(orderName),cartJsonStr=$("#order-cart-info-"+orderId).val(),cartJsonData=JSON.parse(cartJsonStr);var formDom="";$.each(cartJsonData,function(index,item){0==item.confirm_price&&(formDom=formDom+'<div class="form-group cart-item"><label for="refund-money" class="col-sm-2 control-label">'+item.name+"X"+item.num+"&nbsp;&nbsp;已经预付"+item.price*item.num/100+'</label><div class="col-sm-10"><input type="number" placeholder="实际价格" class="form-control" id="cart_'+item.id+'" data-origin-price="'+item.price*item.num+'"></div></div>')}),$("form",$confirmMoneyDialog).append(formDom),$confirmMoneyDialog.modal("show"),$confirmMoneyDialog.on("hide.bs.modal",function(){$("form div.cart-item",$confirmMoneyDialog).remove()})}),$('button[name="handle-confirm-money"]').on("click",function(e){e.preventDefault();var $postData={};$postData.order_id=$confirmOrderId.val(),$postData.cart_map=[],$.each(cartJsonData,function(index,item){if(0==item.confirm_price){var cartId=item.id,$cartDom=$("#cart_"+cartId,$confirmMoneyDialog),cartOriginPrice=$cartDom.data("origin-price"),cartPrice=$cartDom.val()||cartOriginPrice,cartProductId=item.product_id,cartMapData={};cartMapData.product_id=cartProductId,cartMapData.price=cartPrice,$postData.cart_map.push(cartMapData)}});var $postJsonStr=JSON.stringify($postData);$.post("/weshares/confirm_price.json",{data:$postJsonStr},function(result){if(result.success){var orderId=result.order_id,difference_price=parseFloat(result.difference_price),$priceConfirmBtn=$("#price-confirm-btn-"+orderId);$priceConfirmBtn.unbind();var $parent=$priceConfirmBtn.parent("div.offer-content");$parent=$parent.parent();var $statusLabel=$("#process-prepaid-status span",$parent);difference_price>0?$statusLabel.removeClass().addClass("label").addClass("label-info").text("待补款"):0>difference_price?$statusLabel.removeClass().addClass("label").addClass("label-info").text("待退差价"):$statusLabel.removeClass().addClass("label").addClass("label-info").text("无差价"),$priceConfirmBtn.remove(),$confirmMoneyDialog.modal("hide")}else alert("保存失败,请联系客服")},"json")});var $refundShareDialog=$("#refund-share-dialog"),$refundShareOfflineAddress=$("#refund-share-address",$refundShareDialog),$refundShareId=$("#refund-share-id",$refundShareDialog),$refundShareRemark=$("#refund-share-msg",$refundShareDialog);$("button.refund-share-money").on("click",function(e){e.preventDefault();var $me=$(this),address=$me.data("address"),shareId=$me.data("id");$refundShareOfflineAddress.val(address),$refundShareId.val(shareId),$refundShareRemark.val(""),$refundShareDialog.modal("show")}),$('button[name="handle-refund-share-money"]').on("click",function(e){e.preventDefault();var refundMark=$refundShareRemark.val(),shareId=$refundShareId.val();if(!refundMark)return alert("请输入退款原因"),!1;var postData={refundMark:refundMark};$.post("/weshares/refund_share/"+shareId+".json",postData,function(data){data.success&&($("#refund-share-btn-"+shareId).remove(),$refundShareDialog.modal("hide"))},"json")});var $toEditOrderShipInfoBtn=$("button.edit-ship-code"),$editOrderShipInfoForm=$("div.update-ship-info-dialog"),$editOrderShipTypeNameEl=$('input[name="ship_type_name"]',$editOrderShipInfoForm),$editOrderShipCodeEl=$('input[name="ship_code"]',$editOrderShipInfoForm),$editOrderShipOrderId=$('input[name="order_id"]',$editOrderShipInfoForm),$handleUpdateShipCodeBtn=$('button[name="handle-update-ship-code"]',$editOrderShipInfoForm);$toEditOrderShipInfoBtn.on("click",function(e){e.preventDefault();var $me=$(this),orderId=$me.data("order-id"),$shipInfoP=$me.parent(),shipTypeName=$('strong[name="order_ship_type_name"]',$shipInfoP).text(),shipCode=$('strong[name="order_ship_code"]',$shipInfoP).text();$editOrderShipTypeNameEl.val(shipTypeName),$editOrderShipCodeEl.val(shipCode),$editOrderShipOrderId.val(orderId),$editOrderShipInfoForm.modal("show")}),$handleUpdateShipCodeBtn.on("click",function(e){e.preventDefault();var $me=$(this),weshare_id=$me.data("id"),order_id=$editOrderShipOrderId.val(),ship_type_name=$editOrderShipTypeNameEl.val(),ship_code=$editOrderShipCodeEl.val();if(!ship_code||!ship_type_name)return alert("请输入快递单号和快递公司"),!1;var postData={order_id:order_id,ship_type_name:ship_type_name,ship_code:ship_code,weshare_id:weshare_id};$.post("/weshares/update_order_ship_code",postData,function(data){if(data.success){var $currentOrderShipInfo=$("#order-ship-info-"+order_id);$('strong[name="order_ship_type_name"]',$currentOrderShipInfo).text(ship_type_name),$('strong[name="order_ship_code"]',$currentOrderShipInfo).text(ship_code),$editOrderShipOrderId.val(""),$editOrderShipTypeNameEl.val(""),$editOrderShipCodeEl.val(""),$editOrderShipInfoForm.modal("hide")}},"json")});var $toEditOrderRemarkInfoBtn=$("button.remark-order"),$editOrderRemarkInfoForm=$("div.update-order-remark-dialog"),$editOrderRemarkOrderId=$('input[name="order_id"]',$editOrderRemarkInfoForm),$editOrderRemarkContent=$('textarea[name="order_remark"]',$editOrderRemarkInfoForm),$handleUpdateOrderRemarkBtn=$('button[name="handle-update-order-remark"]',$editOrderRemarkInfoForm);$toEditOrderRemarkInfoBtn.on("click",function(e){e.preventDefault();var $me=$(this),orderId=$me.data("order-id"),oldRemark=$me.data("order-remark");$editOrderRemarkOrderId.val(orderId),$editOrderRemarkContent.val(oldRemark),$editOrderRemarkInfoForm.modal("show")}),$handleUpdateOrderRemarkBtn.on("click",function(e){e.preventDefault();var orderId=$editOrderRemarkOrderId.val(),orderRemark=$editOrderRemarkContent.val(),$me=$(this),weshare_id=$me.data("id");if(!orderRemark.trim())return void alert("请输入备注信息！");var postData={order_id:orderId,order_remark:orderRemark,weshare_id:weshare_id};$.post("/weshares/update_order_remark",postData,function(data){if(data.success){var $orderInfoPanel=$("#order-info-panel-"+orderId),$orderRemarkHolder=$('span[name="order-remark"]',$orderInfoPanel);$orderRemarkHolder.length?$orderRemarkHolder.text(orderRemark):$orderInfoPanel.append('<strong name="order-remark">备注:</strong>&nbsp;&nbsp;<span name="order-remark">'+orderRemark+"</span>"),$("#remark-order-"+orderId).data("order-remark",orderRemark)}else alert("标记失败！");$editOrderRemarkInfoForm.modal("hide")},"json")})});