$(document).ready(function(){var e=$("#order-tag-toggle");var r=$("li",e);var a=$("div.div-order-item");var t=$("tr.summery-product-item");var i=$("tr.order-data-summery");var n=$("#self-ziti-orders");var s="all";var d="all";var o="";var v=$("#filter-order");var l=$("#filterOrderText");$("div.offer .div-share-item").on("click",function(e){e.preventDefault();var r=$(this);var a=r.parentsUntil("div.col-xs-12").parent("div.col-xs-12");var t=a.data("id");window.location.href="/weshares/view/"+t});function c(){if(r.length>0){$("li:first",e).trigger("click")}}r.on("click",function(e){e.preventDefault();var a=$(this);var t=a.data("id");f(t);r.removeClass("active");a.addClass("active")});c();function f(e){s=e;if(e=="all"){a.show();t.show();i.hide();$('tr[name="order-data-summery-all"]').show()}else{a.hide();t.hide();b(s,d,o);$('tr[name="summery-product-'+e+'"]').show();i.hide();$('tr[name="order-data-summery-'+e+'"]').show()}}var u="";var p=$("#self-ziti-orders");$('select[name="ship_company_code"]').on("change",function(){var e=this.value;$("option[value='"+e+"']").prop("selected",true)});$("ul.nav-tabs li a").on("click",function(){var e=$(this);u=e.data("order-type");if(u=="self_ziti"){$("#send_product_arrive_msg").show()}else{$("#send_product_arrive_msg").hide()}});$("ul.nav-tabs li:first a").trigger("click");$("button.set-order-ship-code").on("click",function(){var e=$(this);var r=e.parentsUntil("div.col-xs-12");var a=e.parent("div");var t=$("select[name=ship_company_code]",a);var i=$("input[name=ship_code]",a);var n=e.data("order-id");var s=t.val();var d=i.val();var o=e.data("weshare-id");var v=$("option:selected",t).text();$.post("/weshares/set_order_ship_code",{order_id:n,company_id:s,ship_code:d,weshare_id:o},function(e){if(e["success"]){r.removeClass("offer-success").addClass("offer-warning");$("div.shape-text",r).text("已发货");a.parent("div.offer-content").append("<p><strong>"+v+":</strong><strong>"+d+"</strong> </p>");a.remove()}},"json")});var m=$("ul.nav-pills li");var h=$('font[name="self-ziti-orders-count"]');var _=$('font[name="kuaidi-orders-count"]');var g=$('font[name="pys-ziti-orders-count"]');v.on("click",function(e){e.preventDefault();var r=l.val();o=r.trim();b(s,d,o)});m.on("click",function(e){e.preventDefault();m.removeClass("disabled");var r=$(this);r.addClass("disabled");var a=r.data("toggle-val");d=a;b(s,d,o)});function b(e,r,t){a.hide();var i=a;if(e=="all"){if(r!="all"){i=a.filter('div[data-order-status="'+r+'"]')}}else{if(r=="all"){i=$('div[name="order-item-tag-'+e+'"]')}else{i=$('div[name="order-item-tag-'+e+'"]').filter('div[data-order-status="'+r+'"]')}}if(t){i=i.filter(function(){if($('p[id^="order-info-panel"]',$(this)).text().indexOf(t)!=-1){return true}else{return false}})}i.show();if(h.length){h.text(i.filter('div[data-order-ship-type="self_ziti"]').length)}if(_.length){_.text(i.filter('div[data-order-ship-type="kuai_di"]').length)}if(g.length){g.text(i.filter('div[data-order-ship-type="pys_ziti"]').length)}}$('button[name="set_order_received"]').on("click",function(e){e.preventDefault();var r=$(this);bootbox.confirm("确定已签收?",function(e){if(!e){return}var a=r.data("order-id");var t=r.parentsUntil("div.col-xs-12");$.getJSON("/weshares/confirmReceived/"+a,function(e){if(e["success"]){t.removeClass("offer-success").addClass("offer-warning");$("div.shape-text",t).text("已取货");r.remove()}else{alert("更新失败")}})})});$('button[name="send_product_arrival_msg"]').on("click",function(e){e.preventDefault();var r=$("#arrival_msg");var a=r.val();if(!a||!a.trim()){return}var t=$(this).data("id");var i=$("div.div-order-item:visible",n);var s=[];i.each(function(e,r){var a=$(r);s.push(a.data("id"))});var d=s.join(",");var o={msg:a,share_id:t,ids:d};$.ajax({type:"POST",url:"/weshares/send_arrival_msg",data:JSON.stringify(o),success:function(e){$("div.send-msg-dialog").modal("hide");var r=$('div[data-order-status="1"]',p);r.each(function(e,r){var a=$(r);a.removeClass("offer-success").addClass("offer-warning");$("div.shape-text",a).text("已发货");a.data("order-status","2")})},contentType:"application/json",dataType:"json"})});var k=$("#set_share_shipped_dialog");var y=$("#set_shipped_share_id",k);var w=$("#share_arrival_msg",k);var x=$("#set_shipped_refer_share_id",k);var C=$("#set_shipped_address",k);$("button.set-shipped-share").on("click",function(e){e.preventDefault();var r=$(this);var a=r.data("id");var t=r.data("refer-share-id");var i=r.data("address");x.val(t);C.val(C);y.val(a);k.modal("show")});$('button[name="set-share-shipped"]').on("click",function(e){e.preventDefault();var r=w.val();if(!r||!r.trim()){return}var a=y.val();var t=x.val();var i=C.val();var n={share_id:a,refer_share_id:t,address:i,msg:r};$.post("/weshares/set_share_shipped",n,function(){var e=$("#set-share-shipped-btn-"+a);e.unbind();var r=e.parent("div.offer-content");r=r.parent();r.removeClass().addClass("offer").addClass("offer-success");$("div.shape-text",r).text("已发货");e.remove();k.modal("hide")},"json")});var D=$("#refund-money-dialog");var j=$("#refund-order-user",D);var z=$("#refund-order-id",D);var O=$("#refund-money",D);var N=$("#refund-msg",D);$('button[name="handle-refund-money"]').on("click",function(e){e.preventDefault();var r=$(this);var a=O.val();if(isNaN(a)){alert("请输入退款金额");return false}var t=N.val();if(!t){alert("请输入退款原因");return false}var i={orderId:z.val(),shareId:r.data("id"),refundMoney:O.val(),refundMark:N.val()};$.post("/weshares/refund_money.json",i,function(e){if(e["success"]){var r=e["order_id"];var a=$("#refund-btn-"+r);a.unbind();var t=a.parent("div.offer-content");t=t.parent();t.removeClass().addClass("offer").addClass("offer-danger");$("div.shape-text",t).text("退款中");a.remove();D.modal("hide")}},"json")});$("button.refund-money").on("click",function(e){e.preventDefault();var r=$(this);var a=r.data("order-id");var t=r.data("order-name");j.val(t);z.val(a);O.val(0);N.val("");D.modal("show")});var S=$("#confirm-money-dialog");var J=$("#confirm-order-id",S);var T=$("#confirm-order-user",S);var M="";var U={};$("button.price-confirm").on("click",function(e){e.preventDefault();var r=$(this);var a=r.data("order-id");var t=r.data("order-name");J.val(a);T.val(t);M=$("#order-cart-info-"+a).val();U=JSON.parse(M);var i="";$.each(U,function(e,r){if(r["confirm_price"]==0){i=i+'<div class="form-group cart-item">'+'<label for="refund-money" class="col-sm-2 control-label">'+r["name"]+"X"+r["num"]+"&nbsp;&nbsp;已经预付"+r["price"]*r["num"]/100+"</label>"+'<div class="col-sm-10">'+'<input type="number" placeholder="实际价格" class="form-control" id="cart_'+r["id"]+'" data-origin-price="'+r["price"]*r["num"]+'">'+"</div>"+"</div>"}});$("form",S).append(i);S.modal("show");S.on("hide.bs.modal",function(){$("form div.cart-item",S).remove()})});$('button[name="handle-confirm-money"]').on("click",function(e){e.preventDefault();var r={};r["order_id"]=J.val();r["cart_map"]=[];$.each(U,function(e,a){if(a["confirm_price"]==0){var t=a["id"];var i=$("#cart_"+t,S);var n=i.data("origin-price");var s=i.val()||n;var d=a["product_id"];var o={};o["product_id"]=d;o["price"]=s;r["cart_map"].push(o)}});var a=JSON.stringify(r);$.post("/weshares/confirm_price.json",{data:a},function(e){if(e["success"]){var r=e["order_id"];var a=parseFloat(e["difference_price"]);var t=$("#price-confirm-btn-"+r);t.unbind();var i=t.parent("div.offer-content");i=i.parent();var n=$("#process-prepaid-status span",i);if(a>0){n.removeClass().addClass("label").addClass("label-info").text("待补款")}else if(a<0){n.removeClass().addClass("label").addClass("label-info").text("待退差价")}else{n.removeClass().addClass("label").addClass("label-info").text("无差价")}t.remove();S.modal("hide")}else{alert("保存失败,请联系客服")}},"json")});var I=$("#refund-share-dialog");var F=$("#refund-share-address",I);var P=$("#refund-share-id",I);var R=$("#refund-share-msg",I);$("button.refund-share-money").on("click",function(e){e.preventDefault();var r=$(this);var a=r.data("address");var t=r.data("id");F.val(a);P.val(t);R.val("");I.modal("show")});$('button[name="handle-refund-share-money"]').on("click",function(e){e.preventDefault();var r=R.val();var a=P.val();if(!r){alert("请输入退款原因");return false}var t={refundMark:r};$.post("/weshares/refund_share/"+a+".json",t,function(e){if(e["success"]){$("#refund-share-btn-"+a).remove();I.modal("hide")}},"json")});var X=$("button.edit-ship-code");var q=$("div.update-ship-info-dialog");var A=$('input[name="ship_type_name"]',q);var B=$('input[name="ship_code"]',q);var E=$('input[name="order_id"]',q);var G=$('button[name="handle-update-ship-code"]',q);X.on("click",function(e){e.preventDefault();var r=$(this);var a=r.data("order-id");var t=r.parent();var i=$('strong[name="order_ship_type_name"]',t).text();var n=$('strong[name="order_ship_code"]',t).text();A.val(i);B.val(n);E.val(a);q.modal("show")});G.on("click",function(e){e.preventDefault();var r=$(this);var a=r.data("id");var t=E.val();var i=A.val();var n=B.val();if(!n||!i){alert("请输入快递单号和快递公司");return false}var s={order_id:t,ship_type_name:i,ship_code:n,weshare_id:a};$.post("/weshares/update_order_ship_code",s,function(e){if(e["success"]){var r=$("#order-ship-info-"+t);$('strong[name="order_ship_type_name"]',r).text(i);$('strong[name="order_ship_code"]',r).text(n);E.val("");A.val("");B.val("");q.modal("hide")}},"json")});var H=$("button.remark-order");var K=$("div.update-order-remark-dialog");var L=$('input[name="order_id"]',K);var Q=$('textarea[name="order_remark"]',K);var V=$('button[name="handle-update-order-remark"]',K);H.on("click",function(e){e.preventDefault();var r=$(this);var a=r.data("order-id");var t=r.data("order-remark");L.val(a);Q.val(t);K.modal("show")});V.on("click",function(e){e.preventDefault();var r=L.val();var a=Q.val();var t=$(this);var i=t.data("id");if(!a.trim()){alert("请输入备注信息！");return}var n={order_id:r,order_remark:a,weshare_id:i};$.post("/weshares/update_order_remark",n,function(e){if(e["success"]){var t=$("#order-info-panel-"+r);var i=$('span[name="order-remark"]',t);if(i.length){i.text(a)}else{t.append('<strong name="order-remark">备注:</strong>&nbsp;&nbsp;<span name="order-remark">'+a+"</span>")}$("#remark-order-"+r).data("order-remark",a)}else{alert("标记失败！")}K.modal("hide")},"json")})});