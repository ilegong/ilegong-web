$(document).ready(function(){var e=$("#order-tag-toggle");var a=$("li",e);var r=$("div.div-order-item");var t=$("tr.summery-product-item");var n=$("tr.order-data-summery");var i=$("#self-ziti-orders");var s="all";var d="all";$("div.offer .div-share-item").on("click",function(e){e.preventDefault();var a=$(this);var r=a.parentsUntil("div.col-xs-12").parent("div.col-xs-12");var t=r.data("id");window.location.href="/weshares/view/"+t});function o(){if(a.length>0){$("li:first",e).trigger("click")}}a.on("click",function(e){e.preventDefault();var r=$(this);var t=r.data("id");v(t);a.removeClass("active");r.addClass("active")});o();function v(e){s=e;if(e=="all"){r.show();t.show();n.hide();$('tr[name="order-data-summery-all"]').show()}else{r.hide();t.hide();h(s,d);$('tr[name="summery-product-'+e+'"]').show();n.hide();$('tr[name="order-data-summery-'+e+'"]').show()}}var l="";var c=$("#self-ziti-orders");$('select[name="ship_company_code"]').on("change",function(){var e=this.value;$("option[value='"+e+"']").prop("selected",true)});$("ul.nav-tabs li a").on("click",function(){var e=$(this);l=e.data("order-type");if(l=="self_ziti"){$("#send_product_arrive_msg").show()}else{$("#send_product_arrive_msg").hide()}});$("ul.nav-tabs li:first a").trigger("click");$("button.set-order-ship-code").on("click",function(){var e=$(this);var a=e.parentsUntil("div.col-xs-12");var r=e.parent("div");var t=$("select[name=ship_company_code]",r);var n=$("input[name=ship_code]",r);var i=e.data("order-id");var s=t.val();var d=n.val();var o=e.data("weshare-id");var v=$("option:selected",t).text();$.post("/weshares/set_order_ship_code",{order_id:i,company_id:s,ship_code:d,weshare_id:o},function(e){if(e["success"]){a.removeClass("offer-success").addClass("offer-warning");$("div.shape-text",a).text("已发货");r.parent("div.offer-content").append("<p><strong>"+v+":</strong><strong>"+d+"</strong> </p>");r.remove()}},"json")});var f=$("ul.nav-pills li");var u=$('font[name="self-ziti-orders-count"]');var p=$('font[name="kuaidi-orders-count"]');var m=$('font[name="pys-ziti-orders-count"]');f.on("click",function(e){e.preventDefault();f.removeClass("disabled");var a=$(this);a.addClass("disabled");var r=a.data("toggle-val");d=r;h(s,d)});function h(e,a){r.hide();var t=r;if(e=="all"){if(a!="all"){t=r.filter('div[data-order-status="'+a+'"]')}}else{if(a=="all"){t=$('div[name="order-item-tag-'+e+'"]')}else{t=$('div[name="order-item-tag-'+e+'"]').filter('div[data-order-status="'+a+'"]')}}t.show();if(u.length){u.text(t.filter('div[data-order-ship-type="self_ziti"]').length)}if(p.length){p.text(t.filter('div[data-order-ship-type="kuai_di"]').length)}if(m.length){m.text(t.filter('div[data-order-ship-type="pys_ziti"]').length)}}$('button[name="set_order_received"]').on("click",function(e){e.preventDefault();var a=$(this);bootbox.confirm("确定已签收?",function(e){if(!e){return}var r=a.data("order-id");var t=a.parentsUntil("div.col-xs-12");$.getJSON("/weshares/confirmReceived/"+r,function(e){if(e["success"]){t.removeClass("offer-success").addClass("offer-warning");$("div.shape-text",t).text("已取货");a.remove()}else{alert("更新失败")}})})});$('button[name="send_product_arrival_msg"]').on("click",function(e){e.preventDefault();var a=$("#arrival_msg");var r=a.val();if(!r||!r.trim()){return}var t=$(this).data("id");var n=$("div.div-order-item:visible",i);var s=[];n.each(function(e,a){var r=$(a);s.push(r.data("id"))});var d=s.join(",");var o={msg:r,share_id:t,ids:d};$.ajax({type:"POST",url:"/weshares/send_arrival_msg",data:JSON.stringify(o),success:function(e){$("div.send-msg-dialog").modal("hide");var a=$('div[data-order-status="1"]',c);a.each(function(e,a){var r=$(a);r.removeClass("offer-success").addClass("offer-warning");$("div.shape-text",r).text("已发货");r.data("order-status","2")})},contentType:"application/json",dataType:"json"})});var _=$("#set_share_shipped_dialog");var g=$("#set_shipped_share_id",_);var b=$("#share_arrival_msg",_);var y=$("#set_shipped_refer_share_id",_);var k=$("#set_shipped_address",_);$("button.set-shipped-share").on("click",function(e){e.preventDefault();var a=$(this);var r=a.data("id");var t=a.data("refer-share-id");var n=a.data("address");y.val(t);k.val(k);g.val(r);_.modal("show")});$('button[name="set-share-shipped"]').on("click",function(e){e.preventDefault();var a=b.val();if(!a||!a.trim()){return}var r=g.val();var t=y.val();var n=k.val();var i={share_id:r,refer_share_id:t,address:n,msg:a};$.post("/weshares/set_share_shipped",i,function(){var e=$("#set-share-shipped-btn-"+r);e.unbind();var a=e.parent("div.offer-content");a=a.parent();a.removeClass().addClass("offer").addClass("offer-success");$("div.shape-text",a).text("已发货");e.remove();_.modal("hide")},"json")});var w=$("#refund-money-dialog");var x=$("#refund-order-user",w);var C=$("#refund-order-id",w);var D=$("#refund-money",w);var j=$("#refund-msg",w);$('button[name="handle-refund-money"]').on("click",function(e){e.preventDefault();var a=$(this);var r=D.val();if(isNaN(r)){alert("请输入退款金额");return false}var t=j.val();if(!t){alert("请输入退款原因");return false}var n={orderId:C.val(),shareId:a.data("id"),refundMoney:D.val(),refundMark:j.val()};$.post("/weshares/refund_money.json",n,function(e){if(e["success"]){var a=e["order_id"];var r=$("#refund-btn-"+a);r.unbind();var t=r.parent("div.offer-content");t=t.parent();t.removeClass().addClass("offer").addClass("offer-danger");$("div.shape-text",t).text("退款中");r.remove();w.modal("hide")}},"json")});$("button.refund-money").on("click",function(e){e.preventDefault();var a=$(this);var r=a.data("order-id");var t=a.data("order-name");x.val(t);C.val(r);D.val(0);j.val("");w.modal("show")});var z=$("#confirm-money-dialog");var N=$("#confirm-order-id",z);var O=$("#confirm-order-user",z);var S="";var J={};$("button.price-confirm").on("click",function(e){e.preventDefault();var a=$(this);var r=a.data("order-id");var t=a.data("order-name");N.val(r);O.val(t);S=$("#order-cart-info-"+r).val();J=JSON.parse(S);var n="";$.each(J,function(e,a){if(a["confirm_price"]==0){n=n+'<div class="form-group cart-item">'+'<label for="refund-money" class="col-sm-2 control-label">'+a["name"]+"X"+a["num"]+"&nbsp;&nbsp;已经预付"+a["price"]*a["num"]/100+"</label>"+'<div class="col-sm-10">'+'<input type="number" placeholder="实际价格" class="form-control" id="cart_'+a["id"]+'" data-origin-price="'+a["price"]*a["num"]+'">'+"</div>"+"</div>"}});$("form",z).append(n);z.modal("show");z.on("hide.bs.modal",function(){$("form div.cart-item",z).remove()})});$('button[name="handle-confirm-money"]').on("click",function(e){e.preventDefault();var a={};a["order_id"]=N.val();a["cart_map"]=[];$.each(J,function(e,r){if(r["confirm_price"]==0){var t=r["id"];var n=$("#cart_"+t,z);var i=n.data("origin-price");var s=n.val()||i;var d=r["product_id"];var o={};o["product_id"]=d;o["price"]=s;a["cart_map"].push(o)}});var r=JSON.stringify(a);$.post("/weshares/confirm_price.json",{data:r},function(e){if(e["success"]){var a=e["order_id"];var r=parseFloat(e["difference_price"]);var t=$("#price-confirm-btn-"+a);t.unbind();var n=t.parent("div.offer-content");n=n.parent();var i=$("#process-prepaid-status span",n);if(r>0){i.removeClass().addClass("label").addClass("label-info").text("待补款")}else if(r<0){i.removeClass().addClass("label").addClass("label-info").text("待退差价")}else{i.removeClass().addClass("label").addClass("label-info").text("无差价")}t.remove();z.modal("hide")}else{alert("保存失败,请联系客服")}},"json")});var M=$("#refund-share-dialog");var T=$("#refund-share-address",M);var U=$("#refund-share-id",M);var I=$("#refund-share-msg",M);$("button.refund-share-money").on("click",function(e){e.preventDefault();var a=$(this);var r=a.data("address");var t=a.data("id");T.val(r);U.val(t);I.val("");M.modal("show")});$('button[name="handle-refund-share-money"]').on("click",function(e){e.preventDefault();var a=I.val();var r=U.val();if(!a){alert("请输入退款原因");return false}var t={refundMark:a};$.post("/weshares/refund_share/"+r+".json",t,function(e){if(e["success"]){$("#refund-share-btn-"+r).remove();M.modal("hide")}},"json")});var F=$("button.edit-ship-code");var P=$("div.update-ship-info-dialog");var R=$('input[name="ship_type_name"]',P);var X=$('input[name="ship_code"]',P);var q=$('input[name="order_id"]',P);var A=$('button[name="handle-update-ship-code"]',P);F.on("click",function(e){e.preventDefault();var a=$(this);var r=a.data("order-id");var t=a.parent();var n=$('strong[name="order_ship_type_name"]',t).text();var i=$('strong[name="order_ship_code"]',t).text();R.val(n);X.val(i);q.val(r);P.modal("show")});A.on("click",function(e){e.preventDefault();var a=$(this);var r=a.data("id");var t=q.val();var n=R.val();var i=X.val();if(!i||!n){alert("请输入快递单号和快递公司");return false}var s={order_id:t,ship_type_name:n,ship_code:i,weshare_id:r};$.post("/weshares/update_order_ship_code",s,function(e){if(e["success"]){var a=$("#order-ship-info-"+t);$('strong[name="order_ship_type_name"]',a).text(n);$('strong[name="order_ship_code"]',a).text(i);q.val("");R.val("");X.val("");P.modal("hide")}},"json")});var B=$("button.remark-order");var E=$("div.update-order-remark-dialog");var G=$('input[name="order_id"]',E);var H=$('textarea[name="order_remark"]',E);var K=$('button[name="handle-update-order-remark"]',E);B.on("click",function(e){e.preventDefault();var a=$(this);var r=a.data("order-id");var t=a.data("order-remark");G.val(r);H.val(t);E.modal("show")});K.on("click",function(e){e.preventDefault();var a=G.val();var r=H.val();var t=$(this);var n=t.data("id");if(!r.trim()){alert("请输入备注信息！");return}var i={order_id:a,order_remark:r,weshare_id:n};$.post("/weshares/update_order_remark",i,function(e){if(e["success"]){var t=$("#order-info-panel-"+a);var n=$('span[name="order-remark"]');if(n.length){n.text(r)}else{t.append('<strong name="order-remark">备注:</strong>&nbsp;&nbsp;<span name="order-remark">'+r+"</span>")}}else{alert("标记失败！")}E.modal("hide")},"json")})});