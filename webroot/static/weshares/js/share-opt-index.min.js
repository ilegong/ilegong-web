!function(window,angular){function ShareOptIndexController($rootScope,$http,$log,$q,$window,Utils){function activate(){vm.shares=[],$http.get("/users/get_id_and_proxies").success(function(data){null!=data.uid&&($rootScope.uid=data.uid,$rootScope.proxies=_.map(data.proxies,function(pid){return parseInt(pid)}))}).error(function(data,e){})}function loadNextPage(){return vm.loading||vm.loadOver?!1:(vm.loading=!0,void vm.loadData().then(function(shares){vm.shares=vm.shares.concat(shares),vm.loading=!1,$rootScope.loadingPage=!1},function(detail){vm.onLoadOver(detail),vm.loading=!1,$rootScope.loadingPage=!1}))}function loadData(){var deferred=$q.defer(),time=_.min(_.map(vm.shares,function(s){return s.NewOptLog.time}));return $http.get("/share_opt/fetch_opt_list_data.json?limit=10&type=0&time="+time).success(function(data){data.error&&deferred.reject(data.error);var existingShareIds=_.map(vm.shares,function(s){return s.Weshare.id}),shares=_.map(_.reject(data.opt_logs,function(s){return _.isEmpty(s)||_.isEmpty(s.Weshare)||_.contains(existingShareIds,s.Weshare.id)}),function(s){return s.NewOptLog.time=new Date(s.NewOptLog.time).getTime(),s});_.isEmpty(shares)&&deferred.reject("no more data");var shareIds=_.map(shares,function(s){return s.Weshare.id});$http.get("/weshares/summaries",{params:{shareIds:JSON.stringify(shareIds)}}).success(function(summaries){_.each(summaries,function(summary){var share=_.find(shares,function(s){return s.Weshare.id==summary.share_id});share.summary=summary})}).error(function(data,e){$log.log("Failed to get summaries: "+e)}),deferred.resolve(shares)}).error(function(data,e){deferred.reject("Failed to load data")}),deferred.promise}function onLoadOver(detail){vm.loadOver=!0}function getShareImage(share){return _.isEmpty(share)||_.isEmpty(share.Weshare.images)?vm.staticFilePath+"/static/img/default_product_banner.png":share.Weshare.images[0]}function scrollToTop(){$window.scrollTo(0,0)}var vm=this;vm.staticFilePath=Utils.staticFilePath(),vm.loadData=loadData,vm.loadNextPage=loadNextPage,vm.onLoadOver=onLoadOver,vm.getShareImage=getShareImage,vm.scrollToTop=scrollToTop,activate()}angular.module("weshares").controller("ShareOptIndexController",ShareOptIndexController)}(window,window.angular),function(window,angular){function SubscriptionController($rootScope,$scope,$http,$log){function activate(){sub.showUnSubscribeBtn=!1,$scope.$on("page_clicked",function(){sub.showUnSubscribeBtn=!1})}function isSubscribed(proxyId){return _.contains($rootScope.proxies,parseInt(proxyId))}function subscribe(proxyId){return $rootScope.uid<0?void($window.location.href="/users/login"):void(sub.subscribeInProcess||(sub.subscribeInProcess=!0,$http.get("/weshares/subscribe_sharer/"+proxyId+"/"+$rootScope.uid).success(function(data){data.success&&$rootScope.proxies.push(parseInt(proxyId)),sub.subscribeInProcess=!1}).error(function(data,e){sub.subscribeInProcess=!1,$log.log("Failed to subscribe: "+e)})))}function unSubscribe(proxyId){return $rootScope.uid<0?void($window.location.href="/users/login"):void(sub.unSubscribeInProcess||(sub.unSubscribeInProcess=!0,$http.get("/weshares/unsubscribe_sharer/"+proxyId+"/"+$rootScope.uid).success(function(data){data.success&&($rootScope.proxies=_.reject($rootScope.proxies,function(proxy){return proxy==proxyId})),sub.unSubscribeInProcess=!1}).error(function(data,e){$log.log("Failed to get proxies: "+e),sub.unSubscribeInProcess=!1})))}function clickSubscribedBtn(proxyId,$event){sub.showUnSubscribeBtn=!0,$event.stopPropagation()}var sub=this;sub.isSubscribed=isSubscribed,sub.unSubscribe=unSubscribe,sub.subscribe=subscribe,sub.clickSubscribedBtn=clickSubscribedBtn,activate()}angular.module("weshares").controller("SubscriptionController",SubscriptionController)}(window,window.angular);