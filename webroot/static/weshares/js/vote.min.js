!function(window,angular,wx){function VoteSignupCtrl($http,$log,$templateCache,$rootScope,Utils){function active(){vm.candidate={title:"",mobileNum:"",images:["http://static.tongshijia.com/images/index/2016/07/19/8d65ff6e-4d87-11e6-b8d8-00163e1600b6.jpg"],description:""}}function signup(eventId){if(Utils.isBlank(vm.candidate.title))return alert("请输入作品名称"),!1;if(Utils.isBlank(vm.candidate.mobileNum))return alert("请输入手机号码"),!1;if(!Utils.isMobileValid(vm.candidate.mobileNum))return alert("手机号码无效"),!1;if(0==vm.candidate.images.length)return alert("请上传图片"),!1;if(Utils.isBlank(vm.candidate.description))return alert("请输入作品描述"),!1;if(!vm.processing){vm.processing=!0;var data={title:vm.candidate.title,mobileNum:vm.candidate.mobileNum,description:vm.candidate.description,images:vm.candidate.images.join("|")};$http.post("/vote/upload_candidate/"+eventId+".json",data).success(function(data){if(vm.processing=!1,data.success)return void alert("报名成功",window.location.href="/vote/vote_event_view/"+eventId);if("not login"==data.reason&&alert("请登录",function(){window.location.href="/users/login.html?referer="+encodeURIComponent("/vote/sign_up/"+eventId)},1e3),"server error"==data.reason&&alert("上传失败请联系客服"),"not subscribed"==data.reason&&alert("请先关注微信服务号",window.location.href="http://mp.weixin.qq.com/s?__biz=MjM5MjY5ODAyOA==&mid=209556231&idx=1&sn=2a60e7f060180c9ecd0792f89694defb#rd"),"has sign"==data.reason){var candidateId=data.candidate_id;alert("已经报过名了",window.location.href="/vote/candidate_detail/"+candidateId+"/"+eventId)}}).error(function(){vm.processing=!1,alert("上传失败请联系客服")})}}function chooseAndUploadImage(){wx.chooseImage({count:10,success:function(res){vm.uploadImage(res.localIds)},fail:function(res){vm.messages.push({name:"choose image failed",detail:res})}})}function uploadImage(localIds){function upload(){wx.uploadImage({localId:localIds[i],isShowProgressTips:1,success:function(res){i++,$http.get("/downloads/download_wx_img?media_id="+res.serverId).success(function(data,status,headers,config){var imageUrl=data.download_url;imageUrl&&"false"!=imageUrl&&vm.candidate.images.push(imageUrl)}).error(function(data){}),len>i&&upload()},fail:function(res){}})}var i=0,len=localIds.length;upload()}function deleteImage(image){vm.candidate.images=_.without(vm.candidate.images,image)}var vm=this;vm.signup=signup,vm.chooseAndUploadImage=chooseAndUploadImage,vm.uploadImage=uploadImage,vm.deleteImage=deleteImage,active()}angular.module("weshares").controller("VoteSignupCtrl",VoteSignupCtrl)}(window,window.angular,window.wx);