<style>
td {padding:5px 10px;}

a.coupon .glyphicon {
    color: #bbbbbb;
}

a.coupon_applied .glyphicon {
    !important;
    color: darkgreen;
}
</style>
<div  class="container">

    {{if $flash_msg}}<div class="alert alert-danger" role="alert">{{$flash_msg}}</div>{{/if}}

    <div class="orderinfo voffset3">
        {{if $specialShipPromotionId}}
        <h2>收货人信息</h2>
        {{if !$limit_ship}}<a id="link_use_promotion" href="{{$this->Html->url('/orders/info?ship_promotion=0')}}">[不使用特惠]</a>{{/if}}
        <ul>
            <li>收货人：<span>{{$this->Session->read('OrderConsignee.name')}}</span></li>
            <li>地址：<span>{{$this->Session->read('OrderConsignee.address')}}</span></li>
            <li>手机号码：<span>{{$this->Session->read('OrderConsignee.mobilephone')}}</span></li>
        </ul>
        {{elseif $specialShipPromotion && !$limit_ship}}
        您购买的商品中有可以运送到特定地址的优惠。 <button id="specialShipPromotion_btn" class="btn-small btn-warning">使用优惠</button>
        {{/if}}

        {{if $specialShipPromotion }}

        {{if (!$specialShipPromotionId)}}<h2>收货人信息</h2>
        {{if $limit_ship}}
        <p class="text-warning">只支持以下快递方式：</p>
        {{/if}}
        {{/if}}
        <div id="specialShipPromotion" style="{{if !$limit_ship || $specialShipPromotionId }}display: none{{/if}}">
            <form method="post" action="{{$this->Html->url(array('action' => 'info', '?' => array('action' => 'savePromo')))}}">
            <ul id="ul_special_promotion" class="list-group">
                {{loop $specialShipPromotion $key $item}}
                    <li item-id="{{$item['id']}}" item-addr-mark="{{!empty($item['need_address_remark'])}}" class="list-group-item {{$specialShipPromotionId == $item['id']? 'active':''}}">
                        {{if isset($item['price'])}}
                        <span class="text-price-small pull-right">{{$this->Number->precision($item['price'], 2)}}</span>{{/if}}
                        <small>{{if $item['time']}}{{$item['time']}}派送到{{/if}}{{$item['address']}}</small></li>
                {{/loop}}
            </ul>
                <input type="text" class="form-control" placeholder="收货人姓名" id="p_consignee_name" name="consignee_name" value="{{$this->Session->read('OrderConsignee.name')}}">
                <input type="text" class="form-control" placeholder="手机号" id="p_consignee_mobile" name="consignee_mobilephone" value="{{$this->Session->read('OrderConsignee.mobilephone')}}" >
                <input type="text" class="form-control" placeholder="详细地址" id="p_consignee_address" style="display: none" name="consignee_address" value="">
                <input type="hidden" id="special_ship_promotion" name="ship_promotion" value="{{$specialShipPromotionId}}">

            <button id="specialShipPromotion_submit" type="submit" class="btn btn-warning">保存</button>
            </form>
        </div>
        {{/if}}

        {{if !$limit_ship}}
		<div id="part_consignee" style="display:{{$specialShipPromotionId ? 'none':''}}">
			{{if $has_chosen_consignee}}
				{{template orders/order_consignee}}
			{{else}}
				{{template orders/edit_consignee}}
			{{/if}}
		</div>
        {{/if}}

		<div id="part_payTypeAndShipType"><!-- template orders/info_shiptype--></div>
		
		<div id="part_invoice"><!-- template orders/order_invoice--></div>
		<hr/>
		<div class="o_show">
            {{loop $cart->brandItems $brandItem}}
		<h4>分享人：{{$brands[$brandItem->id]}}</h4>
		<div class="p-list">
			<table  class="table table-bordered">
			<tbody>
            {{loop $brandItem->items $pid $item}}
			<tr><td>{{$item->name}}</td>
			<td style="width: 80px; font-size: 0.8em">单价：{{$this->Number->precision($item->price, 2)}}</td>
			<td>×{{$item->num}}</td>
			<td>{{$this->Number->precision($item->price*$item->num, 2)}}</td>
			</tr>
			{{/loop}}
			</tbody>
			</table>
            <p>
                <label>给分享人留言：<input type="text" maxlength="50" class="remark" name={{"remark_".$brandItem->id}} /> </label>
            </p>
            <ul>
            <?PHP $coupons = $coupons_of_products[$brandItem->id]; if(!empty($coupons)){ foreach($coupons as $coupon) {
                $applied =$brandItem->coupon_applied($coupon['CouponItem']['id']); ?>
                <li><a data-coupon_item_id="{{$coupon['CouponItem']['id']}}" data-brandId="{{$brandItem->id}}" class="coupon {{if $applied}}coupon_applied{{/if}}" href="javascript:">
                    {{$coupon['Coupon']['name']}}<span class="glyphicon glyphicon-ok"></span></a><span class="applied_result"></span>
                    </li>
            <?PHP } } ?>
            </ul>
		</div>
        {{/loop}}
        </div>
            <div class="clearfix"></div>

        <div>
            <div class="pull-left">
                <a href="/carts/listcart.html">返回购物车</a>
            </div>
		    <div class="pull-right">
                    <p>运费：{{$this->Number->precision($shipFee, 2)}}</p>
                    <p>已优惠：<span id="total_reduced_span">{{$this->Number->precision($total_reduced, 2)}}</span></p>
                    <p>总价<small>(含运费)</small>：<span id="total_price_span">{{$this->Number->precision($cart->total_price() + $shipFee, 2)}}</span></p>
                <a id="submit-button" class="btn btn-primary" onclick="return checkAddress();" href="{{$this->Html->url('/orders/balance/'.($specialShipPromotionId?'?ship_promotion='.$specialShipPromotionId:''))}}">提交订单</a>
            </div>
        </div>

	</div>
</div>
<script>

    $(document).ready(function () {
        $('li > a.coupon').click(function(){
            var $this = $(this);
            var brandId = $this.attr('data-brandId');
            var coupon_item_id = $this.attr('data-coupon_item_id');
            var action = $this.hasClass('coupon_applied') ? 'unapply' : 'apply';
//            var $notifyDlg = utils.progress_notify('');
            $.post('/orders/apply_coupon.json', {'brand_id': brandId, 'coupon_item_id': coupon_item_id, 'action': action}, function(data){
//                $notifyDlg.modal('close');
                if(data) {
                    if(data.changed) {
                        $this.toggleClass('coupon_applied');
                        $('#total_price_span').text(utils.toFixed(data.total_price, 2));
                        $('#total_reduced_span').text(utils.toFixed(data.total_reduced, 2));
                    } else {
                        if (data.reason == 'not_login') {
                            utils.alert('您长时间未操作，请重新登录', function(){
                                window.location.href = '/users/login?refer='+ encodeURIComponent('/carts/listcart');
                            });
                        }
                    }
                }
            }, 'json');
        });


        var $specialShipPromotion = $('#specialShipPromotion');
        var $btnSubmit = $('#specialShipPromotion_submit');
        var $linkUsePromotion = $('#link_use_promotion');
        var lists = $specialShipPromotion.find('li');
        lists.click(function (e) {
            lists.filter('.active').removeClass('active');
            var $this = $(this);
            $this.toggleClass('active');
            var $pConsigneeAddress = $('#p_consignee_address');
            if($this.attr('item-addr-mark') == '1') {
                $pConsigneeAddress.show();
            }  else {
                $pConsigneeAddress.hide();
            }
        });

        $btnSubmit.click(function (e) {
            var activeLi = $specialShipPromotion.find('li.active');
            if (activeLi.length == 1) {

                if(activeLi.attr('item-addr-mark') == '1') {
                    var $pConsigneeAddress = $('#p_consignee_address');
                    if ($pConsigneeAddress.val() == '') {
                        utils.alert('请输入详细地址');
                        $pConsigneeAddress.focus();
                        e.preventDefault();
                        return false;
                    }
                }

                var $itemId = activeLi.attr('item-id');
                $('#special_ship_promotion').val($itemId);
            } else {
                utils.alert('请选择特惠信息运送的时间地点');
                e.preventDefault();
                return false;
            }

            if ($('#p_consignee_name').val() == '') {
                utils.alert('请输入收货人姓名');
                e.preventDefault();
                return false;
            }

            if ($('#p_consignee_mobile').val() == '') {
                utils.alert('请输入收货人手机号码');
                e.preventDefault();
                return false;
            }
        });

        $('#specialShipPromotion_btn').click(function () {
            $specialShipPromotion.toggle();
            if ($specialShipPromotion.is(":visible")) {
                $('#part_consignee').hide();
                $(this).text("不使用特惠");
            } else {
                $('#part_consignee').show();
                $(this).text("使用特惠");
            }
        });
    });

    function checkAddress(){
        if ($('input[name="data[OrderConsignee][ship_promotion]"]').val() == "") {
            if ($('input[name="data[OrderConsignee][id]"]:radio').size() > 0) {
                if ($('input[name="data[OrderConsignee][id]"]:checked').val() == "") {
                    alert("请先点击“保存收货人信息”");
                    return false;
                }
            }
        }

        if ($('#special_ship_promotion').size() > 0) {
            var val = $('#special_ship_promotion').val();
            if (val == '' || val == '0' ) {
                alert("请先保存收货人信息!");
                return false;
            }
        }

        var link = $("#submit-button").attr("href");
        var params = (link.indexOf("?")>-1)?"&":"?";
        $(".remark").each(function(){
            var input_name=$(this).attr("name");
            var input_value=$(this).val();
            if(input_value!=""){
                params = params+input_name+"="+input_value+"&";
            }
        });
        params=params.substring(0,params.length-1);
        $("#submit-button").attr("href",link+params);
        return true;
    }
</script>