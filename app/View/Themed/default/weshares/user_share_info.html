<link href="/static/weshares/css/share-info.css?v0.1.0" rel="stylesheet">
<div class="row" style="background: #EAEAEA;">
    <div class="col-md-12 user-details">
        <div class="user-image">
            {{if $is_me}}
            <a href="/users/change_avatar?ref=/weshares/user_share_info"><img style="width: 80px;height: 80px;" onerror="this.src='/img/default_user_icon.jpg'"
                    src="{{$share_user['image']}}" alt="{{$share_user['nickname']}}" title="{{$share_user['nickname']}}"
                    class="img-circle"></a>
            {{else}}
            <img style="width: 80px;height: 80px;" onerror="this.src='/img/default_user_icon.jpg'"
                 src="{{$share_user['image']}}" alt="{{$share_user['nickname']}}" title="{{$share_user['nickname']}}"
                 class="img-circle">
            {{/if}}
        </div>
        <div class="user-info-block">
            <div class="user-heading">
                <div>
                    <span style="font-size: 16px;font-weight: bold;">{{$share_user['nickname']}}</span>
                    {{if $is_verify_user}}
                    <span class="label label-warning">官方认证</span>
                    {{/if}}
                    {{if $is_support_offline_store > 0}}
                    <span class="label label-info">好邻居支持</span>
                    {{/if}}
                    {{if $is_proxy}}
                    <span class="label label-success">团长</span>
                    {{/if}}
                </div>
                {{if !$is_me}}
                <div style="padding: 5px;" id="sub-div-content">
                    <button id="sub-sharer" class="btn btn-warning btn-sm btn-sub-sharer" {{if $sub_status}}style="display:none;"{{/if}} data-sharer-id="{{$share_user['id']}}" data-user-id="{{$visitor}}">+关注</button>
                    <!-- Single button -->
                    <div id="unsub-sharer" class="btn-group" {{if !$sub_status}}style="display:none;"{{/if}}>
                        <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            已关注 <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu btn-sm" style="min-width: 60px;">
                            <li><a class="btn-unsub-sharer" data-sharer-id="{{$share_user['id']}}" data-user-id="{{$visitor}}">取消关注</a></li>
                        </ul>
                    </div>
                </div>
                {{/if}}
                <div style="margin-top: 10px;margin-bottom: 10px;">
                    <ul style="height: 40px;overflow: hidden;font-size: 18px;display: block;padding: 0;">
                        <li id="show-comment-modal-dialog" style="display:inline-block;width: 65px;text-align: center;border-right-width: 1px;border-right-style: solid;border-color: #d9d9d9;">
                            <a style="display: block;color: #333;text-decoration: none;">
                                <strong style="display: block;font-weight: bold;line-height: 18px;width: 65px;overflow: hidden;color: #449D44;">{{$sharer_comment_data['comment_count']}}</strong>
                                <span style="display: block;font-size: 12px;color: #808080;text-decoration: none;">爱心评价</span>
                            </a>
                        </li>
                        <li id="show-fans-modal-dialog" style="display:inline-block;width: 65px;text-align: center;border-right-width: 1px;border-right-style: solid;border-color: #d9d9d9;">
                            <a style="display: block;color: #333;text-decoration: none;">
                                <strong style="display: block;font-weight: bold;line-height: 18px;width: 65px;overflow: hidden;color: #449D44;">{{$follower_count}}</strong>
                                <span style="display: block;font-size: 12px;color: #808080;text-decoration: none;">粉丝</span>
                            </a>
                        </li>
                        <li id="show-focus-modal-dialog" style="display:inline-block;width: 65px;text-align: center;">
                            <a style="display: block;color: #333;text-decoration: none;">
                                <strong style="display: block;font-weight: bold;line-height: 18px;width: 65px;overflow: hidden;color: #449D44;">{{if empty($focus_count)}}0{{else}}{{$focus_count}}{{/if}}</strong>
                                <span style="display: block;font-size: 12px;color: #808080;text-decoration: none;">关注</span>
                            </a>
                        </li>
                    </ul>
                </div>
                {{if $sharer_comment_data['comment_count']>0}}
                <hr style="margin-top: 5px;margin-bottom: 1px;">
                <div style="text-align: left;">
                    <h4>回复率</h4>
                    <div class="testimonials">
                        <div class="active item">
                            <blockquote><p>{{$this->Number->precision($sharer_comment_data['reply_percent'], 2);}}%</p></blockquote>
                        </div>
                    </div>
                </div>
                {{/if}}
                <hr style="margin-top: 5px;margin-bottom: 1px;">
                <div style="text-align: left;">
                    <h4>关于{{$share_user['nickname']}} {{if $is_me}}&nbsp;&nbsp;<button type="button" class="btn btn-default btn-sm" id="open-update-user-info-dialog">修改</button>{{/if}}</h4>
                    {{if $share_user['description']}}
                    <div class="testimonials">
                        <div class="active item">
                            <blockquote><p id="user-info-placeholder">{{mb_substr($share_user['description'],0,500)}}</p></blockquote>
                        </div>
                    </div>
                    {{/if}}
                </div>
                {{if $show_rebate_money}}
                <hr style="margin-top: 5px;margin-bottom: 1px;">
                <div style="text-align: left;">
                    <h4>我的余额</h4>
                    <div class="testimonials">
                        <div class="active item">
                            <blockquote><p>￥{{$rebate_money}}</p></blockquote>
                        </div>
                    </div>
                </div>
                {{/if}}
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <div class="tabbable-panel">
            <div class="tabbable-line">
                <ul class="nav nav-tabs ">
                    <li class="active">
                        <a href="#tab_default_1" data-toggle="tab">{{if $is_me}}我发起的分享{{else}}TA发起的分享{{/if}}</a>
                    </li>
                    <li>
                        <a href="#tab_default_2" data-toggle="tab">{{if $is_me}}我参加的分享{{else}}TA参加的分享{{/if}}</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="tab_default_1">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="comments-list">
                                    {{loop $my_create_shares $share}}
                                    {{template weshares/user_share_item_template}}
                                    {{/loop}}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="tab_default_2">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="comments-list">
                                    <?php $parsing_join_share = true; ?>
                                    {{loop $my_join_shares $share}}
                                    {{template weshares/user_share_item_template}}
                                    {{/loop}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="commentListModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" style="float: left;" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" style="text-align: center;">{{$sharer_comment_data['comment_count']}}爱心评价</h4>
            </div>
            <div class="modal-body" style="padding: 5px;">
                <div>
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="active"><a href="#receive-comments" role="tab" data-toggle="tab">收到的</a></li>
                        <li role="presentation"><a href="#send-comments" aria-controls="profile" role="tab" data-toggle="tab">评价的</a></li>
                    </ul>
                    <!-- Tab panes -->
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active" id="receive-comments">
                            <div class="">
                                <div class="msg-wrap" style="padding: 0;">
                                    {{loop $sharer_comment_data['comments'] $comment}}
                                    <?php
                                        $comment_user_id = $comment["Comment"]["user_id"];
                                    ?>
                                    <div class="media msg" onclick="window.location.href='/weshares/user_share_info/{{$comment_user_id}}'">
                                        <a class="pull-left" href="/weshares/user_share_info/{{$comment['Comment']['user_id']}}">
                                            <img class="img-circle" alt="64x64" style="width: 32px; height: 32px;" src="{{$sharer_comment_data['comment_users'][$comment['Comment']['user_id']]['image']}}">
                                        </a>
                                        <div class="media-body">
                                            <small class="pull-right time"><i class="fa fa-clock-o"></i>{{friendlyDateFromStr($comment['Comment']['created'], FFDATE_CH_MD);}}</small>
                                            <h5 class="media-heading">{{$comment['Comment']['username']}}</h5>
                                            <small class="col-lg-10" style="padding: 0;">{{$comment['Comment']['body']}}</small>
                                        </div>
                                    </div>
                                    {{/loop}}
                                </div>
                            </div>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="send-comments">
                            <div class="">
                                <div class="msg-wrap" style="padding: 0;">
                                    {{loop $user_comment_data['comments'] $comment}}
                                    <?php
                                        $share_id = $comment['Comment']['data_id'];
                                        $share_creator = $user_comment_data['share_info'][$share_id]['creator'];
                                        $share_creator_nickname = $user_comment_data['share_creators'][$share_creator]['nickname'];
                                        $creator_image = $user_comment_data['share_creators'][$share_creator]['image'];
                                        $title = $share_creator_nickname.'分享的'.$user_comment_data['share_info'][$share_id]['title'];
                                    ?>
                                    <div class="media msg" onclick="window.location.href='/weshares/view/{{$share_id}}'">
                                        <a class="pull-left" href="/weshares/view/{{$share_id}}">
                                            <img class="img-circle" alt="64x64" style="width: 32px; height: 32px;" onerror="this.src='/img/default_user_icon.jpg'" src="{{$creator_image}}">
                                        </a>
                                        <div class="media-body">
                                            <small class="pull-right time"><i class="fa fa-clock-o"></i>{{friendlyDateFromStr($comment['Comment']['created'], FFDATE_CH_MD);}}</small>
                                            <h5 class="media-heading">{{$title}}</h5>
                                            <small class="col-lg-10" style="padding: 0;">{{$comment['Comment']['body']}}</small>
                                        </div>
                                    </div>
                                    {{/loop}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!--focus data-->
<div class="modal fade" id="focusListModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" style="float: left;" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" style="text-align: center;">{{if empty($focus_count)}}0{{else}}{{$focus_count}}{{/if}}关注</h4>
            </div>
            <div class="modal-body">
                <div class="pageContentWrapper" style="height: 75vh;overflow: scroll;">
                    <!-- team members start -->
                    {{loop $focus_data $focus_key $focus_data}}
                    <div class="columnWrapper oneFifth teamMember {{if ($focus_key+1)%5==0}}lastColumn{{/if}}">
                        <a href="/weshares/user_share_info/{{$focus_data['id']}}" class="teamMemberImageLink"> <img style="height: 50px;width: 50px;border-radius: 50px;" src="{{$focus_data['image']}}" class="teamMemberImage" alt="" /> </a>
                        <h3 class="teamMemberName" style="margin-top: 10px;word-wrap: break-word;font-size: 13px;">{{$focus_data['nickname']}}</h3>
                    </div>
                    {{/loop}}
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div>
</div>
<!--fans data-->
<div class="modal fade" id="fansListModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" style="float: left;" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" style="text-align: center;">{{$follower_count}}粉丝</h4>
            </div>
            <div class="modal-body">
                <div class="pageContentWrapper" style="height: 75vh;overflow: scroll;">
                    <!-- team members start -->
                    <?php
                        $fans_user_info = $fans_data['fans_data'];
                        $fans_relations = $fans_data['relations'];
                        $fan_key = 0;
                     ?>
                    {{loop $fans_relations $fan_id}}
                        <?php $fan_data = $fans_user_info[$fan_id]; ?>
                        <div class="columnWrapper oneFifth teamMember {{if ($fan_key+1)%5==0}}lastColumn{{/if}}">
                            <a href="/weshares/user_share_info/{{$fan_data['id']}}" class="teamMemberImageLink"> <img style="height: 50px;width: 50px;border-radius: 50px;" src="{{$fan_data['image']}}" class="teamMemberImage" alt="" /> </a>
                            <h3 class="teamMemberName" style="margin-top: 10px;word-wrap: break-word;font-size: 13px;">{{$fan_data['nickname']}}</h3>
                        </div>
                        <?php $fan_key = $fan_key + 1; ?>
                    {{/loop}}
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>
<!--update user info -->
<div class="modal fade" id="updateUserInfo">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">修改个人资料</h4>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="user-info-textarea">简介</label>
                            <input type="hidden" id="user-id" value="{{$current_uid}}">
                            <textarea class="form-control" id="user-info-textarea" style="height: 100px;">{{$share_user['description']}}</textarea>
                            <p class="help-block">不要超过500字.</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="save-user-intro">保存</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        //show-focus-modal-dialog
        //show-fans-modal-dialog
        //show-comment-modal-dialog
        var $userInfoPlaceHolder = $('#user-info-placeholder');
        var $showCommentLi = $('#show-comment-modal-dialog');
        var $commentModalDialog = $('#commentListModal');
        var $showFansLi = $('#show-fans-modal-dialog');
        var $fansModalDialog = $('#fansListModal');
        var $showFocusLi = $('#show-focus-modal-dialog');
        var $focusModalDialog = $('#focusListModal');
        var $showUpdateUserInfoDialog = $('#open-update-user-info-dialog');
        var $changeUserInfoDialog = $('#updateUserInfo');
        var $saveUserIntro = $('#save-user-intro');
        var $userInfoTextArea = $('#user-info-textarea');
        var $userId = $('#user-id', $changeUserInfoDialog);
        var processSub = false;
        var processUnSub = false;
        $showUpdateUserInfoDialog.on('click', function(){
            $changeUserInfoDialog.modal({show:true, backdrop:'static'});
        });
        $showCommentLi.on('click',function(){
            $commentModalDialog.modal({show:true,backdrop:'static'});
        });
        $showFansLi.on('click',function(){
            $fansModalDialog.modal({show:true,backdrop:'static'});
        });
        $showFocusLi.on('click',function(){
            $focusModalDialog.modal({show:true,backdrop:'static'});
        });
        $saveUserIntro.on('click', function(e){
            e.preventDefault();
            var userIntro = $userInfoTextArea.val();
            var userId = $userId.val();
            if(!userIntro||!userIntro.trim()){
                alert('请输入个人介绍');
                return false;
            }
            $.post('/users/update_user_intro', {
                'user_intro': userIntro, 'user_id': userId
            }, function (data) {
                if(data['success']){
                    $userInfoPlaceHolder.text(userIntro);
                }
                $changeUserInfoDialog.modal('hide');
            }, 'json');
        });
        $('button.btn-sub-sharer').on('click', function(e){
            e.preventDefault();
            if(processSub){
                return;
            }
            processSub = true;
            var $me = $(this);
            var sharer_id = $me.data('sharer-id');
            var user_id  = $me.data('user-id');
            $.getJSON('/weshares/subscribe_sharer/'+sharer_id+'/'+user_id, function(data){
                if(data['success']){
                    processSub = false;
                    $('#unsub-sharer').show();
                    $('#sub-sharer').hide();
                }else{
                    if(data['reason'] = 'not_sub'){
                        processSub = false;
                        alert('请先关注朋友说微信公众号！');
                        window.location.href = "http://mp.weixin.qq.com/s?__biz=MjM5MjY5ODAyOA==&mid=400154588&idx=1&sn=5568f4566698bacbc5a1f5ffeab4ccc3";
                    }
                }
            });
        });
        $('a.btn-unsub-sharer').on('click', function(e){
            e.preventDefault();
            if(processUnSub){
                return;
            }
            processUnSub = true;
            var $me = $(this);
            var sharer_id = $me.data('sharer-id');
            var user_id  = $me.data('user-id');
            $.getJSON('/weshares/unsubscribe_sharer/'+sharer_id+'/'+user_id, function(data){
                if(data['success']){
                    if(data['success']){
                        processUnSub = false;
                        $('#unsub-sharer').hide();
                        $('#sub-sharer').show();
                    }
                }
            });
        });
        $('div[name="share_item"]').on('click', function () {
            var $me = $(this);
            var id = $me.data('id');
            window.location.href = '/weshares/view/' + id;
        });
    });
</script>