<style>
td {padding:3px 3px !important; }
    .cart-num-input {
        padding: 4px 1px;
    }

    .input-group-addon {
        width: 0;
    }

    .cart-title img {
        max-width: 6em;
    }
</style>
<script>

    $(document).ready(function() {

        $('#submit_btn').click(function(){
            return sso.check_userlogin({'referer' : '/carts/listcart.html'});
        });

        function editCartNum(id, num) {
            $('#price-' + id).html(utils.toFixed($('#pamount-' + id).data('price') * num, 2));
            var total_price = 0;
            $('.item-price').each(function () {
                total_price += parseFloat($(this).html());
            });
            $('#total-price').html(utils.toFixed(total_price, 2));
            var url = BASEURL + '/carts/editCartNum/' + id + '/' + num;
            // var postdata = {'data[Cart][num]':num,'data[Cart][product_id]':id};
            if (!sso.check_userlogin({"callback": editCartNum, "callback_args": arguments}))
                return false;
            ajaxAction(url, null, null, function (data) {
                if (data && data.success) {
                    if (typeof(updateCartItemCount) === 'function') {
                        updateCartItemCount();
                    }
                }
            }, {'id': id, 'num': num});
            return false;
        }

        //add to global
        cart_edit_amount = {
            modify: function (obj) {
                editAmount.modify(obj);
            },
            amount: function (obj, mode) {
                editAmount.amount(obj, mode);
            },
            reduce: function (obj) {
                editAmount.reduce(obj, function (obj) {
                    editCartNum($(obj).data('id'), $(obj).val());
                });
            },
            add: function (obj) {
                editAmount.add(obj, function (obj) {
                    editCartNum($(obj).data('id'), $(obj).val());
                });
            }
        };
    });
</script>
<div class="container">
<form action="{{$this->Html->url('/orders/info?from=list_cart')}}" method="post">
    <table class="table table-striped table-bordered table-hover">
        <thead>
        <tr>
            <th>名称</th>
            <th>价格</th>
            <th>数量</th>
            <th>合计</th>
        </tr>
        </thead>
        {{loop $Carts $c_id $cart}}
        <tr>
            <td class="cart-title"><a href="{{product_link($cart['product_id'], 'javascript:;')}}">{{$cart['name']}}<br/>
                {{$this->Html->image(Router::url(small_thumb_link($cart['coverimg'])))}}
                </a>
            </td>
            <td>{{$this->Number->precision($cart['price'], 2)}}</td>
            <td>
                <div class="input-group">
                    <span class="reduce input-group-addon"
                          onclick="cart_edit_amount.reduce('#pamount-{{$cart['id']}}')">-</span>
                    <input type="text" disabled="disabled" size="3" id="pamount-{{$cart['id']}}"
                           data-id="{{$cart['id']}}"
                           data-price="{{$cart['price']}}" class="cart-num-input"
                           name="data[Cart][{{$cart['id']}}][num]" value="{{$cart['num']}}"/>
                    <span class="add input-group-addon"
                          onclick="cart_edit_amount.add('#pamount-{{$cart['id']}}')">+</span>
                </div>
            </td>
            <td><span class="item-price" id="price-{{$cart['id']}}">{{$this->Number->precision($cart['price']*$cart['num'], 2)}}</span>
                {{$this->Html->link(__('delete'),Router::url('/carts/delete/'.$cart['id']))}}
            </td>
        </tr>
        {{/loop}}
        <thead>
        <tr>
            <td colspan="4" style="text-align: right"><span id="total-price">总价：{{$this->Number->precision($total_price, 2)}}</span>
                <input id="submit_btn" class="btn btn-warning" type="submit" value="结算"/></td>
        </tr>
        </thead>
    </table>

</form>
</div>
