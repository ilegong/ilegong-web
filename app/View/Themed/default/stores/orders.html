<div class="row">
    <div class="col-sm-3 col-md-2 sidebar">
        <ul class="nav nav-sidebar">
            <li style="{{if $status==1}} background-color: #F1F1F1{{/if}}">
                {{if $status==1}}
                <a href="#">待发货<span style="color: red">{{$total_wait_ship_count}}</span></a>
                {{else}}
                <a href="/s/wait_shipped_orders.html">待发货<span style="color: red">{{$total_wait_ship_count}}</span></a>
                {{/if}}
            </li>
            <li style="{{if $status==0}} background-color: #F1F1F1{{/if}}">
                {{if $status==0}}
                <a href="#">未付款</a>
                {{else}}
                <?php echo $this->Html->link('未付款', array('controller' => 'stores','action'=>'wait_paid_orders','plugin' => null ,)); ?>
                {{/if}}
            </li>
            <li style="{{if $status==2}} background-color: #F1F1F1{{/if}}">
                {{if $status==2}}
                <a href="#">已发货</a>
                {{else}}
                <?php echo $this->Html->link('已发货', array('controller' => 'stores','action'=>'shipped_orders','plugin' => null ,)); ?>
                {{/if}}
            </li>
            <li style="{{if $status==3}} background-color: #F1F1F1{{/if}}">
                {{if $status==3}}
                <a href="#">已签收</a>
                {{else}}
                <?php echo $this->Html->link('已签收', array('controller' => 'stores','action'=>'signed_orders','plugin' => null ,)); ?>
                {{/if}}
            </li>
            <li style="{{if $status==-1}} background-color: #F1F1F1{{/if}}">
                {{if $status==-1}}
                <a href="#">所有</a>
                {{else}}
                <?php echo $this->Html->link('所有', array('controller' => 'stores','action'=>'orders','plugin' => null ,)); ?>
                {{/if}}
            </li>
        </ul>
    </div>
    <div class="col-sm-9 col-md-10">
        <h2 class="sub-header">
            {{if $status==0}}
                未付款订单
            {{elseif $status==1}}
                待发货订单
            {{elseif $status==2}}
                已发货订单
            {{elseif $status==3}}
                已签收订单
            {{elseif $status==-1}}
                所有订单
            {{/if}}
            <span style="color: red">{{$total_count}}</span>个
        </h2>
        {{if $status==0}}
        <?php echo $this->Html->link('导出Excel', array('controller' => 'stores','action'=>'wait_paid_orders_export','plugin' => null),array('class'=>'btn btn-info pull-right')); ?>
        {{elseif $status==1}}
        <br/>
        <form class="form-inline">
            <div class="form-group">
                <label><h3>选择团</h3></label>
                <select class="form-control" id="tuan_teams">
                    <option value="-1">选择团</option>
                    {{loop $tuanTeams $team}}
                    <option value="{{$team['TuanTeam']['id']}}">{{$team['TuanTeam']['tuan_name']}}</option>
                    {{/loop}}
                </select>
            </div>
        </form>
        {{loop $tags $tag}}
            <a name="wait_shipped_orders" href="/s/wait_shipped_orders.html?mark_date={{$tag['mark_date']}}&mark_tip={{$tag['mark_tip']}}" class="btn btn-link">{{if $tag['mark_date'] == 'all'}}全部{{elseif $tag['mark_date'] == null}}没有标记{{else}}{{$tag['mark_date'].' '.$tag['mark_tip']}}{{/if}}<span style="color: red">({{$tag['count']}})</span></a>&nbsp;&nbsp;
        {{/loop}}
        <?php echo $this->Html->link('导出Excel', array('controller' => 'stores','action'=>'wait_shipped_orders_export','?' => array('mark_date' => $mark_date,'mark_tip' => $mark_tip) ,'plugin' => null),array('class'=>'btn btn-info pull-right')); ?>
        {{elseif $status==2}}
        <?php echo $this->Html->link('导出Excel', array('controller' => 'stores','action'=>'shipped_orders_export','plugin' => null),array('class'=>'btn btn-info pull-right')); ?>
        {{elseif $status==3}}
        <?php echo $this->Html->link('导出Excel', array('controller' => 'stores','action'=>'signed_orders_export','plugin' => null),array('class'=>'btn btn-info pull-right')); ?>
        {{elseif $status==-1}}
        <?php echo $this->Html->link('导出Excel', array('controller' => 'stores','action'=>'orders_export','plugin' => null),array('class'=>'btn btn-info pull-right')); ?>
        {{/if}}

        <div class="table-responsive">
            {{loop $orders $order}}
            <table class="table table-bordered">
                <tr>
                    <td>
                        订单号：{{$order['Order']['id']}}<br/>
                        团购：{{if $order['Order']['type'] == 5}}是{{else}}否{{/if}}<br/>
                        收货人：{{$order['Order']['consignee_name']}}，{{$order['Order']['consignee_area']}}{{$order['Order']['consignee_address']}}，{{$order['Order']['consignee_mobilephone']}}<br/>
                        总价：￥{{$order['Order']['total_price']}}<br/>
                        运费：￥{{$order['Order']['ship_fee']}}<br/>
                        实际价格：￥{{$this->Number->precision($order['Order']['total_all_price'], 2)}}<br/>
                        下单时间：{{$order['Order']['created']}}<br/>
                        支付时间：{{$order['Order']['pay_time']}}<br/>
                        {{if $order['Order']['ship_type']}}
                        快递公司: {{$ship_type[$order['Order']['ship_type']]}} ,&nbsp;&nbsp;
                        快递单号：{{$order['Order']['ship_code']}}<br/>
                        {{/if}}
                        订单备注：{{$order['Order']['remark']}}<br/>
                        商家备注：<span id ="business_remark_{{$order['Order']['id']}}">{{$order['Order']['business_remark']}}</span>
                    </td>
                </tr>
                {{if !empty($order_carts[$order['Order']['id']])}}
                <tr>
                    <td>
                        <table class="table table-bordered">
                            <tr>
                                <th width="50%">商品名称</th>
                                <th>价格</th>
                                <th>规格</th>
                                <th>数量</th>
                                <th>合计</th>
                            </tr>
                            <tbody>
                            {{loop $order_carts[$order['Order']['id']] $index $cart}}
                            <tr>
                                <td>{{$cart['Cart']['name']}}</td>
                                <td>￥{{$cart['Cart']['price']}}</td>
                                <td>{{$spec_groups[$cart['Cart']['specId']]}}<br/></td>
                                <td>{{$cart['Cart']['num']}}</td>
                                {{if $index == 0}}
                                <td>￥{{$order['Order']['total_price']}}</td>
                                {{else}}
                                <td>——</td>
                                {{/if}}
                            </tr>
                            {{/loop}}
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="order-status-{{$order['Order']['id']}}">
                            {{if $order['Order']['status']==0}}
                                <font color="red">订单未支付</font>
                            {{elseif $order['Order']['status']==1}}
                                <font color="red">订单待发货</font>
                                <div class="well">
                                    <select id="ship-type-{{$order['Order']['id']}}">
                                        <option value="">快递类型</option>
                                        {{loop $ship_type $id $type}}
                                        <option value="{{$id}}" {{$default_ship_id && $id==$default_ship_id?'selected':''}}>{{$type}}</option>
                                        {{/loop}}
                                    </select>
                                    <input type="text" width="80px;" id="ship-code-{{$order['Order']['id']}}"
                                           placeholder="快递单号">
                                    <button type="button" onclick="ship_order({{$order['Order']['id']}}, {{$creator}});"
                                            class="btn btn-primary btn-sm">订单已发货
                                    </button>
                                </div>
                                <font color="red">标记订单</font>
                                <div class="well">
                                    <label>预发货日期 :</label>
                                    <input type="date" id="mark-date-{{$order['Order']['id']}}" value="{{$order['Order']['mark_ship_date']?date('Y-m-d',strtotime($order['Order']['mark_ship_date'])):date('Y-m-d')}}">
                                    <label>发货方式 :</label>
                                    <input type="text" id="mark-tip-{{$order['Order']['id']}}"
                                           placeholder="默认" value="{{$order['Order']['ship_mark']}}">
                                    <button type="button" onclick="mark_order({{$order['Order']['id']}});"
                                            class="btn btn-primary btn-sm">标记订单
                                    </button>
                                </div>
                            {{elseif $order['Order']['status']==2}}
                                <font color="red">订单已发货</font>
                            {{elseif $order['Order']['status']==3}}
                                <font color="red">订单已签收</font>
                            {{/if}}
                        </div>

                    </td>
                </tr>
                {{/if}}
                {{if $status==0}}
                <tr>
                    <td>
                        <div class="input-group col-sm-4">
                            <span class="input-group-addon">修改价格</span>
                            <input type="number" id= "{{'order-price-'.$order['Order']['id']}}" class="form-control"  placeholder="填写">
                            <span class="input-group-btn">
                                <button class="btn btn-warning" onclick="modify_price({{$order['Order']['id']}}, 0 , {{$creator}}, this);"  type="button">确认修改</button>
                            </span>
                        </div>
                    </td>
                </tr>
                {{/if}}
                <tr>
                    <td>
                        <div class="input-group col-sm-12">
                            <span class="input-group-addon">商家备注</span>
                            <input type="text" class="form-control"  id = "remark_{{$order['Order']['id']}}" placeholder="选填：对本次交易的说明（仅商家本人能看到）">
                            <span class="input-group-btn">
                                <button class="btn btn-default" onclick="submit_remark({{$order['Order']['id']}}, this)"  type="button">提交</button>
                            </span>
                        </div>
                    </td>
                </tr>
            </table>
            {{/loop}}
        </div>
        {{if $total_count>0}}
        <div style="margin-left: 60%">
            {{$this->Paginator->first(__('首页', true), array(), null);}}
            {{$this->Paginator->prev(__('上一页', true), array(), null);}}
            {{$this->Paginator->numbers();}}
            {{$this->Paginator->next(__('下一页', true), array(), null);}}
            {{$this->Paginator->last(__('末页', true), array(), null);}}
        </div>
        {{/if}}
    </div>
</div>
<script>
    $(document).ready(function(){
        var $tuan_teams = $('#tuan_teams');
        $tuan_teams.val('{{$tuan_id}}');
        $('a[name="wait_shipped_orders"]').on('click',function(){
            var tuan_id = $tuan_teams.val();
            var me = $(this);
            var href = me.attr('href');
            href+='&tuan_id='+tuan_id;
            me.attr('href',href);
            window.location.href = href;
            return false;
        });
    });
</script>
