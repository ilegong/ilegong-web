<div class="container">
    <?php echo $this->Html->link('新增商品', '/s/add_product.html',array('class'=>'btn btn-warning pull-right')); ?>
    <table class="table table-striped table-hover">
        <?php
        $tableHeaders =  $this->Html->tableHeaders(array(
        '图片',
        '名称',
        '价格',
        '库存',
        '销量',
        '状态',
        '更新时间',
        '排序权值',
        '操作'
        ));

        echo '<thead>'.$tableHeaders.'</thead>';
        $rows = array();
        foreach ($datalist AS $item) {
        if ($item['Product']['deleted'] != DELETED_YES) {
            $actions = ' ' . $this->Html->link('修改', array('action' => 'edit_product', $item['Product']['id']))
            .' | '.$this->Html->link('删除', array('action' => 'del_product', $item['Product']['id']))
            .' | '.$this->Html->link('查看', array('controller' => 'products', 'action' => 'view', $item['Product']['id']), array('target' => '_blank'))
            .' | '.$this->Html->link('排期', array('action' => 'consignment_dating', 'list' ,'?' => array('p_id' => $item['Product']['id'])), array('target' => '_blank'));
            if(!empty($dates[$item['Product']['id']])){
                $actions = $actions.' | '.$this->Html->link('发货状态', array('action' => 'view_track', $item['Product']['id'],'?'=>array('productname'=>$item['Product']['name'])));
            }
        }

        $rows[] = array(
        $this->Html->image(
        $this->Html->url(small_thumb_link($item['Product']['coverimg'])),
        array('style'=>'max-width:100px;max-height:100px;')),
        $item['Product']['name'],
        $this->Number->precision($item['Product']['price'], 2),
        $item['Product']['storage'],
        $item['Product']['saled'],
        $item['Product']['deleted'] == DELETED_YES ? '已删除' : ($item['Product']['published'] == PUBLISH_YES ? '上架' : '下架'),
        friendlyDateFromStr($item['Product']['updated']),
        '<input type="number" name="weight" id="product_pid_' . $item['Product']['id'] . '"class="form-control" data-toggle="tooltip" data-placement="right" title="权值已保存" value="'.$item['Product']['sort_in_store'].'" style="width: 70px">',
        $actions,
        );
        }
        echo $this->Html->tableCells($rows);

        ?>

    </table>
    {{$page_navi}}
</div>


<script>
    $(document).ready(function(){
        $("input[name='weight']").on('focusout', function(){
            var id = $(this).attr('id').substr(12);
            $.get('/stores/product_sort',{pid: id, weight:$(this).val()},function(result){
                if(result.success){
                    $("#product_pid_"+id).val(result.weight);
                    $("#product_pid_"+id).tooltip('show');
                    setTimeout(function(){
                        $("#product_pid_"+id).tooltip('destroy');
                    },500);

                }else{
                    alert('error');
                }
            }, 'json');

        });
    })
</script>