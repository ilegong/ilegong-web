<link rel="stylesheet" type="text/css" href="/static/share_faq/css/style.css?0.0.1">
<link rel="stylesheet" type="text/css" href="/static/share_faq/css/jquery.mobile.flatui.css?0.0.1"/>
<div>
    <div class="header linear-g">
        <a href="/weshares/view/{{$share_info['Weshare']['id']}}"
           class="glyphicon glyphicon-home col-xs-2 text-right"> </a>
        <a class="text-center col-xs-8"><span class="share-title" id="head-share-title">{{$share_info['Weshare']['title']}}</span></a>
        <a href="/weshares/user_share_info/{{$receiver}}"
           class="glyphicon glyphicon-user col-xs-2 text-left"> </a>
    </div>
    <div style="margin-top: 45px;margin-bottom: 15px;"
         id="chat-msg-list-container">
        <ul class="content-reply-box mg10" id="chat-msg-list">
            {{loop $share_faqs $share_faq}}
            <li class="{{if $share_faq['ShareFaq']['sender'] == $current_user_id}}even{{else}}odd{{/if}}">
                <a class="user" href="/weshares/user_share_info/{{$share_faq['ShareFaq']['sender']}}"><img
                        class="img-responsive avatar_"
                        src="{{$user_info[$share_faq['ShareFaq']['sender']]['image']}}"><span
                        class="user-name">{{$user_info[$share_faq['ShareFaq']['sender']]['nickname']}}</span></a>

                <div class="reply-content-box">
                    <span class="reply-time">{{$share_faq['ShareFaq']['created']}}</span>

                    <div class="reply-content pr">
                        <span class="arrow">&nbsp;</span>
                        {{$share_faq['ShareFaq']['msg']}}
                    </div>
                </div>
            </li>
            {{/loop}}
        </ul>
    </div>
    <div class="panel-footer" style="position: fixed;bottom: 0px;left: 0;">
        <input type="hidden" id="sender-img" value="{{$user_info[$current_user_id]['image']}}">
        <input type="hidden" id="sender-nickname" value="{{$user_info[$current_user_id]['nickname']}}">

        <div class="input-group" id="chat-input-form">
            <input type="hidden" id="senderName" value="{{$user_info[$current_user]['nickname']}}">
            <input type="hidden" id="sender" value="{{$current_user}}">
            <input type="hidden" id="receiver" value="{{$receiver}}">
            <input type="hidden" id="share-id" value="{{$share_id}}">
            <input id="content" required type="text" class="form-control input-sm chat_input"
                   placeholder="写下你要说的话..."/>
                <span class="input-group-btn"><button class="btn btn-primary btn-sm" id="btn-chat-submit">发送
                </button></span>
        </div>
    </div>
</div>
<script>
    // copyright c by zhangxinxu v1.0 2009-09-05
    // http://www.zhangxinxu.com
    /* $(".test1").wordLimit(); 自动获取css宽度进行处理，如果css中未对.test1给定宽度，则不起作用
     $(".test2").wordLimit(24); 截取字符数，值为大于0的整数，这里表示class为test2的标签内字符数最多24个
     */

    (function($){
        $.fn.wordLimit = function(num){
            this.each(function(){
                if(!num){
                    var copyThis = $(this.cloneNode(true)).hide().css({
                        'position': 'absolute',
                        'width': 'auto',
                        'overflow': 'visible'
                    });
                    $(this).after(copyThis);
                    if(copyThis.width()>$(this).width()){
                        $(this).text($(this).text().substring(0,$(this).text().length-4));
                        $(this).html($(this).html()+'...');
                        copyThis.remove();
                        $(this).wordLimit();
                    }else{
                        copyThis.remove(); //清除复制
                        return;
                    }
                }else{
                    var maxwidth=num;
                    if($(this).text().length>maxwidth){
                        $(this).text($(this).text().substring(0,maxwidth));
                        $(this).html($(this).html()+'...');
                    }
                }
            });
        }
    })(jQuery);
</script>
<script type="text/javascript">
    $(function () {
        //var $chatMsgListContainer = $('#chat-msg-list-container');
        var $chatMsgList = $('#chat-msg-list');
        var senderImg = $('#sender-img').val();
        var $chatInputForm = $('#chat-input-form');
        var $sender = $('#sender', $chatInputForm);
        var senderId = $sender.val();
        var $receiver = $('#receiver', $chatInputForm);
        var $shareId = $('#share-id', $chatInputForm);
        var shareId = $shareId.val();
        var $senderName = $('#senderName', $chatInputForm);
        var sendName = $senderName.val();
        var $content = $('#content', $chatInputForm);
        var $btnSubmit = $('#btn-chat-submit', $chatInputForm);
        var submit = false;
        $('#head-share-title').wordLimit(10);
        updateFaqRead();
        //scrollBottom();
        $btnSubmit.on('click', function (e) {
            e.preventDefault();
            if (!$content.val()) {
                alert('请输入内容');
                return;
            }
            var postData = {
                "receiver": $receiver.val(),
                "share_id": $shareId.val(),
                "msg": $content.val()
            };
            if (submit) {
                alert('正在提交');
            }
            submit = true;
            $.post('/share_faq/create_faq/', postData, function (data) {
                console.log(data);
                $chatMsgList.append(genChatItemDom(data));
                $content.val('');
                submit = false;
                //scrollBottom();
            }, 'json');
        });

//        function scrollBottom(){
//            $chatMsgListContainer.scrollTop($chatMsgListContainer.prop("scrollHeight"));
//        }

        function genChatItemDom(data) {
            var domStr = '<li class="even"><a class="user" href="/weshares/user_share_info/' + senderId + '"><img class="img-responsive avatar_" src="' + senderImg + '" alt=""><span class="user-name">' + sendName + '</span></a> <div class="reply-content-box"> <span class="reply-time">' + data["ShareFaq"]["created"] + '</span> <div class="reply-content pr"> <span class="arrow">&nbsp;</span>' + data['ShareFaq']['msg'] + '</div></div></li>';
            return domStr;
        }

        function updateFaqRead() {
            var updateInfoReadUrl = '/share_faq/update_faq_read/' + shareId + '/' + senderId;
            $.getJSON(updateInfoReadUrl, function (data) {

            });
        }
    });
</script>