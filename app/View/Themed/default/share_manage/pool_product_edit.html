<div class="row">
  <div class="col-lg-12">
    <h1 class="page-header">产品街产品编辑</h1>
  </div>
  <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
<div class="row">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        添加
      </div>
      <div class="panel-body">
        <div class="row">
          <div class="col-lg-12">
            <form role="form" action="/shareManage/pool_product_save.html" method="post">
              <input type="hidden" name="data[PoolProduct][id]" value="{{$index_product['PoolProduct']['id']}}">


              <div class='row'>
                <div class="form-group col-sm-4">
                  <label>分享人</label>
                  <input type="text" class="form-control" name="disable_data[PoolProduct][name]" value="{{$index_product['User']['nickname']}}" disabled>
                  <p class="help-block">分享人</p>
                </div>
                <div class="form-group col-sm-4">
                  <label>分享人手机号</label>
                  <input type="text" class="form-control" name="disable_data[PoolProduct][mobilephone]" value="{{$index_product['User']['mobilephone']}}" disabled>
                  <p class="help-block">分享人手机号</p>
                </div>
              </div>

              <div class="form-group">
                <label>显示名称</label>
                <input type="text" class="form-control" name="data[PoolProduct][share_name]" value="{{$index_product['PoolProduct']['share_name']}}">
                <p class="help-block">首页显示名称</p>
              </div>

              {{loop $index_product['WeshareProducts'] $key $WeshareProduct}}
              <div class='row pool-product-item'>
                <input type="hidden" class="form-control" name="data[WeshareProduct][{{$key}}][id]" value="{{$WeshareProduct['id']}}">
                <div class="form-group col-sm-3">
                  <label>规格</label>
                  <input type="text" class="form-control" name="data[WeshareProduct][{{$key}}][name]" value="{{$WeshareProduct['name']}}">
                  <p class="help-block">用于显示，不参与计算</p>
                </div>
                <div class="form-group col-sm-3">
                  <label>显示价格</label>
                  <input type="number" class="form-control" name="data[WeshareProduct][{{$key}}][price]" value="{{$WeshareProduct['price']}}">
                  <p class="help-block">用于显示，不参与计算</p>
                </div>
                <div class="form-group col-sm-3">
                  <label>渠道价格</label>
                  <input type="number" class="form-control" name="data[WeshareProduct][{{$key}}][channel_price]" value="{{$WeshareProduct['channel_price']}}">
                  <p class="help-block">渠道价格</p>
                </div>
                <div class="form-group col-sm-1">
                  <label>状态</label>
                  <div class=''>
                    {{if $WeshareProduct['deleted']}}
                    已下架
                    {{else}}
                    正常
                    {{/if}}
                  </div>
                </div>
                <div class="form-group col-sm-2">
                  <label>操作</label>
                  <div class=''>
                    <a href='javascript:void(0)' class='product-ban btn btn-danger' data-upid="{{$WeshareProduct['id']}}">
                      下架
                    </a>
                  </div>
                </div>
              </div>
              {{/loop}}
              <a href='javascript:void(0)' id='add-new-product' class='btn btn-primary'>
                添加新规格
              </a>

              <input type="hidden" class="form-control" name="data[Weshares][id]" value="{{$index_product['Weshares']['id']}}">
              <input type='hidden' class="form-control" id='store-images-string' name="data[Weshares][images]" value="{{$index_product['Weshares']['images']}}" autocomplete="off" />
              <div class="row images-list">
                <h3>
                  展示图片链接
                </h3>
                {{loop $index_product['Weshares']['images_array'] $image}}
                <div class="image-area col-sm-2">
                  <img src="{{$image}}" />
                  <div class="operator">
                    <a class="btn btn-primary preview-image" src-data="{{$image}}" href="javascript:void(0)">预览</a>
                    <a class="btn btn-danger delete-image" src-data="{{$image}}" href="javascript:void(0)">删除</a>
                  </div>
                </div>
                {{/loop}}
                <div class="col-sm-12 share-upload-btn">
                  <a class='btn btn-default' href="javascript:void(0)" id='upload-image'>
                    选择图片
                  </a>
                  <a class='btn btn-primary' href="javascript:void(0)" id='upload-image-action'>
                    上传图片
                  </a>
                </div>
              </div>
              <div class="form-group">
                <label>Banner图片链接</label>
                <input type='hidden' class="form-control" id='banner-images-string' name="data[PoolProduct][share_img]" value="{{$index_product['PoolProduct']['share_img']}}" autocomplete="off" />
                <div class="banner-image-area col-sm-12">
                  <img src="{{$index_product['PoolProduct']['share_img']}}" />
                  <div class="operator">
                    <a class="btn btn-primary preview-image" src-data="{{$index_product['PoolProduct']['share_img']}}" href="javascript:void(0)">预览</a>
                    <a class="btn btn-danger delete-banner-image" src-data="{{$index_product['PoolProduct']['share_img']}}" href="javascript:void(0)">删除</a>
                  </div>
                </div>
                <div class="col-sm-12 banner-upload-btn">
                  <a class='btn btn-default' href="javascript:void(0)" id='banner-upload-image'>
                    选择图片
                  </a>
                  <a class='btn btn-primary' href="javascript:void(0)" id='banner-upload-image-action'>
                    上传图片
                  </a>
                </div>
              </div>
              <div class="form-group">
                <label>分享描述</label>
                <textarea class="form-control" rows="5" name="data[Weshares][description]">{{$index_product['Weshares']['description']}}</textarea>
              </div>
              <button type="submit" class="btn btn-default">保存</button>
            </form>
          </div>
        </div>
        <!-- /.row (nested) -->
      </div>
      <!-- /.panel-body -->
    </div>
    <!-- /.panel -->
  </div>
  <!-- /.col-lg-12 -->
</div>
<!-- /.row -->
</div>

<div class="modal fade" id="image-preview-modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">图片预览</h4>
      </div>
      <div class="modal-body">
        <img id="image-preview" />
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<form id="file-uploader">
  <input type="file" name='images' class="hidden" id="uploader"  />
</form>

<script>
$(function (){
  $('.product-ban').on('click', function (){
    if (confirm('确定下架?')) {
      window.location.href = '/shareManage/pool_product_item_ban/' + $(this).attr('data-upid') + "/" + {{$index_product['PoolProduct']['id']}};
    } else {
      console.log('手贱, 不好意思');
    }
  });
  $('#add-new-product').on("click", function (){
    var len = $('.pool-product-item').length;
    var newItem = $('.pool-product-item').eq(0).clone();
    newItem.find('input[type!=hidden]').each(function (){
      var tmp_name = $(this).attr('name');
      $(this).attr('name', tmp_name.replace(/(data\[[a-zA-Z_-]+\]\[)\d+(\]\[[a-zA-Z_-]+\])/g, '$1' + len + '$2'));
      $(this).attr('value', '');
    });

    $('#add-new-product').before(newItem);
  });

  $('.preview-image').on("click", function (){
    $('#image-preview').attr('src', $(this).attr('src-data'));
    $('#image-preview-modal').modal('show');
  });

  $('.delete-image').on("click", function (){
    var arr = $('#store-images-string').val().split('|');
    var idx = arr.splice(arr.indexOf($(this).attr('src-data')), 1);
    var nstring = arr.join('|');
    $('#store-images-string').val(nstring);
    $(this).parent('div').parent('div.image-area').remove();
  });

  $('.delete-banner-image').on("click", function (){
    $('#banner-images-string').val();
    $(this).parent('div').parent('div.image-area').remove();
  });

  $('#upload-image, #banner-upload-image').on("click", function (){
    $('#uploader').click();
  });

  $('#upload-image-action').on("click", function (){
    var formData = new FormData($('#file-uploader').get(0));
    console.log(formData);

    $.ajax({
      url: 'http://images.tongshijia.com/upload' ,
      type: 'post',
      data: formData,
      dataType: 'json',
      async: false,
      processData: false,
      contentType: false,
      success: function (data) {
        console.log(data);
        imgUrl = 'http://static.tongshijia.com/' + data.url[0];
        var obj = $('.image-area').eq(0).clone();
        obj.find('img').attr('src', imgUrl);
        obj.find('a').attr('src-data', imgUrl);
        $('.share-upload-btn').before(obj);
        $('.preview-image').on("click", function (){
          $('#image-preview').attr('src', $(this).attr('src-data'));
          $('#image-preview-modal').modal('show');
        });
        $('#store-images-string').val($('#store-images-string').val() + "|" + imgUrl);
      },
      error: function (data) {
      }
    });

  });
  $('#banner-upload-image-action').on("click", function (){
    var formData = new FormData($('#file-uploader').get(0));
    console.log(formData);

    $.ajax({
      url: 'http://images.tongshijia.com/upload' ,
      type: 'post',
      data: formData,
      dataType: 'json',
      async: false,
      processData: false,
      contentType: false,
      success: function (data) {
        imgUrl = 'http://static.tongshijia.com/' + data.url[0];
        var obj = $('.image-area').eq(0).clone();
        obj.removeClass('col-sm-2').addClass('col-sm-12 banner-image-area');
        obj.find('img').attr('src', imgUrl);
        obj.find('a').attr('src-data', imgUrl);
        $('.banner-image-area').remove();
        $('.banner-upload-btn').before(obj);
        $('.preview-image').on("click", function (){
          $('#image-preview').attr('src', $(this).attr('src-data'));
          $('#image-preview-modal').modal('show');
        });
        $('#banner-images-string').val(imgUrl);
      },
      error: function (data) {
      }
    });

  });
});
</script>
<style>
  .banner-images-list,
  .images-list {
  margin: 10px 0;
}
  .banner-image-area img,
  .image-area img {
      width: 160px;
      height: 160px;
    }
  .banner-image-area .operator,
  .image-area .operator {
      margin: 5px 0;
    }
    .share-upload-btn {
      margin: 0;
      padding: 0;
    }
    #image-preview {
      max-width: 100%;
      height: 80%;
    }
</style>
