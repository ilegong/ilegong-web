{{$this->Html->css(array('game_xiyang.css?ver1',));}}
{{$this->Html->script(array('trace/tracekit.min.report.js', 'shake/shake.js', 'howler/howler.min.js', '3dfalling/rotate3Di.min.js', '3dfalling/3d-falling-leaves.js', 'jquery/jquery.fullPage.min.js', 'jquery/jquery.rotate.js'), array('block' => 'scriptBottom'));}}

<script>
    user_subscribed = "{{$user_subscribed}}";
    _path_exchange = '/game_xiyang/exchange_coupon';
    _path_shake = '/game_xiyang/shake';
    _path_notify = '/game_xiyang/notifiedToMe';
    _path_assign_follow = '/game_xiyang/assignWXSubscribeTimes';
    _path_query = '/game_xiyang/hasNewTimes';
    _mobile_bind_reason = '离大奖很近了，请绑定手机号验证是否人类';
</script>
<div id="xy_game">
    <div class="gold_bg" id="xy_top">
        <div class="gold_title"><img src="{{$this->Html->assetUrl('/img/game_xiyang/title.gif')}}"></div>
        <div class="gold_sheep"><img src="{{$this->Html->assetUrl('/img/game_xiyang/sheep.jpg')}}"></div>
        <div class="gold_count">你摇到 <span id="apple_got_cnt">{{$total_apple}}</span> 个金币，剩余机会 <span id="apple_times_left">{{$total_times}}</span> 次</div>
        <ul class="clearfix">
            <li class="fl"><a id="btn_rules" href="#xy_top"><img src="{{$this->Html->assetUrl('/img/game_xiyang/rule_btn.gif')}}" ></a></li>
            <li class="fr"><a id="btn_add_chance" href="#xy_top"><img src="{{$this->Html->assetUrl('/img/game_xiyang/addchance_btn.gif')}}" ></a></li>
        </ul>
        <ul class="clearfix">
            <li class="fl"><a id="btn_story" href="#X"><img src="{{$this->Html->assetUrl('/img/game_xiyang/story_btn.gif')}}" ></a></li>
            <li class="fr"><a id="btn_help_me" href="#xy_top"><img src="{{$this->Html->assetUrl('/img/game_xiyang/help_btn.gif')}}" ></a></li>
        </ul>
        <a class="gold_prizelist_btn" id="xy_prizelist_btn" href="#gold_prizelist"><img src="{{$this->Html->assetUrl('/img/game_xiyang/prize_btn.gif')}}" ></a>
    </div>

    <div class="gold_prizeset">
        <div class="gold_prizeset_title"><img src="{{$this->Html->assetUrl('/img/game_xiyang/prizeset.gif')}}" ></div>
        <div class="gold_prizeset_level_title">一等奖：</div>
        <ul class="clearfix">
            <li>
                <div>
                    <img src="{{$this->Html->assetUrl('/img/game_xiyang/parize1.jpg')}}"><br/>
                    <p>2月13日下午21:00整点秒杀<br/><a href="#X">使用说明</a></p>
                    <a class="gold_prizeset_seckill_disabled radius4" href="#X">50金币参加秒杀</a>
                </div>
            </li>
            <li>
                <div>
                    <img src="{{$this->Html->assetUrl('/img/game_xiyang/parize2.jpg')}}"><br/>
                    <p>9-13日每天9/12/16/21<br/>整点秒杀，每次1盒<br/><a href="#X">使用说明</a></p>
                    <a class="gold_prizeset_seckill_usable radius4" href="#X">去使用</a>
                </div>
            </li>
        </ul>
        <ul class="clearfix">
            <li>
                <div>
                    <img src="{{$this->Html->assetUrl('/img/game_xiyang/parize3.jpg')}}"><br/>
                    <p>9-13日每天9/12/16/21<br/>整点秒杀，每次一盒<br/><a href="#X">使用说明</a></p>
                    <a class="gold_prizeset_seckill_disabled radius4" href="#X">50金币参加秒杀</a>
                </div>
            </li>
            <li>
                <div>
                    <img src="{{$this->Html->assetUrl('/img/game_xiyang/parize4.jpg')}}"><br/>
                    <p>9-13日每天9/12/16/21<br/>整点秒杀，每次一盒<br/><a href="#X">使用说明</a></p>
                    <a class="gold_prizeset_seckill_usable radius4" href="#X">凭码兑换<span>(45845)</span></a>
                </div>
            </li>
        </ul>
        <div class="gold_prizeset_level_title">二等奖：</div>
        <ul class="clearfix">
            <li>
                <div>
                    <img src="{{$this->Html->assetUrl('/img/game_xiyang/parize5.jpg')}}"><br/>
                    <p>随时兑换，不限份数<br/><a href="#X">使用说明</a></p>
                    <a class="gold_prizeset_seckill_disabled radius4" href="#X">30金币兑换</a>
                </div>
            </li>
            <li>
                <div>
                    <img src="{{$this->Html->assetUrl('/img/game_xiyang/parize6.jpg')}}"><br/>
                    <p>随时兑换，限当天使用<br/>剩余500张<br/><a href="#X">使用说明</a></p>
                    <a class="gold_prizeset_seckill_usable radius4" href="#X">去使用</a>
                </div>
            </li>
        </ul>
        <ul class="clearfix">
            <li>
                <div>
                    <img src="{{$this->Html->assetUrl('/img/game_xiyang/parize7.jpg')}}"><br/>
                    <p>随时兑换，限当天使用<br/>剩余200份<br/><a href="#X">使用说明</a></p>
                    <a class="gold_prizeset_seckill_disabled radius4" href="#X">50金币参加秒杀</a>
                </div>
            </li>
            <li>
                <div>
                    <img src="{{$this->Html->assetUrl('/img/game_xiyang/parize8.jpg')}}"><br/>
                    <p>随时兑换，剩余300张<br/><a href="#X">使用说明</a></p>
                    <a class="gold_prizeset_seckill_usable radius4" href="#X">凭码兑换<span>(45845)</span></a>
                </div>
            </li>
        </ul>
    </div>

    <div class="gold_prizelist" id="gold_prizelist">
        <div class="gold_prizelist_title"><img src="{{$this->Html->assetUrl('/img/game_xiyang/prizelist.gif')}}" ></div>
        <p>更新于2015-02-07,11:32:30</p>
        <a href="#X">看看谁得奖</a>
        <ul class="clearfix">
            <li class="fl"><strong>小郑</strong>  <span>获得二等奖</span></li>
            <li class="fr"><span>4分钟前</span></li>
        </ul>
    </div>
    <!--游戏规则-->
    <div id="xy_rules" class="gold_chance" style="display:none; top:8%;">
        <a class="gold_chance_close" href="#X"><img src="{{$this->Html->assetUrl('/img/game_xiyang/close.png')}}" /></a>
        <ul>
            <li class="strawberry_chance_title">游戏规则与奖品兑换</li>
        </ul>
        <ul class="strawberry_rule_list">
            <li style="padding-top:1em;"><strong>游戏规则</strong></li>
            <li>
                <span class="fl">1）</span>
                <span style="overflow:hidden;">时间：2015年2月4日至2月8日23:59</span>
            </li>
            <li>
                <span class="fl">2）</span>
                <span style="overflow:hidden;">所有奖券请领取后请在1小时内使用</span>
            </li>
            <li>
                <span class="fl">3）</span>
                <span style="overflow:hidden;">免费送出和使用优惠券购买的奖品，第二天或第三天统一发货。其中，北京、天津外规格有区别，详见商品介绍页面</span>
            </li>
            <li>
                <span class="fl">4）</span>
                <span style="overflow:hidden;">相同手机号、微信号、用户、地址只能中奖一次，如有作弊，奖品作废</span>
            </li>
            <li>
                <span class="fl">5）</span>
                <span style="overflow:hidden;">法律许可范围内，本次活动解释权归朋友说所有</span>
            </li>
        </ul>
        <!--<div class="strawberry_adver"><img src="images/index/adver.jpg" /></div>-->
    </div>
    <!--谁帮助过我-->
    <div id="xy_help_me" class="gold_chance" style="display:none; top:8%;">
        <a class="gold_chance_close" href="#X"><img src="{{$this->Html->assetUrl('/img/game_xiyang/close.png')}}" /></a>
        <div class="strawberry_prize_list">
            {{if $helpMe}}
            <?php $i=0; foreach($helpMe as $key => $item) { $i++; if($i >=100){break;} ?>
            <dl class="clearfix">
                <dt class="fl"><span>{{$item['nickname']}}</span></dt>
                <dt class="fr">摇下<span class="gots">{{ $item['got'] }}</span></dt>
            </dl>
            <?php } ?>
            {{else}}
            <div class="con clearfix">还没有朋友帮过你啊，马上分享给朋友们吧！
                <a id="share_btn_2" href="javascript:;" class="help">分享好友求助</a>
            </div>
            {{/if}}
        </div>
    </div>
    <!--加机会-->
    <div id="xy_add_chance" class="gold_chance" style="display: none; top:8%;">
        <a class="gold_chance_close" href="#X"><img src="{{$this->Html->assetUrl('/img/game_xiyang/close.png')}}" /></a>
        <ul>
            <li class="gold_chance_title">摇一摇加机会秘诀</li>
        </ul>
        <p>关注以下平台，分别加2次机会</p>
        <!--<ul>-->
        <!--<li><a href="#X" class="radius4">关注朋友说</a></li>-->
        <!--</ul>-->
        <dl class="clearfix">
            <dt class="fl"><a href="#X" class="radius4">关注朋友说</a></dt>
            <dt class="fr"><a href="#X" class="radius4">关注原态绿</a></dt>
        </dl>
        <dl class="clearfix">
            <dt class="fl"><a href="#X" class="radius4">关注万国万购</a></dt>
            <dt class="fr"><a href="#X" class="radius4">关注宜生到家</a></dt>
        </dl>
        <p>每个朋友点击分享的游戏，<br />分别加1次机会</p>
        <ul>
            <li><a href="javascript:;" id="share_btn" class="radius4">分享游戏加机会</a></li>
        </ul>
        <div class="gold_chance_aboutus">
            <img src="{{$this->Html->assetUrl('/img/game_xiyang/logo.png')}}" /><br />[朋友说]同事间互相分享家乡特产的创业网站,<br />我们都是城市里的乡下人。
        </div>
    </div>
    <div id="gold_trbg" style="display:none;"></div>
</div>
<script type="text/javascript">
    var $today_got_wx = "{{$today_got_wx}}";
    var shake_pic_url = '{{$this->Html->assetUrl("/img/game_jiujiu/index/basketmove.gif")}}';
    var sound_url = 'http://51daifan-images.stor.sinaapp.com/tree_shake.mp3';
    var share_png_url = '{{$this->Html->assetUrl("http://51daifan-images.stor.sinaapp.com/as/rice_xirui/index/share.png")}}';
    var yao_tips_png = '{{$this->Html->assetUrl("http://51daifan-images.stor.sinaapp.com/as/rice_xirui/index/yao.png")}}';
    var game_type = '{{$game_type}}';

    var game_obj_name = '{{$game_obj_name}}';
    var game_least_change = '{{$game_least_change}}';
    var awarded = '{{$awarded}}';
    var game_user_total = '{{$game_user_total}}'; //loading by update_top_list
    var get_coupons_button = $('');

    var first_waiting = '{{$first_waiting}}';
    var left_sec = 0;

    if (total_not_spent() >= 30) {
        $('#first_waiting_span').show();
    }

    function update_after_times_query(data) {
        first_waiting = data['first_waiting'];
        left_sec = data['left_sec'];

        $('#left_sec_span').show();
        $('#left_sec_i').text(left_sec);
        $('#first_waiting_i').text(first_waiting);
    }

    function toggle_red_point(total) {
        var $redPoint = $('#red_point');
        if ($redPoint) {
            if (total >= 30) {
                $redPoint.show();
            } else {
                $redPoint.hide();
            }
        }
    }

    function  notify_after_shake(total, times, msg, close_callback, timeout) {
        if (total >= 30) {
            utils.alert_two(msg, '去兑奖', '继续摇', function(){
                $('#btn_rules').trigger("click");
            }, close_callback, {timeout: timeout, close_callback: close_callback});
        } else {
            utils.alert_one(msg, '继续摇', close_callback, {timeout: timeout, close_callback: close_callback});
        }
    }

    function game_coupon_message(times, total) {
        if (total >= 50)  { return '<br/><span style="color:red">'+total_not_spent()+'</span>颗了，可去规则页秒杀大奖啦'; }
        else if (total >= 40)  { return '<br/>还差<span style="color:red">'+ (50 - total_not_spent()) +'</span>颗获得大奖秒杀机会！'; }
        else if (total >= 30)  { return '<br/><span style="color:red">'+total_not_spent()+'</span>颗了，可去规则页兑奖啦'; }
        else return '';
    }

    var showAfterGotCallback = function($times, total, $got){
        toggle_red_point(total);
    };

    function total_not_spent() {
        var total = $.trim($('#apple_got_cnt').text());
        total = (total != '' ? parseInt(total) : 0);
        return total;
    }

    var friendGots = $('.gots').map(function () {
        var v = $.trim($(this).text());
        return v ? parseInt(v) : 0;
    }).get();

    function get_total() {
        var total = total_not_spent();
        return (total < game_user_total ? game_user_total : total);
    }

    function help_me_cnt() {
        var helpme_cnt_txt = $.trim($('#helpme_cnt_n').text());
        return (helpme_cnt_txt == '' ? 0 : parseInt(helpme_cnt_txt));
    }

    function dabai_percent() {
        var total = get_total();

        var win = 0;
        for(var x in friendGots) {
            if (total > friendGots[x]) {
                win++;
            }
        }
        return (win == friendGots.length) ? 100 : utils.toFixed(win*100/friendGots.length, 0)
    }

    function desc_cmp_friends() {
        var desc = '我已摇下至少' + get_total() + '颗';
        if (friendGots && friendGots.length > 0) {
            var dabaiPercent = dabai_percent();
            desc += (dabaiPercent == 100 ? ', 打败了所有好友，哈哈' : (dabaiPercent == 0 ? ', 朋友圈里垫底 ^_^， 快点我吧' : ', 打败了' + dabaiPercent + '%的好友！'));
        } else {
            desc += ', 还没人帮过我！快来帮我吧';
        }
        return desc;
    }

    $(document).ready(function(){
        //dom
        var $xy_game_div = $('#xy_game');
        var $gold_trbg = $('#gold_trbg');
        var $xy_add_chance=$('#xy_add_chance');
        var $btn_rules = $('#btn_rules');
        var $xy_rules=$('#xy_rules');
        var $btn_add_chance=$('#btn_add_chance');
        var $btn_help_me=$('#btn_help_me');
        var $xy_help_me=$('#xy_help_me');
        var $xy_prizelist_btn=$('#xy_prizelist_btn');

        //red close btn
        var $xy_close_btn=$('a.gold_chance_close');
        var apple_got_cnt = $('#apple_got_cnt');

        //prevent scroll
        function stopScroll(){
            $('body').bind('touchmove', function(e){e.preventDefault()});
        }

        function ebableScroll(){
            $('body').unbind('touchmove');
        }

        //handle close event
        function hidePages(){
            $xy_add_chance.hide();
            $gold_trbg.hide();
            $xy_rules.hide();
            $xy_help_me.hide();
            ebableScroll();
        }
        $xy_close_btn.on('click',hidePages);
        $gold_trbg.on('click',hidePages);
        $btn_add_chance.on('click',function(){
            $gold_trbg.show();
            $xy_add_chance.show();
            stopScroll();
        });
        $btn_rules.on('click',function(){
            $gold_trbg.show();
            $xy_rules.show();
            stopScroll();
        });
        $btn_help_me.on('click',function(){
            $gold_trbg.show();
            $xy_help_me.show();
            stopScroll();
        });
        $xy_prizelist_btn.on('click',function(){
            window.location.hash='#gold_prizelist';
        });

        game_notify_after_exchange = function (coupon_count, coupon_type) {
            if (coupon_count > 0) {
                if ('first' == coupon_type ) {
                    $('a#get_coupon_' + coupon_type).hide();
                    $couponFirstLi.append('<a class="btn btn-warning" style="color:white" href="/products/view/738.html">去使用</a>');
                } else if ('sec' == coupon_type) {
                    $('a#get_coupon_' + coupon_type).hide();
                    $couponSecLi.append('<a class="btn btn-warning" style="color:white" href="/products/view/738.html">去使用</a>');
                }
            } else {
                if (coupon_type == 'first') {
                    utils.alert_one("抱歉本时段已兑完，排队人数"+first_waiting+"人，建议您选择兑换二等奖", '知道了');
                } else {
                    utils.alert("呜呜，本时段已兑完。");
                }

            }
        };

    });

    //wx share
    if (typeof(wx) != 'undefined') {
        wx.ready(function () {
            var share_string = '{{$share_string ? $share_string :"0"}}';
            var to_timeline_title = "摇下50颗，3斤丹东玖玖农场草莓免费送，来自有机认证的水土，中国最早的草莓种植地（之一）。 ";
            var to_friend_title = "摇下50颗，3斤丹东玖玖农场草莓免费送";
            var to_friend_link = 'http://www.tongshijia.com/t/ag/jiujiu.html?trid={{urlencode($_REQUEST["trid"])}}';
            var to_timeline_link = to_friend_link;
            var imgUrl = "{{$this->Html->assetUrl('http://www.tongshijia.com/img/game_jiujiu/index/share_logo.jpg')}}";

            var xx = {
                title: to_friend_title,
                desc: desc_cmp_friends(),
                link: to_friend_link,
                imgUrl: imgUrl,
                success: function () {
                    if (share_string != '0') {
                        $.post('/wx_shares/log_share', { trstr: share_string, share_type: "appMsg" });
                    }
                },
                trigger: function() {
                    xx.desc = desc_cmp_friends();
                }
            };
            wx.onMenuShareAppMessage(xx);
            wx.onMenuShareTimeline({
                title: to_timeline_title,
                link: to_timeline_link,
                imgUrl: imgUrl,
                success: function () {
                    if (share_string != '0') {
                        $.post('/wx_shares/log_share', { trstr: share_string, share_type: "timeline" });
                    }
                }
            });
        })
    }
</script>
{{$this->Html->script(array('apple_game.js?v30'))}}

