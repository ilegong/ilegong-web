<div style="background-color:#f5f5f5;" style="margin-bottom: 50px;">
    <div class="menue">
        <ul data-id="{{$tagId}}">
            <li name="tag-23" class="cur" data-id="23">
                <div>朋友说<br/>爆款</div>
            </li>
            <li name="tag-3" data-id="3">
                <div>水果</div>
            </li>
            <li name="tag-5" data-id="5">
                <div>零食</div>
            </li>
            <li name="tag-8" data-id="8">
                <div>甜点</div>
            </li>
            <li name="tag-24" data-id="24">
                <div>蛋奶</div>
            </li>
            <li name="tag-4" data-id="4">
                <div>肉</div>
            </li>
            <li name="tag-12" data-id="12">
                <div>干货</div>
            </li>
            <li name="tag-25" data-id="25">
                <div>蜂蜜茶</div>
            </li>
            <li name="tag-6" data-id="6">
                <div>酒水</div>
            </li>
            <li name="tag-9" data-id="9">
                <div>粮油</div>
            </li>
            <li name="tag-10" data-id="10">
                <div>海鲜</div>
            </li>
            <li name="tag-18" data-id="18">
                <div>蔬菜</div>
            </li>
        </ul>
    </div>
    <div class="content" id="products-content" style="margin-bottom: 80px;">
        {{if $received_cnt > 0}}
        <div class="refer_banner"><a href="/refer/index{{$CurrentUser['id']?'/'.$CurrentUser['id']:''}}.html?_sl=mobile_index"><img src="{{$this->Html->assetUrl('/img/refer/banner.gif?v6')}}" width="100%"/></a></div>
        {{/if}}
        {{if !empty($tryings)}}
        <div class="tuandetail_seckill clearfix" id="seckill_product">
            <?php $i = 0; foreach($tryings as $trying) {
        if ($i++>=2) {break;} ?>
            <p>秒杀</p>
            <span><img src="{{$this->Html->assetUrl(small_thumb_link($trying['image']))}}" /></span>
        <span>
            <h1>{{$trying['ProductTry']['product_name']}} {{$trying['ProductTry']['spec']}}</h1>
            <em>秒杀价：<strong>¥{{$this->Number->precision(calculate_try_price($trying['ProductTry']['price']),
                2)}}</strong></em>
            <div class="tuan_bar clearfix">
                <?php $limit_num = $trying['ProductTry']['limit_num'];
                        $sold_num = $trying['ProductTry']['sold_num'];
                        if($sold_num >= $limit_num){
                            $sold_num = $limit_num;
                        }
                        if($sold_num >= $limit_num){
                            $sold_percent = 100;
                        }else{
                            $sold_percent = round(($sold_num / $limit_num * 100), 1);
                        }
                ?>
                <div class="fl" style="width: 50%;margin-right: 5px;">
                    <div class="bar">
                        <div class="bar_buy" style="width:{{$sold_percent}}%;"></div>
                    </div>
                    <ul class="clearfix">
                        <li class="fl">已秒<span style=" display:inline;">{{$sold_num}}</span>份</li>
                        <li class="fr">共{{$limit_num}}份</li>
                    </ul>
                </div>
                <div>
                    {{if $trying['status'] == 'sec_kill'}}
                    <a class="tuandetail_seckill_btn radius5 fr" data-try-id="{{$trying['ProductTry']['id']}}" data-tuan-id="{{$tuan_id}}"
                       data-pid="{{$trying['Product']['id']}}" data-send-date="{{$trying['ProductTry']['consignment_date']}}">正在秒杀</a>
                    {{elseif $trying['status'] == 'sec_end'}}
                    <a class="seckill_disabled radius5 fr">已秒完</a>
                    {{else}}
                    <a data-start="{{strtotime($trying['ProductTry']['start_time']) - ($shichi_mem? 30 * 60 : 0)}}"
                       data-pid="{{$trying['Product']['id']}}" href="#X" class="sec_start">{{friendlyDateFromStr($trying['ProductTry']['start_time'])}}开秒</a>
                    {{/if}}
                </div>
            </div>
        </span>
            <?php } ?>
        </div>
        {{/if}}
    </div>
</div>
<script>
    $(document).ready(function(){
        var toTimer = $('.sec_start').first();
        var countDiv = toTimer.parent();
        var cartType = 'tuan_sec';
        utils.countDown(toTimer, function () {
        }, function () {
            var parent = countDiv.parent();
            countDiv.remove();
            parent.append('<a class="tuandetail_seckill_btn radius5 fr" data-try-id="{{$trying["ProductTry"]["id"]}}" data-tuan-id="{{$tuan_id}}" data-pid="{{$trying["Product"]["id"]}}" data-send-date="{{$trying["ProductTry"]["consignment_date"]}}">正在秒杀</a>');
        });

        function buyBtnClicked(buyBtn) {
            if (buyBtn.hasClass('seckill_disabled')) {
                return false;
            }
            var $pid = buyBtn.attr('data-pid');
            var tryId = buyBtn.attr('data-try-id');
            var sendDate = buyBtn.attr('data-send-date');
            quick_buy_try($pid, 1, 0, tryId, cartType, sendDate, function () {
                buyBtn.removeClass('doing').addClass('done');
            }, function () {
                //
            });
        }
        function bindClick(){
            //秒杀事件
            $('a.tuandetail_seckill_btn').click(function () {
                buyBtnClicked($(this));
            });
        }

        bindClick();

        /**
         * 添加到快速购买试吃秒杀
         * @param id 产品编号
         * @param num 产品数量
         * @param spec 产品规格
         * @param tryId 试吃id
         * @param type
         * @param soldOutCallback
         * @param addedCallback
         * @return
         */
        function quick_buy_try(id, num, spec, tryId, type, sendDate, soldOutCallback, addedCallback) {
            type = type || 'normal';
            var url = BASEURL + '/carts/add';
            var postdata = {
                'data[Cart][num]': num,
                'data[Cart][product_id]': id,
                'data[Cart][spec]': spec,
                'data[Cart][type]': type,
                'data[Cart][send_date]': sendDate,
                'try_id': tryId
            };
            ajaxAction(url, postdata, null, function (data) {
                if (data.success == false) {
                    if (data.reason == 'not_login') {
                        window.location.href = '/users/login.html?referer=' + encodeURIComponent("/");
                        return false;
                    } else if (data.reason == 'already_seckill_nopaid') {
                        utils.alert_one('抱歉：您还未支付哦,请前去支付', '去支付', function () {
                            window.location.href = '/orders/mine';
                        });
                    }else if (data.reason == 'already_seckill_paid'){
                        utils.alert_one('抱歉：限购一份哦，您已经秒过啦', '知道啦', function () {
                        });
                    }else if (data.reason == 'sold_out') {
                        utils.alert_one('抱歉：已经被秒完', '知道了', function () {
                            if (typeof(soldOutCallback) == 'function') {
                                soldOutCallback();
                            }
                        });
                    } else if (data.reason == 'already_buy') {
                        utils.alert_one('抱歉：您已经秒过啦', '关闭', function () {});
                    } else if (data.reason = 'not_comment') {
                        utils.alert_one('抱歉：您有' + data.not_comment_cnt + '个试吃商品还没有反馈，请先完成反馈再秒杀');
                    }
                } else {
                    addedCallback();
                    window.location.href = '/tuan_buyings/balance_global_sec_kill?from=tuan_sec&pid_list=' + data.id + '&try=' + tryId;
                }
            });
            return false;
        }

    });
</script>
{{$this->Html->script(array('/js/mobile-index.js?v3.4'), array('block' => 'scriptBottom'));}}
{{if $jWeixinOn}}
 <script>
     wx.ready(function () {
         var share_string = '{{$share_string ? $share_string :"0"}}';
         var to_timeline_title = "{{$to_timeline_title}}";
         var to_friend_title = "{{$to_friend_title}}";
         var to_friend_link = document.URL.split('?')[0] + '?trstr='+ share_string + '&share_type=appMsg';
         var to_timeline_link = document.URL.split('?')[0] + '?trstr='+ share_string + '&share_type=timeline';
         var imgUrl = "{{$this->Html->assetUrl($share_imag_url)}}";
         var desc = "{{$share_desc}}！";
         wx.onMenuShareAppMessage({
             title: to_friend_title,
             desc: desc,
             link: to_friend_link,
             imgUrl: imgUrl,
             success: function () {
                 // 用户确认分享后执行的回调函数
                 if(share_string != '0'){
                     setTimeout(function(){
                         $.post('/wx_shares/log_share',{ trstr: share_string, share_type: "appMsg" });
                     }, 500);
                 }
             }
         });
         wx.onMenuShareTimeline({
             title: to_timeline_title,
             link: to_timeline_link,
             imgUrl: imgUrl,
             success: function () {
                 if(share_string != '0'){
                     setTimeout(function(){
                         $.post('/wx_shares/log_share',{ trstr: share_string, share_type: "timeline" });
                     }, 500);
                 }
             }
         });
     });
 </script>
{{/if}}