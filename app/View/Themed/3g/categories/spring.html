{{$this->Html->css(array(
'spring_mobile.css',
))}}
<div class="year_banner"><img id="nianhuo_banner" src="/img/festival/newyear/banner.jpg" /></div>
<div class="year_good">
    {{loop $data_list $p}}

    {{if $i % 2 == 0}}
    <?php $item = $p; $i++?>
    {{else}}
    <?php $item2 = $p; $i++?>
    <ul class="clearfix">
        <li class="fl">
            <a href="/products/{{date('Ymd',strtotime($item['created']))}}/{{$item['slug']}}.html"><img src="{{$this->Html->assetUrl(small_thumb_link($item['coverimg']))}}" /><br/></a>
            <dl class="clearfix">
                <dt class="fl"><a href="{{$this->Html->url('/brands/'.date('Ymd',strtotime($brands[$item['brand_id']]['Brand']['created'])).'/'.$brands[$item['brand_id']]['Brand']['slug'].'.html')}}"><img class="radius10" src="{{$this->Html->assetUrl(small_thumb_link($brands[$item['brand_id']]['Brand']['coverimg']))}}" /></a></dt>
                <dt class="fl">{{usubstr($brands[$item['brand_id']]['Brand']['name'],0, 7,'')}}</dt>
            </dl>
            <a href="/products/{{date('Ymd',strtotime($item['created']))}}/{{$item['slug']}}.html"><div class="year_good_title">{{usubstr($item['name'],0, 9,'')}}</div></a>
            <div class="price">¥<span class="price_year">{{$this->Number->precision($item['price'], 2)}}</span>&nbsp;&nbsp;<span class="price_original">¥{{$this->Number->precision($item['original_price'], 2)}}</span></div>
            <dl class="clearfix">
                <dd class="fl">
                    <a href="javascript:;" pid="{{$item['id']}}" class="ticket_usable_btn {{if $pid_coupon[$item['id']]}}disabled {{/if}} radius10">
                        <div class="lingqu">领<br />取</div>
                        <div class="quan">¥<span>{{$spring_coupons[$item['id']]?$this->Number->precision($spring_coupons[$item['id']]/100, 0):0}}</span>券</div>
                    </a>
                </dd>
                <dd class="fr"><a  item-id="{{$item['id']}}" href="/products/{{date('Ymd',strtotime($item['created']))}}/{{$item['slug']}}.html" class="pay_usable_btn radius10">&nbsp;立即购买&nbsp;</a></dd>
            </dl>
        </li>
        <li class="fr">
            <a href="/products/{{date('Ymd',strtotime($item2['created']))}}/{{$item2['slug']}}.html"> <img src="{{$this->Html->assetUrl(small_thumb_link($item2['coverimg']))}}" /><br /></a>
            <dl class="clearfix">
                <dt class="fl"><a href="{{$this->Html->url('/brands/'.date('Ymd',strtotime($brands[$item['brand_id']]['Brand']['created'])).'/'.$brands[$item2['brand_id']]['Brand']['slug'].'.html')}}"><img class="radius10" src="{{$this->Html->assetUrl(small_thumb_link($brands[$item2['brand_id']]['Brand']['coverimg']))}}" /></a></dt>
                <dt class="fl">{{usubstr($brands[$item2['brand_id']]['Brand']['name'],0, 7,'')}}</dt>
            </dl>
            <a href="/products/{{date('Ymd',strtotime($item2['created']))}}/{{$item2['slug']}}.html"><div class="year_good_title">{{usubstr($item2['name'],0, 9,'')}}</div></a>
            <div class="price">¥<span class="price_year">{{$this->Number->precision($item2['price'], 2)}}</span>&nbsp;&nbsp;<span class="price_original">¥{{$this->Number->precision($item2['original_price'], 2)}}</span></div>
            <dl>
                <dd class="fl">
                    <a href="javascript:;" pid="{{$item2['id']}}" class="ticket_usable_btn {{if $pid_coupon[$item2['id']]}}disabled {{/if}} radius10">
                        <div class="lingqu">领<br />取</div>
                        <div class="quan">¥<span>{{$spring_coupons[$item['id']]?$this->Number->precision($spring_coupons[$item2['id']]/100, 0):0}}</span>券</div>
                    </a>
                </dd>
                <dd class="fr"><a  item-id="{{$item2['id']}}" href="/products/{{date('Ymd',strtotime($item2['created']))}}/{{$item2['slug']}}.html" class="pay_usable_btn radius10">&nbsp;立即购买&nbsp;</a></dd>
            </dl>
        </li>
    </ul>
    {{/if}}
    {{/loop}}
    {{if $i%2 == 1}}
    <ul class="clearfix">
        <li class="fl">
            <a href="/products/{{date('Ymd',strtotime($item['created']))}}/{{$item['slug']}}.html"><img src="{{$this->Html->assetUrl(small_thumb_link($item['coverimg']))}}" /><br/></a>
            <dl class="clearfix">
                <dt class="fl"><a href="{{$this->Html->url('/brands/'.date('Ymd',strtotime($brands[$item['brand_id']]['Brand']['created'])).'/'.$brands[$item['brand_id']]['Brand']['slug'].'.html')}}"><img class="radius10" src="{{$this->Html->assetUrl(small_thumb_link($brands[$item['brand_id']]['Brand']['coverimg']))}}" /></a></dt>
                <dt class="fl">{{usubstr($brands[$item['brand_id']]['Brand']['name'],0, 7,'')}}</dt>
            </dl>
            <a href="/products/{{date('Ymd',strtotime($item['created']))}}/{{$item['slug']}}.html"><div class="year_good_title">{{usubstr($item['name'],0, 9,'')}}</div></a>
            <div class="price">¥<span class="price_year">{{$this->Number->precision($item['price'], 2)}}</span>&nbsp;&nbsp;<span class="price_original">¥{{$this->Number->precision($item['original_price'], 2)}}</span></div>
            <dl class="clearfix">
                <dd class="fl">
                    <a href="javascript:;" pid="{{$item['id']}}" class="ticket_usable_btn {{if $pid_coupon[$item['id']]}}disabled {{/if}} radius10">
                        <div class="lingqu">领<br />取</div>
                        <div class="quan">¥<span>{{$spring_coupons[$item['id']]?$this->Number->precision($spring_coupons[$item['id']]/100, 0):0}}</span>券</div>
                    </a>
                </dd>
                <dd class="fr"><a   item-id="{{$item['id']}}" href="/products/{{date('Ymd',strtotime($item['created']))}}/{{$item['slug']}}.html" class="pay_usable_btn radius10">&nbsp;立即购买&nbsp;</a></dd>
            </dl>
        </li>
    </ul>

    {{/if}}
</div>
<input type="text" id="current_pid" class="hidden">
<!--领取成功-->
<div class="layer_lingqu radius10" style="display:none;" >领取成功! 下单结算时即可使用。</div>

{{if $lingqu}}
<div id="sub_back" class="layer_lingqu radius10" style="display:none;" >领取成功! 下单结算时即可使用。</div>
{{/if}}


<div class="modal fade" id="myModal" role="dialog">
    <div class="layer_guanzhu radius10">
        <div class="guanzhu_title">关注[朋友说]服务号, 接收优惠券通知!</div>
        <div>优惠券将通过服务号发送到您的微信，<br />便于您使用和查看。</div>
        <a href="javascript:;" id="subscribe" class="radius10">马上关注</a>
    </div>
</div>

<!--寄信说明-->
<div class="modal fade" id="myModal2" role="dialog">
    <div class="layer_guanzhu radius10">
        <div class="guanzhu_title">如何给爸爸妈妈寄出新年的问候</div>
        <div style="text-align:left; color:#666666;">1、微信加朋友说的客服MM号：pyshuo2015<br />2、将对爸爸妈妈的祝福告诉我们<br />3、我们去邮局给您寄出您的新年问候，并将贺卡照片发给您</div>
        <a href="javascript:;" class="radius10" style="color:#666666; border-color:#dddddd;" data-dismiss="modal">关闭</a>
    </div>
</div>
<button id="onMenuShareTimeline">onMenuShareTimeline</button>
<button id="onMenuShareAppMessage">onMenuShareAppMessage</button>
{{template Elements/wexinjssdk}}
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>

<script>
    wx.config({
        debug: true,
        appId: '<?=$appId?>',
        timestamp: <?=$timestamp?>,
            nonceStr: '<?=$nonceStr?>',
            signature: '<?=$signature?>',
            jsApiList: [
        'checkJsApi',
        'onMenuShareTimeline',
        'onMenuShareAppMessage'
    ]
    });

//    wx.config({
//        debug: false,
//        appId: '<?php echo $signPackage["appId"];?>',
//        timestamp: <?php echo $signPackage["timestamp"];?>,
//        nonceStr: '<?php echo $signPackage["nonceStr"];?>',
//        signature: '<?php echo $signPackage["signature"];?>',
//        jsApiList: [
//        // 所有要调用的 API 都要加到这个列表中
//        'checkJsApi',
//        'onMenuShareTimeline',
//        'onMenuShareAppMessage'
//    ]
//    });
//    wx.ready(function () {
//        // 在这里调用 API
//        wx.onMenuShareAppMessage({
//            title: '过年了，'+'{{$nickname}}'+'说一起领红包办年货，把爱带回家。',
//            desc: '低价抢不停，给爸妈置年货，朋友说一起给爸妈寄出新年的问候。',
//            link: 'http://www.tongshijia.com/categories/spring',
//            imgUrl: 'http://www.tongshijia.com/img/festival/newyear/banner.jpg'
//
//        });
//        wx.onMenuShareTimeline({
//            title: '过年了，'+'{{$nickname}}'+'说一起领红包办年货，把爱带回家。',
//            desc: '低价抢不停，给爸妈置年货，朋友说一起给爸妈寄出新年的问候。',
//            link: 'http://www.tongshijia.com/categories/spring',
//            imgUrl: 'http://www.tongshijia.com/img/festival/newyear/banner.jpg'
//        });
//
//    });
//
//
    wx.ready(function () {
        // 1 判断当前版本是否支持指定 JS 接口，支持批量判断
        document.querySelector('#checkJsApi').onclick = function () {
            wx.checkJsApi({
                jsApiList: [
                    'getNetworkType',
                    'previewImage'
                ],
                success: function (res) {
                    alert(JSON.stringify(res));
                }
            });
        };

        // 2. 分享接口
        // 2.1 监听“分享给朋友”，按钮点击、自定义分享内容及分享结果接口
        document.querySelector('#onMenuShareAppMessage').onclick = function () {
            wx.onMenuShareAppMessage({
                title: '互联网之子',
                desc: '在长大的过程中，我才慢慢发现，我身边的所有事，别人跟我说的所有事，那些所谓本来如此，注定如此的事，它们其实没有非得如此，事情是可以改变的。更重要的是，有些事既然错了，那就该做出改变。',
                link: 'http://movie.douban.com/subject/25785114/',
                imgUrl: 'http://img3.douban.com/view/movie_poster_cover/spst/public/p2166127561.jpg',
                trigger: function (res) {
                    alert('用户点击发送给朋友');
                },
                success: function (res) {
                    alert('已分享');
                },
                cancel: function (res) {
                    alert('已取消');
                },
                fail: function (res) {
                    alert(JSON.stringify(res));
                }
            });
            alert('已注册获取“发送给朋友”状态事件');
        };

        // 2.2 监听“分享到朋友圈”按钮点击、自定义分享内容及分享结果接口
        document.querySelector('#onMenuShareTimeline').onclick = function () {
            wx.onMenuShareTimeline({
                title: '互联网之子',
                link: 'http://movie.douban.com/subject/25785114/',
                imgUrl: 'http://img3.douban.com/view/movie_poster_cover/spst/public/p2166127561.jpg',
                trigger: function (res) {
                    alert('用户点击分享到朋友圈');
                },
                success: function (res) {
                    alert('已分享');
                },
                cancel: function (res) {
                    alert('已取消');
                },
                fail: function (res) {
                    alert(JSON.stringify(res));
                }
            });
            alert('已注册获取“分享到朋友圈”状态事件');
        };
    });

</script>
<script>
    $(document).ready(function(){
        $('.year_banner').on('click',function(){
            $('#myModal2').modal('show');
        });
        $('.ticket_usable_btn').each(function(){
            $(this).on('click',function(){
                var element = $(this);
                if(element.hasClass('disabled')){
                    return false;
                }
                if(!sso.check_userlogin()){
                    return false;
                }else{
                    var pid = $(this).attr('pid');
                    var count = 2;
                    $.getJSON("/categories/mobile_get_spring_coupon?pid=" + pid, function(data) {
                        if(data.success){
                            element.addClass('disabled');
                            $('.layer_lingqu').fadeIn(1000).fadeOut(2000);
                            var countdown = setInterval(function(){
                                if (count == 0) {
                                    var $share_div = $('<div class="apple_share fade in"><img src="/img/festival/newyear/share.png" style="width:95%"></div>')
                                            .show().click(function(){
                                                $share_div.hide();
                                            });
                                    $('body').append($share_div);
                                    clearInterval(countdown);
                                }
                                count--;
                            }, 1000);
                        }else{
                            if(data.reason == 'need_sub'){
                                $('#myModal').modal('show');
                                $('#current_pid').val(pid);
                            }else{
                                utils.alert('无法领取');
                            }
                        }
                    });
                }
            });
        });
        $('#subscribe').bind('click', function(){
            var pid = $('#current_pid').val();
            $.get("/weixin/save_subscribe_info?spring="+pid, function(data) {
                window.location.href = 'http://mp.weixin.qq.com/s?__biz=MjM5MjY5ODAyOA==&mid=200769784&idx=1&sn=8cce5a47e8a6123028169065877446b9#rd';
            });
        });
        if($('#sub_back').size()>=1){
            $('#sub_back').fadeIn(1000).fadeOut(2000);
        }

//        var imgUrl = $('#nianhuo_banner').attr('src');
//        var lineLink = 'http://{{WX_HOST}}/categories/spring';
//        var descContent = '低价抢不停，给爸妈置年货，朋友说一起给爸妈寄出新年的问候。';
//        var shareTitle = '过年了，{{$nickname}}说一起领红包办年货，把爱带回家。';
//        var appid = '{{WX_APPID}}';
//
//        // 当微信内置浏览器完成内部初始化后会触发WeixinJSBridgeReady事件。
//        document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
//            WeixinJSBridge.on('menu:share:appmessage', function(argv){
//                utils.wx_to_friend(appid, imgUrl, lineLink, descContent, shareTitle);
//            });
//            WeixinJSBridge.on('menu:share:timeline', function(argv){
//                utils.wx_to_timeline(appid, imgUrl, lineLink, descContent, shareTitle);
//            });
//        }, false);
    })
</script>