<script type="text/javascript">

    //调用微信JS api 支付
    function jsApiCall()
    {
        var doneUrlPrefix = '{{$paid_done_url}}';
        WeixinJSBridge.invoke(
                'getBrandWCPayRequest',
                {{$jsApiParameters}},
        function(res){
            var $msg, not_redirect;
            if(res.err_msg == "get_brand_wcpay_request:ok" ) {
                $msg = 'ok';
            } else if(res.err_msg == "get_brand_wcpay_request:cancel") {
                $msg = 'cancel';
            } else if(res.err_msg == "get_brand_wcpay_request:fail") {
                $msg = 'fail';
            } else if(res.err_msg == "system:access_denied" || res.err_msg == "access_control:not_allow" || res.err_msg == 'getBrandWCPayRequest:fail_invalid appid'){
                $msg = 'denied';
                utils.alert('<div class="alert-warning">请搜索{{WX_SERVICE_ID_NO}}关注我们的服务号，在『个人中心』->『我的订单』完成支付。</div>', function(){
                    window.location.href = doneUrlPrefix + encodeURIComponent($msg);
                });
                not_redirect = true;
            } else {
                WeixinJSBridge.log(res.err_msg);
                $msg = res.err_msg;
            }

            if (!not_redirect) {
                window.location.href = doneUrlPrefix + encodeURIComponent($msg);
            }
        }
    );
    };

    function callpay()
    {
        var $this = $(this);
        if ($this.attr('disabled') == 'disabled') {
            return;
        }
        $this.attr('disabled', 'disabled').addClass('disabled');
        if (typeof WeixinJSBridge == "undefined"){
            if( document.addEventListener ){
                document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
            }else if (document.attachEvent){
                document.attachEvent('WeixinJSBridgeReady', jsApiCall);
                document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
            }
        }else{
            jsApiCall();
        }
    }

    $(document).ready(function(){
        callpay();
    });
</script>

<div class="row">
    <div class="panel panel-primary">
        <div class="panel-body">
            <ul class="list-group">
                <li class="list-group-item">
                    <span>{{$productDesc}}</span>
                </li>
                <li class="list-group-item">
                    <span>应付总额:</span>
                    <span class="text-price fontsize14 pull-right">¥{{$this->Number->precision($totalFee, 2)}}</span>
                </li>
            </ul>
        </div>
    </div>
    <div align="center">
        <button type="button" class="btn btn-warning" onclick="callpay()">正在跳转微信支付...</button>
    </div>
</div>


