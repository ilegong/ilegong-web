{{if !$hideNav }}
<footer class="footbox">
<div class="container">
    <hr>
	<p>如果觉得我们不错，点右上角分享按钮“...”分享给朋友。</p>
	<p>【朋友说】是朋友同事间互相分享自家特产的平台。我们创业团队来自于腾讯、搜狐和去哪儿。	</p>
	<p style="color:red;"><strong>商务电话:</strong><a href="tel:18911911240">18911911240</a></p>
	<p style="color:red;"><strong>客服电话:</strong><a href="tel:18911692346">18911692346</a></p>
	<p><br></p>
	<p><br></p>
	<p><br></p>
</div>
</footer>
{{/if}}

{{$this->Html->script(array(
			'jquery/jquery.lazyload.min.js',
            'bootstrap.min.js','bootbox/bootbox.min.js', 'common.js?v3','front.js','front_orders.js'
        ));
}}
{{$this->Html->scriptStart(array('block' => 'scriptBottom'));}}
    if (bootbox) {
    bootbox.setDefaults({
        locale: "zh_CN"
    });
    }
{{$this->Html->scriptEnd()}}
<!-- helper中追加的底部脚本 $this->_View->append('bottomscript',$script);-->
{{$this->fetch('bottomscript')}}
<script type="text/javascript">
	
	var cart = {};	

	function addToCart(itemId, itemNum, price, name){
		
		cart[itemId] = {'num' : itemNum, 'price' : price , 'name' : name };
		$('#item-' + itemId).find('div.select-item').show();
					
		//产品介绍页面处理
		$('#single-item-' + itemId).removeClass('btn-primary').addClass('btn-success').text('从购物车删除');
		$('#pamount-' + itemId).val(itemNum);
		
		updateCart();
	}

	function deleteFromCart(itemId){
		$('#item-' + itemId).find('div.select-item').hide();
		//产品介绍页面处理
		$('#single-item-' + itemId).removeClass('btn-success').addClass('btn-primary').text('添加到购物车');
		$('#pamount-' + itemId).val(1);
		delete cart[itemId];
		updateCart();
	}

	function updateCart(){
		var itemNum = 0, cost = 0;
		
		for(var itemId in cart){
			
			itemNum += parseInt(cart[itemId]['num']);
			cost +=  parseInt(cart[itemId]['num'])  * parseFloat(cart[itemId]['price']);
		}
		var $cartBtn = $('#card-btn');
		if(itemNum > 0){
			$cartBtn.removeClass('btn-warning').addClass('btn-success').find('span').html('已选' + itemNum + '份，共'+ cost +'元，点击下单');
		}else {
			$cartBtn.addClass('btn-warning').removeClass('btn-success').find('span').html('请先下单');
		}

		saveCartToCookie();
	}

	function saveCartToCookie(){
		var cartStr = '';
		for(var itemId in cart){
			cartStr += [itemId, cart[itemId]['num'], cart[itemId]['price'], cart[itemId]['name']].join(':');
			cartStr += ',';
		}
		$.cookie('cart_products', cartStr, {'path' : '/'});
	}

	function readFromCookie(){
		var cart_products = $.cookie('cart_products') || '';
		var items = cart_products.split(',');

		for(var i = 0, len = items.length; i < len ; ++ i){
			var itemStr = items[i];
			if(itemStr){
				var itemDetails = itemStr.split(':');
				var itemId = parseInt(itemDetails[0]) ;
				var itemNum = parseInt(itemDetails[1]) ;
				if( itemId && itemNum){
					addToCart(itemId, itemNum, parseFloat(itemDetails[2]) || 0, itemDetails[3] )
				}
			}
		}

		updateCart();

	}

	function createCart(){
		var itemNum = 0, cost = 0;
		var itemStr = '';
		var cart_products_html = '';
		for(var itemId in cart){
			
			var $item = $('#item-' + itemId);
			var price = parseFloat(cart[itemId]['price']);
			var name = cart[itemId]['name'];
			var num = parseInt(cart[itemId]['num']);
			itemNum += num;
			cost += (price * num);
			cart_products_html +='<div class="row cart_products-row"><div class="col-xs-5">'
					+'<span class="item-name" title="'+name+'">'+name+' <br></span>'
					+'<span class="item-price-info"><span><span class="item-total-price">￥'+ (price * num)+'</span>(<span class="item-single-price">'+price+'</span>×<span class="item-amount">'+num+'</span>)'
					+'</span></span></div>'
					+'<div class="col-xs-5 input-group input-group-sm">'
					+'<span item-id="'+itemId+'" class="reduce input-group-addon '+(num==1?'disabled':'')+'">—</span>'
					+'<input class="form-control" type="text" name="amount" size="3" value="'+num+'" autocomplete="off" readonly="readonly">'
					+'<span item-id="'+itemId+'" class="add input-group-addon">+</span>'
					+'</div>'
					+'<div class="col-xs-2">'
					+'<a class="delete-btn" item-id="'+itemId+'"  href="javascript:void(0);">'
					+'<span class="glyphicon glyphicon-remove-circle" style="font-size:18px;color:red;"></span></a>'
					+'</div>'
					+'</div><div class="divider"></div>';

		}

		
		$('#cart_products-total-price').text(cost);
		
		if(itemNum <= 0){
			$('#checkout-btn' ).removeClass('btn-primary').addClass('btn-warning');
		}else{
			$('#checkout-btn' ).removeClass('btn-warning').addClass('btn-primary');
		}

		$('#cart-modal').find('.modal-body').html(cart_products_html);
		
	}

	$(document).ready(function(){
		$("img.lazy").lazyload({
			placeholder : "/Public/Index/img/grey.gif",
			effect: "fadeIn",
			threshold : 100
		});
		
		if( $('#item-detail-title').size() > 0) { //detail page
			if( $('#productinfo').size() > 0){//for booking, must refresh
				$('#go-back-div').find('a').attr('href', '/').end().show();
			}else{
				$('#go-back-div').show();
			}
			
		}
		
		readFromCookie();

		//items with shopping class
		$("a.shopping").click(function(){
			var $item = $(this);
			var itemId = $item.attr('item-id');

			if( itemId in cart){ // already added, remove it
				
				deleteFromCart(itemId);
			}else { //not added
				
				addToCart(itemId, parseInt($('#pamount-' + itemId).val()) || 1, (parseFloat($item.attr('item-price')) || 0 ), $item.attr('item-name'));
				
			}
			
		});

		//show cart button
		$('#card-btn').click(function(){
			if($(this).hasClass('btn-success')){ //has item
				createCart();
				$('#cart-modal').modal(); 
			}
		});

		$('#checkout-btn').click(function(){
			if($(this).hasClass('btn-warning')){
				return false;
			}
		});

		//cart dialog
		$('#cart-modal,#productinfo').on('click', 'span.reduce', function(){
			var itemId = $(this).attr('item-id');
			var $amount = $(this).siblings('#pamount-' + itemId);
			if( $amount.size() > 0 && parseInt($amount.val()) > 1){
				$amount.val( parseInt($amount.val()) -  1);
			} 
			if(cart[itemId]){
				var num =  (parseInt(cart[itemId]['num']) || 1);
				if(num > 1){
					num = num -1;
					cart[itemId]['num'] = num;
					updateCart();
					createCart();
				}
				$amount.val(num);
			}
			
		}).on('click', 'span.add', function(){
			var itemId = $(this).attr('item-id');
			var $amount = $(this).siblings('#pamount-' + itemId);
			if( $amount.size() > 0 ){
				$amount.val( parseInt($amount.val()) +  1);
			} 
			if(cart[itemId]){
				var num = (parseInt(cart[itemId]['num']) || 0) + 1;
				cart[itemId]['num'] = num;
				$amount.val(num);
				updateCart();
				createCart();
			}

		}).on('click', 'a.delete-btn', function(){
			var itemId = $(this).attr('item-id');
			deleteFromCart(itemId);
			createCart();
		});





	});
</script>
<script>
    $(document).ready(function() {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-754470-7', 'auto');
        ga('require', 'linkid', 'linkid.js');
        ga('send', 'pageview');
    });
</script>