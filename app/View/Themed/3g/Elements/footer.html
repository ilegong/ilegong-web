{{if !$hideNav }}
<footer>
        <img src="{{$this->Html->url('/img/logo_footer.jpg')}}" border="0" /><br /><br />如果觉得我们不错,点右上角分享按钮"…"分享给朋友。
        <br /><br />[朋友说]是朋友同事间互相分享自家特产的平台。<br />我们创业团队来自于腾讯、搜狐和去哪儿。
        <br /><br />商务电话: <a href="tel:18911911240">189-1191-1240</a><br />客服电话: <a href="tel:18911692346">189-1169-2346</a>
</footer>
{{/if}}

{{$this->Html->script(array(
			'jquery/jquery.lazyload.min.js',
            'bootstrap.min.js','bootbox/bootbox.min.js', 'common.js?v5','front.js','front_orders.js?v1'
        ));
}}
{{$this->Html->scriptStart(array('block' => 'scriptBottom'));}}
    if (bootbox) {
    bootbox.setDefaults({
        locale: "zh_CN"
    });
    }
{{$this->Html->scriptEnd()}}
<!-- helper中追加的底部脚本 $this->_View->append('bottomscript',$script);-->
{{$this->fetch('bottomscript')}}
<script type="text/javascript">
	
	var cart = {};	

	function addToCart(itemId, itemNum, price, name, specId){

		cart[itemId] = {'num' : itemNum, 'price' : price , 'name' : name, 'specId': specId };
		$('#item-' + itemId).find('div.select-item').show();
					
		//产品介绍页面处理
		$('#single-item-' + itemId).removeClass('btn-primary').addClass('btn-success').text('从购物车删除');
		$('#pamount-' + itemId).val(itemNum);
		
		updateCart();
	}

	function deleteFromCart(itemId){
		$('#item-' + itemId).find('div.select-item').hide();
		//产品介绍页面处理
		$('#single-item-' + itemId).removeClass('btn-success').addClass('btn-primary').text('添加到购物车');
		$('#pamount-' + itemId).val(1);
		delete cart[itemId];
		updateCart();
	}

	function updateCart(){
		var itemNum = 0, cost = 0;
		
		for(var itemId in cart){
			
			itemNum += parseInt(cart[itemId]['num']);
			cost +=  parseInt(cart[itemId]['num'])  * parseFloat(cart[itemId]['price']);
		}
		var $cartBtn = $('#card-btn');
		if(itemNum > 0){
			//$cartBtn.removeClass('btn-warning').addClass('btn-success');
            $cartBtn.addClass('cart_icon_not_empty');
		}else {
			//$cartBtn.addClass('btn-warning').removeClass('btn-success');
            $cartBtn.removeClass('cart_icon_not_empty');
		}

		saveCartToCookie();
	}

	function saveCartToCookie(){
		var cartStr = '';
		for(var itemId in cart){
			cartStr += [itemId, cart[itemId]['num'], cart[itemId]['specId'], cart[itemId]['price'], cart[itemId]['name']].join(':');
			cartStr += ',';
		}
		$.cookie('cart_products', cartStr, {'path' : '/'});
	}

	function readFromCookie(){
		var cart_products = $.cookie('cart_products') || '';
		var items = cart_products.split(',');

		for(var i = 0, len = items.length; i < len ; ++ i){
			var itemStr = items[i];
			if(itemStr){
				var itemDetails = itemStr.split(':');
				var itemId = parseInt(itemDetails[0]) ;
				var itemNum = parseInt(itemDetails[1]) ;
				if( itemId && itemNum){

                    var price, name;
                    if (itemDetails.length > 4) {
                        var specId = parseInt(itemDetails[2]) || 0;
                        price = parseFloat(itemDetails[3]) || 0;
                        name = itemDetails[4];
                    } else {
                        price = parseFloat(itemDetails[2]) || 0;
                        name = itemDetails[3];
                    }

                    addToCart(itemId, itemNum, price, name, specId || 0)
				}
			}
		}

		updateCart();
	}

	$(document).ready(function(){
		$("img.lazy").lazyload({
			placeholder : "/Public/Index/img/grey.gif",
			effect: "fadeIn",
			threshold : 100
		});
		
		if( $('#item-detail-title').size() > 0) { //detail page
			if( $('#productinfo').size() > 0){//for booking, must refresh
				$('#go-back-div').find('a').attr('href', '/').end().show();
			}else{
				$('#go-back-div').show();
			}
			
		}
		
		readFromCookie();

		//items with shopping class
		$("a.shopping").click(function(){
			var $item = $(this);
			var itemId = $item.attr('item-id');

			if( itemId in cart){ // already added, remove it
				
				deleteFromCart(itemId);
			}else { //not added

                var specId = '';
                if(typeof(_p_spec_m) != 'undefined') {
                    if(_p_spec_m) {
                        var spec_labels = $('span.spec_label');
                        if (spec_labels.size() > 0) {
//                            $.each(spec_labels, function(idx, spanLabel){
//                            });
                            if($('span.spec_item_selected').size() == 0) {
                                utils.alert("请选择蛋糕口味");
                                return false;
                            }

                            specId = _p_spec_m[$('span.spec_item_selected').text()];
                        }
                    }
                }

				addToCart(itemId, parseInt($('#pamount-' + itemId).val()) || 1, (parseFloat($item.attr('item-price')) || 0 ), $item.attr('item-name'), specId||0);
			}
			
		});

		//show cart button
		$('#card-btn').click(function(ev){
			if($(this).hasClass('cart_icon_not_empty')){ //has item
                window.location.href = '/carts/listcart.html';
			} else {
                utils.alert('购物车中没有东西');
                ev.preventDefault();
                return false;
            }
		});

		$('#checkout-btn').click(function(){
			if($(this).hasClass('btn-warning')){
				return false;
			}
		});
	});
</script>
<script>
    $(document).ready(function() {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-754470-7', 'auto');
        ga('require', 'linkid', 'linkid.js');
        ga('send', 'pageview');
    });
</script>