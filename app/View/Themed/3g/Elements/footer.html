<footer class="footbox">
<div class="container">
	<p><br></p>
	<p>如果觉得我们不错，点右上角“...”分享给朋友。</p>
	<p>51daifan，让一部分人先安全起来！</p>
	<p>51daifan，由腾讯志愿者北京分会志愿者自主研发的爱心项目，同事间互相分享自家特产的平台。	</p>
	<p><br></p>
	<p><br></p>
	<p><br></p>
</div>
</footer>
{{$this->Html->script(array(
          'jquery/jquery.lazyload.js',
    ));
}}
<script type="text/javascript">
	$(document).ready(function() {
		$("img.lazy").lazyload({placeholder : "{{Router::url('/img/grey.gif')}}",effect: "fadeIn",threshold : 200});
	});


	$(document).ready(function(){
		
		var cart = {};	
		readFromCookie();

		//items with shopping class
		$("a.shopping").click(function(){
			var $item = $(this);
			var itemId = $item.attr('item-id');

			if( itemId in cart){ // already added, remove it
				$item.find('div.select-item').hide();
				delete cart[itemId];
			}else { //not added
				
				$item.find('div.select-item').show();
				cart[itemId] = {'num' : 1, 'price' : (parseFloat($item.attr('item-price')) || 0 ) , 'name' : $item.attr('item-name') };
			}
			updateCart();
		});

		//show cart button
		$('#card-btn').click(function(){
			createCart();
			$('#cart-modal').modal(); 
		});

		//cart dialog
		$('#cart-modal').on('click', 'span.reduce', function(){
			var itemId = $(this).attr('data-id');
			cart[itemId]['num'] =  (parseInt(cart[itemId]['num']) || 0) - 1;
			if(cart[itemId]['num'] <= 0){
				$('#item-' + itemId).find('div.select-item').hide();
				delete cart[itemId];
			}
			updateCart();
			createCart();
		}).on('click', 'span.add', function(){
			var itemId = $(this).attr('data-id');
			cart[itemId]['num'] = (parseInt(cart[itemId]['num']) || 0) + 1;
			updateCart();
			createCart();
		}).on('click', 'a.delete-btn', function(){
			var itemId = $(this).attr('data-id');
			$('#item-' + itemId).find('div.select-item').hide();
			delete cart[itemId];
			updateCart();
			createCart();
		});

		function updateCart(){
			var itemNum = 0, cost = 0;
			
			for(var itemId in cart){
				
				itemNum += parseInt(cart[itemId]['num']);
				cost +=  parseInt(cart[itemId]['num'])  * parseFloat(cart[itemId]['price']);
			}
			var $cartBtn = $('#card-btn');
			if(itemNum > 0){
				$cartBtn.removeClass('btn-warning').addClass('btn-success').find('span').html('已选择' + itemNum + '份，总共'+ cost +'元，点击下单');
			}else {
				$cartBtn.addClass('btn-warning').removeClass('btn-success').find('span').html('请先下单');
			}

			saveCartToCookie();
		}

		function saveCartToCookie(){
			var cartStr = '';
			for(var itemId in cart){
				cartStr += [itemId, cart[itemId]['num'], cart[itemId]['price'], cart[itemId]['name']].join(':');
				cartStr += ',';
			}
			$.cookie('cart_products', cartStr, {'path' : '/'});
		}

		function readFromCookie(){
			var cart_products = $.cookie('cart_products') || '';
			var items = cart_products.split(',');

			for(var i = 0, len = items.length; i < len ; ++ i){
				var itemStr = items[i];
				if(itemStr){
					var itemDetails = itemStr.split(':');
					var itemId = parseInt(itemDetails[0]) ;
					var itemNum = parseInt(itemDetails[1]) ;
					if( itemId && itemNum){
						$('#item-' + itemId).find('div.select-item').show();
						cart[itemId] = {'num' : itemNum, 'price' : (parseFloat(itemDetails[2]) || 0 ) , 'name' : itemDetails[3] };
					}
				}

				
			}

			updateCart();

		}

		function createCart(){
			var itemNum = 0, cost = 0;
			var itemStr = '';
			var cart_products_html = '';
			for(var itemId in cart){
				
				var $item = $('#item-' + itemId);
				var price = parseFloat(cart[itemId]['price']);
				var name = cart[itemId]['name'];
				var num = parseInt(cart[itemId]['num']);
				itemNum += num;
				cost += (price * num);
				cart_products_html +='<div class="row cart_products-row"><div class="col-xs-5">'
 					+'<span class="item-name" title="'+name+'">'+name+' <br></span>'
 					+'<span class="item-price-info"><span><span class="item-total-price">￥'+ (price * num)+'</span>(<span class="item-single-price">'+price+'</span>×<span class="item-amount">'+num+'</span>)'
 					+'</span></span></div>'
 					+'<div class="col-xs-5 input-group">'
 					+'<span data-id="'+itemId+'" class="reduce input-group-addon '+(num==1?'disabled':'')+'">—</span>'
 					+'<input class="form-control" type="text" name="amount" value="'+num+'" autocomplete="off" disabled>'
 					+'<span data-id="'+itemId+'" class="add input-group-addon">+</span>'
 					+'</div>'
 					+'<div class="col-xs-2">'
 					+'<a class="delete-btn" data-id="'+itemId+'"  href="javascript:void(0);">'
 					+'<span class="glyphicon glyphicon-remove-circle"></span></a>'
 					+'</div>'
 					+'</div><div class="divider"></div>';

			}

			if(cost > 0){
				cart_products_html += '<div class="row total-info cart_products-total-info"><div class="col-xs-12">共<span id="cart_products-total-price">'+cost+'</span>元</div></div>';
			}

			$('#cart-modal').find('.modal-body').html(cart_products_html);
			
		}

	});
</script>