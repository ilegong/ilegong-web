{{$this->Html->script(array('trace/tracekit.min.report.js', 'shake/shake.js', 'howler/howler.min.js', '3dfalling/rotate3Di.min.js', '3dfalling/3d-falling-leaves.js', 'jquery/jquery.fullPage.min.js'), array('block' => 'scriptBottom'));}}
<style>
    #yao_jp_div > span {
        border: 1px solid darkkhaki;
        margin-bottom: 2px;
        text-align: center;
        display: block;
    }
    .selected {
        background-color: lightgreen;
    }

    .modal-footer { margin-top:0 }
    .modal-body {padding-bottom:10px}

    .bootbox-body {
        text-align: left;
    }
    .modal-footer {
        text-align: center;
    }

    .october-leaf {
        position: absolute;
        background-color: transparent;
        background-image: url('http://51daifan.sinaapp.com/img/apple201410/leavesv2.png');
        -webkit-transform: translateZ(0);
        -moz-transform: translateZ(0);
        transform: translateZ(0);
    }
    .apple_share {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1030;
        background-color: #000;
    }

    .apple_share.in {
        opacity: .9;
    }

    img {
        max-width: 100%;
    }

    a:hover, a:focus {
        color: inherit;
        text-decoration: none;
    }

    .apple_numbers {
        color: red;
        font-size: 20px;
    }

    *{ margin:0; padding:0; font-family:"微软雅黑";}
    img{ border:0;}
    ul,li{ list-style:none;}
    .clearfix{*zoom:1;}
    .clearfix:after{content: ".";display: block;height: 0;clear: both; visibility: hidden;}
    .fl{ float:left;}
    .fr{ float:right;}
    .radius10{
        -moz-border-radius: 0.417em;/* Gecko browsers */-webkit-border-radius: 0.417em;/* Webkit browsers */border-radius:0.417em;/* W3C syntax */
    }

    .bg{ width:100%; /*position:absolute; top:0; left:0;*/ z-index:0;}
    .bg img,.index_bottom img,.index_title img,.tree img{ width:100%;}

    /*index*/
    .index_bottom{ width:100%; position:absolute; bottom:0; left:0; z-index:1;}
    .index_title{ width:100%; position:absolute; top:1.3em; left:0; z-index:2;}
    .tree{ width:100%; position:absolute; top:3.5em; left:0; z-index:2;}
    .rock_num{ margin:0.5em 1.2em 1.8em 1.2em; background-color:#ffffff; font-size:0.8em; color:#333333; padding:0.3em 0.5em 0.3em 0.917em; height: 2.4em; line-height:2em;}
    .rock_num .fl a{ color:#ff483a; text-decoration:none; text-align:center; width:100%;}
    .rock_num .fr a{ display:block; color:#ffffff; text-decoration:none; background-color:#ff483a; font-size:1.1em; padding:0 0.625em;}
    .help{ display:block; margin:0.8em 1.2em 0 1.2em; text-align:center; margin-bottom:0; background-color:#ff483a; font-size:1em; color:#ffffff; padding:0.4em 0.5em 0.4em 0.917em;   text-decoration:none;}
    .seckill{ display:inline-block; margin:0.8em 1.2em 0 1.2em; text-align:center; margin-bottom:0; background-color:#cccccc; font-size:1em; color:#ff483a; padding:0.4em 0.1em 0.4em 0.117em;  text-decoration:none;}
    .word_link{ text-align:center; font-size:1em; margin-top:1.5em;}
    .word_link a{ text-decoration:none; color:#333333;}
    .next{ display:block; text-align:center; position:absolute; bottom:0.3em;  width:100%; z-index:2;}
    .next img{ width:1.2em; height:0.875em;}

    /*产品故事*/
    .viewport {min-width:300px; max-width:640px; margin:0 auto;}
    /*.viewport img{max-width: 640px;min-width: 320px;width: 100%;}*/
    .viewport ul{ /*position:absolute; bottom:0.3em;*/ width:30%; margin: 0 auto; /*left:35%;*/}
    /*.viewport ul li img{ width:1.2em; height:0.875em;max-width:1.2em;min-width:1.2em;}*/


    /*排行榜*/
    /*.ranking{ *//*position:absolute; z-index:2;*//* top:1.2em; left:0; width:100%;}*/
    .ranking img{ width:100%;}
    .ranking_notice{ margin:0.6em 1.2em 0.6em 1.2em; background-color:#ffffff; font-size:0.8em; color:#333333; text-align:center; padding:0.3em;  line-height:2em;}
    .ranking ul{ font-size:0.8em; color:#ffffff; width:50%; float:left;}
    .ranking ul li span{ float:left; display:block; line-height:1.8em;}

    #award_contents ul {
        width: 33%;
    }

    /*关于我们加关注*/
    .guanzhu{ /*position:absolute;*/ z-index:2; padding-top:1.5em; left:0; width:100%;}
    .guanzhu ul{ padding-top:1.5em;}
    .guanzhu ul li{ color:#666666; font-size:1em; padding:0.5em 1.2em 0 1.2em; line-height:1.3em;}
    .attention{ display:block; margin:2em 1.2em 0 1.2em; text-align:center; margin-bottom:0; background-color:#ff483a; font-size:1em; color:#ffffff; padding:0.4em 0.5em 0.4em 0.917em;  text-decoration:none;}
    .pyshuo{ display:block; margin:0.8em 1.2em 0 1.2em; text-align:center; margin-bottom:0; background-color:#ffa531; font-size:1em; color:#ffffff; padding:0.4em 0.5em 0.4em 0.917em; text-decoration:none;}
    .aboutus{ margin-top:2em; text-align:center; font-size:0.8em; color:#666666; line-height:1.3em;}
    .aboutus img{ width:4.125em; height:1.667em;}

    /*游戏规则*/
    .rule{ /*position:absolute;*/ z-index:2; padding-top:5em; left:0; width:100%;}
    .rule ul{ margin:0 1.2em;}
    .rule ul li{ float:left; font-size:0.9em;}
    .rule ul li.title{ background-color:#75b3bc; color:#ffffff; height:2.083em; line-height:2.083em; text-align:center;}
    .rule ul li.con{ border-bottom:1px #c1e2e5 solid; text-align:center; height:2.083em; line-height:2.083em; color:#333333;}
    .rule p{ padding:0.2em 1.2em 0.3em 1.2em;; line-height:1.8em; font-size:0.9em; color:#333333; margin:0}
    .rule_bottom{ /*position:absolute;*/ bottom:0; left:0; z-index:1;}

    #miaosha_time_desc {
        margin-left: 0.3em;
    }

    .to_top {
        text-align: center;
    }

    .to_top img {
        width: 3em !important;
    }

    .bg_green{ background-color:#c8ffd8;}
    .bg_orange{ background-color:#ffeabc;}
    .red{ color:#df1a00;}
    .pad{ padding:1.5em 1em;}
    .pad .title{ font-size:1.167em; font-weight:bold; color:#333333; padding-bottom:0.6em; text-align:center;}
    .pad .con{ font-size:1em; width: 49%; display: inline-block; color:#666666; line-height: 1.5em; float:left}

</style>
<div id="fullpage">
    <div class="section">
        <div class="index_title"><img src="{{$this->Html->assetUrl('/img/apple201410/btc/index/title.png')}}" /></div>
        <div class="tree">
            <img id="apple_tree_img" src="{{$this->Html->assetUrl('/img/apple201410/btc/index/tree.png?1')}}"/>
            <div class="rock_num radius10">
                <div class="fl">已摇下<span id="apple_got_cnt" class="apple_numbers">{{$total_apple}}</span>个, 还有<span class="apple_numbers" id="apple_times_left">{{$total_times}}</span>次机会!&nbsp;<a href="#about_us" style="font-size: 1.25em">[加机会]</a></div>
                <div class="fr"></div>
            </div>
            <a id="share_btn"  href="javascript:;" class="help radius10" style="display:{{$total_times > 0 ? 'none' : ''}}">找人帮忙</a>

            <a id="miaosha_btn" href="javascript:;" class="seckill radius10" style="width: 60%; display: inline-block; margin-right: 0.5em;">1000箱整点秒 <span id="miaosha_time_desc"></span></a>
            <a id="go_exchange_btn" class="radius10 help" href="javascript:;" style="width: 25%; display: inline-block; margin-left: 0.1em;">兑优惠券</a>

            <div class="word_link">
                <a href="#get_coupons">[规则]</a>&nbsp;&nbsp;&nbsp;
                <a id="show_help_btn" href="#friends">[谁帮了我]</a>&nbsp;&nbsp;&nbsp;
                <a href="#award_list">[秒中名单]</a>&nbsp;&nbsp;&nbsp;
                <a href="#product_story">[产品故事]</a>
            </div>
        </div>
        <div class="bg"><img src="{{$this->Html->assetUrl('/img/apple201410/btc/index/bg1.jpg')}}" /></div>
    </div>

    <div class="section">
        <div class="viewport">
            <a href="/products/20141206/qian_yang_bing_tang_cheng.html">
            <img src="{{$this->Html->assetUrl('/img/apple201410/btc/story/imgn1.jpg')}}" style="max-height:22%; width:100%" />
            <img src="{{$this->Html->assetUrl('/img/apple201410/btc/story/imgn2.jpg')}}" style="max-height:30%; width:100%" />
            <img src="{{$this->Html->assetUrl('/img/apple201410/btc/story/imgn3.jpg')}}" style="max-height:36%; width:100%"  />
            </a>
            <ul class="clearfix">
                <li class="to_top"><a href="#firstPage"><img src="{{$this->Html->assetUrl('/img/apple201410/btc/story/top.gif')}}" /></a></li>
            </ul>
        </div>
    </div>

    <div class="section">
        <div style="background-image: url({{$this->Html->assetUrl('/img/apple201410/btc/rule/bg.jpg')}}); background-size: 110%; min-height: 100%; background-repeat: no-repeat">
    <div class="rule" style="min-height: 95%">
        <ul class="clearfix">
            <li class="title" style="width:30%;">摇下数量</li>
            <li class="title" style="width:70%;">购买折扣</li>
        </ul>
        <ul class="clearfix">
            <li class="con" style="width:30%;">30个</li>
            <li class="con" style="width:70%;">15元优惠券</li>
        </ul>
        <ul class="clearfix">
            <li class="con" style="width:30%;">50个</li>
            <li class="con" style="width:70%;">30元优惠券</li>
        </ul>
        <ul class="clearfix">
            <li class="con" style="width:30%;">100个</li>
            <li class="con" style="width:70%;">2张30元优惠券或参加免费秒杀</li>
        </ul>
        <ul class="clearfix">
            <li class="con" style="width:30%;"><a href="#top_list">总榜</a>前20名</li>
            <li class="con" style="width:70%;">价值268元冰糖橙一箱</li>
        </ul>
        <p>1、摇下100个，即可参加每天白天(8点－22点)整点的万橙秒杀活动，每天100箱，送完即止；</p>
        <p>2、活动结束日期12月18号23点59分，活动最终解释权归朋友说所有。</p>
        <a id="get_coupons_button" href="javascript:;" class="help radius10" style="float:left; width:40%; display: inline-block; margin-right:0.5em">马上兑换</a>
        <a id="view_my_coupons" href="/users/my_coupons.html" class="pyshuo radius10" style=" width:40%; display: inline-block; margin-left: 0.5em">我的优惠券</a>
    </div>
    <ul class="clearfix" style="width: 30%; margin: 0 auto; margin-top: 0.5em;">
        <li class="to_top"><a href="#firstPage"><img src="{{$this->Html->assetUrl('/img/apple201410/btc/aboutus/top.gif')}}" /></a></li>
    </ul>
    </div>
    </div>

    <div class="section">
        <div class="ranking" style="background-image: url({{$this->Html->assetUrl('/img/apple201410/btc/award/bg.jpg')}}); min-height: 100%; padding: 0.5em 0.5em 0.2em 0.5em">
            <img src="{{$this->Html->assetUrl('/img/apple201410/btc/award/title.png')}}" />
            <a href="#firstPage" class="help radius10">去秒杀</a>
            <div class="ranking_notice radius10">今日已秒出 <span id="award_list_total"></span>箱 <span style="padding-left: 2em" id="award_list_update">正在更新...</span></div>
            <div id="award_contents" style="margin:0 1.2em; height: 100%; overflow-y: hidden; overflow-x:hidden;">
            </div>
            <ul class="clearfix" style="width: 30%; margin: 0 auto; float: none">
                <li class="to_top"><a href="#firstPage"><img src="{{$this->Html->assetUrl('/img/apple201410/btc/aboutus/top.gif')}}" /></a></li>
            </ul>
        </div>
    </div>

    <div class="section">
        <div class="ranking" style="background-image: url({{$this->Html->assetUrl('/img/apple201410/btc/ranking/bg.jpg')}}); min-height: 100%">
            <img src="{{$this->Html->assetUrl('/img/apple201410/btc/ranking/title.png')}}" />
            <div class="ranking_notice radius10">我的排名：<span id="top_list_mine"></span><span style="padding-left: 2em" id="top_list_update">正在更新...</span><!--你当前摇到了10个,还没有进入排名,要多多努力哦!--></div>
            <div style="margin:0 1.2em; height: 100%; overflow-y: hidden; overflow-x:hidden;">
                <ul id="top_list_contents_left"></ul>
                <ul id="top_list_contents_right"></ul>
            </div>
            <ul class="clearfix" style="width: 30%; margin: 0 auto; float: none">
                <li class="to_top"><a href="#firstPage"><img src="{{$this->Html->assetUrl('/img/apple201410/btc/aboutus/top.gif')}}" /></a></li>
            </ul>
        </div>
    </div>

    <div class="section">
        <div style="background-image: url({{$this->Html->assetUrl('/img/apple201410/btc/aboutus/bg.jpg')}}); height: 100%">
    <div class="guanzhu">
        <img src="{{$this->Html->assetUrl('/img/apple201410/btc/aboutus/title.png')}}" style="width:100%"/><br />
        <ul>
            <li>1、关注朋友说，每天可领取5次游戏机会；</li>
            <li>2、活动期间每购买1件商品增加10次游戏机会;</li>
            <li>3、小伙伴点击分享的摇一摇游戏链接增加1次游戏机会。</li>
        </ul>
        <a id="assignWXSubscribeTimes" href="javascript:;" class="attention radius10">关注加机会</a>
        <a href="/?from=game_{{$game_type}}" class="pyshuo radius10">购物加机会</a>
        <a id="share_btn_2"  href="javascript:;" class="help radius10">分享好友求点</a>
        <div class="aboutus">
            <a href="/"><img src="{{$this->Html->assetUrl('/img/apple201410/btc/aboutus/logo.png')}}" /></a><br /><br />
            [朋友说]同事间互相分享家乡特产的创业网站,<br />
            我们都是城市里的乡下人。
        </div>
        <ul class="clearfix" style="width: 30%; margin: 0 auto; float: none; padding-top: 0">
            <li class="to_top"><a href="#firstPage"><img src="{{$this->Html->assetUrl('/img/apple201410/btc/aboutus/top.gif')}}" /></a></li>
        </ul>
    </div>
    <!--<a class="next" href="#X"><img src="{{$this->Html->assetUrl('/img/apple201410/btc/aboutus/top.gif')}}" /></a>-->
   </div>
        </div>

    <div class="bg_green pad section">
        <div class="title"><span id="helpme_cnt_n" class="red ">{{count($helpMe)}}</span>个朋友帮了我</div>
        {{if $helpMe}}
        <ul>
        {{loop $helpMe $key $item}}
        <li class="con clearfix">
            {{$item['nickname']}}<strong class="red gots">{{ $item['got'] }}</strong>个
        </li>
        {{/loop}}
        </ul>
        {{else}}
        <div class="con clearfix">还没有朋友帮过你啊，马上分享给朋友们吧！
            <a id="share_btn_3" href="javascript:;" class="help">分享好友求助</a>
        </div>
        {{/if}}
        <ul class="clearfix" style="width: 30%; margin: 0 auto; float: none">
            <li class="to_top"><a href="#firstPage"><img src="{{$this->Html->assetUrl('/img/apple201410/btc/aboutus/top.gif')}}" /></a></li>
        </ul>
    </div>
    </div>

    <?php /*
    <div  id="friends" class="bg_green pad section">
        <div class="title"><strong id="helpme_cnt" class="red">{{count($helpMe)}}</strong>个朋友帮了我</div>
            {{if $helpMe}}
            {{loop $helpMe $key $item}}
                <div class="con clearfix">
                    <div class="fl name">{{$item['nickname']}}</div>，<div class="fl">摇到了<strong class="red">
                    {{if $game_type == 'rice201411'}}
                    {{$item['got']*10}}</strong>g大米
                    {{else}}
                    {{ $item['got'] }}</strong>个
                    {{/if}}
                </div>
                </div>
            {{/loop}}
            {{else}}
                <div class="con clearfix">还没有朋友帮过你啊，马上分享给朋友们吧！</div>
            {{/if}}
    </div>

    <div id="friendsIhelped" class="bg_orange pad section">
        <div class="title">我帮过<strong class="red">{{count($meHelp)}}</strong>个朋友</div>
        {{if $meHelp}}
        {{loop $meHelp $key $item}}
        <div class="con clearfix">
            <div class="fl name">{{$item['nickname']}}</div>，<div class="fl">摇到了<strong class="red">
            {{if $game_type == 'rice201411'}}
            {{$item['got']*10}}</strong>g大米
            {{else}}
            {{ $item['got'] }}</strong>个
            {{/if}}
         </div>
        </div>
        {{/loop}}
        {{else}}
        <div class="con clearfix">你竟然还没有帮过朋友！</div>
        {{/if}}
    </div>
    */ ?>
</div>

<script>
    var $today_got_wx = "{{$today_got_wx}}";
    var shake_pic_url = '{{$this->Html->assetUrl("/img/apple201410/btc/index/tree.gif?1")}}';
    var sound_url = 'http://51daifan-images.stor.sinaapp.com/tree_shake.mp3';
    var share_png_url = '{{$this->Html->assetUrl("/img/apple201410/btc/index/share.png")}}';
    var yao_tips_png = '{{$this->Html->assetUrl("/img/apple201410/btc/index/yao.png")}}';
    var game_type = '{{$game_type}}';
    var game_page_title = {{if !empty($title_func)}}function(total){ return {{$title_func}};} {{else}} null {{/if}};
    var game_obj_name = '{{$game_obj_name}}';
    var game_least_change = '{{$game_least_change}}';
    var awarded = '{{$awarded}}';
    var game_user_total = '{{$game_user_total}}'; //loading by update_top_list
    var $shaking_tips_png;

    var $share_before_coupon = '{{$share_before_coupon}}';
    var share_coupon_msg = '';
    var share_coupon_title = '';
    var $share_div;

    $(document).ready(function(){
        $('#fullpage').fullpage({
            touchSensitivity: 15,
            css3: true,
            loopBottom: true,
            loopTop: true,
            anchors: ['firstPage', 'product_story', 'get_coupons', 'award_list', 'top_list', 'about_us', 'friends']
        });

        var today_sold_out = '{{$today_sold_out}}';

        var miaosha_hour = function(){
            var now = new Date();
            return now.getHours();
        };
        function can_miaosha() {
            var now = new Date;
            return (!today_sold_out && now.getHours() >= 8 && now.getHours() < 23);
        }

        var friendGots = $('.gots').map(function () {
            var v = $.trim($(this).text());
            return v ? parseInt(v) : 0;
        }).get();


        var miaosha_span = $('#miaosha_time_desc');
        var miaosha_btn = $('#miaosha_btn');

        miaosha_btn.click(function(){

            if (can_miaosha()) {
                var lefttime = 60;
                utils.progress_notify('正在秒杀...(<span id="miaosha_left">'+lefttime+'</span>)');
                setTimeout( function() {
                    $.getJSON('/apple_201410/jp/{{$game_type}}?' + Math.random(), {}, function (data) {
                        utils.close_notify();
                        if (data.success) {
                            if (data.award_type != 0) {
                                var tips = '恭喜您秒中价值'+data.award_type+'元的优惠券，可兑一箱冰糖橙！<b>分享到朋友圈就能领取啦～</b>';
                                utils.alert_one(tips, '分享到朋友圈', function(){
                                    if($shaking_tips_png){
                                        $share_before_coupon = true;
                                        awarded = true;
                                        $share_div.show();
                                    }
                                });
                            } else {
                                var msg = '';
                                if (data.msg == 'not_enough_100') {
                                    if (total_not_spent() < 80) {
                                        msg = '秒杀失败！摇下越多机会越大，您摇下的橙子还不够多，请继续努力';
                                    } else {
                                        msg = '秒杀失败！摇下100个，几率就翻倍，请继续努力';
                                    }
                                }
                                else if (data.msg == 'no_more') {
                                    msg = '本时段秒杀商品已经全部抢完。 <a href="#award_list">查看中奖名单</a>';
                                    miaosha_btn.removeClass('help').addClass('seckill');
                                    today_sold_out = true;
                                    checking_miaosha();
                                }
                                else if (data.msg == 'game_end') {
                                    msg = '活动已结束';
                                } else {
                                    msg = '手气不太好啊, 请重试！';
                                }
                                utils.alert(msg, null);
                            }
                        } else {
                        }
                    });
                }, 1000);

                var timespan = $('#miaosha_left');
                function decreaseTime() {
                    lefttime--;
                     timespan.text(lefttime);
                    if (lefttime > 0) {
                        setTimeout(decreaseTime, 1000);
                    }
                }
                setTimeout(decreaseTime, 1000);
            } else {
                utils.alert( today_sold_out ? '本时段已经全部抢完，请等待下一时段开秒，<a href="#award_list">查看中奖名单</a>。 您也可以选择兑换30元券。' : '整点开秒，还差'+format_left(calculate_left(), ''), function(){ checking_miaosha(); });
            }
        });

        function azero(v) {
            return  (v < 10) ?  ('0'+''+v) : v;
        }

        function calculate_left() {
            var now = new Date;
            if (now.getHours() >= miaosha_hour()) {
                if (now.getHours() >= 22) {
                    now.setDate(now.getDate() + 1);
                    now.setHours(8);
                } else if (now.getHours() < 8) {
                    now.setHours(8);
                } else {
                    now.setHours(now.getHours() + 1);
                }
            }
            now.setMinutes(0);
            now.setSeconds(0);
            return (now.getTime() - new Date()) / 1000;
        }

        function format_left(dif, gap) {
            var hour = Math.floor(dif / 3600);
            var left = Math.floor(dif % 3600);
            var min = Math.floor(left / 60);
            var seconds = Math.floor(left % 60);
            return azero(hour) + (gap ? gap : '小时') + azero(min) + (gap ? gap : '分') + azero(seconds) + (gap ? '' : '秒');
        }


        var timer_intervalId = null;
        function checking_miaosha() {
            if (can_miaosha()) {
                miaosha_btn.removeClass('seckill').addClass('help');
                miaosha_span.text('立即秒杀');
            } else {
                var dif = calculate_left();
                if (timer_intervalId) {
                    clearInterval(timer_intervalId);
                    timer_intervalId = null;
                }
                timer_intervalId = setInterval(function () {

                    if (dif < 1) {
                        clearInterval(timer_intervalId);
                        timer_intervalId = null;
                        today_sold_out = false;
                        checking_miaosha();
                        return;
                    }

                    miaosha_span.text('倒计时 ' + format_left(dif, ':'));
                    dif--;
                }, 1000);
            }
        }

        function total_not_spent() {
            var total = $.trim($('#apple_got_cnt').text());
            total = total != '' ? parseInt(total) : 0;
            return total;
        }

        function get_total() {
            var total = total_not_spent();
            return (total < game_user_total ? game_user_total : total);
        }

        function show_got_coupon() {
            utils.alert_one('恭喜您秒杀成功，请注意在有效期结束前使用。还可以抢268元终极大奖哦', '查看我的优惠券', function(){ window.location.href = '/users/my_coupons.html';});
        }

        var imgUrl = $('#apple_tree_img').attr('src');
        var lineLink = '{{WX_HOST}}/t/ag/{{$game_type}}.html?{{if $trid}}trid={{urlencode($trid)}}{{/if}}&from=awarded';
        var appid = '{{WX_APPID}}';
        share_coupon_msg = '基友们太给力！我已领取1箱冰糖橙，赶紧点还有268元终极大奖，兄弟们，继续摇起！';
        share_coupon_title = '妈呀，我终于获奖了，1箱冰糖橙到手！';

        function share_before_coupon_msg() {
            utils.wx_to_friend(appid, imgUrl, lineLink, share_coupon_msg, share_coupon_title);
            show_got_coupon();
        }

        function share_before_coupon_tl() {
            utils.wx_to_timeline(appid, imgUrl, lineLink, '', share_coupon_msg);
            show_got_coupon();
        }

        function help_me_cnt() {
            var helpme_cnt_txt = $.trim($('#helpme_cnt_n').text());
            return (helpme_cnt_txt == '' ? 0 : parseInt(helpme_cnt_txt));
        }

        function dabai_percent() {
            var total = get_total();

            var win = 0;
            for(var x in friendGots) {
                if (total > friendGots[x]) {
                    win++;
                }
            }
            return (win == friendGots.length) ? 100 : utils.toFixed(win*100/friendGots.length, 0)
        }

        function desc_cmp_friends() {
            var desc = '摇一摇，一千箱冰糖橙免费送! 我已摇下' + get_total() + '个';
            if (friendGots && friendGots.length > 0) {
                var dabaiPercent = dabai_percent();
                desc += (dabaiPercent == 100 ? ', 打败了所有好友，哈哈' : (dabaiPercent == 0 ? ', 朋友圈里垫底 ^_^， 快点我吧' : ', 打败了' + dabaiPercent + '%的好友！'));
            } else {
                desc += ', 还没人帮过我！快来帮我吧';
            }
            return desc;
        }

        checking_miaosha();

        function desc_normal() {
            var total = get_total();
            var my_list = parseInt($.trim($('#top_list_mine').text()));
            return '万橙，比褚橙不只甜了一点点，'+ help_me_cnt() +'个好基友帮忙，我已经摇下'+total+'个万橙' + (my_list > 0 && my_list<1000 ? '，排名第' + my_list + '名' : '') + '－ 朋友说';
        }
        var shareTitle = '摇下100个，1箱万橙免费领';

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min)) + min;
        }

        function can_exchange_desc() {
            var total = total_not_spent();
            if (total >= 100) {
                return '2张30元优惠券';
            } else if (total >= 80) {
                return '1张30元＋1张15元优惠券';
            } else if (total >= 50) {
                return '1张30元优惠券';
            } else if (total >= 30) {
                return '1张15元优惠券';
            } else {
                return false;
            }
        }

        function exchane_coupon_click() {
            var canExchangeDesc = can_exchange_desc();
            var msg = '<div class="alert alert-danger" style="margin-bottom: 0.5em; margin-top:0.5em">'+ (canExchangeDesc? '恭喜，您可以兑换' + canExchangeDesc : '亲，再摇'+(30 - total_not_spent())+'个就可以兑换啦^_^')+'</div>' +
                    '<div class="panel panel-warning"><div class = "panel-heading">兑换规则</div>' +
                    '<table class="table  table-condensed">' +
                    '<tr><td>30个</td><td>15元优惠券(7.4折)</td></tr>' +
                    '<tr><td>50个</td><td>30元优惠券(4.8折)</td></tr>' +
                    '<tr><td>100个</td><td>2张30元优惠券(4.8折)</td></tr>' +
                    '</table></div>'
                    ;
            if (game_user_total > total_not_spent()) {
                msg += '<div class="text-right"><a href="/users/my_coupons.html">查看我的优惠券</a></div>';
            }
            if (canExchangeDesc) {
                utils.alert_two(msg, '去兑换', '继续摇', function () {
                    $.fn.fullpage.moveTo('get_coupons');
                }, null, {top:'5%', 'margin-top':'0'});
            } else {
                utils.alert_one(msg, '继续摇', null, {top:'5%', 'margin-top':'0'});
            }
        }

        $('#go_exchange_btn').click(function(){
            exchane_coupon_click();
        });

        $('#view_my_coupons').click(function(e){
            if (game_user_total <= total_not_spent()) {
                e.preventDefault();
                utils.alert_one('您还没摇到优惠券', '关闭');
                return false;
            }
        });

        function share_timeline(){
            var $r = getRandomInt(1, 10);
            var sh_src = 'def';
            if ($r >= 8) {
                sh_src = 'jj1';
            } else if ($r >= 5) {
                sh_src = 'zr';
            }
            lineLink += '&src=tl';

            var desc;
//                    if (sh_src == 'jj1') {
//                        desc = '药不能停，出门不吃（摇）怎行？有' + help_me_cnt() + '个好基友给我送药了！已基本治愈！领药请点击';
//                    } else if(sh_src == 'zr') {
//                        desc = '摇一摇，一千箱冰糖橙免费送！我已摇下' + get_total() + '个，你也来试试吧';
//                    } else {
                desc = desc_cmp_friends();
//                    }
            utils.wx_to_timeline(appid, imgUrl, lineLink, '', desc);
        }

        // 当微信内置浏览器完成内部初始化后会触发WeixinJSBridgeReady事件。
        document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
            if (typeof(WeixinJSBridge) != 'undefined') {
                WeixinJSBridge.on('menu:share:appmessage', function (argv) {
                    if ($share_before_coupon) {
                        share_before_coupon_msg();
                        $share_before_coupon = false;
                    } else if (awarded) {
                        utils.wx_to_friend(appid, imgUrl, lineLink, share_coupon_msg, share_coupon_title);
                    } else {
                        utils.wx_to_friend(appid, imgUrl, lineLink, desc_cmp_friends(), shareTitle);
                    }

                });
                WeixinJSBridge.on('menu:share:timeline', function (argv) {
                    if ($share_before_coupon) {
                        share_before_coupon_tl();
                        $share_before_coupon = false;
                    } else if (awarded) {
                        utils.wx_to_timeline(appid, imgUrl, lineLink, '', share_coupon_msg);
                    } else {
                        share_timeline();
                    }
                });
            }
        }, false);

        var top_list = {{$top_list}};
        if (top_list && top_list.top_list){update_top_list(top_list.top_list); }

        var award_list = {{$award_list}};
        if (award_list && award_list.award_list){update_award_list(award_list.award_list); }
    });

    function game_coupon_message(times, total) {
        if (total < 30)  { return '<br/><small>差<span class="apple_numbers">' + (30 - total) + '</span>个就能兑换<span class="apple_numbers">15</span>元优惠券</small>'; }
        else if (total < 50) {return '<br/><small>差<span class="apple_numbers">' + (50 - total) + '</span>个就能兑换<span class="apple_numbers">30</span>元优惠券</small>';}
        else if (total < 100) {return '<br/><small>差<span class="apple_numbers">' + (100 - total) + '</span>个就可以参加一箱免费秒杀</small>';}
        else return '';
    }

    function showAfterGotCallback(times, total, got){
    }

    function update_top_list(top_list) {
        var uid = '{{$CurrentUser["id"]}}';
        var list = top_list['list'],  update_time = top_list['update_time'], user_pos = top_list['user_pos'];
        if (user_pos && user_pos[uid]) {
            $('#top_list_mine').text(user_pos[uid] > 0 ? user_pos[uid] : '1000名以后');
        }
        if (top_list['user_total'] && top_list['user_total'][uid]) {
            game_user_total = top_list['user_total'][uid];
        }
        if(list) {
            $('#top_list_update').html('更新时间:' + update_time);
            var uls = [$('#top_list_contents_left'), $('#top_list_contents_right')];
            uls[0].html(''); uls[1].html('');

            var mid = Math.round(list.length/2);
            for(var i = 0; i < list.length; i++) {
                var item = list[i];
                uls[ i >= mid ? 1 : 0 ].append('<li class="clearfix"><span style="width:75%;">'+(i+1)+'、'+item[0]+'</span> <span style="width:25%;">'+item[1]+'个</span> </li>');
            }
        }
    }

    function update_award_list(award_list) {
        var list = award_list['list'],  update_time = award_list['update_time'], today_awarded = award_list['today_awarded'];
        $('#award_list_total').text(today_awarded ? today_awarded : 0);
        if(list) {
            $('#award_list_update').html('更新时间:' + update_time);
            var $awardContents = $('#award_contents');
            $awardContents.html('<ul></ul><ul></ul><ul></ul>');

            var uls = [];
            uls.push($awardContents.find('ul:nth-child(1)'));
            uls.push($awardContents.find('ul:nth-child(2)'));
            uls.push($awardContents.find('ul:nth-child(3)'));
//            uls.push($awardContents.find('ul:nth-child(4)'));

            for(var i = 0; i < list.length; i++) {
                var item = list[i];
                uls[ i % uls.length ].append('<li>'+item+'</li>');
            }
        }
    }
</script>
{{$this->Html->script(array('apple_game.js?v23'));}}