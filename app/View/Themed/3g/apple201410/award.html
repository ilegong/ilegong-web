{{$this->Html->script(array('shake/shake.js', 'howler/howler.min.js', '3dfalling/rotate3Di.min.js', '3dfalling/3d-falling-leaves.js'), array('block' => 'scriptBottom'));}}
{{$this->Html->scriptStart(array('block' => 'scriptBottom'));}}
{{$this->Html->scriptEnd()}}
<style>
    .october-leaf {
        position: absolute;
        background-color: transparent;
        background-image: url('http://www.pyshuo.com/img/apple201410/leavesv2.png');
        -webkit-transform: translateZ(0);
        -moz-transform: translateZ(0);
        transform: translateZ(0);
    }
    .apple_share {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1030;
        background-color: #000;
    }

    #apple_tree {
        text-align: center;
    }

    .apple_share.in {
        opacity: .9;
    }

    .apple_numbers {
        color: red;
        font-size: 20px;
        font-family: "Droid Sans", Arial, Helvetica, sans-serif;
    }

    #wrapper {
        background-color: #ffeabc;
        min-height: 1000px;
    }
</style>

<div class="container">
    <div class="row">
        <div class="col-xs-12 text-center">剩余机会<span class="apple_numbers" id="apple_times_left">{{$total_times}}</span>次 &nbsp; 已摇下<span class="apple_numbers" id="apple_got_cnt">{{$total_apple}}</span>个</div>
        <div class="col-xs-12 text-center"><small>活动时间：10月21日-10月30日</small> <a href="{{$this->Html->url(array('action'=>'rules'))}}" style="text-decoration: underline; line-height: 28px"><small>活动规则</small></a></div>
    </div>
    <div id="apple_tree" class="row voffset3">
      <img src="{{$this->Html->url('/img/apple201410/apple_tree.gif')}}"/>
    </div>
    <div class="row voffset3">
        <div class="text-center">
        <!--<button id="shake_btn" class="btn btn-danger" type="button">手机摇一摇</button>-->
        <button id="share_btn" class="btn btn-danger" type="button">朋友帮我摇</button>
        <a class="btn btn-danger" href="/products/20141009/xiao_juan_jia_xian_yang_hong_fu_shi_yu_shou_20xiang.html">马上预订</a>
        </div>
    </div>

    <div class="row voffset3 hoz_padding10">
      <p id="game_text_no_more" style="{{if $total_times>0}}display:none{{/if}}">
          你目前没有摇一摇的机会喔~ 赶紧摇起来~~ 只要攒够100个苹果马上换免费苹果一箱！谁怕谁，你又不是没有朋友！分享到朋友圈，分享连接被朋友点击还能够赢得再摇一次的机会喔~
      </p>
        <p id="game_text_has_more" style="{{if $total_times<=0}}display:none{{/if}}">
            你目前有<span class="apple_numbers" id="apple_times_left_bottom">{{$total_times}}</span>次 摇一摇的机会喔~赶紧摇起来~~
            只要攒够100个苹果马上换免费苹果一箱！谁怕谁，你又不是没有朋友！分享到朋友圈，分享链接被朋友点击还能够赢得再摇一次的机会喔~
        </p>
        <p/>
        <p>[朋友说] 同事间互相分享家乡特产的创业网站，我们都是城市里的乡下人。</p>
        <p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MjY5ODAyOA==&mid=200769784&idx=1&sn=8cce5a47e8a6123028169065877446b9#rd">点击关注【朋友说】</a></p>
    </div>
</div>

<script>
    $(document).ready( function(){
        var shake_pic_url = '{{$this->Html->url("/img/apple201410/apple_shakev1.gif")}}';
        $([shake_pic_url]).preload();
        var sound = new Howl({
            urls: ['http://51daifan-images.stor.sinaapp.com/tree_shake.mp3']
        });
        var $appleGotCnt = $('#apple_got_cnt');
        var $appleTimesLeft = $('#apple_times_left, #apple_times_left_bottom');
        var $appleTree = $('#apple_tree > img');
        var apple_tree_url = $('#apple_tree').attr('src');

        var $game_text_has_more = $('#game_text_has_more');
        var $game_text_no_more = $('#game_text_no_more');

        $share_div = $('<div class="apple_share fade in"><img src="{{$this->Html->url('/img/apple201410/share.png')}}"></div>')
            .hide()
                .click(function(){
                    $share_div.hide();
                });
        $('body').append($share_div);

        $('#share_btn').click(function(){
            showShareAndChangeTitle();
        });

        function changeTitle(total) {
            document.title = '摇一摇免费得红富士苹果, 我已经摇到了'+total+'个苹果 -- 城市里的乡下人电科院QA小娟分享家乡的苹果-朋友说';
        }

        function showShareAndChangeTitle() {
            changeTitle($appleGotCnt.text());
            $share_div.show();
        }

        function showAfterGot($got,times, total,  timeout) {
            if ($got > 0) {
                utils.alert('恭喜你！你摇掉了<span class="apple_numbers">' + $got + '</span>个苹果！<br/><small>(2秒后自动消失)</small>', function(){}, timeout);
            } else {
                utils.alert('你力气太小啦！只晃掉了几片树叶！<br/><small>(2秒后自动消失)</small>', function(){}, timeout);
            }

            if (times > 0) {
                $game_text_has_more.show();
                $game_text_no_more.hide();
            } else {
                $game_text_no_more.show();
                $game_text_has_more.hide();
            }

            if (total > 0) {
                changeTitle(total);
            }
        }

        function showNoMoreTimes() {
            bootbox.dialog({
                message: '机会已用完，分享给你的朋友们，每个朋友点击过来就增加<span class="apple_numbers">1</span>次机会！',
                buttons: {
                    main: {
                        label: "取消",
                        className: "btn-default"
                    },
                    danger: {
                        label: "立即分享",
                        className: "btn-danger",
                        callback: function() {
                            $share_div.show();
                        }
                    }
                }
            }).css({
                'top': '50%',
                'margin-top': function () {
                    return -($(this).height() / 2);
                }
            }).find('div.modal-footer').css({'text-align':'center'});
        }

        window.addEventListener('shake', shakeEventDidOccur, false);
        var shaking = false;
        function shakeEventDidOccur() {
            if (shaking) {
                return false;
            }
            var timesLeft = parseInt($appleTimesLeft.text());
            if (timesLeft <= 0) {
                showNoMoreTimes();
                return;
            }
            shaking = true;
            $('#apple_tree').octoberLeaves('start', {'speedC': 1, 'numberOfLeaves':100, 'cycleSpeed':80, 'rotationTrue':0});
            sound.play();
            $appleTree.attr('src', shake_pic_url);

            setTimeout(function(){
                $('#apple_tree').octoberLeaves('stop');
                $.getJSON('/apple_201410/shake/', function(data){
                    var $curr_got = 0;
                    if (data) {
                        $appleGotCnt.text(data['total_apple']);
                        $appleTimesLeft.text(data['total_times'] < 0 ? 0 : data['total_times']);
                        $curr_got = data['got_apple'];
                        showAfterGot($curr_got, data['total_times'], data['total_apple'], 2000);
                    }
                    $appleTree.attr('src', apple_tree_url);
                    shaking = false;
                });
            },1000);
        }

        $('#shake_btn').click(shakeEventDidOccur);
        {{if $notifyFriendId}}
        $.getJSON("{{$this->Html->url(array('action' => 'notifiedToMe', $notifyFriendId))}}?r="+Math.random(), function(data){
            if (data.notified === false) {
                utils.alert('您为朋友获得了<span class="apple_numbers">1</span>次摇苹果的机会！');
            }
        });
        {{/if}}
    });

</script>