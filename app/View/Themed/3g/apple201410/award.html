{{$this->Html->script(array('shake/shake.js', 'howler/howler.min.js', '3dfalling/rotate3Di.min.js', '3dfalling/3d-falling-leaves.js'), array('block' => 'scriptBottom'));}}
{{$this->Html->scriptStart(array('block' => 'scriptBottom'));}}
{{$this->Html->scriptEnd()}}
<style>
    .october-leaf {
        position: absolute;
        background-color: transparent;
        background-image: url('http://www.pyshuo.com/img/apple201410/leavesv2.png');
        -webkit-transform: translateZ(0);
        -moz-transform: translateZ(0);
        transform: translateZ(0);
    }
    .apple_share {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1030;
        background-color: #000;
    }

    #apple_tree {
        text-align: center;
    }

    .apple_share.in {
        opacity: .9;
    }

    .apple_numbers {
        color: red;
        font-size: 20px;
        font-family: "Droid Sans", Arial, Helvetica, sans-serif;
    }

    .apple_numbers_normal {
        color: #df1a00;
        padding-left: 3px;
        padding-right: 3px;
    }

    #wrapper {
        background-color: #ffeabc;
        min-height: 720px;
    }

    #link_rules a:visited {
        color: #0072c6;
    }

    h2 {
        color: #df1a00;
    }

    .apple_nav_links {
        text-decoration: underline; line-height: 28px;
        margin:20px 2px 5px 2px;
    }

    .top_links {
        text-decoration: underline; font-size: 12px;
        margin:10px 2px 5px 10px;
    }

    .shaking_tips_pic {
        opacity: .7;
        z-index: 1031;
        background-color: #000;
    }

    h3 {
        color:#333333;
    }

    .badge {
        color:#df1a00;
        background-color: gold;
    }

    .price {
        color:#df1a00;
        background-color: gold;
    }
</style>

<div class="container">
    <div class="row text-center">
        <h2>摇下100个，小娟家苹果免费领</h2> <a name="top"></a>
        <div class="col-xs-12">剩余机会<span class="apple_numbers" id="apple_times_left">{{$total_times}}</span>次 &nbsp; 已摇下<span class="apple_numbers" id="apple_got_cnt">{{$total_apple}}</span>个
            <a id="link_rules" href="{{$this->Html->url(array('action'=>'rules'))}}" class="apple_nav_links"><small>活动规则</small></a>
        </div>
    </div>
    <div id="apple_tree" class="row voffset3">
        <div style="position: relative; left: 0; top: 0;">
      <img id="apple_tree_img" src="{{$this->Html->url('/img/apple201410/apple_tree.gif')}}" style="position: relative; top: 0; left: 0;"/>
      <img id="shaking_tips_pic" class="shaking_tips_pic" src="{{$this->Html->url('/img/apple201410/rock.png')}}" style="position: absolute; top: 0; left: 0; display:none"/>
        </div>
    </div>
    <div class="row voffset3 text-center">
        <div>
        <button id="shake_btn" class="btn btn-warning" type="button" style="display:{{$total_times <= 0 ? 'none' : ''}}">手机摇一摇<small><em>(iPhone请调大音量)</em></small></button>
        <button id="share_btn" class="btn btn-warning" type="button" style="display:{{$total_times > 0 ? 'none' : ''}}">朋友帮我摇</button>
        </div>
        <div class="voffset3">
            <a href="#award_names" class="apple_nav_links"><small>获奖名单</small></a>
            <a href="#friends" class="apple_nav_links"><small>谁帮我了</small></a>
            <a href="#friendsIhelped" class="apple_nav_links"><small>我帮过谁</small></a>
            <a href="#about_us" class="apple_nav_links"><small>关于我们</small></a>
            <a href="#about_apple" class="apple_nav_links"><small>QA妹子分享富士</small></a>
        </div>
    </div>

    <div class="row voffset3 hoz_padding10">
      <p id="game_text_no_more" style="{{if $total_times>0}}display:none{{/if}}">
          分享到朋友圈，朋友点击就能赢得再摇一次的机会喔~
      </p>
        <p id="game_text_has_more" style="{{if $total_times<=0}}display:none{{/if}}">
            攒够100个苹果，马上免费领取小娟家苹果一箱！谁怕谁，你又不是没有朋友！
        </p>

        <h3 id="about_us">关于我们</h3>
        <div class="col-xs-3">
            {{$this->Html->image($this->Html->url('/img/logo_small.png'), array('style'=>'height:35px;','title' => $site[title],'alt' => $site[title]))}}
        </div><div class="col-xs-9">
        <p>[朋友说] 同事间互相分享家乡特产的创业网站，我们都是城市里的乡下人。</p>
        <p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MjY5ODAyOA==&mid=200769784&idx=1&sn=8cce5a47e8a6123028169065877446b9#rd">点击关注【朋友说】</a></p>
        </div>

        <h3 id="award_names">获奖名单 <span class="badge">{{count($awarded)}}</span><a href="#top" class="top_links">top&uarr;</a></h3>
        <ul class="list-unstyled">
            {{if $awarded}}
            {{loop $awarded $key $item}}
            <li>{{$item['nickname']}}{{$item['company']?'<small>('.$item['company'].')</small>':''}}，摇下<span class="apple_numbers_normal">{{$item['got']}}</span>个苹果, 得红富士一箱！</li>
            {{/loop}}
            {{else}}
            <li>活动刚刚启动，暂无人获奖。</li>
            {{/if}}
        </ul>


        <h3 id="friends">谁帮我了<span class="badge">{{count($helpMe)}}</span><a href="#top" class="top_links">top&uarr;</a></h3>
        <ul class="list-unstyled">
            {{if $helpMe}}
            {{loop $helpMe $key $item}}
            <li>{{$item['nickname']}}，摇到了<span class="apple_numbers_normal">{{$item['got']}}</span>个苹果</li>
            {{/loop}}
            {{else}}
            <li>还没有朋友帮过你啊，马上分享给朋友们吧！</li>
            {{/if}}
        </ul>

        <h3 id="friendsIhelped">我帮过谁<span class="badge">{{count($meHelp)}}</span><a href="#top" class="top_links">top&uarr;</a></h3>
        <ul class="list-unstyled">
            {{if $meHelp}}
            {{loop $meHelp $key $item}}
            <li>{{$item['nickname']}}，摇到了<span class="apple_numbers_normal">{{$item['got']}}</span>个苹果</li>
            {{/loop}}
            {{else}}
            <li>你竟然还没有帮过朋友！</li>
            {{/if}}
        </ul>

        <h3 id="about_apple">QA妹子分享的家乡红富士 <a href="#top" class="top_links">top&uarr;</a></h3>
        <div>
            <img src="{{$this->Html->url('/img/apple201410/slogan.jpg')}}" style="width: 80px; margin-left: 5px" class="pull-right">
            <p>
                &nbsp;&nbsp;这么多年过去，在这座充满雾霾的城市，自己还在不停的奔跑，但，已经是匆匆过客的故乡，却一遍又一遍出现自己的梦里。原来，不管走到哪里，自己都是城市里的乡下人。
            </p>
            <p>
                &nbsp;&nbsp;我的家乡在咸阳乾县山坳村，<span style="color:#df1a00">家乡的红富士，皮薄肉脆、香甜可口，今年由于干旱导致红富士个头偏小，但不影响口感</span>，小娟想帮家乡销售苹果。感谢您品尝我家乡的苹果。（-- 电科院QA妹子小娟分享）<a href="/apple_201410/award.html" class="top_links">查看详情</a>
            </p>
            <img src="{{$this->Html->url('/img/apple201410/head.png')}}" width="120px" class="pull-right" style="margin-right: 50px">

            <div class="clearfix"></div>
            <div class="voffset1 text-center">
                <span class="badge text-price" style="vertical-align: middle; font-size:20px">49.90元/10斤</span>   <a class="btn btn-sm btn-warning" href="/products/20141009/xiao_juan_jia_xian_yang_hong_fu_shi_yu_shou_20xiang.html">立即预定</a>
            </div>
        </div>

        <p>

        </p>
    </div>
</div>

<script>
    $(document).ready(function(){
        var shake_pic_url = '{{$this->Html->url("/img/apple201410/apple_shakev1.gif")}}';
        $([shake_pic_url]).preload();
        var sound = new Howl({
            urls: ['http://51daifan-images.stor.sinaapp.com/tree_shake.mp3']
        });
        var $appleGotCnt = $('#apple_got_cnt');
        var $appleTimesLeft = $('#apple_times_left, #apple_times_left_bottom');
        var $appleTree = $('img#apple_tree_img');
        var apple_tree_url = $('#apple_tree').attr('src');

        var $game_text_has_more = $('#game_text_has_more');
        var $game_text_no_more = $('#game_text_no_more');
        var $shakeBtn = $('#shake_btn');
        var $shareBtn = $('#share_btn');

        $share_div = $('<div class="apple_share fade in"><img src="{{$this->Html->url('/img/apple201410/share.png')}}"></div>')
            .hide().click(function(){
                    $share_div.hide();
                });

        $shaking_tips_png = $('#shaking_tips_pic');

        $('body').append($share_div);

        $shareBtn.click(function(){
            showShareAndChangeTitle();
        });

        function changeTitle(total) {
            document.title = '摇一摇免费得红富士苹果, 我已经摇到了'+total+'个苹果 -- 城市里的乡下人电科院QA小娟分享家乡的苹果-朋友说';
        }

        function showShareAndChangeTitle() {
            changeTitle($appleGotCnt.text());
            $share_div.show();
        }

        var showNoMoreTimesDialog = false;
        function showNoMoreTimes() {
            if (showNoMoreTimesDialog == true) { return; }
            showNoMoreTimesDialog = true;
            bootbox.dialog({
                message: '机会已用完，分享给你的朋友们，每个朋友点击过来就增加<span class="apple_numbers">1</span>次机会！',
                buttons: {
                    main: {
                        label: "取消",
                        className: "btn-default",
                        callback: function(){showNoMoreTimesDialog = false}
                    },
                    danger: {
                        label: "立即分享",
                        className: "btn-danger",
                        callback: function() {
                            showShareAndChangeTitle();
                            showNoMoreTimesDialog = false;
                        }
                    }
                }
            }).css({
                'top': '50%',
                'margin-top': function () {
                    return -($(this).height() / 2);
                }
            }).find('div.modal-footer').css({'text-align':'center'});
        }

        function updateViewState(times, total) {
            if (times > 0) {
                $game_text_has_more.show();
                $game_text_no_more.hide();
                $shakeBtn.show();
                $shareBtn.hide();
            } else {
                $game_text_no_more.show();
                $game_text_has_more.hide();
                $shakeBtn.hide();
                $shareBtn.show();
            }
            if (total && total > 0) {
                changeTitle(total);
            }
        }

        function showAfterGot($got,times, total, timeout) {
            var close_callback = times > 0 ? null : showNoMoreTimes;
            if ($got > 0) {
                utils.alert('恭喜你！你摇掉了<span class="apple_numbers">' + $got + '</span>个苹果！<br/><small>(2秒后自动消失)</small>', function(){}, timeout, close_callback);
            } else {
                utils.alert('你力气太小啦！只晃掉了几片树叶！<br/><small>(2秒后自动消失)</small>', function(){}, timeout, close_callback);
            }
            updateViewState(times, total);
        }


        function currTimes() {
            return parseInt($appleTimesLeft.first().text());
        }

        if (currTimes()>0 && $.trim($appleGotCnt.text()) == '0' ) {
//            $shaking_tips_png.css({
//                'width':$('body').innerWidth()
//            });
            $shaking_tips_png.show();
        }

        window.addEventListener('shake', shakeEventDidOccur, false);
        var shaking = false;
        function shakeEventDidOccur() {
            if (shaking) {
                return false;
            }
            var timesLeft = parseInt($appleTimesLeft.text());
            if (timesLeft <= 0) {
                showNoMoreTimes();
                return;
            }
            shaking = true;
            $shaking_tips_png.hide();
            $('#apple_tree').octoberLeaves('start', {'speedC': 1, 'numberOfLeaves':100, 'cycleSpeed':80, 'rotationTrue':0});
            sound.play();
            $appleTree.attr('src', shake_pic_url);

            setTimeout(function(){
                $('#apple_tree').octoberLeaves('stop');
                $.getJSON('/apple_201410/shake/', function(data){
                    var $curr_got = 0;
                    if (data) {
                        $appleGotCnt.text(data['total_apple']);
                        $appleTimesLeft.text(data['total_times'] < 0 ? 0 : data['total_times']);
                        $curr_got = data['got_apple'];
                        showAfterGot($curr_got, data['total_times'], data['total_apple'], 2000);
                    }
                    $appleTree.attr('src', apple_tree_url);
                    shaking = false;
//                    if (currTimes() > 0) {
//                        $shaking_tips_png.show();
//                    }
                });
            }, 2000);
        }

        $shakeBtn.click(function(){
            utils.alert('摇动手机！没有声音请开声音！');
        });
        $.getJSON("{{$this->Html->url(array('action' => 'notifiedToMe'))}}?r="+Math.random(), function(data){
            if (data.notified === false) {
                var msg = data.got ? '您为<span style="color:red">'+data.name+'</span>获得了<span class="apple_numbers">1</span>次摇苹果的机会！' : '您已经帮这个朋友点过啦！';
                utils.alert(msg);
            }
        });

        var query_interval = 5000;
        function new_times_query() {
            $.getJSON('{{$this->Html->url(array("action"=>"hasNewTimes"))}}', function (data) {
                if (data.success && data.new_times > 0) {
                    var times = currTimes() + data.new_times;
                    $appleTimesLeft.text(times);
                    updateViewState(times);
                    utils.alert('您的朋友<span style="color:red">'+data.nicknames+'</span>为您获得了<span class="apple_numbers">' + data.new_times + '</span>次摇苹果的机会！', function () {
                        setTimeout(new_times_query, query_interval);
                    });
                } else {
                    setTimeout(new_times_query, query_interval);
                }
            });
        }
        setTimeout(new_times_query, query_interval);

    });

</script>