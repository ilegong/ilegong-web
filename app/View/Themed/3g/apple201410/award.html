{{$this->Html->script(array('shake/shake.js', 'howler/howler.min.js', '3dfalling/rotate3Di.min.js', '3dfalling/3d-falling-leaves.js'), array('block' => 'scriptBottom'));}}
{{$this->Html->scriptStart(array('block' => 'scriptBottom'));}}
{{$this->Html->scriptEnd()}}
<style>
    .october-leaf {
        position: absolute;
        background-color: transparent;
        background-image: url('http://www.pyshuo.com/img/apple201410/leaves.png');
        -webkit-transform: translateZ(0);
        -moz-transform: translateZ(0);
        transform: translateZ(0);
    }
    .apple_share {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1030;
        background-color: #000;
    }

    .apple_share.in {
        opacity: .9;
    }

    .apple_numbers {
        color: red;
        font-size: 20px;
        font-family: "Droid Sans", Arial, Helvetica, sans-serif;
    }

    #wrapper {
        background-color: #ffeabc;
    }
</style>

<div class="container">
    <div class="row">
        <h1 style="color: red; text-align: center">摇一摇得红富士</h1>
        <div class="col-xs-4 text-right"><a href="#" style="text-decoration: underline; line-height: 28px">活动规则</a></div>
        <div class="col-xs-4">抽奖机会<span class="apple_numbers" id="apple_times_left">{{$total_times}}</span>次</div>
        <div class="col-xs-4">已摇下<span class="apple_numbers" id="apple_got_cnt">{{$total_apple}}</span>个</div>
    </div>
    <div id="apple_tree" class="row voffset3">
      <img src="{{$this->Html->url('/img/apple201410/apple_tree.gif')}}"/>
    </div>
    <div class="row voffset3">
    <!--<a href="javascript:;" id="clicktest">Test</a>-->
        <div class="text-center">
        <button id="shake_btn" class="btn btn-danger" type="button">手机摇一摇</button>
        <button id="share_btn" class="btn btn-danger" type="button">邀请朋友来</button>
        </div>
    </div>

    <div>

    </div>
</div>

<script>
    $(document).ready( function(){
        var shake_pic_url = '{{$this->Html->url("/img/apple201410/apple_shake.gif")}}';
        $([shake_pic_url]).preload();
        var sound = new Howl({
            urls: ['http://51daifan-images.stor.sinaapp.com/tree_shake.mp3']
        });
        var $appleGotCnt = $('#apple_got_cnt');
        var $appleTimesLeft = $('#apple_times_left');
        var $appleTree = $('#apple_tree > img');
        var apple_tree_url = $('#apple_tree').attr('src');

        $share_div = $('<div class="apple_share fade in"><img src="{{$this->Html->url('/img/apple201410/share.png')}}"></div>')
            .hide()
                .click(function(){
                    $share_div.hide();
                });
        $('body').append($share_div);

        $('#share_btn').click(function(){
            $share_div.show();
        });

        function showAfterGot($got) {
            if ($got > 0) {
                utils.alert('恭喜您，您摇到了<span style="color:darkred">' + $got + '</span>个苹果！');
            } else {
                utils.alert('恭喜您，您还差一点点就要到一个苹果啦！');
            }
        }

        function showNoMoreTimes() {
            bootbox.dialog({
                message: "机会已用完，分享给你的朋友们，每个朋友点击过来就增加1次机会！",
                buttons: {
                    main: {
                        label: "取消",
                        className: "btn-default"
                    },
                    danger: {
                        label: "立即分享",
                        className: "btn-danger",
                        callback: function() {
                            $share_div.show();
                        }
                    }
                }
            }).css({
                'top': '50%',
                'margin-top': function () {
                    return -($(this).height() / 2);
                }
            }).find('div.modal-footer').css({'text-align':'center'});
        }

        window.addEventListener('shake', shakeEventDidOccur, false);
        var shaking = false;
        function shakeEventDidOccur() {
            if (shaking) {
                return false;
            }
            var timesLeft = parseInt($appleTimesLeft.text());
            if (timesLeft <= 0) {
                showNoMoreTimes();
                return;
            }
            shaking = true;
            $('#apple_tree').octoberLeaves('start', {'speedC': 1, 'numberOfLeaves':100, 'cycleSpeed':80, 'rotationTrue':0});
            sound.play();
            $appleTree.attr('src', shake_pic_url);

            setTimeout(function(){
                $('#apple_tree').octoberLeaves('stop');
                $.getJSON('/apple_201410/shake/', function(data){
                    var $curr_got = 0;
                    if (data) {
                        $appleGotCnt.text(data['total_apple']);
                        $appleTimesLeft.text(data['total_times'] < 0 ? 0 : data['total_times']);
                        $curr_got = data['got_apple'];
                        showAfterGot($curr_got);
                    }
                    $appleTree.attr('src', apple_tree_url);
                    shaking = false;
                });
            },2000);
        }

        $('#shake_btn').click(shakeEventDidOccur);
        {{if $addedNotify}}utils.alert("您为朋友获得了一次摇苹果的机会！");{{/if}}
    });

    $('.footbox').hide();

</script>