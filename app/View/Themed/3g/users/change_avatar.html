<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>修改头像</title>
    <style>*, html, body {
        padding: 0px;
        margin: 0px;
    }</style>
    <input type="hidden" id="current-user-id" value="{{$uid}}">
    <input type="hidden" id="refer-url" value="{{$refer_url}}">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.js"></script>
    <script src="/static/user/layer.m.js"></script>
    <script src="/static/user/touch-0.2.14.min.js"></script>
    <script src="/static/user/jquery.crop.js"></script>
    <script>
        $(function () {
            var w = $(window).width();
            var h = $(window).height();
            var $uidDom = $('#current-user-id');
            var uid = $uidDom.val();
            var $referUrl = $('#refer-url');
            var referUrl = $referUrl.val();

            function doUpload(data) {
                $.post('/users/upload_avatar', {"imgData": data, "uid": uid}, function (result) {
                    if (result['success']) {
                        window.location.href = referUrl;
                    } else {
                        alert('保存失败，请重试');
                    }
                }, 'json');
            }

            $('.cutbox').crop({
                w: w > h ? h : w,
                h: h,
                r: (w - 30) * 0.5,
                res: '',
                backUrl:referUrl,
                callback: function (ret) {
                    doUpload(ret);
                }
            });
        });

    </script>
</head>

<body>
<div class="cutbox"></div>
</body>
</html>
