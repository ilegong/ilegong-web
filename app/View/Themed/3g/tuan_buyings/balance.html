<div class="classlist_v2" style="z-index:1">
    <ul class="clearfix" onclick="window.history.back();">
        <li><a class="back"></a></li>
        <li class="line"></li>
        <li style="text-overflow: ellipsis;"><strong>订单</strong></li>
    </ul>
</div>

<div  class="container" style="margin-top: 2.5em">

    <div class="orderinfo voffset3">
        <h2>收货人信息</h2>
        {{if $big_tuan}}
        {{if $way_type=='sf'}}
            <span class="order_status_text" style="font-size: 15px">提示：你选择了顺丰到付，参考价格25元。</span>
        {{/if}}
        <input type="text" class="form-control" placeholder="收货地址"  name="consignee_address">
        <input type="text" class="form-control" placeholder="收货人姓名"  name="consignee_name">
        <input type="text" class="form-control" placeholder="手机号"  name="consignee_mobilephone">
        {{else}}
        <p class="text-warning">具体地点：</p>
        <div id="specialShipPromotion" style="">
            <ul id="ul_special_promotion" class="list-group">
                <li item-id="25" item-addr-mark="1" class="list-group-item ">
                    <p>{{$tuan_address}}</p>
                </li>
            </ul>
            <p class="text-warning">个人信息：</p>
            <input type="text" class="form-control" placeholder="收货人姓名" id="p_consignee_name" name="consignee_name">
            <input type="text" class="form-control" placeholder="手机号" id="p_consignee_mobile" name="consignee_mobilephone">
            <input type="hidden" id="special_ship_promotion" name="ship_promotion" value="0">
        </div>
        {{/if}}

        <div id="part_payTypeAndShipType"><!-- template orders/info_shiptype--></div>

        <div id="part_invoice"><!-- template orders/order_invoice--></div>
        <hr/>
        <div class="o_show">
            <h4>朋友说</h4>
            <div class="p-list">
                <table  class="table table-bordered">
                    <tbody>
                    <tr><td>{{$cart_info['Cart']['name']}}</td>
                        <td style="width: 80px; font-size: 0.8em">单价：{{$this->Number->precision($cart_info['Cart']['price'],2)}}</td>
                        <td>×{{$buy_count}}</td>
                        <td>{{$this->Number->precision($cart_info['Cart']['price']*$buy_count, 2)}} </td>
                    </tr>
                    </tbody>
                </table>

            </div>
        </div>
        <div>
            <ul class="pull-right list-unstyled">
                {{if $ship_fee!=null}}
                <li>邮费：<span id="ship_price_span">{{$this->Number->precision($ship_fee, 2)}}</span></li>
                {{/if}}
                <li>总价<small>{{if $big_tuan&&$ship_fee==null}}(不含运费){{else}}(含运费){{/if}}</small>：<span id="total_price_span">
                            {{$this->Number->precision($total_price, 2)}}                   </span></li>
                <li><a id="confirm_next" class="btn btn-warning" href="javascript:void(0)" data-disable="false">提交订单</a></li>
            </ul>
        </div>

    </div>
</div>

<script type="text/javascript">
    $(document).ready(function(){
        $('#confirm_next').on('click',function(e){
            if($("#confirm_next").attr('data-disable') == 'false') {
                var address = '';
                var way = 'normal';
                var name = $("input[name='consignee_name']").val();
                var mobile = $("input[name='consignee_mobilephone']").val();
                if (name == "") {
                    utils.alert("请输入你的姓名");
                    e.preventDefault();
                    $('#p_consignee_name').focus();
                    return false;
                }
                if (mobile.length != 11) {
                    utils.alert("联系电话格式不正确");
                    $('#p_consignee_mobile').focus();
                    e.preventDefault();
                    return false;
                }
                {{if $big_tuan}}
                address = $("input[name='consignee_address']").val();
                way = 'sf';
                if (address == "") {
                    utils.alert("请输入地址");
                    e.preventDefault();
                    $('#p_consignee_name').focus();
                    return false;
                }
                {{/if}}
                var cart_id = {{empty($cart_id)? 0: $cart_id}};
                var tuan_buy_id = {{empty($tuan_buy_id)? 0: $tuan_buy_id}};
                var tuan_id = {{empty($tuan_id)? 0: $tuan_id}};
                jQuery.ajax({
                    type: "POST",
                    dataType: "json",
                    url: "/tuan_buyings/pre_order",
                    data: {name: name, mobile: mobile, cart_id: cart_id, tuan_buy_id: tuan_buy_id, tuan_id: tuan_id, address:address, way:way },
                    success: function (a) {
                        if (a.success) {
                            $("#confirm_next").attr('data-disable', 'true');
                            window.location.href = '/tuan_buyings/tuan_pay/' + a.order_id;
                        } else {
                            if(a.info){
                                utils.alert(a.info);
                            }else{
                                utils.alert("结算出错，请刷新重试");
                            }
                        }
                    }
                });
            }
        });
    })
</script>