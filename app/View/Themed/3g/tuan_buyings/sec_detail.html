<?php
    if($tuan_team){
        $location = $tuan_team['TuanTeam']['location_long'].','.$tuan_team['TuanTeam']['location_lat'];
    }
    $sold_num = $product_try['ProductTry']['sold_num'];
    $target_num = $product_try['ProductTry']['limit_num'];
    if($sold_num >= $target_num){
        $sold_percent = 100;
    }else{
        $sold_percent = round(($sold_num / $target_num * 100), 1);
    }
?>
<div class="classlist_v2" style="z-index:999;">
    <ul class="clearfix">
        <li><a class="back" onclick="goBack()"></a></li>
        <li class="line"></li>
        <li style="text-overflow: ellipsis;"><strong>秒杀详情</strong></li>
    </ul>
</div>

<div  class="container" style="margin-top: 2.5em; padding: 0">
    <div  class="row" style="margin-left: 0;margin-right: 0;">
        <div  class="col-xs-12" style="padding: 0;">
            <div class="row voffset1" style="margin-left: 0;margin-right: 0;">
                <div class="col-xs-12 col-md-6" style="padding: 0;">
                {{template Elements/product_img_sild}}
                    <div class="p_details_title">{{$product_try['ProductTry']['product_name']}}</div>
                    <ul class="p_details_price clearfix">
                        <li class="fl price"><span>秒杀价￥<font>{{$this->Number->precision(($product_try['ProductTry']['price'])/100,2)}}</font></span></li>
                        <li class="fr stat"><a style="color: #666666"><span>送货日期：<b>{{$product_try['ProductTry']['consignment_date']}}</b></span></a></li>
                    </ul>
                    {{if $Product['Product']['promote_name']}}
                        <ul class="sales clearfix">
                            <li>
                                <span style="display: block;overflow: hidden;">
                                    <span>{{$Product['Product']['promote_name']}}<br></span>
                                </span>
                            </li>
                        </ul>
                    {{/if}}
                    <div class="tuan_bar">
                        <div>已秒杀<span  value="{{$sold_num}}">{{$sold_num}}</span>份</div>
                        <div class="bar">
                            <div class="bar_buy" id = "bar_buy" style={{"width:".$sold_percent."%;"}}></div>
                        </div>
                        <ul class="clearfix">
                            <li class="fl"><span id="bar_percent">{{$sold_percent}}%</span></li>
                            <li class="fr">仅限{{$target_num}}份</li>
                        </ul>
                    </div>
                    {{if $tuan_team}}
                        <div class="clearfix tuanxq">
                            <a href="/tuan_teams/info/{{$tuan_id}}" style="color: #666666">
                                {{$tuan_team['TuanTeam']['tuan_name']}}
                                &nbsp;&nbsp;&nbsp;&nbsp;团长:{{$tuan_team['TuanTeam']['leader_name']}}<br/>参团请加团长微信，微信号:{{$tuan_team['TuanTeam']['leader_weixin']}}
                            </a>
                        </div>
                    {{/if}}
                    <ul class="standard clearfix">
                        <li class="good-spec">
                            <span class="gray title mr12" style="float:left;">秒杀规格:</span>
                            <span class="border" style="display: block;overflow: hidden;padding-bottom: 10px;">
                                <span try-spec-label="" class="mr12 border spec_item_selected cur">
                                    {{$product_try['ProductTry']['spec']}}
                                    <div class="focus"></div>
                                </span>
                            </span>
                        </li>
                    </ul>

                    <ul class="standard clearfix">
                        <li>
                            <span class="gray title mr12" style="float:left;">送货日期:</span>
                            <span class="border" style="display: block;overflow: hidden;">
                                <span class="mr12 border spec_item_selected cur" item-label="SD">
                                    {{$product_try['ProductTry']['consignment_date']}}
                                    <div class="focus"></div>
                                </span>
                            </span>
                        </li>
                    </ul>
                    {{if $tuan_team}}
                        <div class="clearfix tuanxq" style="margin-top: -1px;">
                            <span class="fl">详细地址：{{$tuan_address}}</span>
                            <a class="fr" href="/tuan_teams/lbs_map?location={{$location}}&name={{$tuan_team['TuanTeam']['tuan_name']}}&addr={{$tuan_team['TuanTeam']['tuan_addr']}}">
                                <img src="/img/tuan/locat_icon_xq.gif" border="0" /><s>查看地图</s>
                            </a>
                        </div>
                    {{else}}
                        <ul class="standard clearfix">
                            <li>
                                <span class="gray title mr12" style="float:left;">快递方式:</span>
                                    <span class="border">
                                        <span way-label="" class="mr12 border cur tuan_way_selected">
                                            自提
                                            <div class="focus"></div>
                                        </span>
                                    </span>
                            </li>
                        </ul>
                    {{/if}}
                    <ul class="numbers clearfix b_line">
                    <li class="fl">
                        <span class="gray title mr12" style="float:left;">数量:</span>
                        <span class="clearfix" style="display: block;overflow: hidden;">
                            <div id="pamount_not_r" class="grew">-</div>
                            <input id="input_pamount"  item-id="{{$current_data_id}}" size="3" value="1" class="num" name="shoppingnum" type="text" readonly/>
                            <div id="pamount_not_a" class="grew">+</div>
                        </span>
                    </li>
                    </ul>
                    <div class="all_line">
                        <ul class="clearfix title" style="margin-bottom: 0;" onclick="to_detail();">
                            <li class="xq_xqicon fl" style="padding-left: 0;"></li>
                            <li class="fl"><strong>图文详情</strong></li>
                            <li class="fr"><a class="p_more"></a></li>
                        </ul>
                    </div>
                    <div class="all_line" id="comment-div">
                        <ul class="clearfix title" style="margin-bottom: 0;" {{if $comment_count>5}}onclick="to_comment();"{{/if}}>
                        <li class="xq_commenticon fl" style="padding-left: 0;"></li>
                        <li class="fl">口碑评论<span>{{$comment_count}}</span></li>
                        {{if $comment_count>5}}
                            <li class="fr"><a class="p_more"></a></li>
                        {{/if}}
                        </ul>
                        {{template products/template_product_comments}}
                    </div>
                    <ul class="clearfix shop_entrance" style="color: #29AC0E;padding: 4px 0.8em 5px 0.8em;" onclick="to_brand();">
                        <li class="fl"><img src="{{$this->Html->assetUrl(small_thumb_link($brand['Brand']['coverimg']))}}" border="0"></li>
                        <li class="fl" style="color: #333333;">{{$brand['Brand']['name']}}</li>
                        <li class="fr" style="margin-top: 0.3em;height: 1.634em;"><a class="p_more"></a></li>
                    </ul>
                    <div class="service">
                        <ul class="clearfix b_line">
                            <li>
                                <span class="gray mr12" style="float:left;">快递:</span>
                                <span style="display: block;overflow: hidden;"><span id="consign_way">自提</span>	</span>
                            </li>
                        </ul>
                        <ul class="clearfix">
                            <li>
                                <span class="gray mr12" style="float:left;">服务:</span>
                                <span style="display: block;overflow: hidden;"><span>本商品由 {{$brand['Brand']['name']}} 发货并提供售后服务。</span></span>
                            </li>
                        </ul>
                    </div>

                    <div class="all_line" style="margin-bottom: 0;">
                        <ul class="clearfix title">
                            <li class="fl">相关推荐</li>
                        </ul>
                        <div class="classlist_good" style="margin-top: 0;">
                            <ul class="clearfix list-unstyled" style="padding-left:10px;">
                                <?PHP foreach($items as $index=>$item) {
                                $item['slug'] = $item['slug']?$item['slug']:$item['id'];
                                ?>
                                <li class="{{if $index%2 !=0}}last{{/if}}">
                                    <a href="{{product_link2($item)}}" style="display:block; background-color:#ffffff; margin-right:10px;">
                                        <img  src="{{$this->Html->assetUrl(small_thumb_link($item['coverimg']))}}" border="0" style="display:block; background-color:#ffffff; padding-bottom:0.5em; height: 136px"/>
                                        <div class="item_name" style="text-overflow:ellipsis; display: block;white-space: nowrap;overflow: hidden;">{{if $hasOfferBrandIds && array_key_exists($item['brand_id'], $hasOfferBrandIds)}}{{$item['name']}}<span>有红包</span>
                                            {{else}}
                                            {{$item['name']}}
                                            {{/if}}
                                        </div>
                                    </a>
                                    <dl class="clearfix" style="margin-right: 10px;margin-bottom: 0;">
                                        <dt style="float: none;">
                                            <a href="{{product_link2($item)}}">
                                    <span class="listprice" style="padding-left: 0;">
                                        <span>¥{{$this->Number->precision($item['price'], 2)}}</span>
                                    </span>
                                            </a>
                                        </dt>
                                    </dl>
                                </li>
                                <?php } ?>
                                {{if count($data_list) % 2 == 1}}
                                <li style="height: 12.4285em"></li>
                                {{/if}}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                function to_brand(){
                    window.location.href="/b/{{$brand['Brand']['slug']}}";
                }
                function to_detail(){
                    window.location.href="/tuan_buyings/product_detail/{{$current_data_id}}?tuan_id={{$tuan_id}}&tuan_buy_id={{$tuan_buy_id}}";
                }
                function to_comment(){
                    window.location.href="/products/product_comments/{{$Product['Product']['slug']}}.html?from=tuan&tuan_buy_id={{$tuan_buy_id}}";
                }
                $(document).ready(function(){
                    $('#view_all_comments').on('click',function(){
                        to_comment();
                    });
                });
            </script>
        </div>
        <hr>
    </div>
</div>

<!--底部购买-->
<div class="bottom_bg">
    <ul class="clearfix">
        <li class="love fl">
            <a href="#X" class="love_icon"></a>
        </li>
        <li class="fl" style="width:78%;">
            <div>
                {{if $sold_num>=$target_num}}
                    <a href="javascript:void(0)" class="btn_b cart_btn_soldout radius10">秒杀结束</a>
                {{elseif before_than($product_try['ProductTry']['start_time'])}}
                    <a id="sec_buy" data-send-date="{{$product_try['ProductTry']['consignment_date']}}" data-tuan-id="{{$tuan_team['TuanTeam']['id']}}" data-global-show="{{$product_try['ProductTry']['global_show']}}" data-tryid="{{$product_try['ProductTry']['id']}}" data-pid="{{$current_data_id}}" href="javascript:void(0);" class="btn_b pay_bg radius10">立即秒杀</a>
                {{else}}
                    <a href="javascript:void(0)" class="btn_b cart_btn_soldout radius10">即将开秒</a>
                {{/if}}
            </div>
        </li>
        <li class="shopping fr">
            <a href="/carts/listcart.html" style="position:relative; margin-top: 0.2em;" class="shopping_icon" id="cart_link"><div id="item-count" class="shopping_count"></div></a>
            <p>购物车</p>
        </li>
    </ul>
</div>

{{$this->Html->script(array('swiper/idangerous.swiper-2.0.min.js'));}}

<script>
    $(document).ready(function(){
        $('#pamount_not_r').on('click',function(e){
            e.preventDefault();
            utils.alert('每人限购一份。');
        });
        $('#pamount_not_a').on('click',function(e){
            e.preventDefault();
            utils.alert('每人限购一份。');
        });
    });

    function goBack(){
        var refer = document.referrer;
        var href_1 = "/tuan_buyings/goods_tuans/";
        var href_2 = "/tuan_teams/info/";
        var href_3 = "/refer/client/";
        if (refer.indexOf(href_1)<0&&refer.indexOf(href_2)<0&&refer.indexOf(href_3)<0){
            window.location.href = '/';
        }else{
            window.history.back();
        }
    }
</script>

<script>
    $(document).ready(function(){
        function handleQuickBuy($dom){
            var me = $dom;
            var href = window.location.href;
            if(!sso.check_userlogin({'referer':href})){
                return false;
            }else{
                if (me.hasClass('cart_btn_soldout')) {
                    return false;
                }
                var spec_labels = $('span.spec_label');
                if(spec_labels.length===0){
                    spec_labels = $('li.spec_label');
                }
                if (spec_labels.size() > 0) {
                    $.each(spec_labels, function (idx, val) {
                        var itemLabel = $(val).text().replace(":","");
                        var spec_item_selected = $('span.spec_item_selected[item-label="' + itemLabel + '"]');
                        if (spec_item_selected.size() < 1) {
                            utils.alert("请选择" + itemLabel);
                            return false;
                        }
                    });
                }
                if ($('span.spec_item[item-label="SD"]').size()>0) {
                    var cake_date_selected = $('span.spec_item_selected[item-label="SD"]');
                    if (cake_date_selected.size() < 1) {
                        utils.alert("请选择送货日期");
                        return false;
                    }
                }
                if($('.cur.tuan_way_selected').length<0){
                    utils.alert('请选择送货方式');
                    return false;
                }
                var pid = me.attr('data-pid');
                var tryId = me.attr('data-tryid');
                var sendDate = me.attr('data-send-date');
                var globalShow = me.attr('data-global-show');
                var tuanId = me.attr('data-tuan-id');
                var cartType = 'tuan_sec';
                quick_buy_try(pid, 1, 0, tryId, cartType, sendDate, function () {
                    me.removeClass('pay_bg').addClass('cart_btn_soldout');
                }, function (data) {
                    if(tuanId){
                        window.location.href = '/tuan_buyings/balance_tuan_sec_kill?from=tuan_sec&pid_list='+data.id+'&try='+tryId+'&tuan_id={{$tuan_team['TuanTeam']['id']}}';
                        return;
                    }
                    if(globalShow){
                        window.location.href = '/tuan_buyings/balance_global_sec_kill?from=tuan_sec&pid_list=' + data.id + '&try=' + tryId;
                        return;
                    }
                    window.location.href = '/orders/info?from=try&pid_list='+data.id+'&try='+tryId;
                    return;
                });
            }
        }
        function bind_click(){
            $('#sec_buy').on('click',function(){
                handleQuickBuy($(this));
            });
        }
        bind_click();
    });
</script>

{{if $jWeixinOn}}
<script>
    wx.ready(function () {
        var share_string = '{{$share_string ? $share_string :"0"}}';
        var to_timeline_title = "{{$Product['Product']['name']}}秒杀";
        var to_friend_title = "{{$Product['Product']['name']}}秒杀";
        var to_friend_link = document.URL.split('?')[0] + '?trstr='+ share_string + '&share_type=appMsg';
        var to_timeline_link = document.URL.split('?')[0] + '?trstr='+ share_string + '&share_type=timeline';
        var imgUrl = "{{$Product['Product']['coverimg']}}";
        var desc = "{{$Product['Product']['promote_name']}}！";
        wx.onMenuShareAppMessage({
            title: to_friend_title,
            desc: desc,
            link: to_friend_link,
            imgUrl: imgUrl,
            success: function () {
                // 用户确认分享后执行的回调函数
                if(share_string != '0'){
                    setTimeout(function(){
                        $.post('/wx_shares/log_share',{ trstr: share_string, share_type: "appMsg" });
                    }, 500);
                }
            }
        });
        wx.onMenuShareTimeline({
            title: to_timeline_title,
            link: to_timeline_link,
            imgUrl: imgUrl,
            success: function () {
                if(share_string != '0'){
                    setTimeout(function(){
                        $.post('/wx_shares/log_share',{ trstr: share_string, share_type: "timeline" });
                    }, 500);
                }
            }
        });
    });
</script>
{{/if}}