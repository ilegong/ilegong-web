{{$this->Html->css(array('vote.css'));}}
<div style="background-color:#c54134;" id="baby_sign_up">
    <div class="baby_banner"><img src="{{$this->Html->assetUrl('/img/vote/banner.png')}}"/></div>
    <div class="apply_bg">
        <ul class="clearfix">
            <li class="fl" style="width: 25%;">萌宝姓名</li>
            <li class="fl" style="width: 75%;"><input type="text" name="" id="candidate_title"/></li>
        </ul>
        <ul class="clearfix">
            <li class="fl" style="width: 25%;">联系电话&nbsp;&nbsp;&nbsp;</li>
            <li class="fl" style="width: 75%;"><input type="text" name="" id="candidate_mobile_phone"/></li>
        </ul>
        <ul class="clearfix">
            <li class="fl" style="width: 25%;">上传照片&nbsp;&nbsp;&nbsp;</li>
            <li class="fl" style="width: 75%;"><a href="#X" name="upload_image"><div class="img_delete"></div><img name="no_img" src="{{$this->Html->assetUrl('/img/vote/addpc.png')}}"/></a><a href="#X"><img name="no_img"
                    src="{{$this->Html->assetUrl('/img/vote/addpc.png')}}"/></a><a href="#X"><img name="no_img" src="{{$this->Html->assetUrl('/img/vote/addpc.png')}}"/></a></li>
        </ul>
        <ul class="clearfix">
            <li class="fl" style="width: 25%;">萌宝描述&nbsp;&nbsp;&nbsp;</li>
            <li class="fl" style="width: 75%; height: 90px; overflow:hidden;"><textarea id="candidate_description"></textarea></li>
        </ul>

        <input type="hidden" id="candidate_imgs" value="">

        <a href="#X" class="apply_btn" id="preview_pic">预览图片</a>
        <br/><br/>
        <a href="#X" class="apply_btn" id="sign_up">确认报名</a>

        <p>若在线报名失败，可以将报名信息：姓名+联系方式+描述+宝贝照片(2-3张)发给我们微信号：pyshuo2015</p>
    </div>

    <div class="babyrule">
        <h1>活动规则</h1>

        <p>活动时间：2015年6月14日～2015年6月21日</p>

        <p>活动规则：</p>

        <p>1、萌娃的年龄0-10岁；</p>

        <p>2、每个萌娃只能报名一次，每次报名可展示2-3张图片，请慎重选择后发送。本次比赛不可重复参与，如发现重复参与，将视票数最高的那一次参赛为最终比赛结果，重复投票以票数高者为准。</p>

        <p>3、参与活动的朋友们需对自己发送照片的真实性负责，若被举报并证实有虚假照片现象，将被取消资格，票数无效；</p>

        <p>4、每个微信号每天只能投票5次，每天对一个萌娃照片只能投1次票，多投将不计入总票数；投票方式：长按并识别下面二维码关注朋友说，在公众号中回复“投票”之后即可在页面投票。<br/><img
                src="{{$this->Html->assetUrl('/img/vote/weixin.png')}}"/></p>

        <p>5、如果有诋毁他人或用软件恶意刷票的现象，将直接取消参赛资格；</p>

        <p>6、本次活动不设评委，根据票数决出最终名次。</p>

        <p>7、活动奖品：一等奖1名，二等奖3名，三等奖10名，优秀奖15名</p>
    </div>
    <div class="babyrule" style="margin-bottom: 54px;">
        <h1>活动举办方</h1>

        <p>朋友说、XX幼儿园</p>
    </div>
    <div class="baby_bottom">
        <ul class="clearfix">
            <li>
                <a href="#X">
                    <i class="home"></i>
                    <label>首页</label>
                </a>
            </li>
            <li>
                <a href="#X">
                    <i class="ranking"></i>
                    <label>排名</label>
                </a>
            </li>
            <li class="cur">
                <a href="#X">
                    <i class="apply"></i>
                    <label>报名</label>
                </a>
            </li>
            <li>
                <a href="#X">
                    <i class="award"></i>
                    <label>奖品</label>
                </a>
            </li>
        </ul>
    </div>
    <!--弹出层-->
    <div class="tipslayer" style="display: none;">
        <a href="#X" class="tipslayer_close"></a>

        <div class="babydetaillayer">
            <h1>如何参与活动</h1>

            <p>请先关于微信公众号“pyshuo2014”如您已关注，请进入公众号回复“投票”进入活动页面报名或投票！</p>
            <a href="#X" class="babydetaillayer_btn">去关注</a>
        </div>
    </div>
    <div class="tipslayer_bg" style="display: none;"></div>
</div>

<script>
    wx.ready(function(){
        $(document).ready(function(){
            var $el = $('#baby_sign_up');
            //upload file
            var tempImage = {
                localId:[],
                serverId:[]
            };

            $('#preview_pic',$el).on('click',function(){
                var showImages = [];
                $('img[name="full_img"]',$el).each(function(index,item){
                    showImages.push($(item).attr('src'));
                });
                if(showImages.length>0){
                    wx.previewImage({
                        current: showImages[0],
                        urls: showImages
                    });
                }

            });

            $('a[name="upload_image"]',$el).on('click',function(){
                wx.chooseImage({
                    success: function (res) {
                        tempImage.localId = res.localIds;
                        setTimeout(wxUploadFile,30);
                    }
                });
            });

            function getNoImageHolderLen(){
                return $('img[name="no_img"]',$el).length;
            }
            function getNoImageHolder(){
                return $('img[name="no_img"]',$el);
            }
            //process upload file
            function wxUploadFile(){
                tempImage.localId = tempImage.localId.slice(0,getNoImageHolderLen());
                var i=0;
                var len = tempImage.localId.length;
                var failCount = 0;
                //防止上传失败图片显示位置错位
                var toShowIndex=0;
                var toShowHolder = getNoImageHolder();
                function doUpload(index){
                    wx.uploadImage({
                        localId: tempImage.localId[index],
                        isShowProgressTips:1,
                        success : function(res){
                            //server download and return url
                            tempImage.serverId.push(res.serverId);
                            $.getJSON('/downloads/download_wx_img?media_id='+res.serverId,function(data){
                                //download url
                                var imageUrl = data['download_url'];
                                //先显示图片和添加数据
                                if(imageUrl&&imageUrl!='false'){
                                    var $imgDom  = $(toShowHolder[toShowIndex]);
                                    $imgDom.attr('src',imageUrl);
                                    $imgDom.attr('name','full_img');
                                    $imgDom.parent().append('<div class="comment_delete"></div>');
                                    toShowIndex++;
                                }else{
                                    failCount++;
                                }
                                i++;
                                if(i<len){
                                    doUpload(i);
                                }else{
                                    if(failCount>0){
                                        utils.alert(failCount+'张图片上传失败。请重新上传。');
                                    }
                                }
                            });
                        },
                        fail: function(){
                            failCount++;
                        }
                    });
                }
                doUpload(i);
            }
        });
    });
</script>