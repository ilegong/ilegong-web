{{$this->Html->script(array('trace/tracekit.min.report.js', 'shake/shake.js', 'howler/howler.min.js', '3dfalling/rotate3Di.min.js', '3dfalling/3d-falling-leaves.js', 'jquery/jquery.fullPage.min.js', 'jquery/jquery.rotate.js'), array('block' => 'scriptBottom'));}}
{{$this->Html->css(array('game_jiujiu.css?ver2',));}}
<style>
    .apple_share {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 1030;
        background-color: #000;
    }

    .apple_share.in {
        opacity: .75;
    }

    dl {
        margin-bottom: 0;
    }

    ul {
        margin-bottom: 0 !important;
    }
</style>
<script>

    user_subscribed = "{{$user_subscribed}}";
    _path_exchange = '/game_jiujiu/exchange_coupon';
    _path_shake = '/game_jiujiu/shake';
    _path_notify = '/game_jiujiu/notifiedToMe';
    _path_assign_follow = '/game_jiujiu/assignWXSubscribeTimes';
    _path_query = '/game_jiujiu/hasNewTimes';
    _mobile_bind_reason = '离大奖很近了，请绑定手机号验证是否人类';

	$(document).ready(function(){
		var height = $(window).height();
		var width = $(window).width();
        var $strawberryBg = $('#strawberry_bg');
        $strawberryBg.height(height);
		$strawberryBg.width(width);
        var $strawberryTrbg = $('#strawberry_trbg');
        var $strawberryChance = $('#strawberry_chance');
        var $strawberry_prize = $('#strawberry_prize');
        var $strawberry_rules = $('#strawberry_rules');
        var strawberry_help_me = $('#strawberry_help_me');
        var strawberry_i_help = $('#strawberry_i_help');

        $strawberryTrbg.height(height);
		$strawberryTrbg.width(width);

        function hidePages() {
            $strawberryChance.hide();
            $strawberryTrbg.hide();
            $strawberry_prize.hide();
            $strawberry_rules.hide();
            strawberry_i_help.hide();
            strawberry_help_me.hide();
        }

        $strawberryTrbg.click(function(){
            hidePages();
        });

        $('.strawberry_prize_close').click(function(){
            hidePages();
        });

        $('#btn_add_chance').click(function(){
            $strawberryTrbg.show();
            $strawberryChance.show();
        });

        $('#btn_award').click(function(){
            $strawberry_prize.show();
            $strawberryTrbg.show();
        });

        var apple_got_cnt = $('apple_got_cnt');
        var $couponFirstLi = $('#coupon_first_li');
        var $couponSecLi = $('#coupon_sec_li');
        var $couponThirdLi = $('#coupon_third_li');

        game_notify_after_exchange = function (coupon_count, coupon_type) {
            if (coupon_count > 0) {
                if ('first' == coupon_type ) {
                    $('a#get_coupon_' + coupon_type).hide();
                    $couponFirstLi.append('<a href="/products/view/738.html">去使用</a>');
                } else if ('sec' == coupon_type) {
                    $('a#get_coupon_' + coupon_type).hide();
                    $couponSecLi.append('<a href="/products/view/738.html">去使用</a>');
                }
            } else {
                utils.alert("呜呜，本时段已兑完。");
            }
        };

        function func_li(li, lowest_limit, type) {
            if (li.find('a').length == 1) {
                if (total_not_spent() >= lowest_limit) {
                    li.append('<a id="get_coupon_'+type+'" href="javascript:;">领取</a>');
                    $('#get_coupon_'+type).click(function () {
                        if (typeof get_coupon_click_func == 'function') {
                            get_coupon_click_func(type);
                        }
                    });
                }
            }
        }

        $('#btn_rules').click(function(){
            $strawberry_rules.show();
            $strawberryTrbg.show();
            func_li($couponFirstLi, 50, 'first');
            func_li($couponSecLi, 40, 'sec');
            func_li($couponThirdLi, 30, 'third');
        });
        $('#btn_help_me').click(function(){
            strawberry_help_me.show();
            $strawberryTrbg.show();
        });
        $('#btn_i_help').click(function(){
            strawberry_i_help.show();
            $strawberryTrbg.show();
        });
	})
</script>
<div id="strawberry_bg">
	<i class="strawberry_bg"></i>
</div>
<div class="strawberry_title"><a href="/game_jiujiu/story.html"><img src="{{$this->Html->assetUrl('/img/game_jiujiu/index/title.png')}}" /></a></div>
<div class="strawberry_basket"><img id="apple_tree_img" src="{{$this->Html->assetUrl('/img/game_jiujiu/index/basket.gif')}}" /></div>

<div class="strawberry_num">已摇下<span id="apple_got_cnt">{{$total_apple}}</span>个草莓! 剩余<span id="apple_times_left">{{$total_times}}</span>次机会</div>
<div class="strawberry_btn">

	<ul>
    	<li class="clearfix">
            <a id="btn_rules" href="javascript:;" class="fl" style="position: relative">规则/兑奖<i></i></a>
            <a id="btn_add_chance" href="javascript:;" class="fr">加机会</a>
        </li>
        <li class="clearfix">
            <a id="btn_story" href="/game_jiujiu/story.html" class="fl">产品故事</a>
            <a id="btn_award" href="javascript:;" class="fr">获奖名单</a>
        </li>
        <li class="clearfix">
            <a id="btn_help_me" href="javascript:;" class="fl">谁帮了我<span>(<span id="helpme_cnt_n">{{count($helpMe)}}</span>)</span></a>
            <a id="btn_i_help" href="javascript:;" class="fr">我帮了谁</a>
        </li>
    </ul>
    <dl>
        <dt><a href="http://mp.weixin.qq.com/s?__biz=MjM5MjY5ODAyOA==&mid=204887757&idx=1&sn=94a8cf51cf2f2e36a4b51b0240071936#rd">商务合作</a >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="/brands/20150127/jiu_jiu_nong_chang_xu_gang.html">去店铺看看</a ></dt>
    </dl>
</div>

<!--摇到但还没抽奖机会-->
<div class="strawberry_rocknum_tips radius3" style="display:none; top:40%;">摇下了<span>5</span>个草莓!</div>
<!--没摇到-->
<div class="strawberry_rocknum_tips radius3" style="display:none; top:40%;">没有摇下来草莓, <br/>继续努力(⊙o⊙)哦!</div>
<!--摇到抽一等奖机会-->
<div class="strawberry_rocknum_tips radius3" style="display:none; top:30%;">
    <ul>
    	<li class="strawberry_thisnum">你这次摇下了<span>10</span>个草莓!</li>
        <li class="strawberry_totalnum">共摇下草莓<span>50</span>个, <br/>你是否要兑换 "<span>3斤草莓</span>" ?</li>
        <li class="clearfix">
        	<a href="javascript:;" class="strawberry_exchangebtn fl">兑换</a>
            <a href="javascript:;" class="strawberry_cancelbtn fr">取消</a>
        </li>
    </ul>
</div>
<!--摇到抽二等奖机会-->
<div class="strawberry_rocknum_tips radius3" style="display:none; top:30%;">
    <ul>
    	<li class="strawberry_thisnum">你这次摇下了<span>10</span>颗草莓!</li>
        <li class="strawberry_totalnum">共摇下草莓<span>50</span>颗, <br/>你是否要兑换 "<span>74元优惠券</span>" ?</li>
        <li class="clearfix">
        	<a href="javascript:;" class="strawberry_exchangebtn fl">兑换</a>
            <a href="javascript:;" class="strawberry_cancelbtn fr">取消</a>
        </li>
    </ul>
</div>
<!--摇到抽三等奖机会-->
<div class="strawberry_rocknum_tips radius3" style="display:none; top:30%;">
    <ul>
    	<li class="strawberry_thisnum">你这次摇下了<span>10</span>颗草莓!</li>
        <li class="strawberry_totalnum">共摇下草莓<span>30</span>颗, <br/>你是否要兑换 "<span>50元优惠券</span>" ?</li>
        <li class="clearfix">
        	<a href="javascript:;" class="strawberry_exchangebtn fl">兑换</a>
            <a href="javascript:;" class="strawberry_cancelbtn fr">取消</a>
        </li>
    </ul>
</div>
<!--获奖名单-->
<div id="strawberry_prize" class="strawberry_prize" style="display:none; top:8%;">
	<a class="strawberry_prize_close" href="javascript:;"><img src="{{$this->Html->assetUrl('/img/game_jiujiu/index/close.png')}}" /></a>
	<ul>
    	<li class="strawberry_prize_title">获奖名单<span>(最新100名)</span></li>
        <li class="strawberry_prize_surplus">一等奖剩余10, 二等奖剩余40, 三等奖剩余50</li>
    </ul>
    <div class="strawberry_prize_list">
    	<dl class="clearfix">
            <dt class="fl"><span>Alice</span>获一等奖</dt>
            <dt class="fr">1小时前</dt>
        </dl>
    </div>
</div>
<!--游戏规则
-->
        <style>
            .rules_list {
                text-align: left;
            }
            .rules_list ul li {
                font-size: 0.9em;
            }
        </style>
<div id="strawberry_rules" class="strawberry_prize" style="display:none; top:8%;">
	<a class="strawberry_prize_close" href="javascript:;"><img src="{{$this->Html->assetUrl('/img/game_jiujiu/index/close.png')}}" /></a>
    <div class="strawberry_prize_list rules_list">
        <h4>奖项</h4>
        <ul><li id="coupon_first_li">一等奖：摇满50颗，免费获得价值<a href="/products/20150127/dan_dong_99cao_mei_hong_yan.html">148元玖玖草莓</a>(每天20箱， 10-19点每小时放2箱，送完即止) {{if $had_coupon_first}}<a href="/products/20150127/dan_dong_99cao_mei_hong_yan.html">请在1小时内使用，去使用</a>{{/if}}</li>
        <li id="coupon_sec_li">二等奖：摇满30颗，可兑价值<a href="/products/20150127/dan_dong_99cao_mei_hong_yan.html">148元玖玖草莓</a>的5折券（每天限量200张） {{if $had_coupon_sec}}<a href="/products/20150127/dan_dong_99cao_mei_hong_yan.html">请在1小时内使用，去使用</a>{{/if}} </li>
        <?php /** <li id="coupon_third_li">3）三等奖：摇满30颗，可兑价值148元玖玖小柿子（6斤）的5折券（每天限量300张） {{if $had_coupon_third}}<a href="/products/20150127/dan_dong_99cao_mei_hong_yan.html">去使用</a>{{/if}}</li> */ ?>
        </ul>

        <h4>游戏规则</h4>
        <ul><li>1）时间：2015年2月1日-2月5日</li>
        <li>2）所有奖券请领取后请在1小时内使用</li>
        <li>3）免费送出和使用优惠券购买的奖品，第二天或第三天统一发货。其中，北京、天津外规格有区别，详见商品介绍页面。 </li>
        <li>4）相同手机号、微信号、用户、地址视为一人，如有作弊，奖品作废</li>
        <li>5）法律许可范围内，本次活动解释权归朋友说所有</li>
        </ul>

    </div>
</div>
<!--谁帮助过我-->
<div id="strawberry_help_me" class="strawberry_prize" style="display:none; top:8%;">
	<a class="strawberry_prize_close" href="javascript:;"><img src="{{$this->Html->assetUrl('/img/game_jiujiu/index/close.png')}}" /></a>
    <div class="strawberry_prize_list">
        {{if $helpMe}}
            <?php $i=0; foreach($helpMe as $key => $item) { $i++; if($i >=100){break;} ?>
        <dl class="clearfix">
            <dt class="fl"><span>{{$item['nickname']}}</span>摇下</dt>
            <dt class="fr gots">{{ $item['got'] }}</dt>
        </dl>
            <?php } ?>
        {{else}}
        <div class="con clearfix">还没有朋友帮过你啊，马上分享给朋友们吧！
            <a id="share_btn_2" href="javascript:;" class="help">分享好友求助</a>
        </div>
        {{/if}}
    </div>
</div>
<!--我帮助过的朋友-->
<div id="strawberry_i_help" class="strawberry_prize" style="display:none; top:8%;">
	<a class="strawberry_prize_close" href="javascript:;"><img src="{{$this->Html->assetUrl('/img/game_jiujiu/index/close.png')}}" /></a>
    <div class="strawberry_prize_list">
        {{if $meHelp}}
        <?php $i=0; foreach($helpMe as $key => $item) { $i++; if($i>=100){break;} ?>
        <dl class="clearfix">
            <dt class="fl"><span>{{$item['nickname']}}</span>摇下</dt>
            <dt class="fr gots">{{ $item['got'] }}</dt>
        </dl>
        <?php } ?>
        {{else}}
        <div class="con clearfix">还没有帮过好友！
            <a id="share_btn_3" href="javascript:;" class="help">邀请好友来玩</a>
        </div>
        {{/if}}
    </div>
</div>
<!--加机会-->
<div id="strawberry_chance" class="strawberry_chance" style="display:none; top:8%;">
	<a class="strawberry_prize_close" href="javascript:;"><img src="{{$this->Html->assetUrl('/img/game_jiujiu/index/close.png')}}" /></a>
	<ul>
    	<li class="strawberry_chance_title">摇一摇加机会秘诀</li>
    </ul>
    <dl class="clearfix">
    	<dd class="fl"><a id="assignWXSubscribeTimes" href="javascript:;">关注朋友说</a></dd>
        <dd class="strawberry_chance_explain">每天加2次机会</dd>
    </dl>
    <dl class="clearfix">
    	<dd class="fl"><a id="share_btn" href="javascript:;">邀请朋友</a></dd>
        <dd class="strawberry_chance_explain">每个朋友增加一次机会</dd>
    </dl>
    <div class="strawberry_chance_aboutus">
    	<img src="{{$this->Html->assetUrl('/img/game_jiujiu/index/logo.png')}}" /><br />朋友、同事间互相分享、推荐家乡特产的平台,<br />我们都是城市里的乡下人。
    </div>
</div>
<!--透明黑色背景-->
<div id="strawberry_trbg" style="display:none;"></div>
<script>
    var $today_got_wx = "{{$today_got_wx}}";
    var shake_pic_url = '{{$this->Html->assetUrl("/img/game_jiujiu/index/basketmove.gif")}}';
    var sound_url = 'http://51daifan-images.stor.sinaapp.com/tree_shake.mp3';
//    var share_png_url = '{{$this->Html->assetUrl("http://51daifan-images.stor.sinaapp.com/as/rice_xirui/index/share.png")}}';
    var share_png_url = '{{$this->Html->assetUrl("http://51daifan-images.stor.sinaapp.com/as/rice_xirui/index/share.png")}}';
    var yao_tips_png = '{{$this->Html->assetUrl("http://51daifan-images.stor.sinaapp.com/as/rice_xirui/index/yao.png")}}';
    var game_type = '{{$game_type}}';

    var game_obj_name = '{{$game_obj_name}}';
    var game_least_change = '{{$game_least_change}}';
    var awarded = '{{$awarded}}';
    var game_user_total = '{{$game_user_total}}'; //loading by update_top_list
    var get_coupons_button = $('');

    var showAfterGotCallback = function(){};

    function total_not_spent() {
        var total = $.trim($('#apple_got_cnt').text());
        total = total != '' ? parseInt(total) : 0;
        return total;
    }

    var friendGots = $('.gots').map(function () {
        var v = $.trim($(this).text());
        return v ? parseInt(v) : 0;
    }).get();

    function get_total() {
        var total = total_not_spent();
        return (total < game_user_total ? game_user_total : total);
    }

    function show_got_coupon() {
        utils.alert_one('恭喜您秒杀成功，请注意在有效期结束前使用。还可以抢268元终极大奖哦', '查看我的优惠券', function(){ window.location.href = '/users/my_coupons.html';});
    }

    function help_me_cnt() {
        var helpme_cnt_txt = $.trim($('#helpme_cnt_n').text());
        return (helpme_cnt_txt == '' ? 0 : parseInt(helpme_cnt_txt));
    }

    function dabai_percent() {
        var total = get_total();

        var win = 0;
        for(var x in friendGots) {
            if (total > friendGots[x]) {
                win++;
            }
        }
        return (win == friendGots.length) ? 100 : utils.toFixed(win*100/friendGots.length, 0)
    }

    function desc_cmp_friends() {
        var desc = '我已摇下' + get_total() + '颗';
        if (friendGots && friendGots.length > 0) {
            var dabaiPercent = dabai_percent();
            desc += (dabaiPercent == 100 ? ', 打败了所有好友，哈哈' : (dabaiPercent == 0 ? ', 朋友圈里垫底 ^_^， 快点我吧' : ', 打败了' + dabaiPercent + '%的好友！'));
        } else {
            desc += ', 还没人帮过我！快来帮我吧';
        }
        return desc;
    }

    $(document).ready(function() {
        if (typeof(wx) != 'undefined') {
            wx.ready(function () {
                var share_string = '{{$share_string ? $share_string :"0"}}';
                var to_timeline_title = "摇下50颗， 3斤丹东玖玖农场草莓免费送，来自有机认证的水土，中国最早的草莓种植地（之一）。 ";
                var to_friend_title = "摇下50颗， 3斤丹东玖玖农场草莓免费送";
                var to_friend_desc = desc_cmp_friends();
                var to_friend_link = window.location.href;
                var to_timeline_link = window.location.href;
                var imgUrl = "{{$this->Html->assetUrl('http://www.tongshijia.com/img/game_jiujiu/index/share_logo.jpg')}}";
                wx.onMenuShareAppMessage({
                    title: to_friend_title,
                    desc: to_friend_desc,
                    link: to_friend_link,
                    imgUrl: imgUrl,
                    success: function () {
                        if (share_string != '0') {
                            $.post('/wx_shares/log_share', { trstr: share_string, share_type: "appMsg" });
                        }
                    }
                });
                wx.onMenuShareTimeline({
                    title: to_timeline_title,
                    link: to_timeline_link,
                    imgUrl: imgUrl,
                    success: function () {
                        if (share_string != '0') {
                            $.post('/wx_shares/log_share', { trstr: share_string, share_type: "timeline" });
                        }
                    }
                });
            })
        }
    });
</script>
{{$this->Html->script(array('apple_game.js?v27'));}}
