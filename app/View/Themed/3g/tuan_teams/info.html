<!DOCTYPE html>
<html>
<head>
    {{$this->Html->css(array('tuan-detail.css?v9.2'))}}
</head>
<body style="background-color:#f5f5f5;">
<div class="tuandetail_nav">
    <ul class="clearfix">
        <li class="fl"><a href="/"><img src="{{$this->Html->assetUrl('/img/tuan/detail/logo.png')}}"/></a></li>
        <!--<li class="fr"><a href="#X">收藏</a></li>-->
        <li class="fr"><a href="/orders/mine">我的订单</a></li>
        <li class="fr"><a href="/scores/more_score">领积分</a></li>
    </ul>
</div>
<?php $location = $tuan_team['TuanTeam']['location_long'].','.$tuan_team['TuanTeam']['location_lat'];
?>
<div class="tuandetail">
    <div class="tuandetail_name">
        <strong>{{$tuan_team['TuanTeam']['tuan_name']}}</strong>
        <em>健康&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;营养&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;实惠</em>
    </div>
    <ul class="clearfix tuandetail_member" style="margin-bottom: 0;">
        <li class="fl"><span>团长:{{$tuan_team['TuanTeam']['leader_name']}}</span></li>
        <li class="fl">&nbsp;&nbsp;微信号:{{$tuan_team['TuanTeam']['leader_weixin']}}</li>
        <li class="fr"><a class="p_more" href="/tuan_teams/memberlist/{{$tuan_team['TuanTeam']['id']}}"></a></li>
        <li class="fr">{{$tuan_team['TuanTeam']['member_num']-1}}人</li>
    </ul>
    <a class="clearfix adress"
       href="/tuan_teams/lbs_map?location={{$location}}&name={{$tuan_team['TuanTeam']['tuan_name']}}&addr={{$tuan_team['TuanTeam']['tuan_addr']}}">
        <span class="fl"><img src="{{$this->Html->assetUrl('/img/tuan/detail/locat_icon.gif')}}" border="0"/></span>
        <span style="float: none; padding-left: 20px;line-height: 22px;">配送至: {{$tuan_team['TuanTeam']['tuan_addr']}}</span>
    </a>
</div>
{{if !empty($tryings)}}
<div class="tuandetail_seckill clearfix">
    <?php $i = 0; foreach($tryings as $trying) {
        if ($i++>=2) {break;} ?>
        <span><img src="{{$this->Html->assetUrl(small_thumb_link($trying['image']))}}"/></span>
        <span>
            <h1>{{$trying['ProductTry']['product_name']}} {{$trying['ProductTry']['spec']}}</h1>
            <em>秒杀价：<strong>¥{{$this->Number->precision(calculate_try_price($trying['ProductTry']['price']),
                2)}}</strong></em>
            <div class="tuan_bar clearfix" style="padding:5px 10px 12px 10px;">
                <div>
                    {{if $trying['status'] == 'sec_kill'}}
                    <a class="tuan_bar_btn doing" data-try-id="{{$trying['ProductTry']['id']}}" data-tuan-id="{{$tuan_id}}"
                       data-pid="{{$trying['Product']['id']}}" data-send-date="{{$trying['ProductTry']['consignment_date']}}">正在秒杀</a>
                    {{elseif $trying['status'] == 'sec_end'}}
                    <a class="tuan_bar_btn done" style="background-color: #cccccc;">已秒完</a>
                    {{else}}
                    <a data-start="{{strtotime($trying['ProductTry']['start_time']) - ($shichi_mem? 30 * 60 : 0)}}"
                       data-pid="{{$trying['Product']['id']}}" href="#X" class="tuan_bar_btn sec_start">{{friendlyDateFromStr($trying['ProductTry']['start_time'])}}开秒</a>
                    {{/if}}
                </div>
                <div class="fr" style="width:48%; margin-top:4px;">
                    <?php $limit_num = $trying['ProductTry']['limit_num'];
                        $sold_num = $trying['ProductTry']['sold_num'];
                        if($sold_num >= $limit_num){
                    $sold_num = $limit_num;
                    }
                    if($sold_num >= $limit_num){
                    $sold_percent = 100;
                    }else{
                    $sold_percent = round(($sold_num / $limit_num * 100), 1);
                    }
                    ?>
                    <div class="bar">
                        <div class="bar_buy" id="bar_buy" style="width:{{$sold_percent}}%;"></div>
                    </div>
                    <ul class="clearfix">
                        <li class="fl">已秒<span style="display:inline;">{{$sold_num}}</span>份</li>
                        <li class="fr">共{{$limit_num}}份</li>
                    </ul>
                </div>
                <b>秒杀</b>
            </div>
        </span>
    <?php } ?>
</div>
{{/if}}
<div class="clearfix tuandetail_good">
    {{loop $tuan_product_infos $pid $t_product}}
    <?php
            $product = $product_infos[$pid];
            $t_buying = $tb_product_map[$pid];
            $price = $product['price'];
            if($t_product['price']>0){
    $price = $t_product['price'];
    }
    if($t_buying['tuan_price']>0){
    $price = $t_buying['tuan_price'];
    }
    ?>
    <a href="/tuan_buyings/detail/{{$t_buying['id']}}">
        <div class="tuandetail_img"><img src="{{$this->Html->assetUrl(small_thumb_link($product['coverimg']))}}"/></div>
        <div class="tuandetail_title">
            <span>{{$product['name']}}</span>
            <em><strong>¥{{$price}}</strong>&nbsp;{{if !empty($product['original_price'])}}<font>¥{{$this->Number->precision($product['original_price'],
                2)}}</font>{{/if}}</em>
        </div>
        {{if $t_buying['consignment_type']!=2}}
        <b>团购</b>
        {{/if}}
    </a>
    {{/loop}}
</div>
<dl class="tuanherf clearfix">
    <dd class="fl"><a href="/categories/mobileHome.html">朋友说首页</a></dd>
    {{if empty($is_join)}}
    <dd class="fl"><a href="#X" class="alltuan_addbtn" name="join_tuan" data-tuan-id="{{$tuan_id}}">我要加入团</a ></dd>
    {{else}}
    <dd class="fl"><a href="#X" class="alltuan_curbtn">已加入</a><br/></dd>
    {{/if}}
</dl>
<div class="tuandetail_tips">
    <p>Tips:小贴士</p>
    <span>1、统一配送至：{{$tuan_team['TuanTeam']['tuan_addr']}}</span>
    <em>统一配送是为了保证商品的品质、降低物流成本，让利给您！</em>
    <span>2、贴心小管家</span>
    <em>如您有任何问题可随时招呼【朋友说小妹】，小妹微信二维码如下</em>
    <em><img src="{{$this->Html->assetUrl('/img/tuan/detail/xiaomei.jpg')}}"/></em>
</div>
{{$this->Html->script(array('/js/tuan-area.js?v1','tuanteams/mei-shi-tuan.js?v6',))}}
<script>
    $(document).ready(function () {
        var BASEURL = "{{APP_SUB_DIR}}";
        var timerParentStyle = {'margin-top': '1em'};
        var toTimer = $('.sec_start').first();
        var countDiv = toTimer.parent();
        var pid = toTimer.attr('data-pid');
        var cartType = 'tuan_sec';
        utils.countDown(toTimer, function () {
            countDiv.css(timerParentStyle);
        }, function () {
            var parent = countDiv.parent();
            countDiv.remove();
            parent.append('<a data-try-id="{{$trying["ProductTry"]["id"]}}" data-tuan-id="{{$tuan_id}}" class="tuan_bar_btn doing" data-pid="{{$trying["Product"]["id"]}}">正在秒杀</a>');
            bindClick();
        });

        function buyBtnClicked(buyBtn) {
            if (buyBtn.hasClass('sec_end')) {
                return false;
            }
            var $pid = buyBtn.attr('data-pid');
            var tryId = buyBtn.attr('data-try-id');
            var sendDate = buyBtn.attr('data-send-date');
            quick_buy_try($pid, 1, 0, tryId, cartType, sendDate, function () {
                buyBtn.removeClass('doing').addClass('done');
            }, function () {
                //
            });
        }
        function bindClick(){
            //秒杀事件
            $('a.doing').click(function () {
                buyBtnClicked($(this));
            });
        }

        bindClick();

        /**
         * 添加到快速购买试吃秒杀
         * @param id 产品编号
         * @param num 产品数量
         * @param spec 产品规格
         * @param tryId 试吃id
         * @param type
         * @param soldOutCallback
         * @param addedCallback
         * @return
         */
        function quick_buy_try(id, num, spec, tryId, type, sendDate, soldOutCallback, addedCallback) {
            type = type || 'normal';
            var url = BASEURL + '/carts/add';
            var postdata = {
                'data[Cart][num]': num,
                'data[Cart][product_id]': id,
                'data[Cart][spec]': spec,
                'data[Cart][type]': type,
                'data[Cart][send_date]': sendDate,
                'try_id': tryId
            };
            ajaxAction(url, postdata, null, function (data) {
                if (data.success == false) {
                    if (data.reason == 'not_login') {
                        window.location.href = '/users/login.html?referer=' + encodeURIComponent("/tuan_teams/info/{{$tuan_id}}");
                        return false;
                    } else if (data.reason == 'already_seckill_nopaid') {
                        utils.alert_one('抱歉：您还未支付哦,请前去支付', '去支付', function () {
                            window.location.href = '/orders/mine';
                        });
                    }else if (data.reason == 'already_seckill_paid'){
                        utils.alert_one('抱歉：限购一份哦，您已经秒过啦', '知道啦', function () {
                        });
                    }else if (data.reason == 'sold_out') {
                        utils.alert_one('抱歉：已经被秒完', '知道了', function () {
                            if (typeof(soldOutCallback) == 'function') {
                                soldOutCallback()
                            }
                        });
                    } else if (data.reason == 'already_buy') {
                        utils.alert_one('抱歉：您已经秒过啦', '关闭', function () {
                        });
                    } else if (data.reason = 'not_comment') {
                        utils.alert_one('抱歉：您有' + data.not_comment_cnt + '个试吃商品还没有反馈，请先完成反馈再秒杀');
                    }
                } else {
//                    utils.alert_one('您好，下单支付完成才算秒杀完成, 立即跳转结算', '去结算', function () {
                        addedCallback();
                        window.location.href = '/tuan_buyings/balance_tuan_sec_kill?from=tuan_sec&pid_list=' + data.id + '&try=' + tryId + '&tuan_id={{$tuan_id}}';
//                    });
                }
            });
            return false;
        }
    });
</script>
{{if $jWeixinOn}}
<script>
    wx.ready(function () {
        var share_string = '{{$share_string ? $share_string :"0"}}';
        var to_timeline_title = "寻找最纯粹的美味，让生活多点快乐的色彩！";
        var to_friend_title = "{{$tuan_team['TuanTeam']['tuan_name']}}" + "-朋友说美食团";
        var to_friend_link = document.URL.split('?')[0] + '?trstr=' + share_string + '&share_type=appMsg';
        var to_timeline_link = document.URL.split('?')[0] + '?trstr=' + share_string + '&share_type=timeline';
        var imgUrl = "http://api.map.baidu.com/staticimage?width=200&height=150&center={{$location}}&zoom=18&markers={{$location}}&&markerStyles=l";
        var desc = "{{$tuan_team['TuanTeam']['tuan_name']}}, 找寻最纯粹的美味，让生活多点快乐的色彩！";
        wx.onMenuShareAppMessage({
            title: to_friend_title,
            desc: desc,
            link: to_friend_link,
            imgUrl: imgUrl,
            success: function () {
                // 用户确认分享后执行的回调函数
                if (share_string != '0') {
                    setTimeout(function () {
                        $.post('/wx_shares/log_share', {trstr: share_string, share_type: "appMsg"});
                    }, 500);
                }
            }
        });
        wx.onMenuShareTimeline({
            title: to_timeline_title,
            link: to_timeline_link,
            imgUrl: imgUrl,
            success: function () {
                if (share_string != '0') {
                    setTimeout(function () {
                        $.post('/wx_shares/log_share', {trstr: share_string, share_type: "timeline"});
                    }, 500);
                }
            }
        });
    })
</script>
{{/if}}
</body>
</html>


