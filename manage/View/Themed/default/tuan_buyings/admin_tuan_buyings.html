{{$this->Html->css(array('bootstrap.min.css'));}}
        <style>
            .fade.in{
                opacity: 0.70;
            }
        </style>
<hr/>
<h1>团购管理</h1>
<hr/>
<form class="form-inline tuan_buyings-form" method="get" action="/manage/admin/tuanBuyings/tuan_buyings">
    <div style="padding-bottom: 10px;">
        <input type="hidden" name="noajax" value="true">

        <div class="form-group">
            <input type="text" name="tuan_name" id="tuan_name" class="form-control" placeholder="搜索团队">
        </div>
        <div class="form-group">
            <select class="form-control tuan-teams"  name="team_id" data-team-id="{{$team_id}}">
                <option value="-1">请选择团队</option>
            </select>
        </div>
        <div class="form-group" name="product_id">
            <select class="form-control tuan-products" name="product_id" data-product-id="{{$product_id}}">
                <option value="-1">选择商品</option>
            </select>
        </div>
        <div class="form-group">
            <select class="form-control time-type" name="time_type" data-time-type="{{$time_type}}">
                <option value="-1">选择时间</option>
                <option value="0">截止时间</option>
                <option value="1">发货时间</option>
            </select>
        </div>
        <div class="form-group">
            <label class="sr-only">时间</label>
            <input type="text" name="post_time" class="form-control post-time" placeholder="输入时间">
        </div>
        <div class="form-group ">
            <select class="form-control tuan-type" name="tuan_type" data-tuan-type="{{$tuan_type}}">
                <option value="-1">选择团购状态</option>
                <!--<optgroup label="常用">-->
                <option value="0" selected="selected">进行中</option>
                <option value="1">已完成</option>
                <option value="2">已取消</option>
                <!--</optgroup>-->
                <!--<optgroup label=" 不常用">-->
                <option disabled>-------</option>
                <option value="11">已发货</option>
                <option value="21">已退款</option>
                <!--</optgroup>-->
            </select>
        </div>
        <button type="submit" style="margin-left:10px;" class="btn btn-default">查看团购</button>
    </div>

    <div>
        <a href="/manage/admin/tuanBuyings/tuan_buying_new" role="button" class="btn btn-default fr">创建团购</a>
        <a href="/manage/admin/tuanBuyings/tuan_func_list" role="button" style="margin-right:10px;" class="btn btn-default fr">团购功能列表</a>
        <!--<a href="/manage/admin/tuan/tuan_team_create" role="button" style="margin-right:10px;" class="btn btn-default fr">添加新团</a>-->
    </div>
</form>
<table class="table table-bordered  table-condensed table-responsive">
    <thead>
    <tr>
        <td>团购ID</td><td>团名称</td><td>商品/类别</td><td>发货类型</td><td>团购价</td><td>参团人数</td><td>售出份数/目标</td><td>创建时间</td><td>是否完成(截单时间)</td><td>是否延期</td><td>发货/退款</td><td>操作</td>
    </tr>
    </thead>
    <tbody>
    {{loop $tuan_buyings $index $tuan_buying}}
    <?php
        $tuanBuying = $tuan_buying['TuanBuying'];
        $tuanTeam = $tuan_buying['tuan_team'];
        $tuanProduct = $tuan_buying['tuan_product'];
        if($tuanBuying['status'] == 0){
            $tuanStatus = '进行中';
        }
        elseif($tuanBuying['status'] == 2 || $tuanBuying['status'] == 2){
            $tuanStatus = '已取消';
        }
        elseif($tuanBuying['status'] == 1 || $tuanBuying['status'] == 11){
            $tuanStatus = '已截止';
        }
    ?>
    <tr data-id="{{$tuanBuying['id']}}" class="{{if $tuanBuying['status']==1}} warning {{elseif $tuanBuying['status']==11}} success {{elseif $tuanBuying['status']==2}} danger {{elseif $tuanBuying['status']==21}} active {{/if}}">
        <td>{{$tuanBuying['id']}}</td>
        <td>{{$tuanTeam['tuan_name']}}</td>
        <td>{{$tuanProduct}}/{{$tuanTeam['type']==1?大团:小团}}</td>
        <td>
          {{if $tuanBuying['consignment_type'] == 0}}
            团满发货
          {{elseif $tuanBuying['consignment_type'] == 1}}
            团满准备发货
          {{elseif $tuanBuying['consignment_type'] == 2}}
            排期
          {{else}}
          {{/if}}</td>
        <td>
          <!--{{if $tuanBuying['tuan_price'] >= 0}}-->
            <span class="text-info">{{$tuanBuying['tuan_price']}}</span>
          <!--{{elseif $tuanProduct['tuan_price'] >= 0 }}-->
            <!--<span class="text-success">$tuanProduct['tuan_price']</span>-->
          <!--{{else}}-->
            <!--<span class="text-danger">$tuanProduct['tuan_price']</span>-->
          <!--{{/if}}-->
        </td>
        <td>{{$tuanBuying['join_num']}}</td>
        <td class="{{if $tuanBuying['sold_num']<$tuanBuying['target_num']}} text-danger {{else}} text-success    {{/if}}">{{$tuanBuying['sold_num']}}/{{$tuanBuying['target_num']}}</td>
        <td>{{$tuanBuying['created'] == ''?date('n.j H:i',strtotime($tuanBuying['end_time'])-2*24*60*60):date('n.j H:i',strtotime($tuanBuying['created']))}}
            {{if $tuanBuying['status'] == 0}}
            {{if $tuan_buying['create_msg_status'] == 'true'}}
            <button type="button" class="btn btn-sm btn-info tuan-buying-sendmsg" data-id="{{$tuanBuying['id']}}">建团消息</button>
            {{else}}
            <span class="label label-info">{{$tuan_buying['create_msg_status']}}</span>
            {{/if}}
            {{else}}
            <span class="label label-info">已发建团消息</span>
            {{/if}}
        </td>
        <td>{{$tuanStatus}}({{date('n.j H:i',strtotime($tuanBuying['end_time']))}})
            {{if $tuanBuying['status']==0}}
            <button type="button" class="btn btn-sm btn-warning tuan-buying-due" data-id="{{$tuanBuying['id']}}" value="1">完成</button>
            <button type="button" class="btn btn-sm btn-danger tuan-buying-canceled" data-id="{{$tuanBuying['id']}}" value="2">取消</button>
            {{elseif $tuanBuying['status'] == 1}}
            {{if $tuan_buying['complete_msg_status'] == 'true'}}
            <button type="button" class="btn btn-sm btn-info tuan-buying-completemsg" data-id="{{$tuanBuying['id']}}" data-tuanBuying-id="{{$tuanBuying['status']}}">完成消息</button>
            {{else}}
            <span class="label label-info">{{$tuan_buying['complete_msg_status']}}</span>
            {{/if}}
            {{/if}}
        </td>
        <td>{{if $tuanBuying['status'] == 0}}
            {{if $tuanBuying['sold_num']<$tuanBuying['target_num']}}
            {{if $tuan_buying['tip_msg_status'] == 'true'}}
            <a href="/manage/admin/tuan_msg/to_send_tuan_delay_msg/{{$tuanBuying['id']}}" target="_blank" class="btn btn-sm btn-info tuan-buying-delayemsg" data-id="{{$tuanBuying['id']}}" data-tuanBuying-id="{{$tuanBuying['status']}}">延期消息</a>
            <button type="button" class="btn btn-sm btn-info tuan-buying-tipmsg" data-id="{{$tuanBuying['id']}}">提示消息</button>
            {{else}}
            <span class="label label-info">{{$tuan_buying['tip_msg_status']}}</span>
            {{/if}}
            {{else}}否
            {{/if}}
            {{else}}否
            {{/if}}
        </td>
        <td>
            {{if $tuanBuying['status']==2}}
                待退款
              <button type="button" class="btn btn-sm btn-danger tuan-buying-refunded" data-id="{{$tuanBuying['id']}}" value="1">退款完成</button>
            {{if $tuan_buying['cancel_msg_status'] == 'true'}}
              <button type="button" class="btn btn-sm btn-info tuan-buying-cancelmsg" data-id="{{$tuanBuying['id']}}">取消消息</button>
            {{else}}
              <span class="label label-info">{{$tuan_buying['cancel_msg_status']}}</span>
            {{/if}}
            {{elseif $tuanBuying['status']==21}}
                已退款
            {{elseif $tuanBuying['status']==1}}
                待发货({{date('n.j',strtotime($tuanBuying['consign_time']))}})
              {{if $tuan_buying['start_deliver_msg_status'] == 'true'}}
                <button type="button" class="btn btn-sm btn-info tuanbuying-start-deliver" data-product-name="{{$tuanProduct}}" data-id="{{$tuanBuying['id']}}">配送消息</button>
              {{else}}
                <span class="label label-info">{{$tuan_buying['start_deliver_msg_status']}}</span>
              {{/if}}
              {{if $tuan_buying['notify_deliver_msg_status'] == 'true'}}
                <button type="button" class="btn btn-sm btn-info tuanbuying-notify-deliver" data-tuanteam-address="{{$tuanTeam['address']}}" data-product-name="{{$tuanProduct}}" data-id="{{$tuanBuying['id']}}">到货消息</button>
              {{else}}
                <span class="label label-info">{{$tuan_buying['notify_deliver_msg_status']}}</span>
              {{/if}}
              <button type="button" class="btn btn-sm btn-warning tuan-buying-finished" data-id="{{$tuanBuying['id']}}" value="1">发货完成</button>
            {{elseif $tuanBuying['status']==11}}
                已发货({{date('n.j',strtotime($tuanBuying['consign_time']))}})
            {{elseif $tuanBuying['status']==1}}
              {{if $tuanBuying['consign_time']==null}}
              {{else}}
                预计发货({{date('n.j',strtotime($tuanBuying['consign_time']))}})
              {{/if}}
            {{/if}}
        </td>
        <td>
            {{if $tuanBuying['status']!=11 && $tuanBuying['status']!=21}}
                <a role="button" class="btn btn-sm btn-default" href="/manage/admin/tuanBuyings/tuan_buying_edit/{{$tuanBuying['id']}}">编辑...</a>
                <a role="button" class="btn btn-sm btn-default" href="#">编辑物流...</a>
            {{/if}}

            <!--{{if $tuanBuying['status']==0}}-->
            <!--{{elseif $tuanBuying['status']==1}}-->

                <!--{{if $tuan_buying['complete_msg_status'] == 'true'}}-->
                    <!--<button type="button" class="btn btn-sm btn-info tuan-buying-completemsg" data-id="{{$tuanBuying['id']}}" data-tuanBuying-id="{{$tuanBuying['status']}}">完成消息</button>-->
                <!--{{else}}-->
                    <!--<span class="label label-info">{{$tuan_buying['complete_msg_status']}}</span>-->
                <!--{{/if}}-->
            <!--{{/if}}-->
        </td>
    </tr>
    {{/loop}}
    </tbody>
</table>

{{$this->Html->script(
    array(
        'vendor/jquery.ui.widget.js',
        '//blueimp.github.io/JavaScript-Load-Image/js/load-image.all.min.js',
        '//blueimp.github.io/JavaScript-Canvas-to-Blob/js/canvas-to-blob.min.js',
        'jquery.iframe-transport.js',
        'manage/tuan_buyings/index.js',

    ));
}}