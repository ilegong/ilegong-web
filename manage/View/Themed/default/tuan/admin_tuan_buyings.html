{{$this->Html->css(array('bootstrap.min.css'));}}
<hr/>
<h1>团购管理</h1>
<hr/>
<form class="form-inline" method="get" action="/manage/admin/tuan/tuan_buyings">
    <div style="padding-bottom: 10px;">
        <input type="hidden" name="noajax" value="true">
        <div class="form-group">
            <select class="form-control tuan-teams" name="team_id" value="{{$team_id}}">
                <option value="-1">请选择团队</option>
            </select>
        </div>
        <div class="form-group" name="product_id">
            <select class="form-control tuan-products" value="{{$product_id}}" name="product_id">
                <option value="-1">选择商品</option>
            </select>
        </div>
        <div class="form-group">
            <select class="form-control" name="time_type" value="{{$time_type}}">
                <option value="-1">选择时间</option>
                <option value="0">截止时间</option>
                <option value="1">发货时间</option>
            </select>
        </div>
        <div class="form-group">
            <label class="sr-only">时间</label>
            <input type="text" name="post_time" class="form-control" placeholder="输入时间">
        </div>
        <div class="form-group">
            <select class="form-control" name="tuan_type" value="{{$tuan_type}}">
                <option value="-1">选择团购状态</option>
                <option value="0">进行中</option>
                <option value="1">已完成</option>
                <option value="2">已取消</option>
            </select>
        </div>
    </div>

    <div>
        <a href="/manage/admin/tuan/tuan_buying_new" role="button" class="btn btn-default fr">创建团购</a>
        <button type="submit" class="btn btn-default fr">查看团购</button>
        <!--<a href="/manage/admin/tuan/tuan_team_create" role="button" style="margin-right:10px;" class="btn btn-default fr">添加新团</a>-->
    </div>
</form>
<table class="table table-bordered  table-condensed table-responsive">
    <thead>
    <tr>
        <td>团购ID</td><td>团名称</td><td>商品/类别</td><td>参团人数</td><td>售出份数/目标</td><td>是否完成(截单时间)</td><td>发货/退款</td><td>操作</td>
    </tr>
    </thead>
    <tbody>
    {{loop $tuan_buyings $index $tuan_buying}}
    <?php
        $tuanBuying = $tuan_buying['TuanBuying'];
        $tuanTeam = $tuan_buying['tuan_team'];
        $tuanProduct = $tuan_buying['tuan_product'];
        if($tuanBuying['status'] == 0){
            $tuanStatus = '进行中';
        }
        elseif($tuanBuying['status'] == 2 || $tuanBuying['status'] == 2){
            $tuanStatus = '已取消';
        }
        elseif($tuanBuying['status'] == 1 || $tuanBuying['status'] == 11){
            $tuanStatus = '已截止';
        }
    ?>
    <tr data-id="{{$tuanBuying['id']}}" class="{{if $tuanBuying['status']==1}} warning {{elseif $tuanBuying['status']==11}} success {{elseif $tuanBuying['status']==2}} danger {{elseif $tuanBuying['status']==21}} active {{/if}}">
        <td>{{$tuanBuying['id']}}</td>
        <td>{{$tuanTeam['tuan_name']}}</td>
        <td>{{$tuanProduct}}/{{$tuanTeam['id']==26?大团:小团}}</td>
        <td>{{$tuanBuying['join_num']}}</td>
        <td class="{{if $tuanBuying['sold_num']<$tuanBuying['target_num']}} text-danger {{else}} text-success    {{/if}}">{{$tuanBuying['sold_num']}}/{{$tuanBuying['target_num']}}</td>
        <td>{{$tuanStatus}}({{date('n.j H:i',strtotime($tuanBuying['end_time']))}})</td>
        <td>
            {{if $tuanBuying['status']==2}}
                待退款
            {{elseif $tuanBuying['status']==21}}
                已退款
            {{elseif $tuanBuying['status']==1}}
                待发货({{date('n.j',strtotime($tuanBuying['consign_time']))}})
            {{elseif $tuanBuying['status']==11}}
                已发货({{date('n.j',strtotime($tuanBuying['consign_time']))}})
            {{elseif $tuanBuying['consign_time']==null}}
                团满发货
            {{elseif $tuanBuying['status']==1}}
                预计发货({{date('n.j',strtotime($tuanBuying['consign_time']))}})
            {{/if}}
        </td>
        <td>
            {{if $tuanBuying['status']!=11 && $tuanBuying['status']!=21}}
                <a role="button" class="btn btn-sm btn-default" href="/manage/admin/tuan/tuan_buying_edit/{{$tuanBuying['id']}}">编辑...</a>
            {{/if}}
            {{if $tuanBuying['status']==0}}
                <button type="button" class="btn btn-sm btn-warning tuan-buying-due" data-id="{{$tuanBuying['id']}}" value="1">完成</button>
                <button type="button" class="btn btn-sm btn-danger tuan-buying-canceled" data-id="{{$tuanBuying['id']}}" value="2">取消</button>
                <button type="button" class="btn btn-sm btn-info tuan-buying-sendmsg" data-id="{{$tuanBuying['id']}}">推送建团模板消息</button>
                <button type="button" class="btn btn-sm btn-info tuan-buying-cancelmsg" data-id="{{$tuanBuying['id']}}">推送建团模板消息</button>
            {{elseif $tuanBuying['status']==1}}
                <button type="button" class="btn btn-sm btn-warning tuan-buying-finished" data-id="{{$tuanBuying['id']}}" value="1">发货完成</button>
            {{elseif $tuanBuying['status']==2}}
                <button type="button" class="btn btn-sm btn-danger tuan-buying-refunded" data-id="{{$tuanBuying['id']}}" value="1">退款完成</button>
            {{/if}}
        </td>
    </tr>
    {{/loop}}
    </tbody>
</table>

{{$this->Html->script(
    array(
        'vendor/jquery.ui.widget.js',
        '//blueimp.github.io/JavaScript-Load-Image/js/load-image.all.min.js',
        '//blueimp.github.io/JavaScript-Canvas-to-Blob/js/canvas-to-blob.min.js',
        'jquery.iframe-transport.js',
        'manage/tuan_buyings/index.js'
    ));
}}