{{$this->Html->css(array('/js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css'))}}
<ol class="breadcrumb">
    <li><a href="/manage/admin/tuan/tuan_func_list">团购后台</a></li>
    <li class="active">团购订单</li>
</ol>

<ul class="nav nav-tabs" data-query-type="{{$query_type}}">
    <li role="presentation"><a data-tab="byUser" href="/manage/admin/tuan/query_by_user">快速查询</a></li>
    <li role="presentation"><a data-tab="byProduct" href="/manage/admin/tuan/query_by_product">按商品查询</a></li>
    <li role="presentation"><a data-tab="byOfflineStore"
                               href="/manage/admin/tuan/query_by_offline_store">按自提点查询</a></li>
    <li role="presentation">
        <a data-tab="emptySendDate" href="/manage/admin/tuan/query_b2c_empty_date_address">
            !!!B2C异常订单
            <span {{if $b2c_empty_date_address_count> 0}}class="text-danger"{{/if}}>({{$b2c_empty_date_address_count}})</span>
        </a>
    </li>
    <li role="presentation">
        <a data-tab="b2cPaidNotSend" href="/manage/admin/tuan/query_b2c_paid_not_send">
            !!!B2C未发货
            <span {{if $b2c_paid_not_sent_count> 0}}class="text-danger"{{/if}}>({{$b2c_paid_not_sent_count}})</span>
        </a>
    </li>
    <li role="presentation">
        <a data-tab="c2cPaidNotSend" href="/manage/admin/tuan/query_c2c_paid_not_send">
            !!!C2C未发货
            <span {{if $c2c_paid_not_sent_count> 0}}class="text-danger"{{/if}}>({{$c2c_paid_not_sent_count}})</span>
        </a>
    </li>
    <li role="presentation">
        <a data-tab="ordersToday" href="/manage/admin/tuan/query_orders_today">
            !!!今日订单
            <span {{if $orders_today_count> 0}}class="text-danger"{{/if}}>({{$orders_today_count}})</span>
        </a>
    </li>
</ul>
<div class="tab-content">
    <div id="byUser" class="tab-pane">
        <strong class="text-danger lead">团、秒、普通商品均可</strong>

        <form class="form-inline" method="post" action="/manage/admin/tuan/query_by_user" data-noajax="true">
            <div style="padding-bottom: 10px;padding-top: 10px;">
                <div class="form-group">
                    <input type="text" name="order_id" class="form-control" value="{{$order_id}}" placeholder="订单ID">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" name="con_name" placeholder="姓名" value="{{$con_name}}">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" name="con_phone" placeholder="手机号" value="{{$con_phone}}">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control" name="con_creator" placeholder="用户ID"
                           value="{{$con_creator}}">
                </div>
                <div class="form-group">
                    <select class="form-control order-status" data-value="{{$order_status}}" name="order_status">
                        <option value="-1">选择订单状态</option>
                        <option value="0">待支付</option>
                        <option value="1">待发货</option>
                        <option value="2">已发货</option>
                        <option value="4">已退款</option>
                        <option value="10">已作废</option>
                        <option value="14">退款中</option>
                    </select>
                </div>
                <br/>
                <br/>
                <button type="submit" class="btn btn-primary text-center">查看订单</button>
            </div>
        </form>
    </div>
    <div id="byProduct" class="tab-pane">
        <strong class="text-danger lead">团、秒、普通商品均可</strong>

        <form class="form-inline" method="post" action="/manage/admin/tuan/query_by_product" data-noajax="true">
            <div style="padding-bottom: 10px;padding-top: 10px;">
                <div class="form-group">
                    <input type="text" class="form-control product-search" data-search-for="product1"
                           placeholder="搜索商品">
                </div>
                <div class="form-group">
                    <select class="form-control products search-label" name="product_id" id="product1" data-value="{{$product_id}}">
                        <option value="-1">选择商品</option>
                    </select>
                </div>
                <div class="form-group">
                    <select class="form-control order-types" data-value="{{$order_type}}" name="order_type">
                        <option value="-1">选择订单类型</option>
                        <option value="1">只查普通</option>
                        <option value="5">只查团购</option>
                        <option value="6">只查秒杀</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" class="form-control send-date-start" data-date-format="yyyy-mmm-dd" value="{{$send_date_start}}"
                           placeholder="发货日期(如2015-5-1)" name="send_date_start">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control send-date-end" data-date-format="yyyy-mmm-dd" value="{{$send_date_end}}"
                           placeholder="发货日期(如2015-5-1)" name="send_date_end">
                </div>
                <div class="form-group">
                    <select class="form-control order-status" data-value="{{$order_status}}" name="order_status">
                        <option value="-1">选择订单状态</option>
                        <option value="0">待支付</option>
                        <option value="1">待发货</option>
                        <option value="2">已发货</option>
                        <option value="4">已退款</option>
                        <option value="10">已作废</option>
                        <option value="14">退款中</option>
                    </select>
                </div>
                <br/>
                <br/>
                <button type="submit" class="btn btn-primary text-center">查看订单</button>
            </div>
        </form>
    </div>
    <div id="byOfflineStore" class="tab-pane">
        <form class="form-inline form-by-offline-store" method="post" action="/manage/admin/tuan/query_by_offline_store"
              data-noajax="true">
            <div class="form-group">
                <input type="text" class="form-control offline-store-search" placeholder="搜索自提点"
                       data-search-for="offline-store">
            </div>
            <strong class="text-danger lead">查询团购订单，秒杀订单</strong>
            <div style="padding-bottom: 10px;padding-top: 10px;">
                <div class="form-group">
                    <select class="form-control offline_store search-label" name="store_id" id="offline-store" data-value="{{$store_id}}">
                        <option value="-1">请选择自提点</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" class="form-control  send-date-start" data-date-format="yyyy-mmm-dd"
                           value="{{$send_date}}" placeholder="日期(如2015-5-1)" name="send_date">
                </div>
                <div class="form-group">
                    <input type="text" class="form-control send-date-end" data-date-format="yyyy-mm-dd hh:ii"
                           value="{{$end_stat_date}}" placeholder="结束日期,单天可不填" name="end_stat_date">
                </div>
                <div class="form-group">
                    <select class="form-control order-status" data-value="{{order_status}}" name="order_status">
                        <option value="-1">选择订单状态</option>
                        <option value="0">待支付</option>
                        <option value="1">待发货</option>
                        <option value="2">已发货</option>
                        <option value="4">已退款</option>
                        <option value="10">已作废</option>
                        <option value="14">退款中</option>
                    </select>
                </div>
                <br/>
                <br/>
                <button type="submit" class="btn btn-primary text-center">查看订单</button>
                {{loop $brands $index $brand}}
                <div><span>{{$brand['Product']['name']}}:</span><strong style="color: red; font-size: large">{{$product_detail[$index]}} </strong></div>
                {{/loop}}
            </div>
        </form>
    </div>
    <div id="emptySendDate" class="tab-pane">
        <strong class="text-danger lead">只能查询团购、秒杀，2个月以内，待发货的订单</strong>
    </div>
    <div id="b2cPaidNotSend" class="tab-pane">
        <strong class="text-danger lead">B2C，到了发货时间，仍未发货的订单</strong>
    </div>
    <div id="c2cPaidNotSend" class="tab-pane">
        <strong class="text-danger lead">C2C，昨日以前支付，仍未发货的订单</strong>
    </div>
    <div id="ordersToday" class="tab-pane">
        <strong class="text-danger lead">今日已经支付的订单</strong>
    </div>
</div>

<hr/>
<div>
    <h1>订单总计<span style="color: red">{{count($orders)}}</span>个，金额<span style="color: red">{{$total_order_money}}</span></h1>
    {{if $should_count_nums}}
    <br/>

    <h1>份数<span style="color: red">{{$product_count}}</span>
        {{loop $product_spec_map $spec_map}}
        &nbsp;&nbsp;&nbsp;{{$spec_groups[$spec_map['cake_carts']['specId']]?$spec_groups[$spec_map['cake_carts']['specId']]:'没有规格'}}&nbsp;&nbsp;<span
                style="color: red">{{$spec_map['0']['sum(num)']}}</span>
        {{/loop}}
    </h1>
    {{/if}}
    <button  class="btn btn-primary pull-right ship-to-pys-stores">朋友说自提点发货</button>

</div>
<hr/>
<table class="table table-bordered orders">
    <thead class="data-head">
    <tr>
        <td><input type="checkbox" value="0" id="check_all_tb"></td>
        <td>订单号</td>
        <td>用户ID</td>
        <td>订单状态</td>
        <td>店家</td>
        <td>商品</td>
        <td>规格</td>
        <td>份数</td>
        <td>总价</td>
        <td>创建时间</td>
        <td>付款时间</td>
        <td>类型</td>
        <td>自提点</td>
        <td>配送方式</td>
        <td>发货时间</td>
        <td>收件人</td>
        <td>团队名称</td>
        <td>收件地址</td>
        <td>电话</td>
        <td>支付方式</td>
        <td>交易号</td>
        <td>备注</td>
        <td>操作</td>
    </tr>
    </thead>
    <!--comment-->
    <tbody>
    {{loop $ship_mark_enum $code $item}}
        {{if $code!='ziti'}}
            <?php
                $current_orders=$map_other_orders[$code];
                $data_tag = $code;
            ?>
            <tr class="{{$item['style']}}"><td colspan="22">{{$item['name']}}</td><td><button class="btn btn-primary btn-sm export-excel" data-tag="{{$data_tag}}">导出EXCEL</button></td></tr>
            {{template Elements/order_data_template}}
        {{else}}
            <tr class="{{$item['style']}}"><td colspan="23">{{$item['name']}}</td></tr>
            <tr><td class="warn" colspan="23">朋友说自提</td></tr>
            {{loop $pys_ziti_point $point}}
                <?php
                    $current_orders=$map_ziti_orders[$point['OfflineStore']['id']];
                    $data_tag = 'ziti-'.$point['OfflineStore']['id'];
                ?>
                <tr><td class="success" colspan="22">{{get_address(null,$point)}}</td><td><button class="btn btn-primary btn-sm export-excel" data-tag="{{$data_tag}}">导出EXCEL</button></td></tr>
                {{template Elements/order_data_template}}
                <?php unset($map_ziti_orders[$point['OfflineStore']['id']]); ?>
            {{/loop}}
            <tr><td class="warn" colspan="23">好邻居自提</td></tr>
            {{loop $hlj_ziti_point $point}}
                <?php
                    $current_orders=$map_ziti_orders[$point['OfflineStore']['id']];
                    $data_tag = 'ziti-'.$point['OfflineStore']['id'];
                ?>
                <tr><td class="success" colspan="22">{{get_address(null,$point)}}</td><td><button class="btn btn-primary btn-sm export-excel" data-tag="{{$data_tag}}">导出EXCEL</button></td></tr>
                {{template Elements/order_data_template}}
                <?php unset($map_ziti_orders[$point['OfflineStore']['id']]); ?>
            {{/loop}}
            {{loop $map_ziti_orders $current_orders}}
                <?php $data_tag='none-tag'; ?>
                <tr><td class="danger" colspan="23">未知自提点</td><td><button class="btn btn-primary btn-sm export-excel" data-tag="{{$data_tag}}">导出EXCEL</button></td></tr>
                {{template Elements/order_data_template}}
            {{/loop}}
        {{/if}}
    {{/loop}}
    </tbody>
</table>

<div class="ship-to-haolinju-store-dialog" title="好邻居店铺发货" class="hidden">
    <p class="text-warning">输入提货码，点击确认发货，会同时发送“到货提醒”</p>
    <p class="text-warning">否则只确认发货，不发送“到货提醒”</p>

    <form class="ship-to-haolinju-store-form form-inline">
        <label class="checkbox">
            <input type="checkbox" class="send-weixin-message" checked="checked">同时发送“到货提醒”
        </label>
        <input type="hidden" class="haolinju-order-id" value=""/>
        <input type="text"class="haolinju-code" value="" placeholder="请输入提货码">
    </form>
</div>
<div id="refund-form" class="form-horizontal refund-order-dialog" title="退款通知">
    <div class="form-group">
        <label class="col-sm-2 control-label">订单状态</label>

        <div class="col-sm-9">
            <label class="radio-inline">
                <input type="radio" id="order_in_refunding" name="status" value="14" data-toggle="collapse"
                       data-target="#refund_order">退款中
            </label>
            <label class="radio-inline">
                <input type="radio" id="order_refunded" name="status" checked="checked" value="4" data-toggle="collapse"
                       data-target="#refund_order">已退款
            </label>

            <p class="text-warning">选择退款中，只会更改订单状态；选择已退款，需要输入金额，并发送退款模版和短信</p>
        </div>
    </div>
    <div id="refund_order" class="collapse">
        <div class="form-group">
            <label for="refund_money" class="col-sm-2 control-label">退款金额</label>

            <div class="col-sm-10">
                <input id="refund_money" type="number" step="0.01" class="form-control" placeholder="单位为元">

                <p class="error-message"></p>
            </div>
        </div>
        <div class="form-group">
            <label for="refund_remark" class="col-sm-2 control-label">退款原因</label>

            <div class="col-sm-10">
                <textarea id="refund_remark" class="form-control" placeholder="说明退款原因"></textarea>
            </div>
        </div>
    </div>
    <input type="hidden" value="" id="order-id">
    <input type="hidden" value="" id="order-creator">
    <input type="hidden" value="" id="order-totalprice">
</div>

<div class="ship-to-our-store-dialog" title="自有自提点发货">
    <p class="text-warning">发消息的同时会修改状态，不会重复发送消息</p>
    <form class="ship-to-our-store-form form-inline">
        <div>
            <input type="radio" name="optionsRadios" id="optionsRadios1" value="0" checked>
            发送发货提醒
        </div>
        <br />
        <div>
            <input type="radio" name="optionsRadios" id="optionsRadios2" value="1">
            发送到货提醒
        </div>
    </form>
</div>
<div class="input-ship-code-dialog" title="回填快递单号">
    <p class="text-warning">回填单号会发送模版消息</p>
        <div class="well">
            <select class="ship-type-select">
                <option value="-1">快递类型</option>
                {{loop $ship_type $id $type}}
                <option value="{{$id}}">{{$type}}</option>
                {{/loop}}
            </select>
            <input type="text" width="80px;" name="order-ship-code" placeholder="快递单号">
        </div>
</div>
{{$this->Html->script(array('/js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js',
'/js/bootstrap-datetimepicker/bootstrap-datetimepicker.zh-CN.js',
'/js/manage-lib/tableExport.jquery.plugin/tableExport.js',
'/js/manage-lib/tableExport.jquery.plugin/jquery.base64.js'))}}
{{$this->Html->script(array('manage/tuan/tuan_orders.js?v5.8'))}}