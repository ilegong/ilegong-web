{{$this->Html->css(array('/js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css'))}}
<hr/>
<h1>团购订单管理</h1>
<!--<hr/>-->
    <!--<ul class="nav nav-tabs">-->
      <!--<li role="presentation" class="active"><a href="#general">Home</a></li>-->
      <!--<li role="presentation"><a href="#nameOrMobile">姓名手机号查询</a></li>-->
      <!--<li role="presentation"><a href="#orderId">订单ID查询</a></li>-->
    <!--</ul>-->
<!--<hr/>-->
<div id="general">
  <form class="form-inline" method="post" action="/manage/admin/tuan/tuan_orders" data-noajax="true">
      <div style="padding-bottom: 10px;padding-top: 10px;">
          <div class="form-group">
              <input type="text" class="form-control" placeholder="搜索团队" id="tuan_name">
          </div>
          <div class="form-group">
              <select class="form-control" name="team_id" id="team_id">
                  <option value="-1">请选择团队</option>
              </select>
          </div>
          <div class="form-group">
              <input type="text" class="form-control" placeholder="搜索商品" id="tuan_product">
          </div>
          <div class="form-group">
              <select class="form-control" name="product_id" id="product_id">
                  <option value="-1">选择商品</option>
              </select>
          </div>
          <div class="form-group">
              <select class="form-control" name="order_type" id="order_type">
                  <option value="-1">选择订单状态</option>
                  <option value="0">待支付</option>
                  <option value="1">待发货</option>
                  <option value="2">已发货</option>
                  <option value="4">已退款</option>
                  <option value="10">已作废</option>
              </select>
          </div>
          <div class="form-group">
              <input type="text" class="form-control" data-date-format="yyyy-mm-dd hh:ii" value="{{$start_stat_datetime}}" placeholder="开始统计日期" name="start_stat_datetime">
          </div>
          <div class="form-group">
              <input type="text" class="form-control" data-date-format="yyyy-mm-dd hh:ii" value="{{$end_stat_datetime}}" placeholder="结束统计日期" name="end_stat_datetime">
          </div>
          <br/>
          <br/>
          <div class="form-group">
              <input type="text" class="form-control" data-date-format="yyyy-mmm-dd" value="{{$tuan_con_date}}" placeholder="团购发货日期" name="tuan_con_date">
          </div>
          <div class="form-group">
              <input type="text" class="form-control" data-date-format="yyyy-mmm-dd" value="{{$product_con_date}}" placeholder="产品排期" name="product_con_date">
          </div>
          <div class="form-group">
              <input type="text" name="con_address" class="form-control" placeholder="地址" value="{{$con_address}}">
          </div>
          <div class="form-group">
              <input type="text" class="form-control" name="con_name" placeholder="姓名" value="{{$con_name}}">
          </div>
          <div class="form-group">
              <input type="text" class="form-control" name="con_phone" placeholder="手机号" value="{{$con_phone}}">
          </div>
          <div class="form-group">
              <input type="text" name="order_id" class="form-control" value="{{$order_id}}" placeholder="订单ID">
          </div>
          <div class="form-group">
              <input type="text" name="query_product_id" class="form-control" value="{{$query_product_id}}" placeholder="商品ID">
          </div>
          <div class="form-group">
              <div class="checkbox">
                  <label>
                      <input name="export" type="checkbox"> 导出订单
                  </label>
              </div>
          </div>
          <br/>
          <br/>
          <button type="submit" class="btn btn-primary text-center">查看订单</button>
      </div>
  </form>
</div>

<!--<div id="nameOrMobile">-->
  <!--<form class="form-inline" method="post" action="/manage/admin/tuan/tuan_orders" data-noajax="true">-->
    <!--<div style="padding-bottom: 10px;">-->
      <!--<div class="form-group">-->
        <!--<label class="sr-only">收件人姓名</label>-->
        <!--<input type="text" class="form-control" name="con_name" placeholder="姓名" value="{{$con_name}}">-->
      <!--</div>-->
      <!--<div class="form-group">-->
        <!--<label class="sr-only">收件人手机号</label>-->
        <!--<input type="text" class="form-control" name="con_phone" placeholder="手机号" value="{{$con_phone}}">-->
      <!--</div>-->
      <!--<div class="form-group">-->
        <!--<label class="sr-only">订单ID</label>-->
        <!--<input type="text" name="order_id" class="form-control" value="{{$order_id}}" placeholder="订单ID">-->
      <!--</div>-->
      <!--<button type="submit" class="btn btn-primary text-center">查看订单</button>-->
    <!--</div>-->
  <!--</form>-->
<!--</div>-->

<!--<div id="orderId">-->
  <!--<form class="form-inline" method="post" action="/manage/admin/tuan/tuan_orders" data-noajax="true">-->
    <!--<div style="padding-bottom: 10px;">-->
      <!--<div class="form-group">-->
        <!--<label class="sr-only">收件人姓名</label>-->
        <!--<input type="text" class="form-control" name="con_name" placeholder="姓名" value="{{$con_name}}">-->
      <!--</div>-->
      <!--<div class="form-group">-->
        <!--<label class="sr-only">收件人手机号</label>-->
        <!--<input type="text" class="form-control" name="con_phone" placeholder="手机号" value="{{$con_phone}}">-->
      <!--</div>-->
      <!--<div class="form-group">-->
        <!--<label class="sr-only">订单ID</label>-->
        <!--<input type="text" name="order_id" class="form-control" value="{{$order_id}}" placeholder="订单ID">-->
      <!--</div>-->
      <!--<button type="submit" class="btn btn-primary text-center">查看订单</button>-->
    <!--</div>-->
  <!--</form>-->
<!--</div>-->

<hr/>
<div>
    <h1>订单总计<span style="color: red">{{count($orders)}}</span>个，金额<span style="color: red">{{$total_money}}</span> {{if $orders_invalid === 0 || $orders_invalid}}<small>（待支付/已取消：{{$orders_invalid}}个 {{$total_unpaid}}元)</small>{{/if}}</h1>
    {{if $should_count_nums}}
    <br/>
    <h1>份数<span style="color: red">{{$product_count}}</span>
        {{loop $product_spec_map $spec_map}}
            &nbsp;&nbsp;&nbsp;{{$spec_groups[$spec_map['cake_carts']['specId']]?$spec_groups[$spec_map['cake_carts']['specId']]:'没有规格'}}&nbsp;&nbsp;<span style="color: red">{{$spec_map['0']['sum(num)']}}</span>
        {{/loop}}
    </h1>
    {{/if}}
</div>
<hr/>
<table class="table table-bordered">
    <thead>
        <tr>
            <td>订单号</td><td>用户ID</td><td>订单状态</td><td>商品</td><td>规格</td><td>份数</td><td>总价</td><td>创建时间</td><td>付款时间</td><td>截单时间</td><td>配送方式</td><td>发货时间</td><td>收件人</td><td>团队名称</td><td>收件地址</td><td>电话</td><td>支付方式</td><td>备注</td>
        </tr>
    </thead>
    <tbody>
        {{loop $orders $order}}
            <tr>
                <td>{{$order['Order']['id']}}</td>
                <td>{{$order['Order']['creator']}}</td>
                <td>
                    {{if $order['Order']['status']==0}}
                    待支付
                    {{elseif $order['Order']['status']==1}}
                    待发货
                    {{elseif $order['Order']['status']==2}}已发货
                    {{elseif $order['Order']['status']==3}}已收货
                    {{elseif $order['Order']['status']==4}}已退款
                    {{elseif $order['Order']['status']==10}}已作废
                    {{elseif $order['Order']['status']==11}}待支付
                    {{/if}}
                </td>
                <td>
                    {{loop $order_carts[$order['Order']['id']] $cart}}
                        {{$cart['Cart']['name']}}
                    {{/loop}}
                </td>
                <td>
                    {{loop $order_carts[$order['Order']['id']] $cart}}
                    {{$cart['Cart']['spec_name']}}
                    {{/loop}}
                </td>
                <td>
                    {{loop $order_carts[$order['Order']['id']] $cart}}
                        {{$cart['Cart']['num']}}
                    {{/loop}}
                </td>
                <td>{{$order['Order']['total_all_price']}}</td>
                <td>{{$order['Order']['created']}}</td>
                <td>{{$order['Order']['pay_time']}}</td>
                <td>
                    {{$tuan_buys[$order['Order']['member_id']]['end_time']}}
                </td>
                <td>
                    {{if $order['Order']['ship_type']=='ziti'}}
                        自提
                    {{elseif $order['Order']['ship_type']=='sf'}}
                        顺风到付
                    {{elseif $order['Order']['ship_type']=='kddj'}}
                        快递到家
                    {{else}}
                        没有标注
                    {{/if}}
                </td>
                <td>
                    {{loop $order_carts[$order['Order']['id']] $cart}}
                        {{if !empty($cart['Cart']['consignment_date'])}}
                            <?php
                                $date = $consign_dates[$cart['Cart']['consignment_date']];
                                $consign_time = empty($date)?'': date('m-d', strtotime($date));
                            ?>
                            {{$consign_time}}
                        {{elseif $order['Order']['type'] == 5}}
                            <?php
                                $date = $tuan_buys[$order['Order']['member_id']]['consign_time'];
                                $consign_time = empty($date)?'': date('m-d', strtotime($date));
                            ?>
                            {{if empty($consign_time)}}
                                团满发货
                            {{else}}
                                {{$consign_time}}
                            {{/if}}
                        {{/if}}
                    {{/loop}}
                </td>
                <td>{{$order['Order']['consignee_name']}}</td>
                <td>
                    {{$tuans[$tuan_buys[$order['Order']['member_id']]['tuan_id']]['tuan_name']}}
                </td>
                <td>
                    {{$order['Order']['consignee_address']}}
                </td>

                <td>{{$order['Order']['consignee_mobilephone']}}</td>

                <td>
                    {{if $order['Pay']['trade_type']=='JSAPI'}}
                    微信支付
                    {{elseif $order['Pay']['trade_type']=='ZFB'}}
                    支付宝
                    {{/if}}
                </td>
                <td>
                    {{$order['Order']['remark']}}
                </td>
            </tr>
        {{/loop}}
    </tbody>
</table>
{{$this->Html->script(array('/js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js','/js/bootstrap-datetimepicker/bootstrap-datetimepicker.zh-CN.js'))}}
<script>
    $(document).ready(function(){
        var $team_id = $('#team_id');
        var $product_id = $('#product_id');
        var $order_type = $('#order_type');
        var tuanProducts = $('#product_id');
        var tuan_name = $('#tuan_name');
        var tuan_product = $('#tuan_product');
        var start_stat_date = $('input[name="start_stat_datetime"]');
        var end_stat_date = $('input[name="end_stat_datetime"]');
        var tuan_con_date = $('input[name="tuan_con_date"]');
        var product_con_date = $('input[name="product_con_date"]');
        var leftTeamSelectData = [];
        var leftProductSelectData = [];
        start_stat_date.datetimepicker({
            format: 'yyyy-mm-dd hh:ii'
        });
        end_stat_date.datetimepicker({
            format: 'yyyy-mm-dd hh:ii'
        });
        tuan_con_date.datetimepicker({
            format: 'yyyy-mm-dd'
        });
        product_con_date.datetimepicker({
                format: 'yyyy-mm-dd'
        });
        $.getJSON('/manage/admin/tuanTeams/api_tuan_teams',function(data){
            $.each(data,function(index,item){
                $('<option value="'+item['id']+'">'+item['tuan_name']+'</option>').appendTo($team_id);
            });
            setVal();
            search_tuanteam();
        });
        $.getJSON('/manage/admin/tuanProducts/api_tuan_products',function(data){
            $.each(data,function(index,item){
                var tuan_product = item['TuanProduct'];
                $('<option value="' + tuan_product['product_id'] + '">' + tuan_product['alias'] + '</option>').appendTo(tuanProducts);
            });
            $product_id.val('{{$product_id}}');
            search_product();
        });
        function setVal(){
            $team_id.val('{{$team_id}}');
            $order_type.val('{{$order_type}}');
        }

        String.prototype.Trim = function() {
            return this.replace(/(^\s*)|(\s*$)/g, "");
        };

        function search_product(){
            $("option",$product_id).each(function(){
                leftProductSelectData.push({'val':$(this).val(),'name':$(this).text()});
            });
            if(navigator.userAgent.indexOf("MSIE")>0){
                tuan_product.on('onpropertychange',productChange);
            }else{
                tuan_product.on('input',productChange);
            }
        }

        function search_tuanteam(){
            $("option",$team_id).each(function(){
                leftTeamSelectData.push({'val':$(this).val(),'name':$(this).text()});
            });
            if(navigator.userAgent.indexOf("MSIE")>0){
                tuan_name.on('onpropertychange',tuanNameChange);
            }else{
                tuan_name.on('input',tuanNameChange);
            }
        }
        function tuanNameChange(){
            var content= tuan_name.val().Trim();
            $team_id.empty();
            if(content == ''){
                $.each(leftTeamSelectData,function(index,value){
                    $team_id.append('<option value="'+value['val']+'">'+value['name']+'</option>');
                });
            }else{
                var reg = new RegExp(content,'i');
                $.each(leftTeamSelectData,function(index,val){
                    if(reg.test(val['name'])){
                        $team_id.append('<option selected="selected" value="'+val['val']+'">'+val['name']+'</option>');
                    }
                })
            }
        }

        function productChange(){
            var content= tuan_product.val().Trim();
            $product_id.empty();
            if(content == ''){
                $.each(leftProductSelectData,function(index,value){
                    $product_id.append('<option value="'+value['val']+'">'+value['name']+'</option>');
                });
            }else{
                var reg = new RegExp(content,'i');
                $.each(leftProductSelectData,function(index,val){
                    if(reg.test(val['name'])){
                        $product_id.append('<option selected="selected" value="'+val['val']+'">'+val['name']+'</option>');
                    }
                })
            }
        }

    });
</script>
