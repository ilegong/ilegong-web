<style>
    .filterable {
        margin-top: 15px;
    }

    .filterable .panel-heading .pull-right {
        margin-top: -20px;
    }

    .filterable .filters input[disabled] {
        background-color: transparent;
        border: none;
        cursor: auto;
        box-shadow: none;
        padding: 0;
        height: auto;
    }

    .filterable .filters input[disabled]::-webkit-input-placeholder {
        color: #333;
    }

    .filterable .filters input[disabled]::-moz-placeholder {
        color: #333;
    }

    .filterable .filters input[disabled]:-ms-input-placeholder {
        color: #333;
    }
</style>
{{$this->Html->css(array('/js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css'))}}
<h3>发货预警订单</h3>
<hr>
<div class="row">
    <div class="col-lg-6 pull-right">
        <form action="/manage/admin/share/warn_orders" method="get" class="form-inline">
            <div class="form-group">
                <label for="start_date">开始日期</label>
                <input type="text" class="form-control" id="start_date" name="start_date" placeholder="2015-07-21"
                       value="{{$start_date}}">
            </div>
            <div class="form-group">
                <label for="end_date">结束日期</label>
                <input type="text" class="form-control" id="end_date" name="end_date" placeholder="2015-07-21"
                       value="{{$end_date}}">
            </div>
            <button type="submit" class="btn btn-default">查询</button>
        </form>
    </div>
    <!-- /.col-lg-6 -->
</div><!-- /.row -->
<div class="row">
    <div class="panel panel-primary filterable">
        <div class="panel-heading">
            <h3 class="panel-title">订单</h3>

            <div class="pull-right">
                <button class="btn btn-default btn-xs btn-filter"><span class="glyphicon glyphicon-filter"></span>查找
                </button>
            </div>
        </div>
        <table class="table">
            <thead>
            <tr class="filters">
                <th><input type="text" class="form-control" placeholder="订单ID" disabled></th>
                <th><input type="text" class="form-control" placeholder="用户ID" disabled></th>
                <th><input type="text" class="form-control" placeholder="用户昵称" disabled></th>
                <th><input type="text" class="form-control" placeholder="收货人" disabled></th>
                <th><input type="text" class="form-control" placeholder="地址" disabled></th>
                <th><input type="text" class="form-control" placeholder="联系方式" disabled></th>
                <th><input type="text" class="form-control" placeholder="分享名称" disabled></th>
                <th><input type="text" class="form-control" placeholder="分享人" disabled></th>
                <th><input type="text" class="form-control" placeholder="分享人联系方式" disabled></th>
                <th><input type="text" class="form-control" placeholder="商品" disabled></th>
                <th><input type="text" class="form-control" placeholder="商品份数" disabled></th>
                <th><input type="text" class="form-control" placeholder="商品总价" disabled></th>
                <th><input type="text" class="form-control" placeholder="订单总价" disabled></th>
                <th><input type="text" class="form-control" placeholder="尾款差价" disabled></th>
                <th><input type="text" class="form-control" placeholder="退款金额" disabled></th>
                <th><input type="text" class="form-control" placeholder="创建时间" disabled></th>
                <th><input type="text" class="form-control" placeholder="状态" disabled></th>
                <th><input type="text" class="form-control" placeholder="物流方式" disabled></th>
                <th><input type="text" class="form-control" placeholder="快递单号" disabled></th>
                <th><input type="text" class="form-control" placeholder="交易号" disabled></th>
                <th><input type="text" class="form-control" placeholder="推荐人" disabled></th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {{loop $orders $order}}
            <?php
                    $current_order_id = $order['Order']['id'];
                    $current_order_carts = $order_cart_map[$current_order_id];
                    $current_order = $order['Order'];
                    $current_share = $weshares[$current_order['member_id']];
                    $current_share_creator = $all_users[$current_share['creator']];
                    $loop_index=0;
                    ?>
            {{loop $current_order_carts $cart}}
            <tr data-id="{{$current_order['id']}}">
                <td>{{$current_order['id']}}</td>
                <td>{{$current_order['creator']}}</td>
                <td>{{$all_users[$current_order['creator']]['nickname']}}</td>
                <td>{{$current_order['consignee_name']}}</td>
                <td>{{$current_order['consignee_address']}}</td>
                <td>{{$current_order['consignee_mobilephone']}}</td>
                <td>{{$current_share['title']}}</td>
                <td>{{$current_share_creator['nickname']}}</td>
                <td>{{$current_share_creator['mobilephone']}}</td>
                <td>{{$cart['name']}}</td>
                <td>{{$cart['num']}}</td>
                <td>{{$cart['price']*$cart['num']/100}}</td>
                <td>{{$current_order['total_all_price']}}</td>
                <td>{{if $current_order['price_difference'] > 0}}加尾款{{elseif
                    $current_order['price_difference']==0}}{{else}}退尾款{{/if}}&nbsp;&nbsp;<span style="color: red;">{{abs($current_order['price_difference'])/100}}</span>
                </td>
                <td>{{if
                    !empty($refund_logs[$current_order['id']])}}{{$refund_logs[$current_order['id']]/100}}{{else}}0{{/if}}
                </td>
                <td>{{$current_order['created']}}</td>
                <td name="status">
                    {{if $current_order['status']==ORDER_STATUS_PAID}}
                    已付款
                    {{elseif $current_order['status'] == ORDER_STATUS_SHIPPED}}
                    已发货
                    {{elseif $current_order['status'] == ORDER_STATUS_RECEIVED}}
                    已收货
                    {{elseif $current_order['status'] == 5}}
                    价格待定
                    {{elseif $current_order['status'] == 6}}
                    尾款处理
                    {{elseif $current_order['status'] == 14}}
                    退款中
                    {{elseif $current_order['status'] == 4}}
                    已退款
                    {{else}}
                    已完成
                    {{/if}}
                </td>
                <td>
                    {{if $current_order['ship_mark'] == 'pys_ziti'}}
                    朋友说自提
                    {{elseif $current_order['ship_mark'] == 'self_ziti'}}
                    自有自提
                    {{elseif $current_order['ship_mark'] == 'pin_tuan'}}
                    拼团
                    {{else}}
                    快递
                    {{/if}}
                </td>
                <td>
                    {{$current_order['ship_code']}}
                </td>
                <td>
                    {{if !empty($pay_notifies[$current_order['id']])}}
                    {{$pay_notifies[$current_order['id']]}}
                    {{else}}
                    {{$pay_notifies[$current_order['parent_order_id']]}}
                    {{/if}}
                </td>
                <td>
                    {{$all_users[$rebate_logs[$current_order['cate_id']]]['nickname']}}
                </td>
                <td>
                    {{if $loop_index==0}}
                    {{if $current_order['ship_mark']=='pys_ziti'&&$current_order['status']==1}}
                    <button type="button" class="btn btn-danger send-offline-store-msg"
                            data-id="{{$current_order['id']}}" data-toggle="modal">发货
                    </button>
                    {{/if}}
                    {{if $current_order['status']!=4}}
                    <button type="button" class="btn btn-info refund-order"
                            data-share-id="{{$current_order['member_id']}}" data-id="{{$current_order['id']}}">{{if
                        $current_order['status']!=14}}退款{{else}}退款完成{{/if}}
                    </button>
                    {{/if}}
                    {{if $current_order['process_prepaid_status']==ORDER_STATUS_REFUND_TODO}}
                    <button type="button" data-share-id="{{$current_order['member_id']}}"
                            data-id="{{$current_order['id']}}" class="btn btn-danger refund-added-order">退尾款
                    </button>
                    {{/if}}
                    {{/if}}
                </td>
            </tr>
            <?php
                $loop_index++;
            ?>
            {{/loop}}
            {{/loop}}
            </tbody>
        </table>
    </div>
</div>
<div class="modal" id="refundModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">订单退款操作</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label for="refund-money" class="col-sm-2 control-label">退款金额</label>

                        <div class="col-sm-10">
                            <input type="number" class="form-control" id="refund-money" placeholder="金额/元">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="refund-reason" class="col-sm-2 control-label">退款描述</label>

                        <div class="col-sm-10">
                            <textarea id="refund-reason" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">退款状态</label>

                        <div class="col-sm-10">
                            <div class="checkbox">
                                <label class="radio-inline">
                                    <input type="radio" name="refund-status" value="0" checked="checked"> 退款中
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="refund-status" value="1"> 已退款
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary set-order-refund">提交</button>
            </div>
        </div>
    </div>
</div>
<div class="modal" id="offlineStoreModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">好邻居发送到货提醒</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="offline-store-code" class="control-label">提货码:</label>
                        <input type="text" class="form-control" id="offline-store-code">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary send-offline-store-code-msg">发送</button>
            </div>
        </div>
    </div>
</div>
{{$this->Html->script(array('/js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js'))}}
<script>
    /*
     Please consider that the JS part isn't production ready at all, I just code it to show the concept of merging filters and titles together !
     */
    $(document).ready(function () {
        $('#start_date').datetimepicker({
            format: "yyyy-mm-dd",
            maxView: "day",
            autoclose: true
        });
        $('#end_date').datetimepicker({
            format: "yyyy-mm-dd",
            maxView: "day",
            autoclose: true
        });
        $('.filterable .btn-filter').click(function () {
            var $panel = $(this).parents('.filterable'),
                    $filters = $panel.find('.filters input'),
                    $tbody = $panel.find('.table tbody');
            if ($filters.prop('disabled') == true) {
                $filters.prop('disabled', false);
                $filters.first().focus();
            } else {
                $filters.val('').prop('disabled', true);
                $tbody.find('.no-result').remove();
                $tbody.find('tr').show();
            }
        });

        $('.filterable .filters input').keyup(function (e) {
            /* Ignore tab key */
            var code = e.keyCode || e.which;
            if (code == '9') return;
            /* Useful DOM data and selectors */
            var $input = $(this),
                    inputContent = $input.val().toLowerCase(),
                    $panel = $input.parents('.filterable'),
                    column = $panel.find('.filters th').index($input.parents('th')),
                    $table = $panel.find('.table'),
                    $rows = $table.find('tbody tr');
            /* Dirtiest filter function ever ;) */
            var $filteredRows = $rows.filter(function () {
                var value = $(this).find('td').eq(column).text().toLowerCase();
                return value.indexOf(inputContent) === -1;
            });
            /* Clean previous no-result if exist */
            $table.find('tbody .no-result').remove();
            /* Show all rows, hide filtered ones (never do that outside of a demo ! xD) */
            $rows.show();
            $filteredRows.hide();
            /* Prepend no-result row if all rows are filtered */
            if ($filteredRows.length === $rows.length) {
                $table.find('tbody').prepend($('<tr class="no-result text-center"><td colspan="' + $table.find('.filters th').length + '">No result found</td></tr>'));
            }
        });
    });
</script>